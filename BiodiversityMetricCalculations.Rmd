---
title: "BiodiversityMetric"
author: "Jenny Rogers"
date: '2022-05-20'
output: html_document
---

In this file, we calucate different biodiversity metrics at 5 scales, the survey site, stream reach, HUC 12, HUC 10, and HUC 8.
 
Biodiversity metrics:
spp richness 
ratio of native to nonnative spp richness
ratio of site richness relative to HUC 8, 10, 12 richness
ratio of cold water to warm water
percent of target fish community present

considering climate change
change in spp richness (immigrations vs extirpations)
percent addition of cold or warm water spp

Cluster fish based on cooccurrence - each cluseter is a metric of biodiversity

load libraries

```{r}

library(tidyverse)
library(sf)


```

load datafiles

```{r}
#watershed data
load("C:/Users/jenrogers/Documents/necascFreshwaterBio/model_datafiles/fish_event_huc_join.RData")
load(file = "C:/Users/jenrogers/Documents/necascFreshwaterBio/model_datafiles/fish_event_flowline_join.RData")

#fish data
load(file =  "C:/Users/jenrogers/Documents/necascFreshwaterBio/model_datafiles/fish_occurrence.RData")
load(file =  "C:/Users/jenrogers/Documents/necascFreshwaterBio/model_datafiles/fish_count_with_zeros.RData")

#fish attribute data
load(file =  "C:/Users/jenrogers/Documents/necascFreshwaterBio/spp_data/tidydata/vtdec_fish_species.RData")
load(file =  "C:/Users/jenrogers/Documents/necascFreshwaterBio/spp_data/tidydata/ma_fish_species.RData")

```


Calculate spp richness at each scale

```{r}

#remove absence data
fish_occurrence <- fish_occurrence %>% 
  filter(occurrence == 1)






#spp richness: site scale

richness_site <- fish_occurrence %>%
  group_by(UID) %>% 
  summarise(richness_site = n())
hist(richness_site$richness_site)

#join with spatial data
dat <- left_join(fish_event_flowline_join, richness_site, by = "UID")






#spp richness: NHD Reach

richness_reach <- left_join(fish_occurrence, fish_event_flowline_join, by = 'UID') %>% 
  group_by(NHDPlusID) %>% 
  summarise(richness_reach = length(unique(common_name)))
  
  
hist(richness_reach$richness_reach)






#spp richness: huc12

richness_huc12 <- left_join(fish_occurrence, fish_event_huc_join, by = 'UID') %>% 
  group_by(huc12_name) %>% 
  summarise(richess_huc12 = length(unique(common_name)))
  
  
hist(richness_huc12$richess_huc12)






#spp richness: huc10

richness_huc10 <- left_join(fish_occurrence, fish_event_huc_join, by = 'UID') %>% 
  group_by(huc10_name) %>% 
  summarise(richness_huc10 = length(unique(common_name)))
  
  
hist(richness_huc10$richness_huc10)






#spp richness: huc8

richness_huc8 <- left_join(fish_occurrence, fish_event_huc_join, by = 'UID') %>% 
  group_by(huc8_name) %>% 
  summarise(richness_huc8 = length(unique(common_name)))
  
  
hist(richness_huc8$richness_huc8)


```


cluster spp based on cooccurrence using abundance data, presence absence data
```{r}
library(corrplot)

load(file =  "C:/Users/jenrogers/Documents/necascFreshwaterBio/model_datafiles/fish_count_with_zeros.RData")


dat <- fish_count_with_zeros %>%  
  filter(!is.na(reach_length_m)) %>%
  mutate(reach_length_m = reach_length_m+1, #some reach lengths were 0 - I assume this means they just did a grab sample in one location.. but I need to check
         abundance = count/reach_length_m) %>% 
  select(UID, common_name, abundance) %>% 
  pivot_wider(names_from = common_name, values_from = abundance) %>% 
  column_to_rownames(var = "UID")
  
#check the total abundance in each sample
range(apply(dat, 1, sum), na.rm = T)

#convert the abundance into relative abundance, so that the total abundance always adds up to 1
dat <- decostand(dat, method = "total")
range(apply(dat, 1, sum), na.rm = T)

test <- round(cor(dat),3)


png(height = 10, width = 15, file = "tmpfigures/fishcorplot.png", units = "in", res = 150, type = "cairo")

corrplot(test, type = "upper", order = "hclust")

dev.off()





load(file =  "C:/Users/jenrogers/Documents/necascFreshwaterBio/model_datafiles/fish_occurrence.RData")


dat <- fish_occurrence %>%
  select(UID, common_name, occurrence) %>% 
  pivot_wider(names_from = common_name, values_from = occurrence) %>% 
  column_to_rownames(var = "UID")
  
#check the total abundance in each sample
range(apply(dat, 1, sum), na.rm = T)

#convert the abundance into relative abundance, so that the total abundance always adds up to 1
dat <- decostand(dat, method = "total")
range(apply(dat, 1, sum), na.rm = T)

test <- round(cor(dat),3)


png(height = 10, width = 15, file = "tmpfigures/fishcorplot_occ.png", units = "in", res = 150, type = "cairo")

corrplot(test, type = "upper", order = "hclust")

dev.off()




#corr plot at huc12 scale

dat <- left_join(fish_occurrence, fish_event_huc_join, by = 'UID') %>%
  select(common_name, occurrence, huc12_name) %>% 
  group_by(huc12_name, common_name) %>% 
  summarize(occurrence = max(occurrence)) %>% 
  filter(!is.na(huc12_name)) %>% 
  pivot_wider(names_from = common_name, values_from = occurrence) %>% 
  column_to_rownames(var = "huc12_name")

#check the total abundance in each sample
range(apply(dat, 1, sum), na.rm = T)

#convert the abundance into relative abundance, so that the total abundance always adds up to 1
dat <- decostand(dat, method = "total")
range(apply(dat, 1, sum), na.rm = T)

test <- round(cor(dat),3)

png(height = 10, width = 15, file = "tmpfigures/fishcorplot_huc12.png", units = "in", res = 150, type = "cairo")

corrplot(test, type = "upper", order = "hclust")

dev.off()

```

Cluster spp based on occurrence and based on watershed characteristcs
```{r}
library(data.table)


#cluster based on the occurrence of other species
load(file =  "C:/Users/jenrogers/Documents/necascFreshwaterBio/model_datafiles/fish_occurrence.RData")


dat <- fish_occurrence %>%
  select(UID, common_name, occurrence) %>%
  pivot_wider(names_from = common_name, values_from = occurrence) %>% 
  column_to_rownames(var = "UID")

test <- transpose(dat)
colnames(test) <- rownames(dat)

dist_mat <- dist(test, method = "binary")

hclust_avg <- hclust(dist_mat, method = "average")
hclust_avg$labels<- names(dat)

png(height = 10, width = 15, file = "tmpfigures/fishhclust.png", units = "in", res = 150, type = "cairo")

plot(hclust_avg)
dev.off()


#cluster based on the occurrence of other species by HUC8
load(file =  "C:/Users/jenrogers/Documents/necascFreshwaterBio/model_datafiles/fish_occurrence.RData")

  
tmp <- left_join(fish_occurrence, fish_event_huc_join, by = "UID") 

for (i in unique(fish_event_huc_join$huc8_name)) {

dat <- tmp %>% 
  filter(huc8_name == i)
#remove spp that are never presenct
keep <- dat %>% 
  group_by(common_name) %>% 
  summarise(occ = sum(occurrence)) %>% 
  filter(occ > 0)


dat <- dat %>%
  filter(common_name %in% keep$common_name ) %>%  
  select(UID, common_name, occurrence) %>% # problem - the UID in VT DFW is not unique! there are some that have duplicated names, need to return to the tidying vt data and fix this!!!
  pivot_wider(names_from = common_name, values_from = occurrence) %>% 
  column_to_rownames(var = "UID")

test <- transpose(dat)
colnames(test) <- rownames(dat)

dist_mat <- dist(test, method = "binary")

hclust_avg <- hclust(dist_mat, method = "average")
hclust_avg$labels<- names(dat)

png(height = 10, width = 15, file = paste("tmpfigures/fish_clusters/", i, ".png", sep = ""), units = "in", res = 150, type = "cairo")

plot(hclust_avg)
dev.off()

print(i)

}





#CART analysis based on VAA
library(caret)
library(rpart)
load(file = "C:/Users/jenrogers/Documents/necascFreshwaterBio/model_datafiles/fish_event_flowline_join.RData")

dat <- left_join(fish_occurrence, fish_event_flowline_join, by = "UID") %>% 
  filter(occurrence == 1,
         common_name %in% c("burbot", "swamp darter", "black crappie")) %>% 
  mutate(long = unlist(map(geometry, 1)),
         lat = unlist(map(geometry, 2))) %>% 
  select(common_name, StreamOrde, MinElevSmo, lat, long)

model <- rpart(common_name ~., data = dat)
par(xpd = NA)
plot(model)


```
