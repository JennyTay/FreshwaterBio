---
title: "BiodiversityMetric"
author: "Jenny Rogers"
date: '2022-05-20'
output: html_document
---

In this file, we calucate different biodiversity metrics at 5 scales, the survey site, stream reach, HUC 12, HUC 10, and HUC 8.
 
Biodiversity metrics:
spp richness 
ratio of native to nonnative spp richness
ratio of site richness relative to HUC 8, 10, 12 richness
ratio of cold water to warm water
percent of target fish community present

considering climate change
change in spp richness (immigrations vs extirpations)
percent addition of cold or warm water spp

Cluster fish based on cooccurrence - each cluseter is a metric of biodiversity

load libraries
```{r}

library(tidyverse)
library(sf)


```

load datafiles

Load datasets
```{r}
#watershed data
load("C:/Users/jrogers/Documents/necascFreshwaterBio/model_datafiles/fish_event_huc_join.RData")
load(file = "C:/Users/jrogers/Documents/necascFreshwaterBio/model_datafiles/fish_event_flowline_join.RData")


#fish data
load(file =  "C:/Users/jrogers/Documents/necascFreshwaterBio/model_datafiles/fish_occurrence.RData")
load(file =  "C:/Users/jrogers/Documents/necascFreshwaterBio/model_datafiles/fish_count_with_zeros.RData")
load(file =  "C:/Users/jrogers/Documents/necascFreshwaterBio/spp_data/tidydata/all_fish_size.RData")

#load new england state data
states <- st_read("C:/Users/jrogers/Documents/necascFreshwaterBio/SpatialData/newenglandshape/NEWENGLAND_POLY.shp")

#watershed data
huc8 <- st_read("C:/Users/jrogers/Documents/necascFreshwaterBio/SpatialData/NHDplus/WBDHU8/WBDHU8_NE.shp")
huc10 <- st_read("C:/Users/jrogers/Documents/necascFreshwaterBio/SpatialData/NHDplus/WBDHU10/WBDHU10_NE.shp")
huc12 <- st_read("C:/Users/jrogers/Documents/necascFreshwaterBio/SpatialData/NHDplus/WBDHU12/WBDHU12_NE.shp")
flowline <- st_read("C:/Users/jrogers/Documents/necascFreshwaterBio/SpatialData/NHDplus/NHDflowline/NHDflowline_NE.shp")


```

calcuate the number of repeat surveys at a particular NHD flowline, and each HUC size
```{r}

dat <- fish_event_flowline_join %>%
  data.frame() %>% 
  group_by(NHDPlusID) %>% 
  summarise(count = length(unique(year)))

length(unique(fish_event_flowline_join$NHDPlusID))
hist(dat$count[dat$count>1])

nrow(dat[dat$count>10,])
nrow(dat[dat$count>5,])
nrow(dat[dat$count>1,])

dat <- fish_event_huc_join %>% 
  data.frame() %>% 
  group_by(huc12_name) %>% 
  summarise(count = length(unique(year)))

length(unique(fish_event_huc_join$huc12_tnmid))
hist(dat$count[dat$count>1])

nrow(dat[dat$count>10,])
nrow(dat[dat$count>5,])
nrow(dat[dat$count>1,])

```


plots of presence and absence
plots of counts
```{r}
head(fish_occurrence)

#load fish data
shp <- st_read("C:/Users/jrogers/Documents/necascFreshwaterBio/SpatialData/sppdata/all_fish_presence.shp")
#remove NA names
shp <- shp %>% 
  filter(watrbdy == "lotic") %>% #remove the lentic sites
  select(UID) %>% 
  unique()



####Presence absence:



pres <- left_join(shp, fish_occurrence, by = "UID") %>% 
  filter(!is.na(occurrence))


table(pres$common_name)

for( i in 1:length(unique(pres$common_name))){
  
  ggplot()+
    geom_sf(data = states)+
    geom_sf(data = pres[pres$common_name== unique(pres$common_name)[i], ], 
            aes(color = as.factor(occurrence)))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank())+
    ggtitle(label = unique(pres$common_name)[i])+
    labs(color = "Occurrence")
  
  ggsave(
    filename = paste("tmpfigures/fish_occ_with_zero/", unique(pres$common_name)[i], ".png", sep = ""),
    plot = last_plot(),
    width = 14,
    height = 9,
    units = "cm",
    dpi = 100
  )
  
  print(i)
  
}


#### Counts:



counts <- left_join(shp, fish_count_with_zeros, by = "UID") %>% 
  filter(!is.na(count))

counts$occurrence <- as.factor(ifelse(counts$count>0, 1, 0))


table(counts$common_name)

for( i in 1:length(unique(counts$common_name))){
  
  ggplot()+
    geom_sf(data = states)+
    geom_sf(data = counts[counts$common_name== unique(counts$common_name)[i], ],
            pch = 21,
            aes(size = count, fill = occurrence))+
    scale_fill_manual(values =c("1" = "aquamarine", "0" = "black"))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank())+
    ggtitle(label = unique(counts$common_name)[i])+
    labs(size = "Count", fill = "Occurrence")
  
  ggsave(
    filename = paste("tmpfigures/fish_count_with_zero/", unique(counts$common_name)[i], ".png", sep = ""),
    plot = last_plot(),
    width = 14,
    height = 9,
    units = "cm",
    dpi = 150
  )
  
  print(i)
  
}


```

Calculate spp richness at each scale

```{r}

#remove absence data
fish_occurrence <- fish_occurrence %>% 
  filter(occurrence == 1)




#spp richness: site scale

richness_site <- fish_occurrence %>%
  group_by(UID) %>% 
  summarise(richness_site = n())
hist(richness_site$richness_site)

#join with spatial data
dat <- left_join(shp, richness_site, by = "UID")


ggplot()+
  geom_sf(data = states)+
  geom_sf(data = dat, pch = 21, 
          aes(size = richness_site, 
              fill = richness_site,
              alpha = 0.75))+
  scale_fill_gradient2(low = "red",
  mid = "white",
  high = "blue",
  midpoint = 12)+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank())+
    labs(title = "species richness, site scale",
    size = "richness", fill = "richness")

 ggsave(
    filename = "tmpfigures/spprichness_site_scale.png",
    plot = last_plot(),
    width = 14,
    height = 9,
    units = "cm",
    dpi = 150
  )


#spp richness: NHD Reach
 
load(file =  "C:/Users/jenrogers/Documents/necascFreshwaterBio/model_datafiles/fish_occurrence.RData")


richness_reach <- left_join(fish_occurrence, fish_event_flowline_join, by = 'UID') %>% 
  group_by(NHDPlusID) %>% 
  summarise(richness_reach = length(unique(common_name)))
  

flowline <- flowline %>% st_zm() %>% 
  filter(FType != 566 & FType != 428 & FType !=420) 
st_crs(flowline) == st_crs(states)
states <- st_transform(states, crs = st_crs(flowline))


cropped <- st_crop(flowline, st_bbox(states[states$NAME != "MAINE",]))

dat <- left_join(cropped, richness_reach, by = "NHDPlusID") 

hist(dat$richness_reach)

ggplot()+
  geom_sf(data = states[states$NAME != "MAINE",])+
  geom_sf(data = dat, 
          aes(color = richness_reach))+
  scale_color_gradient2(low = "red",
  mid = "white",
  high = "blue",
  midpoint = 12)+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank())+
    labs(title = "species richness, reach scale",
    size = "richness", color = "richness")

 ggsave(
    filename = "tmpfigures/spprichness_reach_scale.png",
    plot = last_plot(),
    width = 14,
    height = 9,
    units = "cm",
    dpi = 150
  )




#spp richness: huc12

richness_huc12 <- left_join(fish_occurrence, fish_event_huc_join, by = 'UID') %>% 
  group_by(huc12_name) %>% 
  summarise(richess_huc12 = length(unique(common_name)))
  
  

hist(richness_huc12$richess_huc12)

huc12 <- huc12 %>% 
  filter(states != "CN")

dat <- left_join(huc12, richness_huc12, by = c("name" = "huc12_name"))

hist(dat$richess_huc12)

dat$richess_huc12 <- as.numeric(dat$richess_huc12)

ggplot()+
  geom_sf(data = dat, lwd = 0.2,
          aes(fill = richess_huc12))+
  scale_fill_gradient2(low = "red",
  mid = "white",
  high = "blue",
  midpoint = 21)+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank())+
    labs(title = "species richness, huc12 scale",
    fill = "richness")+
  geom_sf(data = states, fill = NA, lwd = 0.5, color = "black")

 ggsave(
    filename = "tmpfigures/spprichness_huc12_scale.png",
    plot = last_plot(),
    width = 14,
    height = 9,
    units = "cm",
    dpi = 150
  )



#spp richness: huc10

richness_huc10 <- left_join(fish_occurrence, fish_event_huc_join, by = 'UID') %>% 
  group_by(huc10_name) %>% 
  summarise(richness_huc10 = length(unique(common_name)))
  
  
hist(richness_huc10$richness_huc10)


huc10 <- huc10 %>% 
  filter(States != "CN")

dat <- left_join(huc10, richness_huc10, by = c("Name" = "huc10_name"))

hist(dat$richness_huc10)

dat$richness_huc10 <- as.numeric(dat$richness_huc10)

ggplot()+
  geom_sf(data = dat, 
          aes(fill = richness_huc10))+
  scale_fill_gradient2(low = "red",
  mid = "white",
  high = "blue",
  midpoint = median(dat$richness_huc10, na.rm = T))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank())+
    labs(title = "species richness, huc10 scale",
    fill = "richness")+
  geom_sf(data = states, fill = NA, lwd = .5, color = "black")

 ggsave(
    filename = "tmpfigures/spprichness_huc10_scale.png",
    plot = last_plot(),
    width = 14,
    height = 9,
    units = "cm",
    dpi = 150
  )




#spp richness: huc8

richness_huc8 <- left_join(fish_occurrence, fish_event_huc_join, by = 'UID') %>% 
  group_by(huc8_name) %>% 
  summarise(richness_huc8 = length(unique(common_name)))
  
  
hist(richness_huc8$richness_huc8)

huc8 <- huc8 %>% 
  filter(states != "CN")

dat <- left_join(huc8, richness_huc8, by = c("name" = "huc8_name"))

hist(dat$richness_huc8)

dat$richness_huc8 <- as.numeric(dat$richness_huc8)

ggplot()+
  geom_sf(data = dat, 
          aes(fill = richness_huc8))+
  scale_fill_gradient2(low = "red",
  mid = "white",
  high = "blue",
  midpoint = median(dat$richness_huc8, na.rm = T))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank())+
    labs(title = "species richness, huc8 scale",
    fill = "richness")+
  geom_sf(data = states, fill = NA, lwd = .5, color = "black")

 ggsave(
    filename = "tmpfigures/spprichness_huc8_scale.png",
    plot = last_plot(),
    width = 14,
    height = 9,
    units = "cm",
    dpi = 150
  )
 
 
 
 
 
 ## spp richness, beta - alpha / gamma
 
 #want to divide the huc 12 richness by the huc 8 richness
 dat <- left_join(fish_event_huc_join, richness_huc12, by = "huc12_name")
 dat <- left_join(dat, richness_huc8, by = "huc8_name")
 dat <- dat %>% 
   data.frame() %>% 
   select(richess_huc12, richness_huc8, huc12_name) %>% 
   unique()
 dat$beta <- dat$richess_huc12/ dat$richness_huc8

 huc12 <- huc12 %>% 
  filter(states != "CN")
 
 dat <- left_join(huc12, dat, by = c("name" = "huc12_name"))

hist(dat$beta)

dat$beta <- as.numeric(dat$beta)

ggplot()+
  geom_sf(data = dat, lwd = 0.2,
          aes(fill = beta))+
  scale_fill_gradient2(low = "red",
  mid = "white",
  high = "blue",
  midpoint = mean(dat$beta, na.rm = T))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank())+
    labs(title = "beta diversity = alpha/gamma",
    fill = "diversity")+
  geom_sf(data = states, fill = NA, lwd = 0.5, color = "black")

 ggsave(
    filename = "tmpfigures/spprichness_beta.png",
    plot = last_plot(),
    width = 14,
    height = 9,
    units = "cm",
    dpi = 150
  )

```


Variation is fish length
```{r}

head(fish_size)
size <- left_join(fish_size, fish_event_huc_join, by = "UID")



huc12 <- huc12 %>% 
  filter(states != "CN")

for (i in unique(fish_size$common_name)) {

fishvar <- size %>% 
  filter(common_name == i) %>% 
  group_by(huc12_name) %>% 
  summarise(stdev = sd(length_mm, na.rm = T))

fishvar <- left_join(huc12, fishvar, by = c("name" = "huc12_name"))

ggplot()+
  geom_sf(data = fishvar, lwd= .2,
          aes(fill = stdev))+
  scale_fill_gradient2(low = "red",
                       mid = "white",
                       high = "blue",
                       midpoint = mean(fishvar$stdev, na.rm = T))+
  geom_sf(data = states, fill = NA, color = "black", lwd = 0.5)+
  labs(fill = "stdev (mm)",
       title = i)+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank())

print(i)

 ggsave(
    filename = paste("tmpfigures/fish_length_var/", i, ".png", sep = ""),
    plot = last_plot(),
    width = 14,
    height = 9,
    units = "cm",
    dpi = 200)
 
}



dat <- size %>% 
  filter(common_name == "brook trout")

ggplot(data = dat[dat$huc8_name == "West",], aes(x = huc12_name, y = length_mm))+
  geom_boxplot()+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))+
  ylim(c(10, 300))

```


investigate interannaul variability by changing the dates that are included in the map
```{r}

#spp richness: huc12

richness_huc12 <- left_join(fish_occurrence, fish_event_huc_join, by = 'UID') %>% 
  filter(year %in% 2010:2012) %>% 
  group_by(huc12_name) %>% 
  summarise(richess_huc12 = length(unique(common_name)))
  
  

hist(richness_huc12$richess_huc12)

huc12 <- huc12 %>% 
  filter(states != "ME" & states != "CN,ME" & states != "CN")

dat <- left_join(huc12, richness_huc12, by = c("name" = "huc12_name"))

hist(dat$richess_huc12)

dat$richess_huc12 <- as.numeric(dat$richess_huc12)

ggplot()+
  geom_sf(data = dat, lwd = 0.2,
          aes(fill = richess_huc12))+
  scale_fill_gradient2(low = "red",
  mid = "white",
  high = "blue",
  midpoint = 21)+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank())+
    labs(title = "species richness, huc12 scale",
    fill = "richness")+
  geom_sf(data = states[states$NAME != "MAINE",], fill = NA, lwd = 0.5, color = "black")

 ggsave(
    filename = "tmpfigures/spprichness_tmporal_scale.png",
    plot = last_plot(),
    width = 14,
    height = 9,
    units = "cm",
    dpi = 150
  )


```

Shannon Wiener and Simpsons Index
```{r}


#need to get the number of surveys in each HUC so we can divide abundance by the number of surveys
surveycounts <- left_join(fish_count_with_zeros, 
                          fish_event_huc_join, 
                          by = "UID") %>% 
   select(UID, huc12_name) %>% 
   unique() %>% 
   group_by(huc12_name) %>% 
   summarise(suveynum = n())



#### Shannon Wiener



shannon1 <- fish_count_with_zeros %>% 
  filter(count>0,
         !is.na(count),
         !is.na(common_name))

#count of each spp by huc
shannon <- left_join(fish_event_huc_join, shannon1, by = "UID") %>%
  filter(!is.na(count),
         !is.na(common_name)) %>% 
  group_by(huc12_name, common_name) %>% 
  summarise(n = sum(count)) %>% 
  data.frame()

shannon <- left_join(shannon, surveycounts, by = "huc12_name") %>% 
  mutate(n1 = n/suveynum)

#Total sum of all counts of all spp
shannon2 <- left_join(fish_event_huc_join, shannon1, by = "UID") %>%
  filter(!is.na(count),
         !is.na(common_name)) %>% 
  group_by(huc12_name)%>% 
  summarise(N = sum(count)) %>% 
  data.frame()

shannon2 <- left_join(shannon2, surveycounts, by = "huc12_name") %>% 
  mutate(N1 = N/suveynum)

shannon3 <- left_join(shannon, shannon2, by = "huc12_name") %>% 
  mutate(tmp = n1/N1,
         tmp2 = log(tmp),
         tmp3 = tmp * tmp2) %>% 
  group_by(huc12_name) %>% 
  summarise(shannonwiener = -(sum(tmp3)))




huc12 <- huc12 %>% 
  filter(states != "CN")

dat <- left_join(huc12, shannon3, by = c("name" = "huc12_name"))

hist(dat$shannonwiener)

dat$shannonwiener <- as.numeric(dat$shannonwiener)

ggplot()+
  geom_sf(data = dat, lwd = 0.2,
          aes(fill = shannonwiener))+
  scale_fill_gradient2(low = "red",
  mid = "white",
  high = "blue",
  midpoint = mean(dat$shannonwiener, na.rm = T))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank())+
    labs(title = "Shannon Wiener (H`), huc12 scale",
    fill = "H`")+
  geom_sf(data = states, fill = NA, lwd = 0.5, color = "black")

 ggsave(
    filename = "tmpfigures/shannonwiener.png",
    plot = last_plot(),
    width = 14,
    height = 9,
    units = "cm",
    dpi = 200
  )
 
 
 #### Simpsons Index
 
 
 simpsons <- left_join(shannon, shannon2, by = "huc12_name") %>% 
  mutate(tmp = n*(n-1),
         tmp2 = N*(N-1),
         tmp3 = tmp / tmp2) %>% 
  group_by(huc12_name) %>% 
  summarise(simpsons = 1 - (sum(tmp3)))


 
 huc12 <- huc12 %>% 
  filter(states != "CN")

dat <- left_join(huc12, simpsons, by = c("name" = "huc12_name"))

hist(dat$simpsons)

 


dat$simpsons <- as.numeric(dat$simpsons)

ggplot()+
  geom_sf(data = dat, lwd = 0.2,
          aes(fill = simpsons))+
  scale_fill_gradient2(low = "red",
  mid = "white",
  high = "blue",
  midpoint = 0.5)+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank())+
    labs(title = "Simpsons, huc12 scale",
    fill = "Probability")+
  geom_sf(data = states, fill = NA, lwd = 0.5, color = "black")

 ggsave(
    filename = "tmpfigures/Simpsons.png",
    plot = last_plot(),
    width = 14,
    height = 9,
    units = "cm",
    dpi = 200
  )


```


Species exchange rates
```{r}

#Species exchange ratio

#SERr = (Simm + Sext) / Stot
#we will lump pre 2000 and post 2000 for now, 

dat <- fish_occurrence %>% 
  filter(occurrence == 1)

dat <- left_join(dat, fish_event_huc_join, by = "UID") %>% 
  mutate(timeperiod = ifelse(year <= 1999, "pre", "post")) %>% 
  select(huc12_name, common_name, timeperiod) %>% 
  unique()


#check to see how many have a pre and a post
test <- dat %>% 
  select(huc12_name, timeperiod) %>% 
  unique() %>% 
  group_by(huc12_name) %>% 
  summarise(count = n())
keep <- test$huc12_name[test$count==2] #554 out of 1405 have been sampled pre and post


dat <- dat %>% 
  filter(huc12_name %in% keep)


### now we want to calculate Simm (the total spp present in the "post" that weren't there in "pre") and Sext (the total spp present in "pre" that weren't there in "post")
post <- dat %>% 
  filter(timeperiod == "post")


pre <- dat %>% 
  filter(timeperiod == "pre")

test <- full_join(post, pre, by = c("huc12_name", "common_name"))

Simm <- test %>% 
  filter(is.na(timeperiod.y)) %>% 
  group_by(huc12_name) %>% 
  summarise(Simm = n())

Sext <- test %>% 
  filter(is.na(timeperiod.x)) %>% 
  group_by(huc12_name) %>% 
  summarise(Sext = n())

Stot <- dat %>% 
  select(huc12_name, common_name) %>% 
  unique() %>% 
  group_by(huc12_name) %>% 
  summarise(Stot = n())

final <- left_join(Stot, Sext, by = "huc12_name")
final <- left_join(final, Simm, by = "huc12_name") 
final$Sext[is.na(final$Sext)] <- 0
final$Simm[is.na(final$Simm)] <- 0

final <- final %>% 
  mutate(SER = (Simm + Sext) / Stot)





 huc12 <- huc12 %>% 
  filter(states != "CN")

dat <- left_join(huc12, final, by = c("name" = "huc12_name"))

hist(dat$SER)

 


dat$SER <- as.numeric(dat$SER)

ggplot()+
  geom_sf(data = dat, lwd = 0.2,
          aes(fill = SER))+
  scale_fill_gradient2(low = "red",
  mid = "white",
  high = "blue",
  midpoint = 0.5)+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank())+
    labs(title = "Species Exchange Ratio, huc12 scale",
    fill = "SER")+
  geom_sf(data = states, fill = NA, lwd = 0.5, color = "black")

 ggsave(
    filename = "tmpfigures/SER.png",
    plot = last_plot(),
    width = 14,
    height = 9,
    units = "cm",
    dpi = 200
  )






# abundance weighted similarly, SERa
#p1 = proportional abundance at time 1
#p2 = proportional abundance at time 2

#SERa = sum(P1 - P2)^2 / sum(p1^2) + sum(p2^2) - sum(p1*p2)
 
 
#need to get the number of surveys in each HUC so we can divide abundance by the number of surveys
surveycounts <- left_join(fish_count_with_zeros, fish_event_huc_join, by = "UID") %>% 
   mutate(timeperiod = ifelse(year<=1999, "pre", "post")) %>% 
   select(UID, huc12_name, timeperiod) %>% 
   unique() %>% 
   group_by(huc12_name, timeperiod) %>% 
   summarise(suveynum = n())


dat <- left_join(fish_count_with_zeros, fish_event_huc_join, by = "UID") %>%  
  filter(count>0,
         !is.na(count),
         !is.na(common_name)) %>% 
  select(huc12_name, count, common_name, year) %>% 
  mutate(timeperiod = ifelse(year<=1999, "pre", "post"))

dat <- left_join(dat, surveycounts, by= c("huc12_name", "timeperiod")) %>% 
  mutate(count_new = count / suveynum)

#check to see how many have a pre and a post
test <- dat %>% 
  select(huc12_name, timeperiod) %>% 
  unique() %>% 
  group_by(huc12_name) %>% 
  summarise(count = n())
keep <- test$huc12_name[test$count==2] #550 out of 1402 have been sampled pre and post


dat <- dat %>% 
  filter(huc12_name %in% keep)



#time 1 (before 1999), pre

#count of each spp by huc
dat2 <-  dat %>%
  filter(timeperiod == "pre",
         !is.na(count_new),
         !is.na(common_name)) %>% 
  group_by(huc12_name, common_name) %>% 
  summarise(n1 = sum(count_new)) %>% 
  data.frame()

#Total sum of all counts of all spp
dat3 <- dat %>%
  filter(timeperiod == "pre",
         !is.na(count_new),
         !is.na(common_name)) %>% 
  group_by(huc12_name)%>% 
  summarise(N1 = sum(count_new)) %>% 
  data.frame()

propabund1 <- left_join(dat2, dat3, by = "huc12_name") %>% 
  mutate(P1 = n1/N1)







#time 2 (>= 2000), post

#count of each spp by huc
dat2 <-  dat %>%
  filter(timeperiod == "post",
         !is.na(count_new),
         !is.na(common_name)) %>% 
  group_by(huc12_name, common_name) %>% 
  summarise(n2 = sum(count_new)) %>% 
  data.frame()

#Total sum of all counts of all spp
dat3 <- dat %>%
  filter(timeperiod == "post",
         !is.na(count_new),
         !is.na(common_name)) %>% 
  group_by(huc12_name)%>% 
  summarise(N2 = sum(count_new)) %>% 
  data.frame()

propabund2 <- left_join(dat2, dat3, by = "huc12_name") %>% 
  mutate(P2 = n2/N2)

SERa <- full_join(propabund1, propabund2, by = c("huc12_name", "common_name"))

SERa$P1[is.na(SERa$P1)] <- 0
SERa$P2[is.na(SERa$P2)] <- 0


SERa <- SERa %>% 
  group_by(huc12_name, common_name) %>% 
  mutate(num = (P1 - P2)^2,
         denom1 = P1^2,
         denom2 = P2^2,
         denom3 = P1*P2) %>% 
  ungroup() %>% 
  group_by(huc12_name) %>% 
  summarise(SERa = (sum(num)) / ((sum(denom1) + sum(denom2) - sum(denom3))))


#SERa = sum(P1 - P2)^2 / sum(p1^2) + sum(p2^2) - sum(p1*p2)




dat <- left_join(huc12, SERa, by = c("name" = "huc12_name"))


 


dat$SERa <- as.numeric(dat$SERa)

ggplot()+
  geom_sf(data = dat, lwd = 0.2,
          aes(fill = SERa))+
  scale_fill_gradient2(low = "red",
  mid = "white",
  high = "blue",
  midpoint = 0.5)+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank())+
    labs(title = "Species Abundance Ratio, huc12 scale",
    fill = "SERa")+
  geom_sf(data = states, fill = NA, lwd = 0.5, color = "black")

 ggsave(
    filename = "tmpfigures/SERa.png",
    plot = last_plot(),
    width = 14,
    height = 9,
    units = "cm",
    dpi = 200
  )

 
 

```





Biodiversity metrics using thermal attributes and traits vs spp names
```{r}
library(readxl)

traits <- read_xlsx("C:/Users/jrogers/Documents/necascFreshwaterBio/spp_data/ThermalPreferences.xlsx")
traits <- traits %>% 
  select(common_name, `Temperatures Notes`) %>% 
  rename(tmp = `Temperatures Notes`)

table(traits$tmp)


#first lets do cold richness, warm richness, and ratio of warm to cold richness



#spp richness - ie number of cold, warm and cool spp: huc12

test <- left_join(fish_occurrence, traits, by = "common_name") %>% 
  filter(occurrence == 1)

richness_huc12 <- left_join(test, fish_event_huc_join, by = 'UID') %>% 
  select(UID, common_name, tmp, huc12_name) %>% 
  unique() %>% 
  filter(!is.na(tmp)) %>% 
  group_by(huc12_name) %>% 
  summarise(rch_huc12 = length(unique(common_name)),
            cd_rch_huc12 = length(unique(common_name[tmp %in% c("cold")])),
            cl_rch_huc12 = length(unique(common_name[tmp %in% c("cool")])),
            w_rch_huc12 = length(unique(common_name[tmp %in% c("warm")])),
            e_rch_huc12 = length(unique(common_name[tmp %in% c("eurythermal")]))) %>% 
  mutate(pct_cd = cd_rch_huc12 / rch_huc12, #percent cold
         pct_w = w_rch_huc12 / rch_huc12) #percent warm
  
  


huc12 <- huc12 %>% 
  filter(states != "CN")

dat <- left_join(huc12, richness_huc12, by = c("name" = "huc12_name"))


hist(richness_huc12$pct_cd)
hist(richness_huc12$pct_w)

dat$pct_cd <- as.numeric(dat$pct_cd)

#plot of percent cold speceies
ggplot()+
  geom_sf(data = dat, lwd = 0.2,
          aes(fill = pct_cd))+
  scale_fill_gradient2(low = "red",
  mid = "white",
  high = "blue",
  midpoint = .4)+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank())+
    labs(title = "pct cold richness",
    fill = "richness")+
  geom_sf(data = states, fill = NA, lwd = 0.5, color = "black")

 ggsave(
    filename = "tmpfigures/spprichness_pct_cold_huc12_scale.png",
    plot = last_plot(),
    width = 14,
    height = 9,
    units = "cm",
    dpi = 150
  )


#plot of percent warm species
 
 ggplot()+
  geom_sf(data = dat, lwd = 0.2,
          aes(fill = pct_w))+
  scale_fill_gradient2(low = "blue",
  mid = "white",
  high = "red",
  midpoint = .4)+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank())+
    labs(title = "pct warm richness",
    fill = "richness")+
  geom_sf(data = states, fill = NA, lwd = 0.5, color = "black")

 ggsave(
    filename = "tmpfigures/spprichness_pct_warm_huc12_scale.png",
    plot = last_plot(),
    width = 14,
    height = 9,
    units = "cm",
    dpi = 150
  )


# exchange rates:
# ratio of the number of cold spp to the number of warm spp in time one and then time 2.  
 
 
 #spp richness: huc12

test <- left_join(fish_occurrence, traits, by = "common_name") %>% 
  filter(occurrence == 1)

richness_huc12 <- left_join(test, fish_event_huc_join, by = 'UID') %>% 
  select(UID, year, common_name, tmp, huc12_name) %>% 
  unique() %>% 
  filter(!is.na(tmp)) %>% 
  mutate(timeperiod = ifelse(year <= 1999, "pre", "post")) %>% 
  group_by(huc12_name, timeperiod) %>% 
  summarise(rch_huc12 = length(unique(common_name)),
            cd_rch_huc12 = length(unique(common_name[tmp %in% c("cold")])),
            cl_rch_huc12 = length(unique(common_name[tmp %in% c("cool")])),
            w_rch_huc12 = length(unique(common_name[tmp %in% c("warm")])),
            e_rch_huc12 = length(unique(common_name[tmp %in% c("eurythermal")]))) %>% 
  mutate(pct_cd = cd_rch_huc12 / rch_huc12,
         pct_w = w_rch_huc12 / rch_huc12,
         diff_pct_cd_w = pct_cd - pct_w) # postitive number means greater percent were cold, 1 means all cold, -1 means all warm


#check to see how many have a pre and a post
test <- richness_huc12 %>% 
  select(huc12_name, timeperiod) %>% 
  unique() %>% 
  group_by(huc12_name) %>% 
  summarise(count = n())
keep <- test$huc12_name[test$count==2] #554 out of 1405 have been sampled pre and post


richness_huc12 <- richness_huc12 %>% 
  filter(huc12_name %in% keep) %>% 
  select(huc12_name, timeperiod, diff_pct_cd_w) %>% 
  pivot_wider(names_from = timeperiod, values_from = diff_pct_cd_w) %>%  
  mutate(chng = post - pre) #negative number means the percent cold is decreasing. it doesnt necessarily mean cold spp are leaving, it could mean warm spp are coming.

  
  


huc12 <- huc12 %>% 
  filter(states != "CN")

dat <- left_join(huc12, richness_huc12, by = c("name" = "huc12_name"))


hist(richness_huc12$chng)


dat$chng <- as.numeric(dat$chng)

ggplot()+
  geom_sf(data = dat, lwd = 0.2,
          aes(fill = chng))+
  scale_fill_gradient2(low = "red",
  mid = "white",
  high = "blue",
  midpoint = 0)+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank())+
    labs(title = "pct change",
    fill = "richness")+
  geom_sf(data = states, fill = NA, lwd = 0.5, color = "black")

 ggsave(
    filename = "tmpfigures/spprichness_chng_huc12_scale.png",
    plot = last_plot(),
    width = 14,
    height = 9,
    units = "cm",
    dpi = 150
  )

 
 

 #proportional abundance of cold, cool and warm spp pre and post.
 #for these calculations, we divided by the total count by the number of survey conducted in the time period in that huc.
 
 
 #need to get the number of surveys in each HUC so we can divide abundance by the number of surveys
 surveycounts <- left_join(fish_count_with_zeros, fish_event_huc_join, by = "UID") %>% 
   mutate(timeperiod = ifelse(year<=1999, "pre", "post")) %>% 
   select(UID, huc12_name, timeperiod) %>% 
   unique() %>% 
   group_by(huc12_name, timeperiod) %>% 
   summarise(suveynum = n())
 
 
 # abundance 
  dat <- left_join(fish_count_with_zeros, fish_event_huc_join, by = "UID") %>%  
  filter(count>0,
         !is.na(count),
         !is.na(common_name)) %>% 
  select(huc12_name, count, common_name, year) %>% 
  mutate(timeperiod = ifelse(year<=1999, "pre", "post"))
 
 dat <- left_join(dat, traits, by  = "common_name") %>% 
   filter(!is.na(tmp))

#check to see how many have a pre and a post
test <- dat %>% 
  select(huc12_name, timeperiod) %>% 
  unique() %>% 
  group_by(huc12_name) %>% 
  summarise(count = n())
keep <- test$huc12_name[test$count==2] #550 out of 1401 have been sampled pre and post


dat <- dat %>% 
  filter(huc12_name %in% keep)



#count of each spp by huc
dat2 <-  dat %>%
  filter(!is.na(count),
         !is.na(common_name)) %>% 
  group_by(huc12_name, timeperiod, tmp) %>% 
  summarise(n1 = sum(count)) %>% 
  data.frame()

dat2 <- left_join(dat2, surveycounts, by = c("huc12_name", "timeperiod")) %>% 
  mutate(count_new = n1 / suveynum)

#Total sum of all counts of all spp
dat3 <- dat %>%
  filter(!is.na(count),
         !is.na(common_name)) %>% 
  group_by(huc12_name, timeperiod)%>% 
  summarise(N1 = sum(count)) %>% 
  data.frame()

dat3 <- left_join(dat3, surveycounts, by = c("huc12_name", "timeperiod")) %>% 
  mutate(Tot_count_new = N1 / suveynum)

propabund1 <- left_join(dat2, dat3, by = c("huc12_name", "timeperiod")) %>% 
  mutate(P1 = count_new/Tot_count_new)




#For the hucs and times that had zero of a certain temperature spp, we want to the add those in as 0
#make a dataframe that has each HUC repeated for each timeperiod and temp preference (8 total rows per huc12)
huc12_name <- unique(propabund1$huc12_name)
tmp <- unique(propabund1$tmp)
timeperiod <- c(rep("pre", times = 4), rep("post", times = 4))
absence <- data.frame('huc12_name' = rep(huc12_name, each = 8))
absence$timeperiod <-  rep(timeperiod, times = nrow(absence)/8)
absence$tmp <- rep(tmp, times = nrow(absence)/8)

#keep only rows in the absence list that are not in the propabund1
keep <- anti_join(absence, propabund1, by = c("huc12_name", "tmp", "timeperiod"))

#add presence absence information
keep$P1 <- 0

propabund1 <- propabund1 %>% 
  select(names(keep))


#bind the presence and absence columns together
propabund1 <- rbind(propabund1, keep)
propabund1 <- propabund1 %>% 
  arrange(huc12_name, timeperiod)




huc12 <- huc12 %>% 
  filter(states != "CN")

dat <- left_join(huc12, propabund1, by = c("name" = "huc12_name"))


#pre 1999 COLD
ggplot()+
  geom_sf(data = dat[dat$timeperiod == "pre" & dat$tmp == "cold",], lwd = 0.2,
          aes(fill = P1))+
  scale_fill_gradient2(low = "red",
  mid = "white",
  high = "blue",
  midpoint = .5)+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank())+
    labs(title = "cold proportional abundance, pre 1999",
    fill = "proabund")+
  geom_sf(data = states, fill = NA, lwd = 0.5, color = "black")

 ggsave(
    filename = "tmpfigures/pro_abun_pre_1999.png",
    plot = last_plot(),
    width = 14,
    height = 9,
    units = "cm",
    dpi = 150
  )
 
 #post 1999 COLD
ggplot()+
  geom_sf(data = dat[dat$timeperiod == "post" & dat$tmp == "cold",], lwd = 0.2,
          aes(fill = P1))+
  scale_fill_gradient2(low = "red",
  mid = "white",
  high = "blue",
  midpoint = .5)+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank())+
    labs(title = "cold proportional abundance, 2000 on",
    fill = "proabund")+
  geom_sf(data = states, fill = NA, lwd = 0.5, color = "black")

 ggsave(
    filename = "tmpfigures/pro_abun_post_2000.png",
    plot = last_plot(),
    width = 14,
    height = 9,
    units = "cm",
    dpi = 150
  )
 
 
 
 
 
 #pre 1999 WARM
ggplot()+
  geom_sf(data = dat[dat$timeperiod == "pre" & dat$tmp == "warm",], lwd = 0.2,
          aes(fill = P1))+
  scale_fill_gradient2(low = "red",
  mid = "white",
  high = "blue",
  midpoint = .5)+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank())+
    labs(title = "warm proportional abundance, pre 1999",
    fill = "proabund")+
  geom_sf(data = states, fill = NA, lwd = 0.5, color = "black")

 ggsave(
    filename = "tmpfigures/warm_pro_abun_pre_1999.png",
    plot = last_plot(),
    width = 14,
    height = 9,
    units = "cm",
    dpi = 150
  )
 
 #post 1999 WARM
ggplot()+
  geom_sf(data = dat[dat$timeperiod == "post" & dat$tmp == "warm",], lwd = 0.2,
          aes(fill = P1))+
  scale_fill_gradient2(low = "red",
  mid = "white",
  high = "blue",
  midpoint = .5)+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank())+
    labs(title = "warm proportional abundance, 2000 on",
    fill = "proabund")+
  geom_sf(data = states, fill = NA, lwd = 0.5, color = "black")

 ggsave(
    filename = "tmpfigures/warm_pro_abun_post_2000.png",
    plot = last_plot(),
    width = 14,
    height = 9,
    units = "cm",
    dpi = 150
  )

```


Correlation matrices
```{r}
library(corrplot)

load(file =  "C:/Users/jenrogers/Documents/necascFreshwaterBio/model_datafiles/fish_count_with_zeros.RData")


dat <- fish_count_with_zeros %>%  
  filter(!is.na(reach_length_m)) %>%
  mutate(reach_length_m = reach_length_m+1, #some reach lengths were 0 - I assume this means they just did a grab sample in one location.. but I need to check
         abundance = count/reach_length_m) %>% 
  select(UID, common_name, abundance) %>% 
  pivot_wider(names_from = common_name, values_from = abundance) %>% 
  column_to_rownames(var = "UID")
  
#check the total abundance in each sample
range(apply(dat, 1, sum), na.rm = T)

#convert the abundance into relative abundance, so that the total abundance always adds up to 1
dat <- decostand(dat, method = "total")
range(apply(dat, 1, sum), na.rm = T)

test <- round(cor(dat),3)


png(height = 10, width = 15, file = "tmpfigures/fishcorplot.png", units = "in", res = 150, type = "cairo")

corrplot(test, type = "upper", order = "hclust")

dev.off()





load(file =  "C:/Users/jenrogers/Documents/necascFreshwaterBio/model_datafiles/fish_occurrence.RData")


dat <- fish_occurrence %>%
  select(UID, common_name, occurrence) %>% 
  pivot_wider(names_from = common_name, values_from = occurrence) %>% 
  column_to_rownames(var = "UID")
  
#check the total abundance in each sample
range(apply(dat, 1, sum), na.rm = T)

#convert the abundance into relative abundance, so that the total abundance always adds up to 1
dat <- decostand(dat, method = "total")
range(apply(dat, 1, sum), na.rm = T)

test <- round(cor(dat),3)


png(height = 10, width = 15, file = "tmpfigures/fishcorplot_occ.png", units = "in", res = 150, type = "cairo")

corrplot(test, type = "upper", order = "hclust")

dev.off()




#corr plot at huc12 scale

dat <- left_join(fish_occurrence, fish_event_huc_join, by = 'UID') %>%
  select(common_name, occurrence, huc12_name) %>% 
  group_by(huc12_name, common_name) %>% 
  summarize(occurrence = max(occurrence)) %>% 
  filter(!is.na(huc12_name)) %>% 
  pivot_wider(names_from = common_name, values_from = occurrence) %>% 
  column_to_rownames(var = "huc12_name")

#check the total abundance in each sample
range(apply(dat, 1, sum), na.rm = T)

#convert the abundance into relative abundance, so that the total abundance always adds up to 1
dat <- decostand(dat, method = "total")
range(apply(dat, 1, sum), na.rm = T)

test <- round(cor(dat),3)

png(height = 10, width = 15, file = "tmpfigures/fishcorplot_huc12.png", units = "in", res = 150, type = "cairo")

corrplot(test, type = "upper", order = "hclust")

dev.off()

```

Cluster spp based on co - occurrence 
```{r}
library(data.table)


########################################

#cluster based on the occurrence of other species lumping all basins and stream orders

########################################



load(file =  "C:/Users/jenrogers/Documents/necascFreshwaterBio/model_datafiles/fish_occurrence.RData")


dat <- fish_occurrence %>%
  select(UID, common_name, occurrence) %>%
  pivot_wider(names_from = common_name, values_from = occurrence) %>% 
  column_to_rownames(var = "UID")

test <- t(dat)
colnames(test) <- rownames(dat)

dist_mat <- dist(test, method = "binary")

hclust_avg <- hclust(dist_mat, method = "average")
hclust_avg$labels<- names(dat)

png(height = 10, width = 15, file = "tmpfigures/fishhclust.png", units = "in", res = 150, type = "cairo")

plot(hclust_avg)
dev.off()






#####################################

#cluster based on the occurrence of other species for each HUC8, lumping all stream orders within each HUC 8

#####################################



load(file =  "C:/Users/jenrogers/Documents/necascFreshwaterBio/model_datafiles/fish_occurrence.RData")

  
tmp <- left_join(fish_occurrence, fish_event_huc_join, by = "UID") 

for (i in unique(fish_event_huc_join$huc8_name)) {

dat <- tmp %>% 
  filter(huc8_name == i)
#remove spp that are never present
keep <- dat %>% 
  group_by(common_name) %>% 
  summarise(occ = sum(occurrence)) %>% 
  filter(occ > 0)


dat <- dat %>%
  filter(common_name %in% keep$common_name ) %>%  
  select(UID, common_name, occurrence) %>% 
  pivot_wider(names_from = common_name, values_from = occurrence) %>% 
  column_to_rownames(var = "UID")

test <- t(dat)
colnames(test) <- rownames(dat)

dist_mat <- dist(test, method = "binary")

hclust_avg <- hclust(dist_mat, method = "average")
hclust_avg$labels<- names(dat)

png(height = 10, width = 15, file = paste("tmpfigures/fish_clusters/", i, ".png", sep = ""), units = "in", res = 150, type = "cairo")

plot(hclust_avg)
dev.off()

print(i)

}






#########################################

#cluster based on the occurrence of other species for each HUC8 and for groups of stream orders within each huc 8

#stream order groups: 
#first and second order
#third and forth order
#5th order and higher

##########################################



load(file =  "C:/Users/jenrogers/Documents/necascFreshwaterBio/model_datafiles/fish_occurrence.RData")

tmp1 <- left_join(fish_occurrence, fish_event_flowline_join, by = "UID") %>% 
  filter(StreamOrde %in% c(1,2)) %>% 
  select(names(fish_occurrence))

tmp2 <- left_join(fish_occurrence, fish_event_flowline_join, by = "UID") %>% 
  filter(StreamOrde %in% c(3,4))%>% 
  select(names(fish_occurrence))

tmp3 <- left_join(fish_occurrence, fish_event_flowline_join, by = "UID") %>% 
  filter(StreamOrde > 4)%>% 
  select(names(fish_occurrence))

  


tmp <- left_join(tmp1, fish_event_huc_join, by = "UID") %>% 
  filter(!is.na(huc8_name))

for (i in unique(tmp$huc8_name)) {

dat <- tmp %>% 
  filter(huc8_name == i)
#remove spp that are never presenct
keep <- dat %>% 
  group_by(common_name) %>% 
  summarise(occ = sum(occurrence)) %>% 
  filter(occ > 0)


dat <- dat %>%
  filter(common_name %in% keep$common_name ) %>%  
  select(UID, common_name, occurrence) %>% 
  pivot_wider(names_from = common_name, values_from = occurrence) %>% 
  column_to_rownames(var = "UID")

test <- t(dat)
colnames(test) <- rownames(dat)

dist_mat <- dist(test, method = "binary")

hclust_avg <- hclust(dist_mat, method = "average")
hclust_avg$labels<- names(dat)

png(height = 10, width = 15, file = paste("tmpfigures/fish_clusters_1order/", i, ".png", sep = ""), units = "in", res = 150, type = "cairo")

plot(hclust_avg, main = paste(i, "1st and 2nd order streams", sep = ","))
dev.off()

print(i)

}



tmp <- left_join(tmp2, fish_event_huc_join, by = "UID") %>% 
  filter(!is.na(huc8_name))

for (i in unique(tmp$huc8_name)) {

dat <- tmp %>% 
  filter(huc8_name == i)
#remove spp that are never presenct
keep <- dat %>% 
  group_by(common_name) %>% 
  summarise(occ = sum(occurrence)) %>% 
  filter(occ > 0)


dat <- dat %>%
  filter(common_name %in% keep$common_name ) %>%  
  select(UID, common_name, occurrence) %>% 
  pivot_wider(names_from = common_name, values_from = occurrence) %>% 
  column_to_rownames(var = "UID")

test <- t(dat)
colnames(test) <- rownames(dat)

dist_mat <- dist(test, method = "binary")

hclust_avg <- hclust(dist_mat, method = "average")
hclust_avg$labels<- names(dat)

png(height = 10, width = 15, file = paste("tmpfigures/fish_clusters_3order/", i, ".png", sep = ""), units = "in", res = 150, type = "cairo")

plot(hclust_avg, main = paste(i, "3rd and 4th order streams", sep = ","))

dev.off()

print(i)

}




tmp <- left_join(tmp3, fish_event_huc_join, by = "UID") %>% 
  filter(!is.na(huc8_name))

for (i in unique(tmp$huc8_name)) {

dat <- tmp %>% 
  filter(huc8_name == i)
#remove spp that are never presenct
keep <- dat %>% 
  group_by(common_name) %>% 
  summarise(occ = sum(occurrence)) %>% 
  filter(occ > 0)


dat <- dat %>%
  filter(common_name %in% keep$common_name ) %>%  
  select(UID, common_name, occurrence) %>% 
  pivot_wider(names_from = common_name, values_from = occurrence) %>% 
  column_to_rownames(var = "UID")

test <- t(dat)
colnames(test) <- rownames(dat)

dist_mat <- dist(test, method = "binary")

hclust_avg <- hclust(dist_mat, method = "average")
hclust_avg$labels<- names(dat)

png(height = 10, width = 15, file = paste("tmpfigures/fish_clusters_5order/", i, ".png", sep = ""), units = "in", res = 150, type = "cairo")

plot(hclust_avg, main = paste(i, "5th and higher order streams", sep = ", "))
dev.off()

print(i)

}


```

