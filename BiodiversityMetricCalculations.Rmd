---
title: "BiodiversityMetric"
author: "Jenny Rogers"
date: '2022-05-20'
output: html_document
---

In this file, we calucate different biodiversity metrics at 5 scales, the survey site, stream reach, HUC 12, HUC 10, and HUC 8.
 
Biodiversity metrics:
spp richness 
ratio of native to nonnative spp richness
ratio of site richness relative to HUC 8, 10, 12 richness
ratio of cold water to warm water
percent of target fish community present

considering climate change
change in spp richness (immigrations vs extirpations)
percent addition of cold or warm water spp

Cluster fish based on cooccurrence - each cluseter is a metric of biodiversity

load libraries

```{r}

library(tidyverse)
library(sf)


```

load datafiles

```{r}
#watershed data
load("C:/Users/jenrogers/Documents/necascFreshwaterBio/model_datafiles/fish_event_huc_join.RData")
load(file = "C:/Users/jenrogers/Documents/necascFreshwaterBio/model_datafiles/fish_event_flowline_join.RData")


#fish data
load(file =  "C:/Users/jenrogers/Documents/necascFreshwaterBio/model_datafiles/fish_occurrence.RData")
load(file =  "C:/Users/jenrogers/Documents/necascFreshwaterBio/model_datafiles/fish_count_with_zeros.RData")
load(file =  "C:/Users/jenrogers/Documents/necascFreshwaterBio/spp_data/tidydata/all_fish_size.RData")

#load new englad state data
states <- st_read("C:/Users/jenrogers/Documents/necascFreshwaterBio/SpatialData/newenglandshape/NEWENGLAND_POLY.shp")

#watershed data
huc8 <- st_read("C:/Users/jenrogers/Documents/necascFreshwaterBio/SpatialData/NHDplus/WBDHU8/WBDHU8_NE.shp")
huc10 <- st_read("C:/Users/jenrogers/Documents/necascFreshwaterBio/SpatialData/NHDplus/WBDHU10/WBDHU10_NE.shp")
huc12 <- st_read("C:/Users/jenrogers/Documents/necascFreshwaterBio/SpatialData/NHDplus/WBDHU12/WBDHU12_NE.shp")
flowline <- st_read("C:/Users/jenrogers/Documents/necascFreshwaterBio/SpatialData/NHDplus/NHDflowline/NHDflowline_NE.shp")


```

calcuate the number of repeat surveys at a particular NHD flowline, and each HUC size
```{r}

dat <- fish_event_flowline_join %>%
  data.frame() %>% 
  group_by(NHDPlusID) %>% 
  summarise(count = length(unique(year)))

length(unique(fish_event_flowline_join$NHDPlusID))
hist(dat$count[dat$count>1])

nrow(dat[dat$count>10,])
nrow(dat[dat$count>5,])
nrow(dat[dat$count>1,])

dat <- fish_event_huc_join %>% 
  data.frame() %>% 
  group_by(huc12_name) %>% 
  summarise(count = length(unique(year)))

length(unique(fish_event_huc_join$huc12_tnmid))
hist(dat$count[dat$count>1])

nrow(dat[dat$count>10,])
nrow(dat[dat$count>5,])
nrow(dat[dat$count>1,])

```


plots of presence and absence
plots of counts
```{r}
head(fish_occurrence)

#load fish data
shp <- st_read("C:/Users/jenrogers/Documents/necascFreshwaterBio/SpatialData/sppdata/all_fish_count.shp")
#remove NA names
shp <- shp %>% 
  filter(!is.na(cmmn_nm),
         watrbdy == "lotic") %>% #remove the lentic sites
  select(UID) %>% 
  unique()



####Presence absence:



counts <- left_join(shp, fish_occurrence, by = "UID") %>% 
  filter(!is.na(occurrence))


table(counts$common_name)

for( i in 1:length(unique(counts$common_name))){
  
  ggplot()+
    geom_sf(data = states[states$NAME != "MAINE",])+
    geom_sf(data = counts[counts$common_name== unique(counts$common_name)[i], ], 
            aes(color = as.factor(occurrence)))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank())+
    ggtitle(label = unique(counts$common_name)[i])+
    labs(color = "Occurrence")
  
  ggsave(
    filename = paste("tmpfigures/fish_occ_with_zero/", unique(counts$common_name)[i], ".png", sep = ""),
    plot = last_plot(),
    width = 14,
    height = 9,
    units = "cm",
    dpi = 100
  )
  
  print(i)
  
}


#### Counts:



counts <- left_join(shp, fish_count_with_zeros, by = "UID") %>% 
  filter(!is.na(count))

counts$occurrence <- as.factor(ifelse(counts$count>0, 1, 0))


table(counts$common_name)

for( i in 1:length(unique(counts$common_name))){
  
  ggplot()+
    geom_sf(data = states[states$NAME != "MAINE",])+
    geom_sf(data = counts[counts$common_name== unique(counts$common_name)[i], ],
            pch = 21,
            aes(size = count, fill = occurrence))+
    scale_fill_manual(values =c("1" = "aquamarine", "0" = "black"))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank())+
    ggtitle(label = unique(counts$common_name)[i])+
    labs(size = "Count", fill = "Occurrence")
  
  ggsave(
    filename = paste("tmpfigures/fish_count_with_zero/", unique(counts$common_name)[i], ".png", sep = ""),
    plot = last_plot(),
    width = 14,
    height = 9,
    units = "cm",
    dpi = 150
  )
  
  print(i)
  
}


```

Calculate spp richness at each scale

```{r}

#remove absence data
fish_occurrence <- fish_occurrence %>% 
  filter(occurrence == 1)




#spp richness: site scale

richness_site <- fish_occurrence %>%
  group_by(UID) %>% 
  summarise(richness_site = n())
hist(richness_site$richness_site)

#join with spatial data
dat <- left_join(shp, richness_site, by = "UID")


ggplot()+
  geom_sf(data = states[states$NAME != "MAINE",])+
  geom_sf(data = dat, pch = 21, 
          aes(size = richness_site, 
              fill = richness_site,
              alpha = 0.75))+
  scale_fill_gradient2(low = "red",
  mid = "white",
  high = "blue",
  midpoint = 12)+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank())+
    labs(title = "species richness, site scale",
    size = "richness", fill = "richness")

 ggsave(
    filename = "tmpfigures/spprichness_site_scale.png",
    plot = last_plot(),
    width = 14,
    height = 9,
    units = "cm",
    dpi = 150
  )


#spp richness: NHD Reach
 
load(file =  "C:/Users/jenrogers/Documents/necascFreshwaterBio/model_datafiles/fish_occurrence.RData")


richness_reach <- left_join(fish_occurrence, fish_event_flowline_join, by = 'UID') %>% 
  group_by(NHDPlusID) %>% 
  summarise(richness_reach = length(unique(common_name)))
  

flowline <- flowline %>% st_zm() %>% 
  filter(FType != 566 & FType != 428 & FType !=420) 
st_crs(flowline) == st_crs(states)
states <- st_transform(states, crs = st_crs(flowline))


cropped <- st_crop(flowline, st_bbox(states[states$NAME != "MAINE",]))

dat <- left_join(cropped, richness_reach, by = "NHDPlusID") 

hist(dat$richness_reach)

ggplot()+
  geom_sf(data = states[states$NAME != "MAINE",])+
  geom_sf(data = dat, 
          aes(color = richness_reach))+
  scale_color_gradient2(low = "red",
  mid = "white",
  high = "blue",
  midpoint = 12)+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank())+
    labs(title = "species richness, reach scale",
    size = "richness", color = "richness")

 ggsave(
    filename = "tmpfigures/spprichness_reach_scale.png",
    plot = last_plot(),
    width = 14,
    height = 9,
    units = "cm",
    dpi = 150
  )




#spp richness: huc12

richness_huc12 <- left_join(fish_occurrence, fish_event_huc_join, by = 'UID') %>% 
  group_by(huc12_name) %>% 
  summarise(richess_huc12 = length(unique(common_name)))
  
  

hist(richness_huc12$richess_huc12)

huc12 <- huc12 %>% 
  filter(states != "ME" & states != "CN,ME" & states != "CN")

dat <- left_join(huc12, richness_huc12, by = c("name" = "huc12_name"))

hist(dat$richess_huc12)

dat$richess_huc12 <- as.numeric(dat$richess_huc12)

ggplot()+
  geom_sf(data = dat, lwd = 0.2,
          aes(fill = richess_huc12))+
  scale_fill_gradient2(low = "red",
  mid = "white",
  high = "blue",
  midpoint = 21)+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank())+
    labs(title = "species richness, huc12 scale",
    fill = "richness")+
  geom_sf(data = states[states$NAME != "MAINE",], fill = NA, lwd = 0.5, color = "black")

 ggsave(
    filename = "tmpfigures/spprichness_huc12_scale.png",
    plot = last_plot(),
    width = 14,
    height = 9,
    units = "cm",
    dpi = 150
  )



#spp richness: huc10

richness_huc10 <- left_join(fish_occurrence, fish_event_huc_join, by = 'UID') %>% 
  group_by(huc10_name) %>% 
  summarise(richness_huc10 = length(unique(common_name)))
  
  
hist(richness_huc10$richness_huc10)


huc10 <- huc10 %>% 
  filter(States != "ME" & States != "CN,ME" & States != "CN")

dat <- left_join(huc10, richness_huc10, by = c("Name" = "huc10_name"))

hist(dat$richness_huc10)

dat$richness_huc10 <- as.numeric(dat$richness_huc10)

ggplot()+
  geom_sf(data = dat, 
          aes(fill = richness_huc10))+
  scale_fill_gradient2(low = "red",
  mid = "white",
  high = "blue",
  midpoint = median(dat$richness_huc10, na.rm = T))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank())+
    labs(title = "species richness, huc10 scale",
    fill = "richness")+
  geom_sf(data = states[states$NAME != "MAINE",], fill = NA, lwd = .5, color = "black")

 ggsave(
    filename = "tmpfigures/spprichness_huc10_scale.png",
    plot = last_plot(),
    width = 14,
    height = 9,
    units = "cm",
    dpi = 150
  )




#spp richness: huc8

richness_huc8 <- left_join(fish_occurrence, fish_event_huc_join, by = 'UID') %>% 
  group_by(huc8_name) %>% 
  summarise(richness_huc8 = length(unique(common_name)))
  
  
hist(richness_huc8$richness_huc8)

huc8 <- huc8 %>% 
  filter(states != "ME" & states != "CN,ME" & states != "CN" & states != "ME,CN")

dat <- left_join(huc8, richness_huc8, by = c("name" = "huc8_name"))

hist(dat$richness_huc8)

dat$richness_huc8 <- as.numeric(dat$richness_huc8)

ggplot()+
  geom_sf(data = dat, 
          aes(fill = richness_huc8))+
  scale_fill_gradient2(low = "red",
  mid = "white",
  high = "blue",
  midpoint = median(dat$richness_huc8, na.rm = T))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank())+
    labs(title = "species richness, huc8 scale",
    fill = "richness")+
  geom_sf(data = states[states$NAME != "MAINE",], fill = NA, lwd = .5, color = "black")

 ggsave(
    filename = "tmpfigures/spprichness_huc8_scale.png",
    plot = last_plot(),
    width = 14,
    height = 9,
    units = "cm",
    dpi = 150
  )
 
 
 
 
 
 ## spp richness, beta - alpha / gamma
 
 #want to divide the huc 12 richness by the huc 8 richness
 dat <- left_join(fish_event_huc_join, richness_huc12, by = "huc12_name")
 dat <- left_join(dat, richness_huc8, by = "huc8_name")
 dat <- dat %>% 
   data.frame() %>% 
   select(richess_huc12, richness_huc8, huc12_name) %>% 
   unique()
 dat$beta <- dat$richess_huc12/ dat$richness_huc8

 huc12 <- huc12 %>% 
  filter(states != "ME" & states != "CN,ME" & states != "CN")
 
 dat <- left_join(huc12, dat, by = c("name" = "huc12_name"))

hist(dat$beta)

dat$beta <- as.numeric(dat$beta)

ggplot()+
  geom_sf(data = dat, lwd = 0.2,
          aes(fill = beta))+
  scale_fill_gradient2(low = "red",
  mid = "white",
  high = "blue",
  midpoint = mean(dat$beta, na.rm = T))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank())+
    labs(title = "beta diversity = alpha/gamma",
    fill = "diversity")+
  geom_sf(data = states[states$NAME != "MAINE",], fill = NA, lwd = 0.5, color = "black")

 ggsave(
    filename = "tmpfigures/spprichness_beta.png",
    plot = last_plot(),
    width = 14,
    height = 9,
    units = "cm",
    dpi = 150
  )

```


Variation is fish length
```{r}

head(fish_size)
size <- left_join(fish_size, fish_event_huc_join, by = "UID")



huc12 <- huc12 %>% 
  filter(states != "ME" & states != "CN,ME" & states != "CN")

for (i in unique(fish_size$common_name)) {

fishvar <- size %>% 
  filter(common_name == i) %>% 
  group_by(huc12_name) %>% 
  summarise(stdev = sd(length_mm, na.rm = T))

fishvar <- left_join(huc12, fishvar, by = c("name" = "huc12_name"))

ggplot()+
  geom_sf(data = fishvar, lwd= .2,
          aes(fill = stdev))+
  scale_fill_gradient2(low = "red",
                       mid = "white",
                       high = "blue",
                       midpoint = mean(fishvar$stdev, na.rm = T))+
  geom_sf(data = states[states$NAME != "MAINE",], fill = NA, color = "black", lwd = 0.5)+
  labs(fill = "stdev (mm)",
       title = i)+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank())

print(i)

 ggsave(
    filename = paste("tmpfigures/fish_length_var/", i, ".png", sep = ""),
    plot = last_plot(),
    width = 14,
    height = 9,
    units = "cm",
    dpi = 200)
 
}



dat <- size %>% 
  filter(common_name == "brook trout")

ggplot(data = dat[dat$huc8_name == "West",], aes(x = huc12_name, y = length_mm))+
  geom_boxplot()+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))+
  ylim(c(10, 300))

```


investigate interannaul variability by changing the dates that are included in the map
```{r}

#spp richness: huc12

richness_huc12 <- left_join(fish_occurrence, fish_event_huc_join, by = 'UID') %>% 
  filter(year %in% 2010:2012) %>% 
  group_by(huc12_name) %>% 
  summarise(richess_huc12 = length(unique(common_name)))
  
  

hist(richness_huc12$richess_huc12)

huc12 <- huc12 %>% 
  filter(states != "ME" & states != "CN,ME" & states != "CN")

dat <- left_join(huc12, richness_huc12, by = c("name" = "huc12_name"))

hist(dat$richess_huc12)

dat$richess_huc12 <- as.numeric(dat$richess_huc12)

ggplot()+
  geom_sf(data = dat, lwd = 0.2,
          aes(fill = richess_huc12))+
  scale_fill_gradient2(low = "red",
  mid = "white",
  high = "blue",
  midpoint = 21)+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank())+
    labs(title = "species richness, huc12 scale",
    fill = "richness")+
  geom_sf(data = states[states$NAME != "MAINE",], fill = NA, lwd = 0.5, color = "black")

 ggsave(
    filename = "tmpfigures/spprichness_tmporal_scale.png",
    plot = last_plot(),
    width = 14,
    height = 9,
    units = "cm",
    dpi = 150
  )


```


Correlation matrices
```{r}
library(corrplot)

load(file =  "C:/Users/jenrogers/Documents/necascFreshwaterBio/model_datafiles/fish_count_with_zeros.RData")


dat <- fish_count_with_zeros %>%  
  filter(!is.na(reach_length_m)) %>%
  mutate(reach_length_m = reach_length_m+1, #some reach lengths were 0 - I assume this means they just did a grab sample in one location.. but I need to check
         abundance = count/reach_length_m) %>% 
  select(UID, common_name, abundance) %>% 
  pivot_wider(names_from = common_name, values_from = abundance) %>% 
  column_to_rownames(var = "UID")
  
#check the total abundance in each sample
range(apply(dat, 1, sum), na.rm = T)

#convert the abundance into relative abundance, so that the total abundance always adds up to 1
dat <- decostand(dat, method = "total")
range(apply(dat, 1, sum), na.rm = T)

test <- round(cor(dat),3)


png(height = 10, width = 15, file = "tmpfigures/fishcorplot.png", units = "in", res = 150, type = "cairo")

corrplot(test, type = "upper", order = "hclust")

dev.off()





load(file =  "C:/Users/jenrogers/Documents/necascFreshwaterBio/model_datafiles/fish_occurrence.RData")


dat <- fish_occurrence %>%
  select(UID, common_name, occurrence) %>% 
  pivot_wider(names_from = common_name, values_from = occurrence) %>% 
  column_to_rownames(var = "UID")
  
#check the total abundance in each sample
range(apply(dat, 1, sum), na.rm = T)

#convert the abundance into relative abundance, so that the total abundance always adds up to 1
dat <- decostand(dat, method = "total")
range(apply(dat, 1, sum), na.rm = T)

test <- round(cor(dat),3)


png(height = 10, width = 15, file = "tmpfigures/fishcorplot_occ.png", units = "in", res = 150, type = "cairo")

corrplot(test, type = "upper", order = "hclust")

dev.off()




#corr plot at huc12 scale

dat <- left_join(fish_occurrence, fish_event_huc_join, by = 'UID') %>%
  select(common_name, occurrence, huc12_name) %>% 
  group_by(huc12_name, common_name) %>% 
  summarize(occurrence = max(occurrence)) %>% 
  filter(!is.na(huc12_name)) %>% 
  pivot_wider(names_from = common_name, values_from = occurrence) %>% 
  column_to_rownames(var = "huc12_name")

#check the total abundance in each sample
range(apply(dat, 1, sum), na.rm = T)

#convert the abundance into relative abundance, so that the total abundance always adds up to 1
dat <- decostand(dat, method = "total")
range(apply(dat, 1, sum), na.rm = T)

test <- round(cor(dat),3)

png(height = 10, width = 15, file = "tmpfigures/fishcorplot_huc12.png", units = "in", res = 150, type = "cairo")

corrplot(test, type = "upper", order = "hclust")

dev.off()

```

Cluster spp based on co - occurrence 
```{r}
library(data.table)


########################################

#cluster based on the occurrence of other species lumping all basins and stream orders

########################################



load(file =  "C:/Users/jenrogers/Documents/necascFreshwaterBio/model_datafiles/fish_occurrence.RData")


dat <- fish_occurrence %>%
  select(UID, common_name, occurrence) %>%
  pivot_wider(names_from = common_name, values_from = occurrence) %>% 
  column_to_rownames(var = "UID")

test <- t(dat)
colnames(test) <- rownames(dat)

dist_mat <- dist(test, method = "binary")

hclust_avg <- hclust(dist_mat, method = "average")
hclust_avg$labels<- names(dat)

png(height = 10, width = 15, file = "tmpfigures/fishhclust.png", units = "in", res = 150, type = "cairo")

plot(hclust_avg)
dev.off()






#####################################

#cluster based on the occurrence of other species for each HUC8, lumping all stream orders within each HUC 8

#####################################



load(file =  "C:/Users/jenrogers/Documents/necascFreshwaterBio/model_datafiles/fish_occurrence.RData")

  
tmp <- left_join(fish_occurrence, fish_event_huc_join, by = "UID") 

for (i in unique(fish_event_huc_join$huc8_name)) {

dat <- tmp %>% 
  filter(huc8_name == i)
#remove spp that are never present
keep <- dat %>% 
  group_by(common_name) %>% 
  summarise(occ = sum(occurrence)) %>% 
  filter(occ > 0)


dat <- dat %>%
  filter(common_name %in% keep$common_name ) %>%  
  select(UID, common_name, occurrence) %>% 
  pivot_wider(names_from = common_name, values_from = occurrence) %>% 
  column_to_rownames(var = "UID")

test <- t(dat)
colnames(test) <- rownames(dat)

dist_mat <- dist(test, method = "binary")

hclust_avg <- hclust(dist_mat, method = "average")
hclust_avg$labels<- names(dat)

png(height = 10, width = 15, file = paste("tmpfigures/fish_clusters/", i, ".png", sep = ""), units = "in", res = 150, type = "cairo")

plot(hclust_avg)
dev.off()

print(i)

}






#########################################

#cluster based on the occurrence of other species for each HUC8 and for groups of stream orders within each huc 8

#stream order groups: 
#first and second order
#third and forth order
#5th order and higher

##########################################



load(file =  "C:/Users/jenrogers/Documents/necascFreshwaterBio/model_datafiles/fish_occurrence.RData")

tmp1 <- left_join(fish_occurrence, fish_event_flowline_join, by = "UID") %>% 
  filter(StreamOrde %in% c(1,2)) %>% 
  select(names(fish_occurrence))

tmp2 <- left_join(fish_occurrence, fish_event_flowline_join, by = "UID") %>% 
  filter(StreamOrde %in% c(3,4))%>% 
  select(names(fish_occurrence))

tmp3 <- left_join(fish_occurrence, fish_event_flowline_join, by = "UID") %>% 
  filter(StreamOrde > 4)%>% 
  select(names(fish_occurrence))

  


tmp <- left_join(tmp1, fish_event_huc_join, by = "UID") %>% 
  filter(!is.na(huc8_name))

for (i in unique(tmp$huc8_name)) {

dat <- tmp %>% 
  filter(huc8_name == i)
#remove spp that are never presenct
keep <- dat %>% 
  group_by(common_name) %>% 
  summarise(occ = sum(occurrence)) %>% 
  filter(occ > 0)


dat <- dat %>%
  filter(common_name %in% keep$common_name ) %>%  
  select(UID, common_name, occurrence) %>% 
  pivot_wider(names_from = common_name, values_from = occurrence) %>% 
  column_to_rownames(var = "UID")

test <- t(dat)
colnames(test) <- rownames(dat)

dist_mat <- dist(test, method = "binary")

hclust_avg <- hclust(dist_mat, method = "average")
hclust_avg$labels<- names(dat)

png(height = 10, width = 15, file = paste("tmpfigures/fish_clusters_1order/", i, ".png", sep = ""), units = "in", res = 150, type = "cairo")

plot(hclust_avg, main = paste(i, "1st and 2nd order streams", sep = ","))
dev.off()

print(i)

}



tmp <- left_join(tmp2, fish_event_huc_join, by = "UID") %>% 
  filter(!is.na(huc8_name))

for (i in unique(tmp$huc8_name)) {

dat <- tmp %>% 
  filter(huc8_name == i)
#remove spp that are never presenct
keep <- dat %>% 
  group_by(common_name) %>% 
  summarise(occ = sum(occurrence)) %>% 
  filter(occ > 0)


dat <- dat %>%
  filter(common_name %in% keep$common_name ) %>%  
  select(UID, common_name, occurrence) %>% 
  pivot_wider(names_from = common_name, values_from = occurrence) %>% 
  column_to_rownames(var = "UID")

test <- t(dat)
colnames(test) <- rownames(dat)

dist_mat <- dist(test, method = "binary")

hclust_avg <- hclust(dist_mat, method = "average")
hclust_avg$labels<- names(dat)

png(height = 10, width = 15, file = paste("tmpfigures/fish_clusters_3order/", i, ".png", sep = ""), units = "in", res = 150, type = "cairo")

plot(hclust_avg, main = paste(i, "3rd and 4th order streams", sep = ","))

dev.off()

print(i)

}




tmp <- left_join(tmp3, fish_event_huc_join, by = "UID") %>% 
  filter(!is.na(huc8_name))

for (i in unique(tmp$huc8_name)) {

dat <- tmp %>% 
  filter(huc8_name == i)
#remove spp that are never presenct
keep <- dat %>% 
  group_by(common_name) %>% 
  summarise(occ = sum(occurrence)) %>% 
  filter(occ > 0)


dat <- dat %>%
  filter(common_name %in% keep$common_name ) %>%  
  select(UID, common_name, occurrence) %>% 
  pivot_wider(names_from = common_name, values_from = occurrence) %>% 
  column_to_rownames(var = "UID")

test <- t(dat)
colnames(test) <- rownames(dat)

dist_mat <- dist(test, method = "binary")

hclust_avg <- hclust(dist_mat, method = "average")
hclust_avg$labels<- names(dat)

png(height = 10, width = 15, file = paste("tmpfigures/fish_clusters_5order/", i, ".png", sep = ""), units = "in", res = 150, type = "cairo")

plot(hclust_avg, main = paste(i, "5th and higher order streams", sep = ", "))
dev.off()

print(i)

}


```
