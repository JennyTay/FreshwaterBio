---
title: "Fish_and_Mussel_Biodiversity_Assessment"
author: "Jenny Rogers"
date: "2023-11-29"
output: html_document
---




Read in fish and mussel projections and trait data

```{r}
#spatial file
huc12 <- st_read("C:/Users/jenrogers/Documents/necascFreshwaterBio/SpatialData/NHDplus/WBDHU12/WBDHU12_NE.shp")


#mussel predictions

load('ProjectResults/mussel_CC2080_proboccurrence.RData')
load('ProjectResults/mussel_baseline_proboccurrence.RData')
load('ProjectResults/mussel_CC2080_landcover_mgmt_proboccurrence.RData')
load('ProjectResults/mussel_CC2080_connectivity_mgmt_proboccurrence.RData')
load('ProjectResults/mussel_CC2080_forest_proboccurrence.RData')
load('ProjectResults/mussel_CC2080_wetland_proboccurrence.RData')

#fish predictions

load('ProjectResults/fish_cc_proboccurrence.RData')
load('ProjectResults/fish_baseline_proboccurrence.RData')
load('ProjectResults/fish_mg_cnt_proboccurrence.RData')
load('ProjectResults/fish_mg_proboccurrence.RData')
load('ProjectResults/fish_forest_proboccurrence.RData')
load('ProjectResults/fish_wetland_proboccurrence.RData')


#fish traits
load("C:/Users/jenrogers/Documents/necascFreshwaterBio/model_datafiles/fish_traits.RData")
temperature <- read_xlsx("C:/Users/jenrogers/Documents/necascFreshwaterBio/spp_data/thermalpref_origin_tolerance.xlsx",
                  sheet = 1,
                  range = cell_cols("A:G")) %>% 
  pivot_longer(2:7, names_to = "state", values_to = "tmp") %>% 
  filter(!is.na(tmp),
         !tmp == "eury",
         !(common_name %in% c("american brook lamprey") & tmp == "cold"),
         !(common_name %in% c("common shiner", "white sucker", "smallmouth bass", "fallfish") & tmp == "warm")) %>% 
  select(-state) %>% 
  unique()

origin <- read_xlsx("C:/Users/jenrogers/Documents/necascFreshwaterBio/spp_data/thermalpref_origin_tolerance.xlsx",
                  sheet = 2,
                  range = cell_cols("A:G"))%>% 
  pivot_longer(2:7, names_to = "state", values_to = "origin") %>% 
  filter(!is.na(origin),
         !(common_name == "spottail shiner" & origin == "introduced"),
         !origin == "unk") %>% 
  select(-state) %>%  
  unique()



#mussel traits
mussel_traits <- read_xlsx("C:/Users/jenrogers/Documents/necascFreshwaterBio/spp_data/mussel_traits.xlsx",
                           range = cell_cols("A:J")) %>% 
  filter(!is.na(common_name)) 
names(mussel_traits) <- c("common_name", "scientific_name", "status", "host", "size", "strat", "rank", "shell", "habitat", "brood")

mussel_traits_print <- mussel_traits %>%
  select(common_name, scientific_name, size, shell, status, rank, host, strat, habitat) %>%
  arrange(size, shell, status, rank, host, strat, habitat) %>%
  mutate(common_name = str_to_title(common_name))
write.csv(mussel_traits_print, "tmpfigures/paper2/musselgroups.csv")


#Fish clusters _bytemperature and _bystreamflow
cluster_temp <- read.csv("tmpfigures/fishclusters_bytemperature.csv")
cluster_temp <- cluster_temp %>% 
  select(-1) %>% 
  rename(cluster_TP = final.cluster)

cluster_flow <- read.csv("tmpfigures/fishclusters_bystreamflow.csv")
cluster_flow <- cluster_flow %>% 
  select(-1) %>% 
  rename(cluster_SF = final.cluster)


```



Describe fish biodiversity
```{r}


#Baseline

fish_baseline_proboccurrence_huc12$common_name <- gsub(pattern = ".rds", replacement = "", x = fish_baseline_proboccurrence_huc12$common_name)
fish_baseline_proboccurrence_huc12$common_name <- gsub(pattern = "pres_", replacement = "", x = fish_baseline_proboccurrence_huc12$common_name)
fish_baseline_proboccurrence_huc12$common_name <- gsub(pattern = "\\.", replacement = " ", x = fish_baseline_proboccurrence_huc12$common_name)

#set all values less than 0.01 to be 0.01 to keep ratios reasonable
fish_baseline_proboccurrence_huc12$mean_prob_occ[fish_baseline_proboccurrence_huc12$mean_prob_occ<0.01] <- 0.01

#1)	Total summed probabilities of native species divided by the total summed probabilities of introduced species.

df_origin_baseline <- fish_baseline_proboccurrence_huc12 %>% 
  left_join(origin, by = "common_name") %>%
  filter(!is.na(origin)) %>% 
  group_by(huc12_name, huc12_tnmid, origin) %>% 
  summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
  pivot_wider(names_from = origin, values_from = total_summed_prob) %>% 
  mutate(origin_ratio = native/introduced)

shp_origin <- left_join(huc12, df_origin_baseline, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  mutate(taxa = "fish",
         scenario = "baseline",
         grp = "origin")

a <- ggplot(data = shp_origin)+
  geom_sf(aes(fill = origin_ratio), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = 14,
                       limits = c(1,27))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 7),
        legend.title = element_text(size = 10),
        legend.position = c(0.78, 0.21),
        legend.key.size = unit(.25, "cm"))+
    ggtitle(label = "A. Native : Introduced")+
  labs(fill = "Ratio")

summary(shp_origin$origin_ratio)  
  



#2)	Total summed probabilities of fluvial specialist and fluvial dependent species divided by the total summed probabilities of macrohabitat generalist species.
df_habitat_baseline <- fish_baseline_proboccurrence_huc12 %>% 
  left_join(final_traits, by = "common_name") %>%  
  filter(!is.na(tolerance)) %>%
  select(-c("strategy", "timing", "velocity")) %>% 
  group_by(huc12_name, huc12_tnmid, tolerance) %>% 
  summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
  pivot_wider(names_from = tolerance, values_from = total_summed_prob) %>% 
  mutate(habitat_ratio = (`fluvial specialist` + `fluvial dependent`) / generalist)

shp_habitat <- left_join(huc12, df_habitat_baseline, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  mutate(taxa = "fish",
         scenario = "baseline",
         grp = "habitat")

b <- ggplot(data = shp_habitat)+
  geom_sf(aes(fill = habitat_ratio), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = 7.5,
                       limits = c(0,15))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 7),
        legend.title = element_text(size = 10),
        legend.position = c(0.78, 0.21),
        legend.key.size = unit(.25, "cm"))+
    ggtitle(label = "B. FS + FD : MG")+
  labs(fill = "Ratio")




#3)	Total summed probabilities of cold-water species divided by the total summed probabilities of warm-water species.
df_temp_baseline <- fish_baseline_proboccurrence_huc12 %>% 
  left_join(temperature, by = "common_name") %>%
  filter(!is.na(tmp)) %>% 
  group_by(huc12_name, huc12_tnmid, tmp) %>% 
  summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
  pivot_wider(names_from = tmp, values_from = total_summed_prob) %>% 
  mutate(ratio = (cold/warm))

shp_temp <- left_join(huc12, df_temp_baseline, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  mutate(taxa = "fish",
         scenario = "baseline",
         grp = "temp")

c <- ggplot(data = shp_temp)+
  geom_sf(aes(fill = ratio), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = 5.5,
                       limits = c(0,11.1))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 7),
        legend.title = element_text(size = 10),
        legend.position = c(0.78, 0.21),
        legend.key.size = unit(.25, "cm"))+
    ggtitle(label = "C. Cold : Warm")+
  labs(fill = "Ratio")




#4)	Total summed probabilities of temperature cluster 1
df_tempclust1_baseline <- fish_baseline_proboccurrence_huc12 %>% 
  left_join(cluster_temp, by = "common_name") %>%
  group_by(huc12_name, huc12_tnmid, cluster_TP) %>% 
  summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
  pivot_wider(names_from = cluster_TP, values_from = total_summed_prob)

shp_tempclust1 <- left_join(huc12, df_tempclust1_baseline, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  mutate(taxa = "fish",
         scenario = "baseline",
         grp = "temp")

d <- ggplot(data = shp_tempclust1)+
  geom_sf(aes(fill = `1`), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = 1.0,
                       limits = c(0,2.0))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 7),
        legend.title = element_text(size = 10),
        legend.position = c(0.78, 0.21),
        legend.key.size = unit(.25, "cm"))+
    ggtitle(label = "A. Temperature Cluster 1")+
  labs(fill = "Occ.")




#5)	Total summed probabilities of temperature cluster 5
df_tempclust5_baseline <- fish_baseline_proboccurrence_huc12 %>% 
  left_join(cluster_temp, by = "common_name") %>%
  group_by(huc12_name, huc12_tnmid, cluster_TP) %>% 
  summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
  pivot_wider(names_from = cluster_TP, values_from = total_summed_prob)

shp_tempclust5 <- left_join(huc12, df_tempclust5_baseline, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  mutate(taxa = "fish",
         scenario = "baseline",
         grp = "temp")

e <- ggplot(data = shp_tempclust5)+
  geom_sf(aes(fill = `5`), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = 1.6,
                       limits = c(0,3.2))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 7),
        legend.title = element_text(size = 10),
        legend.position = c(0.78, 0.21),
        legend.key.size = unit(.25, "cm"))+
    ggtitle(label = "B. Temperature Cluster 5")+
  labs(fill = "Occ.")


#5)	Total summed probabilities of temperature cluster 5
df_flowclust6_baseline <- fish_baseline_proboccurrence_huc12 %>% 
  left_join(cluster_flow, by = "common_name") %>%
  group_by(huc12_name, huc12_tnmid, cluster_SF) %>% 
  summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
  pivot_wider(names_from = cluster_SF, values_from = total_summed_prob)

shp_flowclust6 <- left_join(huc12, df_flowclust6_baseline, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  mutate(taxa = "fish",
         scenario = "baseline",
         grp = "flow")

f <- ggplot(data = shp_flowclust6)+
  geom_sf(aes(fill = `6`), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = 1.8,
                       limits = c(0,3.7))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 7),
        legend.title = element_text(size = 10),
        legend.position = c(0.78, 0.21),
        legend.key.size = unit(.25, "cm"))+
    ggtitle(label = "C. Streamflow Cluster 6")+
  labs(fill = "Occ.")




############################################





#Climate Change

fish_cc_proboccurrence_huc12$common_name <- gsub(pattern = ".rds", replacement = "", x = fish_cc_proboccurrence_huc12$common_name)
fish_cc_proboccurrence_huc12$common_name <- gsub(pattern = "pres_", replacement = "", x = fish_cc_proboccurrence_huc12$common_name)
fish_cc_proboccurrence_huc12$common_name <- gsub(pattern = "\\.", replacement = " ", x = fish_cc_proboccurrence_huc12$common_name)

fish_cc_proboccurrence_huc12$mean_prob_occ[fish_cc_proboccurrence_huc12$mean_prob_occ<0.01] <- 0.01

#1)	Total summed probabilities of native species divided by the total summed probabilities of introduced species.
df_origin_cc <- fish_cc_proboccurrence_huc12 %>% 
  left_join(origin, by = "common_name") %>%
  filter(!is.na(origin)) %>% 
  group_by(huc12_name, huc12_tnmid, origin) %>% 
  summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
  pivot_wider(names_from = origin, values_from = total_summed_prob) %>% 
  mutate(origin_ratio = native/introduced)

shp_origin_cc <- left_join(huc12, df_origin_cc, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  mutate(taxa = "fish",
         scenario = "cc",
         grp = "origin")

g <- ggplot(data = shp_origin_cc)+
  geom_sf(aes(fill = origin_ratio), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = 7,
                       limits = c(.99,15))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 15),
        legend.position = c(0.78, 0.21),
        legend.key.size = unit(.25, "cm"))+
    ggtitle(label = "Native:Introduced - Climate Change")+
  labs(fill = "ratio")

  
  



#2)	Total summed probabilities of fluvial specialist and fluvial dependent species divided by the total summed probabilities of macrohabitat generalist species.
df_habitat_cc <- fish_cc_proboccurrence_huc12 %>% 
  left_join(final_traits, by = "common_name") %>%  
  filter(!is.na(tolerance)) %>%
  select(-c("strategy", "timing", "velocity")) %>% 
  group_by(huc12_name, huc12_tnmid, tolerance) %>% 
  summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
  pivot_wider(names_from = tolerance, values_from = total_summed_prob) %>% 
  mutate(habitat_ratio = (`fluvial specialist` + `fluvial dependent`) / generalist)

shp_habitat_cc <- left_join(huc12, df_habitat_cc, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  mutate(taxa = "fish",
         scenario = "cc",
         grp = "habitat") 

h <- ggplot(data = shp_habitat_cc)+
  geom_sf(aes(fill = habitat_ratio), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = 4,
                       limits = c(0,8))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 15),
        legend.position = c(0.78, 0.21),
        legend.key.size = unit(.25, "cm"))+
    ggtitle(label = "FS + FD : MG - Climate Change")+
  labs(fill = "ratio")




#3)	Total summed probabilities of cold-water species divided by the total summed probabilities of warm-water species.
df_temp_cc <- fish_cc_proboccurrence_huc12 %>% 
  left_join(temperature, by = "common_name") %>%
  filter(!is.na(tmp)) %>% 
  group_by(huc12_name, huc12_tnmid, tmp) %>% 
  summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
  pivot_wider(names_from = tmp, values_from = total_summed_prob) %>% 
  mutate(ratio = cold/warm)

shp_temp_cc <- left_join(huc12, df_temp_cc, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  mutate(taxa = "fish",
         scenario = "cc",
         grp = "temp")

i <- ggplot(data = shp_temp_cc)+
  geom_sf(aes(fill = ratio), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = 3.25,
                       limits = c(0,6.5))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 15),
        legend.position = c(0.78, 0.21),
        legend.key.size = unit(.25, "cm"))+
    ggtitle(label = "Cold : Warm - Climate Change")+
  labs(fill = "ratio")




#4)	Total summed probabilities of temperature cluster 1
df_tempclust1_cc <- fish_cc_proboccurrence_huc12 %>% 
  left_join(cluster_temp, by = "common_name") %>%
  group_by(huc12_name, huc12_tnmid, cluster_TP) %>% 
  summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
  pivot_wider(names_from = cluster_TP, values_from = total_summed_prob)

shp_tempclust1_cc <- left_join(huc12, df_tempclust1_cc, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  mutate(taxa = "fish",
         scenario = "cc",
         grp = "temp")

j <- ggplot(data = shp_tempclust1_cc)+
  geom_sf(aes(fill = `1`), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = 1.5,
                       limits = c(0,3.0))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 7),
        legend.title = element_text(size = 10),
        legend.position = c(0.78, 0.21),
        legend.key.size = unit(.25, "cm"))+
    ggtitle(label = "Temperature Cluster 1 - Climate Change")+
  labs(fill = "Prob Occ")




#5)	Total summed probabilities of temperature cluster 5
df_tempclust5_cc <- fish_cc_proboccurrence_huc12 %>% 
  left_join(cluster_temp, by = "common_name") %>%
  group_by(huc12_name, huc12_tnmid, cluster_TP) %>% 
  summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
  pivot_wider(names_from = cluster_TP, values_from = total_summed_prob)

shp_tempclust5_cc <- left_join(huc12, df_tempclust5_cc, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  mutate(taxa = "fish",
         scenario = "cc",
         grp = "temp")

k <- ggplot(data = shp_tempclust5_cc)+
  geom_sf(aes(fill = `5`), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = 1.5,
                       limits = c(0,2.4))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 7),
        legend.title = element_text(size = 10),
        legend.position = c(0.78, 0.21),
        legend.key.size = unit(.25, "cm"))+
    ggtitle(label = "Temperature Cluster 5 - Climate Change")+
  labs(fill = "Prob Occ")


#6)	Total summed probabilities of streamflow cluster 6
df_flowclust6_cc <- fish_cc_proboccurrence_huc12 %>% 
  left_join(cluster_flow, by = "common_name") %>%
  group_by(huc12_name, huc12_tnmid, cluster_SF) %>% 
  summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
  pivot_wider(names_from = cluster_SF, values_from = total_summed_prob)

shp_flowclust6 <- left_join(huc12, df_flowclust6_cc, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  mutate(taxa = "fish",
         scenario = "cc",
         grp = "flow")

l <- ggplot(data = shp_flowclust6)+
  geom_sf(aes(fill = `6`), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = 1.5,
                       limits = c(0,3.0))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 7),
        legend.title = element_text(size = 10),
        legend.position = c(0.78, 0.21),
        legend.key.size = unit(.25, "cm"))+
    ggtitle(label = "Streamflow Cluster 6 - Climate Change")+
  labs(fill = "Prob Occ")





############################################





#Climate Change and landcover management (riparian resotation)

fish_mg_proboccurrence_huc12$common_name <- gsub(pattern = ".rds", replacement = "", x = fish_mg_proboccurrence_huc12$common_name)
fish_mg_proboccurrence_huc12$common_name <- gsub(pattern = "pres_", replacement = "", x = fish_mg_proboccurrence_huc12$common_name)
fish_mg_proboccurrence_huc12$common_name <- gsub(pattern = "\\.", replacement = " ", x = fish_mg_proboccurrence_huc12$common_name)

fish_mg_proboccurrence_huc12$mean_prob_occ[fish_mg_proboccurrence_huc12$mean_prob_occ<0.01] <- 0.01

#1)	Total summed probabilities of native species divided by the total summed probabilities of introduced species.
df_origin_mg <- fish_mg_proboccurrence_huc12 %>% 
  left_join(origin, by = "common_name") %>%
  filter(!is.na(origin)) %>% 
  group_by(huc12_name, huc12_tnmid, origin) %>% 
  summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
  pivot_wider(names_from = origin, values_from = total_summed_prob) %>% 
  mutate(origin_ratio = native/introduced)

shp_origin_mg <- left_join(huc12, df_origin_mg, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  mutate(taxa = "fish",
         scenario = "Riparian Restoration",
         grp = "origin")

m <- ggplot(data = shp_origin_mg)+
  geom_sf(aes(fill = origin_ratio), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = 7,
                       limits = c(.99,15))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 15))+
    ggtitle(label = "Native:Introduced - Climate Change and Riparian Restoration")+
  labs(fill = "ratio")

  
  



#2)	Total summed probabilities of fluvial specialist and fluvial dependent species divided by the total summed probabilities of macrohabitat generalist species.
df_habitat_mg <- fish_mg_proboccurrence_huc12 %>% 
  left_join(final_traits, by = "common_name") %>%  
  filter(!is.na(tolerance)) %>%
  select(-c("strategy", "timing", "velocity")) %>% 
  group_by(huc12_name, huc12_tnmid, tolerance) %>% 
  summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
  pivot_wider(names_from = tolerance, values_from = total_summed_prob) %>% 
  mutate(habitat_ratio = (`fluvial specialist` + `fluvial dependent`) / generalist)

shp_habitat_mg <- left_join(huc12, df_habitat_mg, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  mutate(taxa = "fish",
         scenario = "Riparian Restoration",
         grp = "habitat")

n <- ggplot(data = shp_habitat_mg)+
  geom_sf(aes(fill = habitat_ratio), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = 4,
                       limits = c(0,8))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 15))+
    ggtitle(label = "FS + FD : MG - Climate Change and Riparian Restoration")+
  labs(fill = "ratio")




#3)	Total summed probabilities of cold-water species divided by the total summed probabilities of warm-water species.
df_temp_mg <- fish_mg_proboccurrence_huc12 %>% 
  left_join(temperature, by = "common_name") %>%
  filter(!is.na(tmp)) %>% 
  group_by(huc12_name, huc12_tnmid, tmp) %>% 
  summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
  pivot_wider(names_from = tmp, values_from = total_summed_prob) %>% 
  mutate(ratio = cold/warm)

shp_temp_mg <- left_join(huc12, df_temp_mg, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  mutate(taxa = "fish",
         scenario = "Riparian Restoration",
         grp = "temp")

o <- ggplot(data = shp_temp_mg)+
  geom_sf(aes(fill = ratio), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = 3.25,
                       limits = c(0,6.5))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 15))+
    ggtitle(label = "Cold : Warm - Climate Change and Riparian Restoration")+
  labs(fill = "ratio")





#4)	Total summed probabilities of temperature cluster 1
df_tempclust1_mg <- fish_mg_proboccurrence_huc12 %>% 
  left_join(cluster_temp, by = "common_name") %>%
  group_by(huc12_name, huc12_tnmid, cluster_TP) %>% 
  summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
  pivot_wider(names_from = cluster_TP, values_from = total_summed_prob)

shp_tempclust1_mg <- left_join(huc12, df_tempclust1_mg, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  mutate(taxa = "fish",
         scenario = "landcover",
         grp = "temp")

p <- ggplot(data = shp_tempclust1_mg)+
  geom_sf(aes(fill = `1`), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = 1.5,
                       limits = c(0,3.0))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 7),
        legend.title = element_text(size = 10))+
    ggtitle(label = "Temperature Cluster 1 - landcover")+
  labs(fill = "Prob Occ")




#5)	Total summed probabilities of temperature cluster 5
df_tempclust5_mg <- fish_mg_proboccurrence_huc12 %>% 
  left_join(cluster_temp, by = "common_name") %>%
  group_by(huc12_name, huc12_tnmid, cluster_TP) %>% 
  summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
  pivot_wider(names_from = cluster_TP, values_from = total_summed_prob)

shp_tempclust5_mg <- left_join(huc12, df_tempclust5_mg, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  mutate(taxa = "fish",
         scenario = "landcover",
         grp = "temp")

q <- ggplot(data = shp_tempclust5_mg)+
  geom_sf(aes(fill = `5`), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = 1.5,
                       limits = c(0,2.4))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 7),
        legend.title = element_text(size = 10))+
    ggtitle(label = "Temperature Cluster 5 - landcover")+
  labs(fill = "Prob Occ")


#6)	Total summed probabilities of streamflow cluster 6
df_flowclust6_mg <- fish_cc_proboccurrence_huc12 %>% 
  left_join(cluster_flow, by = "common_name") %>%
  group_by(huc12_name, huc12_tnmid, cluster_SF) %>% 
  summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
  pivot_wider(names_from = cluster_SF, values_from = total_summed_prob)

shp_flowclust6_mg <- left_join(huc12, df_flowclust6_mg, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  mutate(taxa = "fish",
         scenario = "landcover",
         grp = "flow")

r <- ggplot(data = shp_flowclust6_mg)+
  geom_sf(aes(fill = `6`), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = 1.5,
                       limits = c(0,3.0))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 7),
        legend.title = element_text(size = 10))+
    ggtitle(label = "Streamflow Cluster 6 - landcover")+
  labs(fill = "Prob Occ")




############################################





#Climate Change and connectivity management

fish_mg_cnt_proboccurrence_huc12$common_name <- gsub(pattern = ".rds", replacement = "", x = fish_mg_cnt_proboccurrence_huc12$common_name)
fish_mg_cnt_proboccurrence_huc12$common_name <- gsub(pattern = "pres_", replacement = "", x = fish_mg_cnt_proboccurrence_huc12$common_name)
fish_mg_cnt_proboccurrence_huc12$common_name <- gsub(pattern = "\\.", replacement = " ", x = fish_mg_cnt_proboccurrence_huc12$common_name)

fish_mg_cnt_proboccurrence_huc12$mean_prob_occ[fish_mg_cnt_proboccurrence_huc12$mean_prob_occ<0.01] <- 0.01

#1)	Total summed probabilities of native species divided by the total summed probabilities of introduced species.
df_origin_mg_cnt <- fish_mg_cnt_proboccurrence_huc12 %>% 
  left_join(origin, by = "common_name") %>%
  filter(!is.na(origin)) %>% 
  group_by(huc12_name, huc12_tnmid, origin) %>% 
  summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
  pivot_wider(names_from = origin, values_from = total_summed_prob) %>% 
  mutate(origin_ratio = native/introduced)

shp_origin_mg_cnt <- left_join(huc12, df_origin_mg_cnt, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  mutate(taxa = "fish",
         scenario = "connectivity",
         grp = "origin")

s <- ggplot(data = shp_origin_mg_cnt)+
  geom_sf(aes(fill = origin_ratio), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = 7,
                       limits = c(.99,15))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 15))+
    ggtitle(label = "Native:Introduced - Climate Change and connectivity")+
  labs(fill = "ratio")

  
  



#2)	Total summed probabilities of fluvial specialist and fluvial dependent species divided by the total summed probabilities of macrohabitat generalist species.
df_habitat_mg_cnt <- fish_mg_cnt_proboccurrence_huc12 %>% 
  left_join(final_traits, by = "common_name") %>%  
  filter(!is.na(tolerance)) %>%
  select(-c("strategy", "timing", "velocity")) %>% 
  group_by(huc12_name, huc12_tnmid, tolerance) %>% 
  summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
  pivot_wider(names_from = tolerance, values_from = total_summed_prob) %>% 
  mutate(habitat_ratio = (`fluvial specialist` + `fluvial dependent`) / generalist)

shp_habitat_mg_cnt <- left_join(huc12, df_habitat_mg_cnt, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  mutate(taxa = "fish",
         scenario = "connectivity",
         grp = "habitat") 

t <- ggplot(data = shp_habitat_mg_cnt)+
  geom_sf(aes(fill = habitat_ratio), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = 4,
                       limits = c(0,8))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 15))+
    ggtitle(label = "FS + FD : MG - Climate Change and connectivity")+
  labs(fill = "ratio")




#3)	Total summed probabilities of cold-water species divided by the total summed probabilities of warm-water species.
df_temp_mg_cnt <- fish_mg_cnt_proboccurrence_huc12 %>% 
  left_join(temperature, by = "common_name") %>%
  filter(!is.na(tmp)) %>% 
  group_by(huc12_name, huc12_tnmid, tmp) %>% 
  summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
  pivot_wider(names_from = tmp, values_from = total_summed_prob) %>% 
  mutate(ratio = cold/warm)

shp_temp_mg_cnt <- left_join(huc12, df_temp_mg_cnt, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  mutate(taxa = "fish",
         scenario = "connectivity",
         grp = "temp") 

u <- ggplot(data = shp_temp_mg_cnt)+
  geom_sf(aes(fill = ratio), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = 3.25,
                       limits = c(0,6.5))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 15))+
    ggtitle(label = "Cold : Warm - Climate Change and connectivity")+
  labs(fill = "ratio")




#4)	Total summed probabilities of temperature cluster 1
df_tempclust1_mg_cnt <- fish_mg_cnt_proboccurrence_huc12 %>% 
  left_join(cluster_temp, by = "common_name") %>%
  group_by(huc12_name, huc12_tnmid, cluster_TP) %>% 
  summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
  pivot_wider(names_from = cluster_TP, values_from = total_summed_prob)

shp_tempclust1_mg_cnt <- left_join(huc12, df_tempclust1_mg_cnt, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  mutate(taxa = "fish",
         scenario = "connectivity",
         grp = "temp")

v <- ggplot(data = shp_tempclust1_mg_cnt)+
  geom_sf(aes(fill = `1`), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = 1.5,
                       limits = c(0,3.0))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 7),
        legend.title = element_text(size = 10))+
    ggtitle(label = "Temperature Cluster 1 - connectivity")+
  labs(fill = "Prob Occ")




#5)	Total summed probabilities of temperature cluster 5
df_tempclust5_mg_cnt <- fish_mg_proboccurrence_huc12 %>% 
  left_join(cluster_temp, by = "common_name") %>%
  group_by(huc12_name, huc12_tnmid, cluster_TP) %>% 
  summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
  pivot_wider(names_from = cluster_TP, values_from = total_summed_prob)

shp_tempclust5_mg_cnt <- left_join(huc12, df_tempclust5_mg_cnt, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  mutate(taxa = "fish",
         scenario = "landcover",
         grp = "temp")

w <- ggplot(data = shp_tempclust5_mg_cnt)+
  geom_sf(aes(fill = `5`), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = 1.5,
                       limits = c(0,2.4))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 7),
        legend.title = element_text(size = 10))+
    ggtitle(label = "Temperature Cluster 5 - connectivity")+
  labs(fill = "Prob Occ")


#6)	Total summed probabilities of streamflow cluster 6
df_flowclust6_mg_cnt <- fish_cc_proboccurrence_huc12 %>% 
  left_join(cluster_flow, by = "common_name") %>%
  group_by(huc12_name, huc12_tnmid, cluster_SF) %>% 
  summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
  pivot_wider(names_from = cluster_SF, values_from = total_summed_prob)

shp_flowclust6_mg_cnt <- left_join(huc12, df_flowclust6_mg_cnt, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  mutate(taxa = "fish",
         scenario = "connectivity",
         grp = "flow")

x <- ggplot(data = shp_flowclust6_mg_cnt)+
  geom_sf(aes(fill = `6`), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = 1.5,
                       limits = c(0,3.0))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 7),
        legend.title = element_text(size = 10))+
    ggtitle(label = "Streamflow Cluster 6 - connectivity")+
  labs(fill = "Prob Occ")








############################################





#Climate Change and Forest management

fish_forest_proboccurrence_huc12$common_name <- gsub(pattern = ".rds", replacement = "", x = fish_forest_proboccurrence_huc12$common_name)
fish_forest_proboccurrence_huc12$common_name <- gsub(pattern = "pres_", replacement = "", x = fish_forest_proboccurrence_huc12$common_name)
fish_forest_proboccurrence_huc12$common_name <- gsub(pattern = "\\.", replacement = " ", x = fish_forest_proboccurrence_huc12$common_name)

fish_forest_proboccurrence_huc12$mean_prob_occ[fish_forest_proboccurrence_huc12$mean_prob_occ<0.01] <- 0.01

#1)	Total summed probabilities of native species divided by the total summed probabilities of introduced species.
df_origin_forest <- fish_forest_proboccurrence_huc12 %>% 
  left_join(origin, by = "common_name") %>%
  filter(!is.na(origin)) %>% 
  group_by(huc12_name, huc12_tnmid, origin) %>% 
  summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
  pivot_wider(names_from = origin, values_from = total_summed_prob) %>% 
  mutate(origin_ratio = native/introduced)

shp_origin_forest <- left_join(huc12, df_origin_forest, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  mutate(taxa = "fish",
         scenario = "Forest",
         grp = "origin")

org_forest <- ggplot(data = shp_origin_forest)+
  geom_sf(aes(fill = origin_ratio), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = 7,
                       limits = c(1,16.3))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 15))+
    ggtitle(label = "Native:Introduced - Climate Change and Forest")+
  labs(fill = "ratio")

  
  



#2)	Total summed probabilities of fluvial specialist and fluvial dependent species divided by the total summed probabilities of macrohabitat generalist species.
df_habitat_forest <- fish_forest_proboccurrence_huc12 %>% 
  left_join(final_traits, by = "common_name") %>%  
  filter(!is.na(tolerance)) %>%
  select(-c("strategy", "timing", "velocity")) %>% 
  group_by(huc12_name, huc12_tnmid, tolerance) %>% 
  summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
  pivot_wider(names_from = tolerance, values_from = total_summed_prob) %>% 
  mutate(habitat_ratio = (`fluvial specialist` + `fluvial dependent`) / generalist)

shp_habitat_forest <- left_join(huc12, df_habitat_forest, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  mutate(taxa = "fish",
         scenario = "Forest",
         grp = "habitat") 

hab_forest <- ggplot(data = shp_habitat_forest)+
  geom_sf(aes(fill = habitat_ratio), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = 4,
                       limits = c(0,8))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 15))+
    ggtitle(label = "FS + FD : MG - Climate Change and Forest")+
  labs(fill = "ratio")




#3)	Total summed probabilities of cold-water species divided by the total summed probabilities of warm-water species.
df_temp_forest <- fish_forest_proboccurrence_huc12 %>% 
  left_join(temperature, by = "common_name") %>%
  filter(!is.na(tmp)) %>% 
  group_by(huc12_name, huc12_tnmid, tmp) %>% 
  summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
  pivot_wider(names_from = tmp, values_from = total_summed_prob) %>% 
  mutate(ratio = cold/warm)

shp_temp_forest <- left_join(huc12, df_temp_forest, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  mutate(taxa = "fish",
         scenario = "Forest",
         grp = "temp") 

temp_forest <- ggplot(data = shp_temp_forest)+
  geom_sf(aes(fill = ratio), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = 3.25,
                       limits = c(0,6))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 15))+
    ggtitle(label = "Cold : Warm - Climate Change and Forest")+
  labs(fill = "ratio")





############################################





#Climate Change and Wetland management

fish_wetland_proboccurrence_huc12$common_name <- gsub(pattern = ".rds", replacement = "", x = fish_wetland_proboccurrence_huc12$common_name)
fish_wetland_proboccurrence_huc12$common_name <- gsub(pattern = "pres_", replacement = "", x = fish_wetland_proboccurrence_huc12$common_name)
fish_wetland_proboccurrence_huc12$common_name <- gsub(pattern = "\\.", replacement = " ", x = fish_wetland_proboccurrence_huc12$common_name)

fish_wetland_proboccurrence_huc12$mean_prob_occ[fish_wetland_proboccurrence_huc12$mean_prob_occ<0.01] <- 0.01

#1)	Total summed probabilities of native species divided by the total summed probabilities of introduced species.
df_origin_wetland <- fish_wetland_proboccurrence_huc12 %>% 
  left_join(origin, by = "common_name") %>%
  filter(!is.na(origin)) %>% 
  group_by(huc12_name, huc12_tnmid, origin) %>% 
  summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
  pivot_wider(names_from = origin, values_from = total_summed_prob) %>% 
  mutate(origin_ratio = native/introduced)

shp_origin_wetland <- left_join(huc12, df_origin_wetland, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  mutate(taxa = "fish",
         scenario = "Wetland",
         grp = "origin")

org_wetland <- ggplot(data = shp_origin_wetland)+
  geom_sf(aes(fill = origin_ratio), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = 7,
                       limits = c(1,14.2))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 15))+
    ggtitle(label = "Native:Introduced - Climate Change and Wetland")+
  labs(fill = "ratio")

  
  



#2)	Total summed probabilities of fluvial specialist and fluvial dependent species divided by the total summed probabilities of macrohabitat generalist species.
df_habitat_wetland <- fish_wetland_proboccurrence_huc12 %>% 
  left_join(final_traits, by = "common_name") %>%  
  filter(!is.na(tolerance)) %>%
  select(-c("strategy", "timing", "velocity")) %>% 
  group_by(huc12_name, huc12_tnmid, tolerance) %>% 
  summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
  pivot_wider(names_from = tolerance, values_from = total_summed_prob) %>% 
  mutate(habitat_ratio = (`fluvial specialist` + `fluvial dependent`) / generalist)

shp_habitat_wetland <- left_join(huc12, df_habitat_wetland, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  mutate(taxa = "fish",
         scenario = "Wetland",
         grp = "habitat") 

hab_wetland <- ggplot(data = shp_habitat_wetland)+
  geom_sf(aes(fill = habitat_ratio), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = 4,
                       limits = c(0,7.4))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 15))+
    ggtitle(label = "FS + FD : MG - Climate Change and Wetland")+
  labs(fill = "ratio")




#3)	Total summed probabilities of cold-water species divided by the total summed probabilities of warm-water species.
df_temp_wetland <- fish_wetland_proboccurrence_huc12 %>% 
  left_join(temperature, by = "common_name") %>%
  filter(!is.na(tmp)) %>% 
  group_by(huc12_name, huc12_tnmid, tmp) %>% 
  summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
  pivot_wider(names_from = tmp, values_from = total_summed_prob) %>% 
  mutate(ratio = cold/warm)

shp_temp_wetland <- left_join(huc12, df_temp_wetland, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  mutate(taxa = "fish",
         scenario = "Wetland",
         grp = "temp") 

temp_wetland <- ggplot(data = shp_temp_wetland)+
  geom_sf(aes(fill = ratio), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = 3.25,
                       limits = c(0,6))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 15))+
    ggtitle(label = "Cold : Warm - Climate Change and Wetland")+
  labs(fill = "ratio")







#################

# Change from baseline to future
# climate change ratio - baseline ratio
# positive value means the ratio has increased and the more vulnerable group is doing well
# negative value means the ratio has decreased and the more vulnerable group is doing poorly

unique(df_origin_baseline$huc12_name == df_origin_cc$huc12_name)
df_origin_cc$origin_ratio_change <- df_origin_cc$origin_ratio - df_origin_baseline$origin_ratio
shp_origin_chng <- left_join(huc12, df_origin_cc, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid"))

y <- ggplot(data = shp_origin_chng)+
  geom_sf(aes(fill = origin_ratio_change), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "white",
                        high = "red",
                        midpoint = 0,
                       limits = c(-17,7))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 7),
        legend.title = element_text(size = 10),
        legend.position = c(0.78, 0.21),
        legend.key.size = unit(.25, "cm"))+
    ggtitle(label = "D. Native : Introduced")+
  labs(fill = "Δ")

df_habitat_cc$habitat_ratio_change <- df_habitat_cc$habitat_ratio - df_habitat_baseline$habitat_ratio
shp_habitat_chng <- left_join(huc12, df_habitat_cc, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid"))

z <- ggplot(data = shp_habitat_chng)+
  geom_sf(aes(fill = habitat_ratio_change), color = NA)+
  scale_fill_gradient2(low = "blue",
                        high = "white",
                       limits = c(-12,0))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 7),
        legend.title = element_text(size = 10),
        legend.position = c(0.78, 0.21),
        legend.key.size = unit(.25, "cm"))+
    ggtitle(label = "E. FS + FD : MG")+
  labs(fill = "Δ")

df_temp_cc$temp_ratio_change <- df_temp_cc$ratio - df_temp_baseline$ratio
shp_temp_chng <- left_join(huc12, df_temp_cc, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid"))

aa <- ggplot(data = shp_temp_chng)+
  geom_sf(aes(fill = temp_ratio_change), color = NA)+
  scale_fill_gradient2(low = "blue",
                        high = "white",
                       limits = c(-10,0))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 7),
        legend.title = element_text(size = 10),
        legend.position = c(0.78, 0.21),
        legend.key.size = unit(.25, "cm"))+
    ggtitle(label = "F. Cold : Warm")+
  labs(fill = "Δ")

df_tempclust1_cc$tempclust1_change <- df_tempclust1_cc$`1` - df_tempclust1_baseline$`1`
shp_tempclust1_chng <- left_join(huc12, df_tempclust1_cc, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid"))

bb <- ggplot(data = shp_tempclust1_chng)+
  geom_sf(aes(fill = tempclust1_change), color = NA)+
  scale_fill_gradient2(low = "blue",
                        high = "red",
                       limits = c(-0.54,1.4))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 7),
        legend.title = element_text(size = 10),
        legend.position = c(0.78, 0.21),
        legend.key.size = unit(.25, "cm"))+
    ggtitle(label = "D. Temperature Cluster 1")+
  labs(fill = "Δ")


df_tempclust5_cc$tempclust5_change <- df_tempclust5_cc$`5` - df_tempclust5_baseline$`5`
shp_tempclust5_chng <- left_join(huc12, df_tempclust5_cc, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid"))

cc <- ggplot(data = shp_tempclust5_chng)+
  geom_sf(aes(fill = tempclust5_change), color = NA)+
  scale_fill_gradient2(low = "blue",
                        high = "white",
                       limits = c(-1.4,0))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 7),
        legend.title = element_text(size = 10),
        legend.position = c(0.78, 0.21),
        legend.key.size = unit(.25, "cm"))+
    ggtitle(label = "E. Temperature Cluster 5")+
  labs(fill = "Δ")

df_flowclust6_cc$flowclust6_change <- df_flowclust6_cc$`6` - df_flowclust6_baseline$`6`
shp_flowclust6_chng <- left_join(huc12, df_flowclust6_cc, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid"))

dd <- ggplot(data = shp_flowclust6_chng)+
  geom_sf(aes(fill = flowclust6_change), color = NA)+
  scale_fill_gradient2(low = "blue",
                        high = "white",
                       limits = c(-1.5,0))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 7),
        legend.title = element_text(size = 10),
        legend.position = c(0.78, 0.21),
        legend.key.size = unit(.25, "cm"))+
    ggtitle(label = "F. Streamflow Cluster 6")+
  labs(fill = "Δ")


fig1 <- gridExtra::grid.arrange(a,b, c,  y, z, aa, nrow = 2, ncol = 3)
ggsave(fig1, file = "tmpfigures/paper2/fig1_basline_change_fish.png")

fig2 <- gridExtra::grid.arrange(d,e, f,  bb, cc, dd, nrow = 2, ncol = 3)
ggsave(fig2, file = "tmpfigures/paper2/fig2_basline_change_clusters_fish.png")




```






Describe Mussel Biodiversity

```{r}


#Baseline


head(predictions_baseline)
mussel_baseline_proboccurrence_huc12 <- predictions_baseline %>%
  data.frame() %>% 
  select(huc12_name, huc12_tnmid, 40:51) %>% 
  filter(!is.na(alewifefloater),
         !is.na(huc12_name)) %>%
  pivot_longer(3:14, names_to = "common_name", values_to = "prob_occ") %>% 
  group_by(huc12_name, huc12_tnmid, common_name) %>% 
  summarise(mean_prob_occ = mean(prob_occ)) %>% 
  ungroup() %>% 
  mutate(scenario = "baseline", taxa = "mussel")

mussel_baseline_proboccurrence_huc12$common_name <- gsub(pattern = "\\.", replacement = " ", x = mussel_baseline_proboccurrence_huc12$common_name)

mussel_baseline_proboccurrence_huc12$common_name[mussel_baseline_proboccurrence_huc12$common_name == "alewifefloater"] <- "alewife floater"
mussel_baseline_proboccurrence_huc12$common_name[mussel_baseline_proboccurrence_huc12$common_name == "easternpearlshell"] <- "eastern pearlshell"
mussel_baseline_proboccurrence_huc12$common_name[mussel_baseline_proboccurrence_huc12$common_name == "easternpondmussel"] <- "eastern pondmussel"
mussel_baseline_proboccurrence_huc12$common_name[mussel_baseline_proboccurrence_huc12$common_name == "Tidewatermucket"] <- "tidewater mucket"
mussel_baseline_proboccurrence_huc12$common_name[mussel_baseline_proboccurrence_huc12$common_name == "yellowlampmussel"] <- "yellow lampmussel"

#remove the really small mean prob occurrences so the ratios arent too high
mussel_baseline_proboccurrence_huc12$mean_prob_occ[mussel_baseline_proboccurrence_huc12$mean_prob_occ<0.01] <- 0.01

#1)	Total summed probabilities of rare species divided by the total summed probabilities of common species.
df_status_baseline <- mussel_baseline_proboccurrence_huc12 %>% 
  left_join(mussel_traits, by = "common_name") %>%
  filter(!is.na(status)) %>% 
  group_by(huc12_name, huc12_tnmid, status) %>% 
  summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
  pivot_wider(names_from = status, values_from = total_summed_prob) %>% 
  mutate(status_ratio = rare/common)

shp_status <- left_join(huc12, df_status_baseline, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  mutate(taxa = "mussel",
         scenario = "baseline",
         grp = "status") 

ee <- ggplot(data = shp_status)+
  geom_sf(aes(fill = status_ratio), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = .5,
                       limits = c(0,1.1))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 7),
        legend.title = element_text(size = 10),
        title = element_text(size = 10))+
    ggtitle(label = "A. Rare:Common")+
  labs(fill = "Ratio")

  
  



#2)	Total summed probabilities of host specialist divided by the total summed probabilities of host generalist species.
df_host_baseline <- mussel_baseline_proboccurrence_huc12 %>% 
  left_join(mussel_traits, by = "common_name") %>%  
  filter(!is.na(host)) %>%
  group_by(huc12_name, huc12_tnmid, host) %>% 
  summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
  pivot_wider(names_from = host, values_from = total_summed_prob) %>% 
  mutate(host_ratio = (specialist / generalist))

shp_host <- left_join(huc12, df_host_baseline, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  mutate(taxa = "mussel",
         scenario = "baseline",
         grp = "host")

ff <- ggplot(data = shp_host)+
  geom_sf(aes(fill = host_ratio), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = .5,
                       limits = c(0,1.02))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 7),
        legend.title = element_text(size = 0),
        title = element_text(size = 10))+
    ggtitle(label = "Host specialist : generalist")+
  labs(fill = "Ratio")




#3)	Total summed probabilities of small species divided by the total summed probabilities of large species.
df_size_baseline <- mussel_baseline_proboccurrence_huc12 %>% 
  left_join(mussel_traits, by = "common_name") %>%
  filter(!is.na(size)) %>% 
  group_by(huc12_name, huc12_tnmid, size) %>% 
  summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
  pivot_wider(names_from = size, values_from = total_summed_prob) %>% 
  mutate(ratio = (small/large))

shp_size <- left_join(huc12, df_size_baseline, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  mutate(taxa = "mussel",
         scenario = "baseline",
         grp = "size")

gg <- ggplot(data = shp_size)+
  geom_sf(aes(fill = ratio), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = 6,
                       limits = c(0,12))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 7),
        legend.title = element_text(size = 10),
        title = element_text(size = 10))+
    ggtitle(label = "B. Small:large")+
  labs(fill = "Ratio")



#4)	Total summed probabilities of equilibrium + periodic species divided by the total summed probabilities of opportunistic species.
df_strat_baseline <- mussel_baseline_proboccurrence_huc12 %>% 
  left_join(mussel_traits, by = "common_name") %>%
  filter(!is.na(strat)) %>% 
  group_by(huc12_name, huc12_tnmid, strat) %>% 
  summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
  pivot_wider(names_from = strat, values_from = total_summed_prob) %>% 
  mutate(ratio = ((equilibrium + periodic) /opportunistic))

shp_strat <- left_join(huc12, df_strat_baseline, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  mutate(taxa = "mussel",
         scenario = "baseline",
         grp = "strategy")

hh <- ggplot(data = shp_strat)+
  geom_sf(aes(fill = ratio), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = 8,
                       limits = c(0,16))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 7),
        legend.title = element_text(size = 10),
        title = element_text(size = 10))+
    ggtitle(label = "Equil : opportun")+
  labs(fill = "Ratio")




#5)	Total summed probabilities of sensitive divided by the total summed probabilities of secure species.
df_rank_baseline <- mussel_baseline_proboccurrence_huc12 %>% 
  left_join(mussel_traits, by = "common_name") %>%
  filter(!is.na(rank)) %>% 
  group_by(huc12_name, huc12_tnmid, rank) %>% 
  summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
  pivot_wider(names_from = rank, values_from = total_summed_prob) %>% 
  mutate(ratio = (sensitive /secure))

shp_rank <- left_join(huc12, df_rank_baseline, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  mutate(taxa = "mussel",
         scenario = "baseline",
         grp = "rank")

rank_baseline <- ggplot(data = shp_rank)+
  geom_sf(aes(fill = ratio), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = 1.15,
                       limits = c(0,2.31))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 7),
        legend.title = element_text(size = 10),
        title = element_text(size = 10))+
    ggtitle(label = "sensitive : secure")+
  labs(fill = "Ratio")



#6)	Total summed probabilities of thin divided by the total summed probabilities of thick species.
df_shell_baseline <- mussel_baseline_proboccurrence_huc12 %>% 
  left_join(mussel_traits, by = "common_name") %>%
  filter(!is.na(shell)) %>% 
  group_by(huc12_name, huc12_tnmid, shell) %>% 
  summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
  pivot_wider(names_from = shell, values_from = total_summed_prob) %>% 
  mutate(ratio = (thin /thick))

shp_shell <- left_join(huc12, df_shell_baseline, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  mutate(taxa = "mussel",
         scenario = "baseline",
         grp = "shell")

shell_baseline <- ggplot(data = shp_shell)+
  geom_sf(aes(fill = ratio), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = 2,
                       limits = c(0,4))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 7),
        legend.title = element_text(size = 10),
        title = element_text(size = 10))+
    ggtitle(label = "Thin : thick")+
  labs(fill = "Ratio")


#7)	Total summed probabilities of lotic divided by the total summed probabilities of generalist species.
df_musselhabitat_baseline <- mussel_baseline_proboccurrence_huc12 %>% 
  left_join(mussel_traits, by = "common_name") %>%
  filter(!is.na(habitat)) %>% 
  group_by(huc12_name, huc12_tnmid, habitat) %>% 
  summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
  pivot_wider(names_from = habitat, values_from = total_summed_prob) %>% 
  mutate(ratio = (lotic /generalist))

shp_musselhabitat <- left_join(huc12, df_musselhabitat_baseline, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  mutate(taxa = "mussel",
         scenario = "baseline",
         grp = "habitat")

musselhabitat_baseline <- ggplot(data = shp_musselhabitat)+
  geom_sf(aes(fill = ratio), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = 1.25,
                       limits = c(0,2.5))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 7),
        legend.title = element_text(size = 10),
        title = element_text(size = 10))+
    ggtitle(label = "Lotic : generalist")+
  labs(fill = "Ratio")


############################################





#Climate Change

head(prediction_cc)
mussel_cc_proboccurrence_huc12 <- prediction_cc %>%
  data.frame() %>% 
  select(huc12_name, huc12_tnmid, 44:55) %>% 
  filter(!is.na(alewifefloater),
         !is.na(huc12_name)) %>%
  pivot_longer(3:14, names_to = "common_name", values_to = "prob_occ") %>% 
  group_by(huc12_name, huc12_tnmid, common_name) %>% 
  summarise(mean_prob_occ = mean(prob_occ)) %>% 
  ungroup() %>% 
  mutate(scenario = "cc", taxa = "mussel")

mussel_cc_proboccurrence_huc12$common_name <- gsub(pattern = "\\.", replacement = " ", x = mussel_cc_proboccurrence_huc12$common_name)
mussel_cc_proboccurrence_huc12$common_name[mussel_cc_proboccurrence_huc12$common_name == "alewifefloater"] <- "alewife floater"
mussel_cc_proboccurrence_huc12$common_name[mussel_cc_proboccurrence_huc12$common_name == "easternpearlshell"] <- "eastern pearlshell"
mussel_cc_proboccurrence_huc12$common_name[mussel_cc_proboccurrence_huc12$common_name == "easternpondmussel"] <- "eastern pondmussel"
mussel_cc_proboccurrence_huc12$common_name[mussel_cc_proboccurrence_huc12$common_name == "Tidewatermucket"] <- "tidewater mucket"
mussel_cc_proboccurrence_huc12$common_name[mussel_cc_proboccurrence_huc12$common_name == "yellowlampmussel"] <- "yellow lampmussel"


mussel_cc_proboccurrence_huc12$mean_prob_occ[mussel_cc_proboccurrence_huc12$mean_prob_occ<0.01]<-0.01

#1)	Total summed probabilities of rare species divided by the total summed probabilities of common species.
df_status_cc <- mussel_cc_proboccurrence_huc12 %>% 
  left_join(mussel_traits, by = "common_name") %>%
  filter(!is.na(status)) %>% 
  group_by(huc12_name, huc12_tnmid, status) %>% 
  summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
  pivot_wider(names_from = status, values_from = total_summed_prob) %>% 
  mutate(status_ratio = rare/common)

shp_status_cc <- left_join(huc12, df_status_cc, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  mutate(taxa = "mussel",
         scenario = "cc",
         grp = "status")

ii <- ggplot(data = shp_status_cc)+
  geom_sf(aes(fill = status_ratio), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = .26,
                       limits = c(0,.52))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 15))+
    ggtitle(label = "Rare:Common - cc")+
  labs(fill = "ratio")

  
  



#2)	Total summed probabilities of host specialist divided by the total summed probabilities of host generalist species.
df_host_cc <- mussel_cc_proboccurrence_huc12 %>% 
  left_join(mussel_traits, by = "common_name") %>%  
  filter(!is.na(host)) %>%
  group_by(huc12_name, huc12_tnmid, host) %>% 
  summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
  pivot_wider(names_from = host, values_from = total_summed_prob) %>% 
  mutate(host_ratio = (specialist / generalist))

shp_host_cc <- left_join(huc12, df_host_cc, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  mutate(taxa = "mussel",
         scenario = "cc",
         grp = "host")

jj <- ggplot(data = shp_host_cc)+
  geom_sf(aes(fill = host_ratio), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = .26,
                       limits = c(0,.57))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 15))+
    ggtitle(label = "Host specialist : generalist - cc")+
  labs(fill = "ratio")



#3)	Total summed probabilities of small species divided by the total summed probabilities of large species.
df_size_cc <- mussel_cc_proboccurrence_huc12 %>% 
  left_join(mussel_traits, by = "common_name") %>%
  filter(!is.na(size)) %>% 
  group_by(huc12_name, huc12_tnmid, size) %>% 
  summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
  pivot_wider(names_from = size, values_from = total_summed_prob) %>% 
  mutate(ratio = (small/large))

shp_size_cc <- left_join(huc12, df_size_cc, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  mutate(taxa = "mussel",
         scenario = "cc",
         grp = "size")

kk <- ggplot(data = shp_size_cc)+
  geom_sf(aes(fill = ratio), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = 5,
                       limits = c(0,9))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 15))+
    ggtitle(label = "small : large - cc")+
  labs(fill = "ratio")



#4)	Total summed probabilities of equilibrium + periodic species divided by the total summed probabilities of opportunistic species.
df_strat_cc <- mussel_cc_proboccurrence_huc12 %>% 
  left_join(mussel_traits, by = "common_name") %>%
  filter(!is.na(strat)) %>% 
  group_by(huc12_name, huc12_tnmid, strat) %>% 
  summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
  pivot_wider(names_from = strat, values_from = total_summed_prob) %>% 
  mutate(ratio = ((equilibrium + periodic) /opportunistic))

shp_strat_cc <- left_join(huc12, df_strat_cc, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  mutate(taxa = "mussel",
         scenario = "cc",
         grp = "strategy")

ll <- ggplot(data = shp_strat_cc)+
  geom_sf(aes(fill = ratio), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = 5,
                       limits = c(0,8))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 15))+
    ggtitle(label = "equil : opportun - cc")+
  labs(fill = "ratio")


#5)	Total summed probabilities of sensitive species divided by the total summed probabilities of secure species.
df_rank_cc <- mussel_cc_proboccurrence_huc12 %>% 
  left_join(mussel_traits, by = "common_name") %>%
  filter(!is.na(rank)) %>% 
  group_by(huc12_name, huc12_tnmid, rank) %>% 
  summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
  pivot_wider(names_from = rank, values_from = total_summed_prob) %>% 
  mutate(ratio = (sensitive /secure))

shp_rank_cc <- left_join(huc12, df_rank_cc, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  mutate(taxa = "mussel",
         scenario = "cc",
         grp = "rank")

rank_cc <- ggplot(data = shp_rank_cc)+
  geom_sf(aes(fill = ratio), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = .5,
                       limits = c(0,1))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 15))+
    ggtitle(label = "sensitive : secure - cc")+
  labs(fill = "ratio")

#6)	Total summed probabilities of thin species divided by the total summed probabilities of thick species.
df_shell_cc <- mussel_cc_proboccurrence_huc12 %>% 
  left_join(mussel_traits, by = "common_name") %>%
  filter(!is.na(shell)) %>% 
  group_by(huc12_name, huc12_tnmid, shell) %>% 
  summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
  pivot_wider(names_from = shell, values_from = total_summed_prob) %>% 
  mutate(ratio = (thin /thick))

shp_shell_cc <- left_join(huc12, df_shell_cc, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  mutate(taxa = "mussel",
         scenario = "cc",
         grp = "shell")

shell_cc <- ggplot(data = shp_shell_cc)+
  geom_sf(aes(fill = ratio), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = 1.5,
                       limits = c(0,13))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 15))+
    ggtitle(label = "thin : thick - cc")+
  labs(fill = "ratio")


#7)	Total summed probabilities of lotic species divided by the total summed probabilities of generalist species.
df_musselhabitat_cc <- mussel_cc_proboccurrence_huc12 %>% 
  left_join(mussel_traits, by = "common_name") %>%
  filter(!is.na(habitat)) %>% 
  group_by(huc12_name, huc12_tnmid, habitat) %>% 
  summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
  pivot_wider(names_from = habitat, values_from = total_summed_prob) %>% 
  mutate(ratio = (lotic /generalist))

shp_musselhabitat_cc <- left_join(huc12, df_musselhabitat_cc, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  mutate(taxa = "mussel",
         scenario = "cc",
         grp = "habitat")

musselhabitat_cc <- ggplot(data = shp_musselhabitat_cc)+
  geom_sf(aes(fill = ratio), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = .5,
                       limits = c(0,1))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 15))+
    ggtitle(label = "lotic : generalist - cc")+
  labs(fill = "ratio")



############################################





#Climate Change and landcover mgmt

head(prediction_mg)
mussel_mg_proboccurrence_huc12 <- prediction_mg %>%
  data.frame() %>% 
  select(huc12_name, huc12_tnmid, 44:55) %>% 
  filter(!is.na(alewifefloater),
         !is.na(huc12_name)) %>%
  pivot_longer(3:14, names_to = "common_name", values_to = "prob_occ") %>% 
  group_by(huc12_name, huc12_tnmid, common_name) %>% 
  summarise(mean_prob_occ = mean(prob_occ)) %>% 
  ungroup() %>% 
  mutate(scenario = "Riparian Restoration", taxa = "mussel")

mussel_mg_proboccurrence_huc12$common_name <- gsub(pattern = "\\.", replacement = " ", x = mussel_mg_proboccurrence_huc12$common_name)
mussel_mg_proboccurrence_huc12$common_name[mussel_mg_proboccurrence_huc12$common_name == "alewifefloater"] <- "alewife floater"
mussel_mg_proboccurrence_huc12$common_name[mussel_mg_proboccurrence_huc12$common_name == "easternpearlshell"] <- "eastern pearlshell"
mussel_mg_proboccurrence_huc12$common_name[mussel_mg_proboccurrence_huc12$common_name == "easternpondmussel"] <- "eastern pondmussel"
mussel_mg_proboccurrence_huc12$common_name[mussel_mg_proboccurrence_huc12$common_name == "Tidewatermucket"] <- "tidewater mucket"
mussel_mg_proboccurrence_huc12$common_name[mussel_mg_proboccurrence_huc12$common_name == "yellowlampmussel"] <- "yellow lampmussel"


mussel_mg_proboccurrence_huc12$mean_prob_occ[mussel_mg_proboccurrence_huc12$mean_prob_occ<0.01]<-0.01

#1)	Total summed probabilities of rare species divided by the total summed probabilities of common species.
df_status_mg <- mussel_mg_proboccurrence_huc12 %>% 
  left_join(mussel_traits, by = "common_name") %>%
  filter(!is.na(status)) %>% 
  group_by(huc12_name, huc12_tnmid, status) %>% 
  summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
  pivot_wider(names_from = status, values_from = total_summed_prob) %>% 
  mutate(status_ratio = rare/common)

shp_status_mg <- left_join(huc12, df_status_mg, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  mutate(taxa = "mussel",
         scenario = "Riparian Restoration",
         grp = "status")

mm <- ggplot(data = shp_status_mg)+
  geom_sf(aes(fill = status_ratio), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = .26,
                       limits = c(0,.52))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 15))+
    ggtitle(label = "Rare:Common - Riparian Restoration")+
  labs(fill = "ratio")

  
  



#2)	Total summed probabilities of host specialist divided by the total summed probabilities of host generalist species.
df_host_mg <- mussel_mg_proboccurrence_huc12 %>% 
  left_join(mussel_traits, by = "common_name") %>%  
  filter(!is.na(host)) %>%
  group_by(huc12_name, huc12_tnmid, host) %>% 
  summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
  pivot_wider(names_from = host, values_from = total_summed_prob) %>% 
  mutate(host_ratio = (specialist / generalist))

shp_host_mg <- left_join(huc12, df_host_mg, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  mutate(taxa = "mussel",
         scenario = "Riparian Restoration",
         grp = "host")

nn <- ggplot(data = shp_host_mg)+
  geom_sf(aes(fill = host_ratio), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = .26,
                       limits = c(0,.57))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 15))+
    ggtitle(label = "Host specialist : generalist - Riparian Restoration")+
  labs(fill = "ratio")



#3)	Total summed probabilities of small species divided by the total summed probabilities of large species.
df_size_mg <- mussel_mg_proboccurrence_huc12 %>% 
  left_join(mussel_traits, by = "common_name") %>%
  filter(!is.na(size)) %>% 
  group_by(huc12_name, huc12_tnmid, size) %>% 
  summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
  pivot_wider(names_from = size, values_from = total_summed_prob) %>% 
  mutate(ratio = (small/large))

shp_size_mg <- left_join(huc12, df_size_mg, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  mutate(taxa = "mussel",
         scenario = "Riparian Restoration",
         grp = "size")

oo <- ggplot(data = shp_size_mg)+
  geom_sf(aes(fill = ratio), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = 5,
                       limits = c(0,9))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 15))+
    ggtitle(label = "small : large - Riparian Restoration")+
  labs(fill = "ratio")



#4)	Total summed probabilities of equilibrium + periodic species divided by the total summed probabilities of opportunistic species.
df_strat_mg <- mussel_mg_proboccurrence_huc12 %>% 
  left_join(mussel_traits, by = "common_name") %>%
  filter(!is.na(strat)) %>% 
  group_by(huc12_name, huc12_tnmid, strat) %>% 
  summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
  pivot_wider(names_from = strat, values_from = total_summed_prob) %>% 
  mutate(ratio = ((equilibrium + periodic) /opportunistic))

shp_strat_mg <- left_join(huc12, df_strat_mg, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  mutate(taxa = "mussel",
         scenario = "Riparian Restoration",
         grp = "strategy")

pp <- ggplot(data = shp_strat_mg)+
  geom_sf(aes(fill = ratio), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = 5,
                       limits = c(0,8))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 15))+
    ggtitle(label = "equil : opportun - Riparian Restoration")+
  labs(fill = "ratio")


#5)	Total summed probabilities of senstive species divided by the total summed probabilities of secure species.
df_rank_mg <- mussel_mg_proboccurrence_huc12 %>% 
  left_join(mussel_traits, by = "common_name") %>%
  filter(!is.na(rank)) %>% 
  group_by(huc12_name, huc12_tnmid, rank) %>% 
  summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
  pivot_wider(names_from = rank, values_from = total_summed_prob) %>% 
  mutate(ratio = (sensitive /secure))

shp_rank_mg <- left_join(huc12, df_rank_mg, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  mutate(taxa = "mussel",
         scenario = "Riparian Restoration",
         grp = "rank")

rank_mg <- ggplot(data = shp_rank_mg)+
  geom_sf(aes(fill = ratio), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = 1.6,
                       limits = c(0,3.73))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 15))+
    ggtitle(label = "sensitive : secure - Riparian Restoration")+
  labs(fill = "ratio")

#6)	Total summed probabilities of thin species divided by the total summed probabilities of thick species.
df_shell_mg <- mussel_mg_proboccurrence_huc12 %>% 
  left_join(mussel_traits, by = "common_name") %>%
  filter(!is.na(shell)) %>% 
  group_by(huc12_name, huc12_tnmid, shell) %>% 
  summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
  pivot_wider(names_from = shell, values_from = total_summed_prob) %>% 
  mutate(ratio = (thin /thick))

shp_shell_mg <- left_join(huc12, df_shell_mg, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  mutate(taxa = "mussel",
         scenario = "Riparian Restoration",
         grp = "shell")

shell_mg <- ggplot(data = shp_shell_mg)+
  geom_sf(aes(fill = ratio), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = 3.34,
                       limits = c(0,6.78))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 15))+
    ggtitle(label = "thin : thick - Riparian Restoration")+
  labs(fill = "ratio")

#7)	Total summed probabilities of lotic species divided by the total summed probabilities of generalist species.
df_musselhabitat_mg <- mussel_mg_proboccurrence_huc12 %>% 
  left_join(mussel_traits, by = "common_name") %>%
  filter(!is.na(habitat)) %>% 
  group_by(huc12_name, huc12_tnmid, habitat) %>% 
  summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
  pivot_wider(names_from = habitat, values_from = total_summed_prob) %>% 
  mutate(ratio = (lotic /generalist))

shp_musselhabitat_mg <- left_join(huc12, df_musselhabitat_mg, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  mutate(taxa = "mussel",
         scenario = "Riparian Restoration",
         grp = "habitat")

musselhabitat_mg <- ggplot(data = shp_musselhabitat_mg)+
  geom_sf(aes(fill = ratio), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = 1.25,
                       limits = c(0,2.53))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 15))+
    ggtitle(label = "lotic : generalist - Riparian Restoration")+
  labs(fill = "ratio")



############################################





#Climate Change and connectivity mgmt

head(prediction_mg_cnt)
mussel_mg_cnt_proboccurrence_huc12 <- prediction_mg_cnt %>%
  data.frame() %>% 
  select(huc12_name, huc12_tnmid, 44:55) %>% 
  filter(!is.na(alewifefloater),
         !is.na(huc12_name)) %>%
  pivot_longer(3:14, names_to = "common_name", values_to = "prob_occ") %>% 
  group_by(huc12_name, huc12_tnmid, common_name) %>% 
  summarise(mean_prob_occ = mean(prob_occ)) %>% 
  ungroup() %>% 
  mutate(scenario = "connectivity", taxa = "mussel")

mussel_mg_cnt_proboccurrence_huc12$common_name <- gsub(pattern = "\\.", replacement = " ", x = mussel_mg_cnt_proboccurrence_huc12$common_name)
mussel_mg_cnt_proboccurrence_huc12$common_name[mussel_mg_cnt_proboccurrence_huc12$common_name == "alewifefloater"] <- "alewife floater"
mussel_mg_cnt_proboccurrence_huc12$common_name[mussel_mg_cnt_proboccurrence_huc12$common_name == "easternpearlshell"] <- "eastern pearlshell"
mussel_mg_cnt_proboccurrence_huc12$common_name[mussel_mg_cnt_proboccurrence_huc12$common_name == "easternpondmussel"] <- "eastern pondmussel"
mussel_mg_cnt_proboccurrence_huc12$common_name[mussel_mg_cnt_proboccurrence_huc12$common_name == "Tidewatermucket"] <- "tidewater mucket"
mussel_mg_cnt_proboccurrence_huc12$common_name[mussel_mg_cnt_proboccurrence_huc12$common_name == "yellowlampmussel"] <- "yellow lampmussel"


mussel_mg_cnt_proboccurrence_huc12$mean_prob_occ[mussel_mg_cnt_proboccurrence_huc12$mean_prob_occ<0.01]<-0.01

#1)	Total summed probabilities of rare species divided by the total summed probabilities of common species.
df_status_mg_cnt <- mussel_mg_cnt_proboccurrence_huc12 %>% 
  left_join(mussel_traits, by = "common_name") %>%
  filter(!is.na(status)) %>% 
  group_by(huc12_name, huc12_tnmid, status) %>% 
  summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
  pivot_wider(names_from = status, values_from = total_summed_prob) %>% 
  mutate(status_ratio = rare/common)

shp_status_mg_cnt <- left_join(huc12, df_status_mg_cnt, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  mutate(taxa = "mussel",
         scenario = "connectivity",
         grp = "status")

qq <- ggplot(data = shp_status_mg_cnt)+
  geom_sf(aes(fill = status_ratio), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = .26,
                       limits = c(0,.52))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 15))+
    ggtitle(label = "Rare:Common - connectivity")+
  labs(fill = "ratio")

  
  



#2)	Total summed probabilities of host specialist divided by the total summed probabilities of host generalist species.
df_host_mg_cnt <- mussel_mg_cnt_proboccurrence_huc12 %>% 
  left_join(mussel_traits, by = "common_name") %>%  
  filter(!is.na(host)) %>%
  group_by(huc12_name, huc12_tnmid, host) %>% 
  summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
  pivot_wider(names_from = host, values_from = total_summed_prob) %>% 
  mutate(host_ratio = (specialist / generalist))

shp_host_mg_cnt <- left_join(huc12, df_host_mg_cnt, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  mutate(taxa = "mussel",
         scenario = "connectivity",
         grp = "host")

rr <- ggplot(data = shp_host_mg_cnt)+
  geom_sf(aes(fill = host_ratio), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = .26,
                       limits = c(0,.57))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 15))+
    ggtitle(label = "Host specialist : generalist - connectivity")+
  labs(fill = "ratio")



#3)	Total summed probabilities of small species divided by the total summed probabilities of large species.
df_size_mg_cnt <- mussel_mg_cnt_proboccurrence_huc12 %>% 
  left_join(mussel_traits, by = "common_name") %>%
  filter(!is.na(size)) %>% 
  group_by(huc12_name, huc12_tnmid, size) %>% 
  summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
  pivot_wider(names_from = size, values_from = total_summed_prob) %>% 
  mutate(ratio = (small/large))

shp_size_mg_cnt <- left_join(huc12, df_size_mg_cnt, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  mutate(taxa = "mussel",
         scenario = "connectivity",
         grp = "size")

ss <- ggplot(data = shp_size_mg_cnt)+
  geom_sf(aes(fill = ratio), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = 5,
                       limits = c(0,9))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 15))+
    ggtitle(label = "small : large - connectivity")+
  labs(fill = "ratio")



#4)	Total summed probabilities of equilibrium + periodic species divided by the total summed probabilities of opportunistic species.
df_strat_mg_cnt <- mussel_mg_cnt_proboccurrence_huc12 %>% 
  left_join(mussel_traits, by = "common_name") %>%
  filter(!is.na(strat)) %>% 
  group_by(huc12_name, huc12_tnmid, strat) %>% 
  summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
  pivot_wider(names_from = strat, values_from = total_summed_prob) %>% 
  mutate(ratio = ((equilibrium + periodic) /opportunistic))

shp_strat_mg_cnt <- left_join(huc12, df_strat_mg_cnt, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  mutate(taxa = "mussel",
         scenario = "connectivity",
         grp = "strategy")

tt <- ggplot(data = shp_strat_mg_cnt)+
  geom_sf(aes(fill = ratio), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = 5,
                       limits = c(0,8))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 15))+
    ggtitle(label = "equil : opportun - connectivity")+
  labs(fill = "ratio")


#5)	Total summed probabilities of senstive species divided by the total summed probabilities of secure species.
df_rank_mg_cnt <- mussel_mg_cnt_proboccurrence_huc12 %>% 
  left_join(mussel_traits, by = "common_name") %>%
  filter(!is.na(rank)) %>% 
  group_by(huc12_name, huc12_tnmid, rank) %>% 
  summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
  pivot_wider(names_from = rank, values_from = total_summed_prob) %>% 
  mutate(ratio = (sensitive /secure))

shp_rank_mg_cnt <- left_join(huc12, df_rank_mg_cnt, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  mutate(taxa = "mussel",
         scenario = "connectivity",
         grp = "rank")

rank_mg_cnt <- ggplot(data = shp_rank_mg_cnt)+
  geom_sf(aes(fill = ratio), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = 1,
                       limits = c(0,2))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 15))+
    ggtitle(label = "senstive : secure - connectivity")+
  labs(fill = "ratio")


#6)	Total summed probabilities of thin species divided by the total summed probabilities of thick species.
df_shell_mg_cnt <- mussel_mg_cnt_proboccurrence_huc12 %>% 
  left_join(mussel_traits, by = "common_name") %>%
  filter(!is.na(shell)) %>% 
  group_by(huc12_name, huc12_tnmid, shell) %>% 
  summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
  pivot_wider(names_from = shell, values_from = total_summed_prob) %>% 
  mutate(ratio = (thin /thick))

shp_shell_mg_cnt <- left_join(huc12, df_shell_mg_cnt, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  mutate(taxa = "mussel",
         scenario = "connectivity",
         grp = "shell")

shell_mg_cnt <- ggplot(data = shp_shell_mg_cnt)+
  geom_sf(aes(fill = ratio), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = 5,
                       limits = c(0,10))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 15))+
    ggtitle(label = "thin : thick - connectivity")+
  labs(fill = "ratio")

#7)	Total summed probabilities of lotic species divided by the total summed probabilities of generalist species.
df_musselhabitat_mg_cnt <- mussel_mg_cnt_proboccurrence_huc12 %>% 
  left_join(mussel_traits, by = "common_name") %>%
  filter(!is.na(habitat)) %>% 
  group_by(huc12_name, huc12_tnmid, habitat) %>% 
  summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
  pivot_wider(names_from = habitat, values_from = total_summed_prob) %>% 
  mutate(ratio = (lotic /generalist))

shp_musselhabitat_mg_cnt <- left_join(huc12, df_musselhabitat_mg_cnt, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  mutate(taxa = "mussel",
         scenario = "connectivity",
         grp = "habitat")

musselhabitat_mg_cnt <- ggplot(data = shp_musselhabitat_mg_cnt)+
  geom_sf(aes(fill = ratio), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = .7,
                       limits = c(0,1.4))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 15))+
    ggtitle(label = "thin : thick - connectivity")+
  labs(fill = "ratio")







############################################





#Climate Change and Watershed Forest mgmt

head(prediction_forest)
mussel_forest_proboccurrence_huc12 <- prediction_forest %>%
  data.frame() %>% 
  select(huc12_name, huc12_tnmid, 44:55) %>% 
  filter(!is.na(alewifefloater),
         !is.na(huc12_name)) %>%
  pivot_longer(3:14, names_to = "common_name", values_to = "prob_occ") %>% 
  group_by(huc12_name, huc12_tnmid, common_name) %>% 
  summarise(mean_prob_occ = mean(prob_occ)) %>% 
  ungroup() %>% 
  mutate(scenario = "forest", taxa = "mussel")

mussel_forest_proboccurrence_huc12$common_name <- gsub(pattern = "\\.", replacement = " ", x = mussel_forest_proboccurrence_huc12$common_name)
mussel_forest_proboccurrence_huc12$common_name[mussel_forest_proboccurrence_huc12$common_name == "alewifefloater"] <- "alewife floater"
mussel_forest_proboccurrence_huc12$common_name[mussel_forest_proboccurrence_huc12$common_name == "easternpearlshell"] <- "eastern pearlshell"
mussel_forest_proboccurrence_huc12$common_name[mussel_forest_proboccurrence_huc12$common_name == "easternpondmussel"] <- "eastern pondmussel"
mussel_forest_proboccurrence_huc12$common_name[mussel_forest_proboccurrence_huc12$common_name == "Tidewatermucket"] <- "tidewater mucket"
mussel_forest_proboccurrence_huc12$common_name[mussel_forest_proboccurrence_huc12$common_name == "yellowlampmussel"] <- "yellow lampmussel"


mussel_forest_proboccurrence_huc12$mean_prob_occ[mussel_forest_proboccurrence_huc12$mean_prob_occ<0.01]<-0.01

#1)	Total summed probabilities of rare species divided by the total summed probabilities of common species.
df_status_forest <- mussel_forest_proboccurrence_huc12 %>% 
  left_join(mussel_traits, by = "common_name") %>%
  filter(!is.na(status)) %>% 
  group_by(huc12_name, huc12_tnmid, status) %>% 
  summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
  pivot_wider(names_from = status, values_from = total_summed_prob) %>% 
  mutate(status_ratio = rare/common)

shp_status_forest <- left_join(huc12, df_status_forest, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  mutate(taxa = "mussel",
         scenario = "forest",
         grp = "status")

qq <- ggplot(data = shp_status_forest)+
  geom_sf(aes(fill = status_ratio), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = .26,
                       limits = c(0,.52))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 15))+
    ggtitle(label = "Rare:Common - forest")+
  labs(fill = "ratio")

  
  



#2)	Total summed probabilities of host specialist divided by the total summed probabilities of host generalist species.
df_host_forest <- mussel_forest_proboccurrence_huc12 %>% 
  left_join(mussel_traits, by = "common_name") %>%  
  filter(!is.na(host)) %>%
  group_by(huc12_name, huc12_tnmid, host) %>% 
  summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
  pivot_wider(names_from = host, values_from = total_summed_prob) %>% 
  mutate(host_ratio = (specialist / generalist))

shp_host_forest <- left_join(huc12, df_host_forest, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  mutate(taxa = "mussel",
         scenario = "forest",
         grp = "host")

rr <- ggplot(data = shp_host_forest)+
  geom_sf(aes(fill = host_ratio), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = .26,
                       limits = c(0,.57))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 15))+
    ggtitle(label = "Host specialist : generalist - forest")+
  labs(fill = "ratio")



#3)	Total summed probabilities of small species divided by the total summed probabilities of large species.
df_size_forest <- mussel_forest_proboccurrence_huc12 %>% 
  left_join(mussel_traits, by = "common_name") %>%
  filter(!is.na(size)) %>% 
  group_by(huc12_name, huc12_tnmid, size) %>% 
  summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
  pivot_wider(names_from = size, values_from = total_summed_prob) %>% 
  mutate(ratio = (small/large))

shp_size_forest <- left_join(huc12, df_size_forest, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  mutate(taxa = "mussel",
         scenario = "forest",
         grp = "size")

ss <- ggplot(data = shp_size_forest)+
  geom_sf(aes(fill = ratio), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = 5,
                       limits = c(0,9))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 15))+
    ggtitle(label = "small : large - forest")+
  labs(fill = "ratio")



#4)	Total summed probabilities of equilibrium + periodic species divided by the total summed probabilities of opportunistic species.
df_strat_forest <- mussel_forest_proboccurrence_huc12 %>% 
  left_join(mussel_traits, by = "common_name") %>%
  filter(!is.na(strat)) %>% 
  group_by(huc12_name, huc12_tnmid, strat) %>% 
  summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
  pivot_wider(names_from = strat, values_from = total_summed_prob) %>% 
  mutate(ratio = ((equilibrium + periodic) /opportunistic))

shp_strat_forest <- left_join(huc12, df_strat_forest, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  mutate(taxa = "mussel",
         scenario = "forest",
         grp = "strategy")

tt <- ggplot(data = shp_strat_forest)+
  geom_sf(aes(fill = ratio), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = 5,
                       limits = c(0,8))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 15))+
    ggtitle(label = "equil : opportun - forest")+
  labs(fill = "ratio")


#5)	Total summed probabilities of senstive species divided by the total summed probabilities of secure species.
df_rank_forest <- mussel_forest_proboccurrence_huc12 %>% 
  left_join(mussel_traits, by = "common_name") %>%
  filter(!is.na(rank)) %>% 
  group_by(huc12_name, huc12_tnmid, rank) %>% 
  summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
  pivot_wider(names_from = rank, values_from = total_summed_prob) %>% 
  mutate(ratio = (sensitive /secure))

shp_rank_forest <- left_join(huc12, df_rank_forest, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  mutate(taxa = "mussel",
         scenario = "forest",
         grp = "rank")

rank_forest <- ggplot(data = shp_rank_forest)+
  geom_sf(aes(fill = ratio), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = 1,
                       limits = c(0,2))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 15))+
    ggtitle(label = "senstive : secure - forest")+
  labs(fill = "ratio")


#6)	Total summed probabilities of thin species divided by the total summed probabilities of thick species.
df_shell_forest <- mussel_forest_proboccurrence_huc12 %>% 
  left_join(mussel_traits, by = "common_name") %>%
  filter(!is.na(shell)) %>% 
  group_by(huc12_name, huc12_tnmid, shell) %>% 
  summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
  pivot_wider(names_from = shell, values_from = total_summed_prob) %>% 
  mutate(ratio = (thin /thick))

shp_shell_forest <- left_join(huc12, df_shell_forest, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  mutate(taxa = "mussel",
         scenario = "forest",
         grp = "shell")

shell_forest <- ggplot(data = shp_shell_forest)+
  geom_sf(aes(fill = ratio), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = 5,
                       limits = c(0,10))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 15))+
    ggtitle(label = "thin : thick - forest")+
  labs(fill = "ratio")

#7)	Total summed probabilities of lotic species divided by the total summed probabilities of generalist species.
df_musselhabitat_forest <- mussel_forest_proboccurrence_huc12 %>% 
  left_join(mussel_traits, by = "common_name") %>%
  filter(!is.na(habitat)) %>% 
  group_by(huc12_name, huc12_tnmid, habitat) %>% 
  summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
  pivot_wider(names_from = habitat, values_from = total_summed_prob) %>% 
  mutate(ratio = (lotic /generalist))

shp_musselhabitat_forest <- left_join(huc12, df_musselhabitat_forest, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  mutate(taxa = "mussel",
         scenario = "forest",
         grp = "habitat")

musselhabitat_forest <- ggplot(data = shp_musselhabitat_forest)+
  geom_sf(aes(fill = ratio), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = .7,
                       limits = c(0,1.4))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 15))+
    ggtitle(label = "thin : thick - forest")+
  labs(fill = "ratio")






############################################




#Climate Change and Watershed Wetland mgmt

head(prediction_wetland)
mussel_wetland_proboccurrence_huc12 <- prediction_wetland %>%
  data.frame() %>% 
  select(huc12_name, huc12_tnmid, 44:55) %>% 
  filter(!is.na(alewifefloater),
         !is.na(huc12_name)) %>%
  pivot_longer(3:14, names_to = "common_name", values_to = "prob_occ") %>% 
  group_by(huc12_name, huc12_tnmid, common_name) %>% 
  summarise(mean_prob_occ = mean(prob_occ)) %>% 
  ungroup() %>% 
  mutate(scenario = "wetland", taxa = "mussel")

mussel_wetland_proboccurrence_huc12$common_name <- gsub(pattern = "\\.", replacement = " ", x = mussel_wetland_proboccurrence_huc12$common_name)
mussel_wetland_proboccurrence_huc12$common_name[mussel_wetland_proboccurrence_huc12$common_name == "alewifefloater"] <- "alewife floater"
mussel_wetland_proboccurrence_huc12$common_name[mussel_wetland_proboccurrence_huc12$common_name == "easternpearlshell"] <- "eastern pearlshell"
mussel_wetland_proboccurrence_huc12$common_name[mussel_wetland_proboccurrence_huc12$common_name == "easternpondmussel"] <- "eastern pondmussel"
mussel_wetland_proboccurrence_huc12$common_name[mussel_wetland_proboccurrence_huc12$common_name == "Tidewatermucket"] <- "tidewater mucket"
mussel_wetland_proboccurrence_huc12$common_name[mussel_wetland_proboccurrence_huc12$common_name == "yellowlampmussel"] <- "yellow lampmussel"


mussel_wetland_proboccurrence_huc12$mean_prob_occ[mussel_wetland_proboccurrence_huc12$mean_prob_occ<0.01]<-0.01

#1)	Total summed probabilities of rare species divided by the total summed probabilities of common species.
df_status_wetland <- mussel_wetland_proboccurrence_huc12 %>% 
  left_join(mussel_traits, by = "common_name") %>%
  filter(!is.na(status)) %>% 
  group_by(huc12_name, huc12_tnmid, status) %>% 
  summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
  pivot_wider(names_from = status, values_from = total_summed_prob) %>% 
  mutate(status_ratio = rare/common)

shp_status_wetland <- left_join(huc12, df_status_wetland, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  mutate(taxa = "mussel",
         scenario = "wetland",
         grp = "status")

qq <- ggplot(data = shp_status_wetland)+
  geom_sf(aes(fill = status_ratio), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = .26,
                       limits = c(0,.52))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 15))+
    ggtitle(label = "Rare:Common - wetland")+
  labs(fill = "ratio")

  
  



#2)	Total summed probabilities of host specialist divided by the total summed probabilities of host generalist species.
df_host_wetland <- mussel_wetland_proboccurrence_huc12 %>% 
  left_join(mussel_traits, by = "common_name") %>%  
  filter(!is.na(host)) %>%
  group_by(huc12_name, huc12_tnmid, host) %>% 
  summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
  pivot_wider(names_from = host, values_from = total_summed_prob) %>% 
  mutate(host_ratio = (specialist / generalist))

shp_host_wetland <- left_join(huc12, df_host_wetland, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  mutate(taxa = "mussel",
         scenario = "wetland",
         grp = "host")

rr <- ggplot(data = shp_host_wetland)+
  geom_sf(aes(fill = host_ratio), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = .26,
                       limits = c(0,.57))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 15))+
    ggtitle(label = "Host specialist : generalist - wetland")+
  labs(fill = "ratio")



#3)	Total summed probabilities of small species divided by the total summed probabilities of large species.
df_size_wetland <- mussel_wetland_proboccurrence_huc12 %>% 
  left_join(mussel_traits, by = "common_name") %>%
  filter(!is.na(size)) %>% 
  group_by(huc12_name, huc12_tnmid, size) %>% 
  summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
  pivot_wider(names_from = size, values_from = total_summed_prob) %>% 
  mutate(ratio = (small/large))

shp_size_wetland <- left_join(huc12, df_size_wetland, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  mutate(taxa = "mussel",
         scenario = "wetland",
         grp = "size")

ss <- ggplot(data = shp_size_wetland)+
  geom_sf(aes(fill = ratio), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = 5,
                       limits = c(0,9))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 15))+
    ggtitle(label = "small : large - wetland")+
  labs(fill = "ratio")



#4)	Total summed probabilities of equilibrium + periodic species divided by the total summed probabilities of opportunistic species.
df_strat_wetland <- mussel_wetland_proboccurrence_huc12 %>% 
  left_join(mussel_traits, by = "common_name") %>%
  filter(!is.na(strat)) %>% 
  group_by(huc12_name, huc12_tnmid, strat) %>% 
  summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
  pivot_wider(names_from = strat, values_from = total_summed_prob) %>% 
  mutate(ratio = ((equilibrium + periodic) /opportunistic))

shp_strat_wetland <- left_join(huc12, df_strat_wetland, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  mutate(taxa = "mussel",
         scenario = "wetland",
         grp = "strategy")

tt <- ggplot(data = shp_strat_wetland)+
  geom_sf(aes(fill = ratio), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = 5,
                       limits = c(0,8))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 15))+
    ggtitle(label = "equil : opportun - wetland")+
  labs(fill = "ratio")


#5)	Total summed probabilities of senstive species divided by the total summed probabilities of secure species.
df_rank_wetland <- mussel_wetland_proboccurrence_huc12 %>% 
  left_join(mussel_traits, by = "common_name") %>%
  filter(!is.na(rank)) %>% 
  group_by(huc12_name, huc12_tnmid, rank) %>% 
  summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
  pivot_wider(names_from = rank, values_from = total_summed_prob) %>% 
  mutate(ratio = (sensitive /secure))

shp_rank_wetland <- left_join(huc12, df_rank_wetland, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  mutate(taxa = "mussel",
         scenario = "wetland",
         grp = "rank")

rank_wetland <- ggplot(data = shp_rank_wetland)+
  geom_sf(aes(fill = ratio), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = 1,
                       limits = c(0,2))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 15))+
    ggtitle(label = "senstive : secure - wetland")+
  labs(fill = "ratio")


#6)	Total summed probabilities of thin species divided by the total summed probabilities of thick species.
df_shell_wetland <- mussel_wetland_proboccurrence_huc12 %>% 
  left_join(mussel_traits, by = "common_name") %>%
  filter(!is.na(shell)) %>% 
  group_by(huc12_name, huc12_tnmid, shell) %>% 
  summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
  pivot_wider(names_from = shell, values_from = total_summed_prob) %>% 
  mutate(ratio = (thin /thick))

shp_shell_wetland <- left_join(huc12, df_shell_wetland, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  mutate(taxa = "mussel",
         scenario = "wetland",
         grp = "shell")

shell_wetland <- ggplot(data = shp_shell_wetland)+
  geom_sf(aes(fill = ratio), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = 5,
                       limits = c(0,10))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 15))+
    ggtitle(label = "thin : thick - wetland")+
  labs(fill = "ratio")

#7)	Total summed probabilities of lotic species divided by the total summed probabilities of generalist species.
df_musselhabitat_wetland <- mussel_wetland_proboccurrence_huc12 %>% 
  left_join(mussel_traits, by = "common_name") %>%
  filter(!is.na(habitat)) %>% 
  group_by(huc12_name, huc12_tnmid, habitat) %>% 
  summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
  pivot_wider(names_from = habitat, values_from = total_summed_prob) %>% 
  mutate(ratio = (lotic /generalist))

shp_musselhabitat_wetland <- left_join(huc12, df_musselhabitat_wetland, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  mutate(taxa = "mussel",
         scenario = "wetland",
         grp = "habitat")

musselhabitat_wetland <- ggplot(data = shp_musselhabitat_wetland)+
  geom_sf(aes(fill = ratio), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = .7,
                       limits = c(0,1.4))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 15))+
    ggtitle(label = "thin : thick - wetland")+
  labs(fill = "ratio")

#################

# Change from baseline to future
# climate change ratio - baseline ratio
# positive value means the ratio has increased and the more vulnerable group is doing well
# negative value means the ratio has decreased and the more vulnerable group is doing poorly

unique(df_status_baseline$huc12_name == df_status_cc$huc12_name)
df_status_cc$status_ratio_change <- df_status_cc$status_ratio - df_status_baseline$status_ratio
shp_status_chng <- left_join(huc12, df_status_cc, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid"))

uu <- ggplot(data = shp_status_chng)+
  geom_sf(aes(fill = status_ratio_change), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "white",
                        high = "red",
                        midpoint = 0,
                       limits = c(-.8,.11))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 7),
        legend.title = element_text(size = 10),
        title = element_text(size = 10))+
    ggtitle(label = "D. Rare:common")+
  labs(fill = "Δ")

df_host_cc$host_ratio_change <- df_host_cc$host_ratio - df_host_baseline$host_ratio
shp_host_chng <- left_join(huc12, df_host_cc, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid"))

vv <- ggplot(data = shp_host_chng)+
  geom_sf(aes(fill = host_ratio_change), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "white",
                        high = "red",
                        midpoint = 0,
                       limits = c(-.7,.11))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 7),
        legend.title = element_text(size = 10),
        title = element_text(size = 10))+
    ggtitle(label = "specialist : generalist")+
  labs(fill = "Δ")

df_size_cc$size_ratio_change <- df_size_cc$ratio - df_size_baseline$ratio
shp_size_chng <- left_join(huc12, df_size_cc, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid"))

ww <- ggplot(data = shp_size_chng)+
  geom_sf(aes(fill = size_ratio_change), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "white",
                        high = "red",
                        midpoint = 0,
                       limits = c(-7.3,4.4))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 7),
        legend.title = element_text(size = 10),
        title = element_text(size = 10))+
    ggtitle(label = "E. Small:large")+
  labs(fill = "Δ")



df_strat_cc$strat_ratio_change <- df_strat_cc$ratio - df_strat_baseline$ratio
shp_strat_chng <- left_join(huc12, df_strat_cc, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid"))

xx <- ggplot(data = shp_strat_chng)+
  geom_sf(aes(fill = strat_ratio_change), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "white",
                        high = "red",
                        midpoint = 0,
                       limits = c(-12,4))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 7),
        legend.title = element_text(size = 10),
        title = element_text(size = 10))+
    ggtitle(label = "equib : opp")+
  labs(fill = "Δ")


df_rank_cc$rank_ratio_change <- df_rank_cc$ratio - df_rank_baseline$ratio
shp_rank_chng <- left_join(huc12, df_rank_cc, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid"))

rank_cc_change <- ggplot(data = shp_rank_chng)+
  geom_sf(aes(fill = rank_ratio_change), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "white",
                        high = "red",
                        midpoint = 0,
                       limits = c(-2.6,.2))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 7),
        legend.title = element_text(size = 10),
        title = element_text(size = 10))+
    ggtitle(label = "sensitive : secure")+
  labs(fill = "Δ")


df_shell_cc$shell_ratio_change <- df_shell_cc$ratio - df_shell_baseline$ratio
shp_shell_chng <- left_join(huc12, df_shell_cc, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid"))

shell_cc_change <- ggplot(data = shp_shell_chng)+
  geom_sf(aes(fill = shell_ratio_change), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "white",
                        high = "red",
                        midpoint = 0,
                       limits = c(-2.2,12.3))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 7),
        legend.title = element_text(size = 10),
        title = element_text(size = 10))+
    ggtitle(label = "thin : thick")+
  labs(fill = "Δ")


df_musselhabitat_cc$musselhabitat_ratio_change <- df_musselhabitat_cc$ratio - df_musselhabitat_baseline$ratio
shp_musselhabitat_chng <- left_join(huc12, df_musselhabitat_cc, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid"))

musselhabitat_cc_change <- ggplot(data = shp_musselhabitat_chng)+
  geom_sf(aes(fill = musselhabitat_ratio_change), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "white",
                        high = "red",
                        midpoint = 0,
                       limits = c(-2.01,0.13))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 7),
        legend.title = element_text(size = 10),
        title = element_text(size = 10))+
    ggtitle(label = "lotic : generalist")+
  labs(fill = "Δ")



########## Change in overall mussel species richness






#change from baseline to climate change for each species

prediction_cc <- data.frame(prediction_cc)
predictions_baseline <- data.frame(predictions_baseline)
prediction_mg <- data.frame(prediction_mg)
prediction_mg_cnt <- data.frame(prediction_mg_cnt)
prediction_forest <- data.frame(prediction_forest)
prediction_wetland <- data.frame(prediction_wetland)

cc <- as.matrix(prediction_cc[, 44:55])
bl <- as.matrix(predictions_baseline[, 44:55])

change <- (cc - bl)
change <- data.frame(change)
change <- cbind(predictions_baseline[1:3], change)

change <- left_join(huc12, change, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid", "areasqkm" = "huc12_areasqkm"))

names(change) <- gsub("\\.", " ", names(change))


#sample plot
change <- change %>% 
  filter(name != "Long Island Sound Deep")

ggplot(data = change)+
  geom_sf(aes(fill = `eastern floater`), linewidth = .02)+
  scale_fill_gradient2(low = "red2",
                        mid = "white",
                        high = "green4",
                        midpoint = 0,
                       limits = c(-1,1))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 15),
        legend.title = element_text(size = 20))+
    ggtitle(label = "eastern floater")+
  labs(fill = "Δ P")

ggsave(paste("tmpfigures/baseline_mussel_predictions/tidewatermucket_change.png"), 
    plot = last_plot(),
    width = 18,
    height = 12,
    units = "cm",
    dpi = 300) 



#species richness in the baseline
richness_baseline <- predictions_baseline %>% 
  select(1,3,44:55) %>% 
  pivot_longer(3:14, names_to = "common_name", values_to = "prob") %>% 
  mutate(occurrence = ifelse(common_name %in% c("alewifefloater", "brook.floater", "dwarf.wedgemussel", "easternpondmussel", "Tidewatermucket", "yellowlampmussel") &
                                                  prob > 0.1 , 1,
                                                ifelse(common_name %in% c("creeper", "eastern.elliptio", "eastern.floater", "eastern.lampmussel", "easternpearlshell", "triangle.floater") & prob > 0.5, 1, 0)))  %>% 
  group_by(huc12_name, huc12_tnmid) %>% 
  summarise(richness = sum(occurrence))


richness_baseline <- left_join(huc12, richness_baseline, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  mutate(taxa = "mussel",
         scenario = "baseline",
         grp = "richness")

  
yy <- ggplot(data = richness_baseline)+
  geom_sf(aes(fill = richness), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = 4.5,
                       limits = c(0,9))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 7),
        legend.title = element_text(size = 10))+
    ggtitle(label = "C. Species Richness")+
  labs(fill = "Richness")




#species richness in climate change
richness_cc <- prediction_cc %>% 
  select(1,3,44:55) %>% 
  pivot_longer(3:14, names_to = "common_name", values_to = "prob") %>% 
  mutate(occurrence = ifelse(common_name %in% c("alewifefloater", "brook.floater", "dwarf.wedgemussel", "easternpondmussel", "Tidewatermucket", "yellowlampmussel") &
                                                  prob > 0.1 , 1,
                                                ifelse(common_name %in% c("creeper", "eastern.elliptio", "eastern.floater", "eastern.lampmussel", "easternpearlshell", "triangle.floater") & prob > 0.5, 1, 0)))  %>% 
  group_by(huc12_name, huc12_tnmid) %>% 
  summarise(richness = sum(occurrence))

richness_cc <- left_join(huc12, richness_cc, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  mutate(taxa = "mussel",
         scenario = "cc",
         grp = "richness")


zz <- ggplot(data = richness_cc)+
  geom_sf(aes(fill = richness), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = 5,
                       limits = c(0,10))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 15),
        legend.title = element_text(size = 20))+
    ggtitle(label = "CC Species Richness")+
  labs(fill = "Richness")




#species richness in climate change and landcover mgmt
richness_mg <- prediction_mg %>% 
  data.frame() %>% 
  select(1,3,44:55) %>% 
  pivot_longer(3:14, names_to = "common_name", values_to = "prob") %>% 
  mutate(occurrence = ifelse(common_name %in% c("alewifefloater", "brook.floater", "dwarf.wedgemussel", "easternpondmussel", "Tidewatermucket", "yellowlampmussel") &
                                                  prob > 0.1 , 1,
                                                ifelse(common_name %in% c("creeper", "eastern.elliptio", "eastern.floater", "eastern.lampmussel", "easternpearlshell", "triangle.floater") & prob > 0.5, 1, 0)))  %>% 
  group_by(huc12_name, huc12_tnmid) %>% 
  summarise(richness = sum(occurrence))

richness_mg <- left_join(huc12, richness_mg, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  mutate(taxa = "mussel",
         scenario = "Riparian Restoration",
         grp = "richness")


aaa <- ggplot(data = richness_mg)+
  geom_sf(aes(fill = richness), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = 5,
                       limits = c(0,10))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 15),
        legend.title = element_text(size = 20))+
    ggtitle(label = "Riparian Restoration Species Richness")+
  labs(fill = "Richness")




#species richness in climate change and connectivity mgmt
richness_mg_cnt <- prediction_mg_cnt %>% 
  data.frame() %>% 
  select(1,3,44:55) %>% 
  pivot_longer(3:14, names_to = "common_name", values_to = "prob") %>% 
  mutate(occurrence = ifelse(common_name %in% c("alewifefloater", "brook.floater", "dwarf.wedgemussel", "easternpondmussel", "Tidewatermucket", "yellowlampmussel") &
                                                  prob > 0.1 , 1,
                                                ifelse(common_name %in% c("creeper", "eastern.elliptio", "eastern.floater", "eastern.lampmussel", "easternpearlshell", "triangle.floater") & prob > 0.5, 1, 0)))  %>% 
  group_by(huc12_name, huc12_tnmid) %>% 
  summarise(richness = sum(occurrence))

richness_mg_cnt <- left_join(huc12, richness_mg_cnt, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  mutate(taxa = "mussel",
         scenario = "connectivity",
         grp = "richness")


bbb <- ggplot(data = richness_mg_cnt)+
  geom_sf(aes(fill = richness), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = 5,
                       limits = c(0,10))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 15),
        legend.title = element_text(size = 20))+
    ggtitle(label = "CC_mg_cnt Species Richness")+
  labs(fill = "Richness")






#species richness in climate change and Forest mgmt
richness_forest <- prediction_forest %>% 
  data.frame() %>% 
  select(1,3,44:55) %>% 
  pivot_longer(3:14, names_to = "common_name", values_to = "prob") %>% 
  mutate(occurrence = ifelse(common_name %in% c("alewifefloater", "brook.floater", "dwarf.wedgemussel", "easternpondmussel", "Tidewatermucket", "yellowlampmussel") &
                                                  prob > 0.1 , 1,
                                                ifelse(common_name %in% c("creeper", "eastern.elliptio", "eastern.floater", "eastern.lampmussel", "easternpearlshell", "triangle.floater") & prob > 0.5, 1, 0)))  %>% 
  group_by(huc12_name, huc12_tnmid) %>% 
  summarise(richness = sum(occurrence))

richness_forest <- left_join(huc12, richness_forest, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  mutate(taxa = "mussel",
         scenario = "forest",
         grp = "richness")


richness_forest_plot <- ggplot(data = richness_forest)+
  geom_sf(aes(fill = richness), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = 4,
                       limits = c(0,8))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 15),
        legend.title = element_text(size = 20))+
    ggtitle(label = "CC_forest Species Richness")+
  labs(fill = "Richness")





#species richness in climate change and Wetland mgmt
richness_wetland <- prediction_wetland %>% 
  data.frame() %>% 
  select(1,3,44:55) %>% 
  pivot_longer(3:14, names_to = "common_name", values_to = "prob") %>% 
  mutate(occurrence = ifelse(common_name %in% c("alewifefloater", "brook.floater", "dwarf.wedgemussel", "easternpondmussel", "Tidewatermucket", "yellowlampmussel") &
                                                  prob > 0.1 , 1,
                                                ifelse(common_name %in% c("creeper", "eastern.elliptio", "eastern.floater", "eastern.lampmussel", "easternpearlshell", "triangle.floater") & prob > 0.5, 1, 0)))  %>% 
  group_by(huc12_name, huc12_tnmid) %>% 
  summarise(richness = sum(occurrence))

richness_wetland <- left_join(huc12, richness_wetland, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  mutate(taxa = "mussel",
         scenario = "wetland",
         grp = "richness")


richness_wetland_plot <- ggplot(data = richness_wetland)+
  geom_sf(aes(fill = richness), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = 2.5,
                       limits = c(0,5))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 15),
        legend.title = element_text(size = 20))+
    ggtitle(label = "CC_wetland Species Richness")+
  labs(fill = "Richness")



#change in species richness: climate change - baseline

change_richness <- data.frame(
  "tnmid" = huc12$tnmid,
  "name" = huc12$name,
  "huc12" = huc12$huc12,
  "richness_change" = richness_cc$richness - richness_baseline$richness
)


change_richness <- left_join(huc12, change_richness, by = c("name", "tnmid", "huc12"))

  
ccc <- ggplot(data = change_richness)+
  geom_sf(aes(fill = richness_change), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "white",
                        high = "red",
                        midpoint = 0,
                       limits = c(min(change_richness$richness_change, na.rm = T), max(change_richness$richness_change, na.rm = T)))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 7),
        legend.title = element_text(size = 10),
        title = element_text(size = 10))+
    ggtitle(label = "F. Species Richness")+
  labs(fill = "Δ")



fig3 <- gridExtra::grid.arrange(ee,ff, gg, hh, 
                                uu, vv, ww, xx, nrow = 2, ncol = 4)
ggsave(fig3, file = "tmpfigures/paper2/fig3_baseline_change_mussel.png")
fig3a <- gridExtra::grid.arrange(rank_baseline, shell_baseline, musselhabitat_baseline,yy, 
                                rank_cc_change, shell_cc_change, musselhabitat_cc_change, ccc, nrow = 2, ncol = 4)
ggsave(fig3a, file = "tmpfigures/paper2/fig3a_baseline_change_mussel.png")




#align change in richess values with change in the climate change varaibles
covariates_bl <- NHDplusV2_NewEngCrop_mussel_covariates_HUC12 %>% 
  select(huc12_name, huc12_tnmid, annual_mean_summer_temp, BFI_HIST, LO7Q1DT_HIST, CFM_HIST, W95_HIST, logMJJA_HIST)

#Climate change streamflow and temperature variables
covariates_cc <- NHDplusV2_NewEngCrop_2080 %>% 
  data.frame() %>% 
  rename(annual_mean_summer_temp = annual_mean_summer_temp_pls_4,
         BFI_HIST = BFI_2080,
         LO7Q1DT_HIST = LO7Q1DT_2080,
         CFM_HIST = CFM_2080,
         W95_HIST = W95_2080,
         logMJJA_HIST = logMJJA_2080) %>% 
  select(huc12_name, huc12_tnmid, annual_mean_summer_temp, BFI_HIST, LO7Q1DT_HIST, CFM_HIST, W95_HIST, logMJJA_HIST) %>% 
  group_by(huc12_name, huc12_tnmid) %>% 
  summarise(annual_mean_summer_temp = mean(annual_mean_summer_temp, na.rm = T),
            BFI_HIST = mean(BFI_HIST, na.rm = T),
            LO7Q1DT_HIST = mean(LO7Q1DT_HIST, na.rm = T),
            CFM_HIST = mean(CFM_HIST, na.rm = T),
            W95_HIST = mean(W95_HIST, na.rm = T),
            logMJJA_HIST = mean(logMJJA_HIST, na.rm = T))


sum(names(covariates_bl) == names(covariates_cc)) #45
sum(covariates_bl$huc12_name == covariates_cc$huc12_name, na.rm = T) #423

bl_cov <- covariates_bl %>% 
  ungroup() %>% 
  select(annual_mean_summer_temp, W95_HIST, logMJJA_HIST) %>% 
  mutate(mjja_hist = exp(logMJJA_HIST)) %>% 
  as.matrix()

cc_cov <- covariates_cc %>% 
  ungroup() %>% 
  select(annual_mean_summer_temp, W95_HIST, logMJJA_HIST) %>% 
  mutate(mjja_hist = exp(logMJJA_HIST)) %>% 
  as.matrix()

change_cov <- (cc_cov - bl_cov)
change_cov <- data.frame(change_cov)
change_cov <- cbind(covariates_bl[1:2], change_cov)


change_cov <- left_join(huc12, change_cov, by = c("huc12_name", "huc12_tnmid"))%>% 
  filter(huc12_name != "Long Island Sound Deep")

  
ggplot(data = change_cov)+
  geom_sf(aes(fill = annual_mean_summer_temp))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 15),
        legend.title = element_text(size = 20))+
    ggtitle(label = "Annual mean summer temp Change")+
  labs(fill = "Δ T(°C)")

ggsave(paste("tmpfigures/baseline_mussel_predictions/temp_change.png"), 
    plot = last_plot(),
    width = 18,
    height = 12,
    units = "cm",
    dpi = 300)  


change_richness <- change_richness %>% 
  data.frame() %>% 
  select(huc12_tnmid, huc12_name, richness_change)
df <- left_join(change_cov, change_richness, by = c("huc10_name", "huc10_tnmid"))

df <- df %>% 
  filter(!is.na(annual_mean_summer_temp))

r2 <- round(cor(df$richness_change, df$annual_mean_summer_temp),2)
cor.test(df$richness_change, df$W95_HIST)
label <- paste("R2 = ",  r2, sep = "")

ggplot(data = df, mapping = aes(x = annual_mean_summer_temp, y = richness_change))+
  geom_jitter(alpha = 0.1, size = 3)+
  geom_smooth(method = "lm", linewidth = 2, color = "red")+
  labs(y = "Change in Richness",
       x = "Change in Summer Stream Temperature (°C)")+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
          axis.title = element_text(size = 17),
          axis.text = element_text(size = 17))+
  annotate("text",x=3,y=-3,label=r2 ,parse=TRUE, color = "red", size = 5)


```



Here, We will overlay the different maps  to get 
1. 'best' watersheds in the baseline
2. most climate vulnerable (ie which have the biggest negative change)
3. most climate resistent (ie which have the least negative change)
4. which have the biggest increase in positive change with the mgmt scenario

```{r}
#1. 
#first we need to standardize each of the ratios so that the 'larger' ratios are not considered more important than the 'smaller' ratios

#make a matrix of all the ratio columns and then scale them and then add them together and then cbind back to the HUC12 and plot
#there are two ways I am going to look at best:
#1. the watersheds that maximize the fish origin ratio and the mussel spp richess 
#2. the watersheds that maximuz the spp that might be most vulnerable to cliamte change (fish temp, fish habitat, mussel size, mussel strat)

#this looks at the ratios of combined groups in the baseline
df <- scale(as.matrix(data.frame(
  "x1" = shp_origin$origin_ratio,
  "x2" = shp_habitat$habitat_ratio,
  "x3" = shp_temp$ratio,
  "x4" =  shp_status$status_ratio,
  "x5" = shp_host$host_ratio,
  "x6" = shp_size$ratio,
  "x7" = shp_strat$ratio,
  "x8" = richness_baseline$richness,
  "x9" = shp_rank$ratio,
  "x10" = shp_shell$ratio,
  "x11" = shp_musselhabitat$ratio)))

#native fish and mussel richness
native <- data.frame(df) %>% 
  mutate(native = x1 +x8)

#FS fish and mussel
habitat <- data.frame(df) %>% 
  mutate(habitat = x2 + x11)

#cold water fish and thin shelled mussels
climvul <- data.frame(df) %>% 
  mutate(climvul = x3 + x10)

# best <- data.frame(df) %>% 
#   mutate(best = x1 + x2 + x3 + x4 + x5 + x6 + x7 + x8)

huc12 <- st_read("C:/Users/jenrogers/Documents/necascFreshwaterBio/SpatialData/NHDplus/WBDHU12/WBDHU12_NE.shp")

huc12$native <- native$native
huc12$climvul <- climvul$climvul
huc12$habitat <- habitat$habitat

aaaa <- ggplot(data = huc12)+
  geom_sf(aes(fill = native), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = 1,
                       limits = c(-3,4.2))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 7),
        legend.title = element_text(size = 10))+
    ggtitle(label = "A. Native")+
  labs(fill = "Sum")

bbbb <- ggplot(data = huc12)+
  geom_sf(aes(fill = climvul), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = 3.3,
                       limits = c(-3,10.3))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 7),
        legend.title = element_text(size = 10))+
    ggtitle(label = "B. Vulnerable")+
  labs(fill = "Sum")

cccc <- ggplot(data = huc12)+
  geom_sf(aes(fill = habitat), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = 1.5,
                       limits = c(-3,7.4))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 7),
        legend.title = element_text(size = 10))+
    ggtitle(label = "C. Lotic Dependent")+
  labs(fill = "Sum")


load("C:/Users/jenrogers/Documents/necascFreshwaterBio/model_datafiles/NHDplusV2_NewEngCrop_mussel_covariates_HUC12.RData")
NHDplusV2_NewEngCrop_mussel_covariates_HUC12 <- NHDplusV2_NewEngCrop_mussel_covariates_HUC12 %>%  
  mutate(latitude  = ifelse(lat > 44.51944, "High latitude",
                            ifelse(lat < 42.97004, "Low latitude", "Mid latitude"))) %>% 
  mutate(elevation  = ifelse(ElevCat > 181.4322 , "High elevation", "Low elevation")) 

NHDplusV2_NewEngCrop_mussel_covariates_HUC12$latitude <- 
  factor(NHDplusV2_NewEngCrop_mussel_covariates_HUC12$latitude, levels = c("Low latitude", "Mid latitude", "High latitude"))

NHDplusV2_NewEngCrop_mussel_covariates_HUC12$elevation <- 
  factor(NHDplusV2_NewEngCrop_mussel_covariates_HUC12$elevation, levels = c("Low elevation", "Mid elevation", "High elevation"))


huc12 <- left_join(huc12, NHDplusV2_NewEngCrop_mussel_covariates_HUC12, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  filter(!is.na(elevation),
         !is.na(latitude)) 
huc12describe <- huc12 %>% 
  data.frame() %>% 
  group_by(elevation, latitude) %>% 
  summarise(native = mean(native, na.rm = T))
huc12describe <- huc12 %>% 
  data.frame() %>% 
  group_by(elevation, latitude) %>% 
  summarise(climvul = mean(climvul, na.rm = T))
huc12describe <- huc12 %>% 
  data.frame() %>% 
  group_by(elevation, latitude) %>% 
  summarise(habitat = mean(habitat, na.rm = T))


#2. most climate vulnerable (ie which have the biggest negative change)
#this looks at the ratios of vulnerable to not vulnerable
df <- scale(as.matrix(data.frame(
  "x1" = shp_origin_chng$origin_ratio_change,
  "x2" = shp_habitat_chng$habitat_ratio_change,
  "x3" = shp_temp_chng$temp_ratio_change,
  "x4" = shp_status_chng$status_ratio_change,
  "x5" = shp_host_chng$host_ratio_change,
  "x6" = shp_size_chng$ratio,
  "x7" = shp_strat_chng$strat_ratio_change,
  "x8" = change_richness$richness_change,
  "x9" = shp_rank_chng$rank_ratio_change,
  "x10" = shp_shell_chng$shell_ratio_change,
  "x11" = shp_musselhabitat_chng$musselhabitat_ratio_change)))


native <- data.frame(df) %>% 
  mutate(native = x1 +x8)

climvul <- data.frame(df) %>% 
  mutate(climvul = x3 + x10)

habitat <- data.frame(df) %>% 
  mutate(habitat = x2 + x11)

huc12 <- st_read("C:/Users/jenrogers/Documents/necascFreshwaterBio/SpatialData/NHDplus/WBDHU12/WBDHU12_NE.shp")


huc12$native <- native$native
huc12$climvul <- climvul$climvul
huc12$habitat <- habitat$habitat

dddd <- ggplot(data = huc12)+
  geom_sf(aes(fill = native), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "white",
                        high = "red",
                        midpoint = 0,
                       limits = c(-6,3.4))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 7),
        legend.title = element_text(size = 10))+
    ggtitle(label = "D. Native")+
  labs(fill = "Sum")

eeee <- ggplot(data = huc12)+
  geom_sf(aes(fill = climvul), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "white",
                        high = "red",
                        midpoint = 0,
                       limits = c(-5,10))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 7),
        legend.title = element_text(size = 10))+
    ggtitle(label = "E. Vulnerable")+
  labs(fill = "Sum")

ffff <- ggplot(data = huc12)+
  geom_sf(aes(fill = habitat), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "white",
                        high = "red",
                        midpoint = 0,
                       limits = c(-9,3))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 7),
        legend.title = element_text(size = 10))+
    ggtitle(label = "F. Lotic Dependent")+
  labs(fill = "Sum")

fig4 <- gridExtra::grid.arrange(aaaa,bbbb,cccc, dddd, eeee, ffff, nrow = 2, ncol = 3)
ggsave(fig4, file = "tmpfigures/paper2/fig4_baseline_change_mussel_and_fish.png")

huc12 <- left_join(huc12, NHDplusV2_NewEngCrop_mussel_covariates_HUC12, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  filter(!is.na(elevation),
         !is.na(latitude)) 
huc12describe <- huc12 %>% 
  data.frame() %>% 
  group_by(elevation, latitude) %>% 
  summarise(native = mean(native, na.rm = T))
huc12describe <- huc12 %>% 
  data.frame() %>% 
  group_by(elevation, latitude) %>% 
  summarise(climvul = mean(climvul, na.rm = T))
huc12describe <- huc12 %>% 
  data.frame() %>% 
  group_by(elevation, latitude) %>% 
  summarise(habitat = mean(habitat, na.rm = T))



#make dot plot figure showing values of each metric (facet) by scenaio (color)

load("C:/Users/jenrogers/Documents/necascFreshwaterBio/model_datafiles/NHDv2_huc_state_join.RData")

df1 <- shp_habitat %>% 
  select(name, tnmid, taxa, scenario, grp, habitat_ratio) %>% 
  rename(ratio = habitat_ratio)
df2 <- shp_habitat_cc %>% 
  select(name, tnmid, taxa, scenario, grp, habitat_ratio) %>% 
  rename(ratio = habitat_ratio)
df3 <- shp_habitat_mg %>% 
  select(name, tnmid, taxa, scenario, grp, habitat_ratio) %>% 
  rename(ratio = habitat_ratio)
df4 <- shp_habitat_mg_cnt %>% 
  select(name, tnmid, taxa, scenario, grp, habitat_ratio) %>% 
  rename(ratio = habitat_ratio)
df4a <- shp_habitat_forest %>% 
  select(name, tnmid, taxa, scenario, grp, habitat_ratio) %>% 
  rename(ratio = habitat_ratio)
df4b <- shp_habitat_wetland %>% 
  select(name, tnmid, taxa, scenario, grp, habitat_ratio) %>% 
  rename(ratio = habitat_ratio)

df5 <- shp_origin %>% 
  select(name, tnmid, taxa, scenario, grp, origin_ratio) %>% 
  rename(ratio = origin_ratio)
df6 <- shp_origin_cc %>% 
  select(name, tnmid, taxa, scenario, grp, origin_ratio) %>% 
  rename(ratio = origin_ratio)
df7 <- shp_origin_mg %>% 
  select(name, tnmid, taxa, scenario, grp, origin_ratio) %>% 
  rename(ratio = origin_ratio)
df8 <- shp_origin_mg_cnt %>% 
  select(name, tnmid, taxa, scenario, grp, origin_ratio) %>% 
  rename(ratio = origin_ratio)
df8a <- shp_origin_forest %>% 
  select(name, tnmid, taxa, scenario, grp, origin_ratio) %>% 
  rename(ratio = origin_ratio)
df8b <- shp_origin_wetland %>% 
  select(name, tnmid, taxa, scenario, grp, origin_ratio) %>% 
  rename(ratio = origin_ratio)

df9 <- shp_temp %>% 
  select(name, tnmid, taxa, scenario, grp, ratio) 
df10 <- shp_temp_cc %>% 
  select(name, tnmid, taxa, scenario, grp, ratio)
df11 <- shp_temp_mg %>% 
  select(name, tnmid, taxa, scenario, grp, ratio) 
df12 <- shp_temp_mg_cnt %>% 
  select(name, tnmid, taxa, scenario, grp, ratio)
df12a <- shp_temp_forest %>% 
  select(name, tnmid, taxa, scenario, grp, ratio)
df12b <- shp_temp_wetland %>% 
  select(name, tnmid, taxa, scenario, grp, ratio)

df13 <- shp_status %>% 
  select(name, tnmid, taxa, scenario, grp, status_ratio)%>% 
  rename(ratio = status_ratio) 
df14 <- shp_status_cc %>% 
  select(name, tnmid, taxa, scenario, grp, status_ratio)%>% 
  rename(ratio = status_ratio)
df15 <- shp_status_mg %>% 
  select(name, tnmid, taxa, scenario, grp, status_ratio) %>% 
  rename(ratio = status_ratio)
df16 <- shp_status_mg_cnt %>% 
  select(name, tnmid, taxa, scenario, grp, status_ratio)%>% 
  rename(ratio = status_ratio)
df16a <- shp_status_forest %>% 
  select(name, tnmid, taxa, scenario, grp, status_ratio)%>% 
  rename(ratio = status_ratio)
df16b <- shp_status_wetland %>% 
  select(name, tnmid, taxa, scenario, grp, status_ratio)%>% 
  rename(ratio = status_ratio)

df17 <- shp_size %>% 
  select(name, tnmid, taxa, scenario, grp, ratio) 
df18 <- shp_size_cc %>% 
  select(name, tnmid, taxa, scenario, grp, ratio)
df19 <- shp_size_mg %>% 
  select(name, tnmid, taxa, scenario, grp, ratio)
df20 <- shp_size_mg_cnt %>% 
  select(name, tnmid, taxa, scenario, grp, ratio)
df20a <- shp_size_forest %>% 
  select(name, tnmid, taxa, scenario, grp, ratio)
df20b <- shp_size_wetland %>% 
  select(name, tnmid, taxa, scenario, grp, ratio)


df21 <- shp_strat %>% 
  select(name, tnmid, taxa, scenario, grp, ratio) 
df22 <- shp_strat_cc %>% 
  select(name, tnmid, taxa, scenario, grp, ratio)
df23 <- shp_strat_mg %>% 
  select(name, tnmid, taxa, scenario, grp, ratio)
df24 <- shp_strat_mg_cnt %>% 
  select(name, tnmid, taxa, scenario, grp, ratio)
df24a <- shp_strat_forest %>% 
  select(name, tnmid, taxa, scenario, grp, ratio)
df24b <- shp_strat_wetland %>% 
  select(name, tnmid, taxa, scenario, grp, ratio)


df29 <- shp_rank %>% 
  select(name, tnmid, taxa, scenario, grp, ratio) 
df30 <- shp_rank_cc %>% 
  select(name, tnmid, taxa, scenario, grp, ratio)
df31 <- shp_rank_mg %>% 
  select(name, tnmid, taxa, scenario, grp, ratio)
df32 <- shp_rank_mg_cnt %>% 
  select(name, tnmid, taxa, scenario, grp, ratio)
df33 <- shp_rank_forest %>% 
  select(name, tnmid, taxa, scenario, grp, ratio)
df34 <- shp_rank_wetland %>% 
  select(name, tnmid, taxa, scenario, grp, ratio)

df35 <- shp_shell %>% 
  select(name, tnmid, taxa, scenario, grp, ratio) 
df36 <- shp_shell_cc %>% 
  select(name, tnmid, taxa, scenario, grp, ratio)
df37 <- shp_shell_mg %>% 
  select(name, tnmid, taxa, scenario, grp, ratio)
df38 <- shp_shell_mg_cnt %>% 
  select(name, tnmid, taxa, scenario, grp, ratio)
df39 <- shp_shell_forest %>% 
  select(name, tnmid, taxa, scenario, grp, ratio)
df40 <- shp_shell_wetland %>% 
  select(name, tnmid, taxa, scenario, grp, ratio)

df41 <- shp_musselhabitat %>% 
  select(name, tnmid, taxa, scenario, grp, ratio) 
df42 <- shp_musselhabitat_cc %>% 
  select(name, tnmid, taxa, scenario, grp, ratio)
df43 <- shp_musselhabitat_mg %>% 
  select(name, tnmid, taxa, scenario, grp, ratio)
df44 <- shp_musselhabitat_mg_cnt %>% 
  select(name, tnmid, taxa, scenario, grp, ratio)
df45 <- shp_musselhabitat_forest %>% 
  select(name, tnmid, taxa, scenario, grp, ratio)
df46 <- shp_musselhabitat_wetland %>% 
  select(name, tnmid, taxa, scenario, grp, ratio)

df25 <- richness_baseline %>% 
  select(name, tnmid, taxa, scenario, grp, richness) 
df26 <- richness_cc %>% 
  select(name, tnmid, taxa, scenario, grp, richness)
df27 <- richness_mg %>% 
  select(name, tnmid, taxa, scenario, grp, richness)
df28 <- richness_mg_cnt %>% 
  select(name, tnmid, taxa, scenario, grp, richness)
df28a <- richness_forest %>% 
  select(name, tnmid, taxa, scenario, grp, richness)
df28b <- richness_wetland %>% 
  select(name, tnmid, taxa, scenario, grp, richness)



final <- rbind(df1,df2, df3, df4, df4a, df4b, df5, df6, df7, df8, df8a, df8b, df9, df10, df11, df12, df12a, df12b, 
               df13, df14, df15, df16, df16a, df16b, df17, df18, df19, df20, df20a, df20b, df21, df22, df23,
               df24, df24a, df24b, df29, df30, df31, df32,df33, df34,
               df35, df36, df37, df38, df39, df40, df41, df42, df43, df44, df45, df46)
final$scenario <- str_to_title(final$scenario)
final$grp <- str_to_title(final$grp)

richness <- rbind(df25, df26, df27, df28, df28a, df28b)
richness$scenario <- str_to_title(richness$scenario)


load("C:/Users/jenrogers/Documents/necascFreshwaterBio/model_datafiles/NHDplusV2_NewEngCrop_mussel_covariates_HUC12.RData")
NHDplusV2_NewEngCrop_mussel_covariates_HUC12 <- NHDplusV2_NewEngCrop_mussel_covariates_HUC12 %>%  
  mutate(latitude  = ifelse(lat > 44.51944, "High latitude",
                            ifelse(lat < 42.97004, "Low latitude", "Mid latitude"))) %>% 
  mutate(elevation  = ifelse(ElevCat > 181.4322 , "High elevation", "Low elevation")) 

NHDplusV2_NewEngCrop_mussel_covariates_HUC12$latitude <- 
  factor(NHDplusV2_NewEngCrop_mussel_covariates_HUC12$latitude, levels = c("Low latitude", "Mid latitude", "High latitude"))

NHDplusV2_NewEngCrop_mussel_covariates_HUC12$elevation <- 
  factor(NHDplusV2_NewEngCrop_mussel_covariates_HUC12$elevation, levels = c("Low elevation", "Mid elevation", "High elevation"))


final <- left_join(final, NHDplusV2_NewEngCrop_mussel_covariates_HUC12, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  filter(!is.na(elevation),
         !is.na(latitude)) 

ggplot(data = final[final$taxa == "fish",], aes(x = grp, y = ratio, fill = scenario), color = "black")+
  geom_boxplot(position=position_dodge(width=.75),
               outlier.size = 0.1,
               outlier.colour = "grey50")+
  geom_hline(yintercept = 1, color= "red", linetype = "dashed")+
  coord_flip(ylim = c(0, 7))+
  theme(panel.border = element_rect(colour = "black", fill = NA),
        axis.text = element_text(size = 10),
        axis.title = element_text(size = 15),
        axis.title.y = element_blank(),
        title = element_text(size = 15))+
  labs(y = "Ratio")+
  facet_wrap(~elevation)
ggsave(
    filename = "C:/Users/jenrogers/Documents/git/FreshwaterBio/FreshwaterBio/tmpfigures/paper2/fishcompare.png",
    plot = last_plot(),
    width = 19,
    height = 10,
    units = "cm",
    dpi = 200
  )

ggplot(data = final[final$taxa == "mussel",], aes(x = grp, y = ratio, fill = scenario), color = "black")+
  geom_boxplot(position=position_dodge(width=.75),
               outlier.size = 0.1,
               outlier.colour = "grey50")+
  geom_hline(yintercept = 1, color= "red", linetype = "dashed")+
  coord_flip(ylim = c(0, 4))+
  theme(panel.border = element_rect(colour = "black", fill = NA),
        axis.text = element_text(size = 10),
        axis.title = element_text(size = 15),
        axis.title.y = element_blank(),
        title = element_text(size = 15))+
  labs(y = "Ratio")+
  facet_wrap(~elevation)
ggsave(
    filename = "C:/Users/jenrogers/Documents/git/FreshwaterBio/FreshwaterBio/tmpfigures/paper2/musselcompare.png",
    plot = last_plot(),
    width = 19,
    height = 10,
    units = "cm",
    dpi = 200
  )


richness2 <- left_join(richness, NHDplusV2_NewEngCrop_mussel_covariates_HUC12, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  filter(!is.na(elevation),
         !is.na(latitude)) 

ggplot(data = richness2[richness2$taxa == "mussel",], aes(x = scenario, y = richness), color = "black")+
  geom_boxplot(outlier.size = 0.1,
               outlier.colour = "grey50")+
  coord_flip(ylim = c(0, 10))+
  theme(panel.border = element_rect(colour = "black", fill = NA),
        axis.text = element_text(size = 10),
        axis.title = element_text(size = 15),
        axis.title.y = element_blank(),
        title = element_text(size = 15))+
  labs(y = "Richness")+
  facet_wrap(~elevation)
ggsave(
    filename = "C:/Users/jenrogers/Documents/git/FreshwaterBio/FreshwaterBio/tmpfigures/paper2/musselrichnesscompare.png",
    plot = last_plot(),
    width = 19,
    height = 10,
    units = "cm",
    dpi = 200
  )
stats <- richness2 %>% 
  data.frame() %>% 
  select(elevation, taxa, grp, scenario, richness) %>% 
  filter(!is.na(richness)) %>% 
  group_by(elevation, taxa, grp, scenario) %>% 
  summarise(mean = mean(richness)) %>% 
  arrange(elevation, taxa, grp, scenario)


stats <- final %>% 
  data.frame() %>% 
  select(elevation, taxa, grp, scenario, ratio) %>% 
  filter(!is.na(ratio)) %>% 
  group_by(elevation, taxa, grp, scenario) %>% 
  summarise(grt = round((sum(ratio >1)/n()),5),
            mean = mean(ratio)) %>% 
  arrange(elevation, taxa, grp, scenario)

#calculate p values between baseline and climate change ratios
fishhigh <- final %>%
  data.frame() %>% 
  filter(elevation == "High elevation" & taxa == "fish")
t.test(fishhigh[fishhigh$grp == "temp" & fishhigh$scenario == "baseline",]$ratio, 
       fishhigh[fishhigh$grp == "temp" & fishhigh$scenario == "cc",]$ratio, conf.level = 0.9972222)
t.test(fishhigh[fishhigh$grp == "habitat" & fishhigh$scenario == "baseline",]$ratio, 
       fishhigh[fishhigh$grp == "habitat" & fishhigh$scenario == "cc",]$ratio, conf.level = 0.9972222)
t.test(fishhigh[fishhigh$grp == "origin" & fishhigh$scenario == "baseline",]$ratio, 
       fishhigh[fishhigh$grp == "origin" & fishhigh$scenario == "cc",]$ratio, conf.level = 0.9972222)


#calculate p values between climate change and connectivity ratios
t.test(fishhigh[fishhigh$grp == "temp" & fishhigh$scenario == "cnt",]$ratio, 
       fishhigh[fishhigh$grp == "temp" & fishhigh$scenario == "cc",]$ratio, conf.level = 0.9972222)
t.test(fishhigh[fishhigh$grp == "habitat" & fishhigh$scenario == "cnt",]$ratio, 
       fishhigh[fishhigh$grp == "habitat" & fishhigh$scenario == "cc",]$ratio, conf.level = 0.9972222)
t.test(fishhigh[fishhigh$grp == "origin" & fishhigh$scenario == "cnt",]$ratio, 
       fishhigh[fishhigh$grp == "origin" & fishhigh$scenario == "cc",]$ratio, conf.level = 0.95)


#now we want to average the values for 'habitat' 'vulnerability' and 'all' and make the boxplots again (numbers will be meaningless because they will have been scaled)
#we need to scale each scenario using the baseline mean and sd values
#scale the variables using the means and sd used to scale the variables in the baseline condition


df <- data.frame(
  "x1" = shp_origin$origin_ratio,
  "x2" = shp_habitat$habitat_ratio,
  "x3" = shp_temp$ratio,
  "x4" =  shp_status$status_ratio,
  "x5" = shp_host$host_ratio,
  "x6" = shp_size$ratio,
  "x7" = shp_strat$ratio,
  "x8" = shp_rank$ratio,
  "x9" = shp_shell$ratio,
  "x10" = shp_musselhabitat$ratio,
  "x11" = richness_baseline$richness)

means <- sapply(df, mean, na.rm = T)
sd <- sapply(df, sd, na.rm = T)
df <- data.frame(scale(as.matrix(df)))
  
df2 <- data.frame(
  "x12" = shp_origin_cc$origin_ratio,
  "x13" = shp_habitat_cc$habitat_ratio,
  "x14" = shp_temp_cc$ratio,
  "x15" =  shp_status_cc$status_ratio,
  "x16" = shp_host_cc$host_ratio,
  "x17" = shp_size_cc$ratio,
  "x18" = shp_strat_cc$ratio,
  "x19" = shp_rank_cc$ratio,
  "x20" = shp_shell_cc$ratio,
  "x21" = shp_musselhabitat_cc$ratio,
  "x22" = richness_cc$richness)
  
df2 <- sweep(df2, 2, means, FUN = '-') 
df2 <- sweep(df2, 2, sd, FUN = '/') 
 
  
  df3 <- data.frame(
  "x23" = shp_origin_mg$origin_ratio,
  "x24" = shp_habitat_mg$habitat_ratio,
  "x25" = shp_temp_mg$ratio,
  "x26" =  shp_status_mg$status_ratio,
  "x27" = shp_host_mg$host_ratio,
  "x28" = shp_size_mg$ratio,
  "x29" = shp_strat_mg$ratio,
  "x30" = shp_rank_mg$ratio,
  "x31" = shp_shell_mg$ratio,
  "x32" = shp_musselhabitat_mg$ratio,
  "x33" = richness_mg$richness)
df3 <- sweep(df3, 2, means, FUN = '-') 
df3 <- sweep(df3, 2, sd, FUN = '/') 
   
  
df4 <- data.frame(
  "x34" = shp_origin_mg_cnt$origin_ratio,
  "x35" = shp_habitat_mg_cnt$habitat_ratio,
  "x36" = shp_temp_mg_cnt$ratio,
  "x37" =  shp_status_mg_cnt$status_ratio,
  "x38" = shp_host_mg_cnt$host_ratio,
  "x39" = shp_size_mg_cnt$ratio,
  "x40" = shp_strat_mg_cnt$ratio,
  "x41" = shp_rank_mg_cnt$ratio,
  "x42" = shp_shell_mg_cnt$ratio,
  "x43" = shp_musselhabitat_mg_cnt$ratio,
  "x44" = richness_mg_cnt$richness)

df4 <- sweep(df4, 2, means, FUN = '-') 
df4 <- sweep(df4, 2, sd, FUN = '/') 


df5 <- data.frame(
  "x45" = shp_origin_forest$origin_ratio,
  "x46" = shp_habitat_forest$habitat_ratio,
  "x47" = shp_temp_forest$ratio,
  "x48" = shp_status_forest$status_ratio,
  "x49" = shp_host_forest$host_ratio,
  "x50" = shp_size_forest$ratio,
  "x51" = shp_strat_forest$ratio,
  "x52" = shp_rank_forest$ratio,
  "x53" = shp_shell_forest$ratio,
  "x54" = shp_musselhabitat_forest$ratio,
  "x55" = richness_forest$richness)
  
df5 <- sweep(df5, 2, means, FUN = '-') 
df5 <- sweep(df5, 2, sd, FUN = '/') 



df6 <- data.frame(
  "x56" = shp_origin_wetland$origin_ratio,
  "x57" = shp_habitat_wetland$habitat_ratio,
  "x58" = shp_temp_wetland$ratio,
  "x59" =  shp_status_wetland$status_ratio,
  "x60" = shp_host_wetland$host_ratio,
  "x61" = shp_size_wetland$ratio,
  "x62" = shp_strat_wetland$ratio,
  "x63" = shp_rank_wetland$ratio,
  "x64" = shp_shell_wetland$ratio,
  "x65" = shp_musselhabitat_wetland$ratio,
  "x66" = richness_wetland$richness)
  
df6 <- sweep(df6, 2, means, FUN = '-') 
df6 <- sweep(df6, 2, sd, FUN = '/') 

df <- cbind(df, df2, df3, df4, df5, df6)



new2 <- df %>% 
  mutate(native_baseline = x1 + x11,
         native_cc = x12 + x22,
         native_mg = x23 + x33,
         native_cnt = x34 + x44,
         native_forest = x45 + x55,
         native_wetland = x56 + x66,
         
         vul_baseline = x3 + x9,
         vul_cc = x14 + x20,
         vul_mg = x25 + x31,
         vul_cnt = x36 + x42,
         vul_forest = x47 + x53,
         vul_wetland = x58 +x64,
        
         habitat_baseline = x2 +x10,
         habitat_cc = x13 + x21,
         habitat_mg = x24 + x32,
         habitat_cnt =  x35 + x43,
         habitat_forest = x46 + x54,
         habitat_wetland = x57 +x65
         ) %>% 
  select(67:84) %>% 
  pivot_longer(cols = 1:18, values_to = "value", names_to = "grp_scenario") %>% 
  separate(grp_scenario, sep = "_", into = c("grp", "scenario")) %>% 
  filter(!is.na(value))

ggplot(data = new2, aes(x = grp, y = value, fill = scenario), color = "black")+
  geom_boxplot(position=position_dodge(width=.75),
               outlier.size = 0.1,
               outlier.colour = "grey50")+
  coord_flip(ylim = c(-3, 5))+
  theme(panel.border = element_rect(colour = "black", fill = NA),
        axis.text = element_text(size = 10),
        axis.title = element_text(size = 15),
        axis.title.y = element_blank(),
        title = element_text(size = 15))+
  labs(y = "Value")

ggsave(
    filename = "C:/Users/jenrogers/Documents/git/FreshwaterBio/FreshwaterBio/tmpfigures/paper2/Fig8.png",
    plot = last_plot(),
    width = 19,
    height = 10,
    units = "cm",
    dpi = 200
  )


```


Here we calcualte some summary stats for the manuscript
```{r}

load("C:/Users/jenrogers/Documents/necascFreshwaterBio/model_datafiles/NHDplusV2_NewEngCrop_mussel_covariates_HUC12.RData")
NHDplusV2_NewEngCrop_mussel_covariates_HUC12 <- NHDplusV2_NewEngCrop_mussel_covariates_HUC12 %>%  
  mutate(latitude  = ifelse(lat > 44.51944, "High latitude",
                            ifelse(lat < 42.97004, "Low latitude", "Mid latitude"))) %>% 
  mutate(elevation  = ifelse(ElevCat > 181.4322 , "High elevation", "Low elevation")) %>% 
  mutate(longitude  = ifelse(long > -71.27307, "East", "West")) 

NHDplusV2_NewEngCrop_mussel_covariates_HUC12$latitude <- 
  factor(NHDplusV2_NewEngCrop_mussel_covariates_HUC12$latitude, levels = c("Low latitude", "Mid latitude", "High latitude"))
NHDplusV2_NewEngCrop_mussel_covariates_HUC12$elevation <- 
  factor(NHDplusV2_NewEngCrop_mussel_covariates_HUC12$elevation, levels = c("Low elevation", "Mid elevation", "High elevation"))


#fish origin  
df <- left_join(df_origin_baseline, NHDplusV2_NewEngCrop_mussel_covariates_HUC12, by = c("huc12_name", "huc12_tnmid")) %>% 
  select(origin_ratio, latitude, longitude, elevation, huc12_name, huc12_tnmid) 

summary(df_origin_baseline$origin_ratio)

ggplot(data = df, mapping = aes(x = elevation, y = origin_ratio))+
  geom_boxplot(outlier.size = .5, outlier.colour = "grey80")+ 
    labs(x = "Grouping", y = "Origin Ratio")
df_high <- df %>% 
  group_by(latitude) %>% 
  summarise(mean = mean(origin_ratio))




#fish habitat
df <- left_join(df_habitat_baseline, NHDplusV2_NewEngCrop_mussel_covariates_HUC12, by = c("huc12_name", "huc12_tnmid")) %>% 
  select(habitat_ratio, latitude, longitude, elevation, huc12_name, huc12_tnmid) 

summary(df_habitat_baseline$habitat_ratio)

ggplot(data = df, mapping = aes(x = elevation, y = habitat_ratio))+
  geom_boxplot(outlier.size = .5, outlier.colour = "grey80")+ 
    labs(x = "Grouping", y = "Habitat Ratio")
df_high <- df %>% 
  group_by(elevation) %>% 
  summarise(mean = mean(habitat_ratio))


#fish temp baseline
df <- left_join(df_temp_baseline, NHDplusV2_NewEngCrop_mussel_covariates_HUC12, by = c("huc12_name", "huc12_tnmid")) %>% 
  select(ratio, latitude, longitude, elevation, huc12_name, huc12_tnmid) 

summary(df_temp_baseline$ratio)

ggplot(data = df, mapping = aes(x = elevation, y = ratio))+
  geom_boxplot(outlier.size = .5, outlier.colour = "grey80")+ 
    labs(x = "Grouping", y = "Temp Ratio")
df_high <- df %>% 
  group_by(elevation) %>% 
  summarise(mean = mean(ratio))


#mussel status
df <- left_join(df_status_baseline, NHDplusV2_NewEngCrop_mussel_covariates_HUC12, by = c("huc12_name", "huc12_tnmid")) %>% 
  select(status_ratio, latitude, longitude, elevation, huc12_name, huc12_tnmid) 

summary(df_status_baseline$status_ratio)

ggplot(data = df, mapping = aes(x = elevation, y = status_ratio))+
  geom_boxplot(outlier.size = .5, outlier.colour = "grey80")+ 
    labs(x = "Grouping", y = "Temp Ratio")
df_high <- df %>% 
  group_by(elevation) %>% 
  summarise(mean = mean(status_ratio))
nrow(df[df$status_ratio > 1,])/nrow(df)
test <- df[df$status_ratio > 1,]


#mussel size
df <- left_join(df_size_baseline, NHDplusV2_NewEngCrop_mussel_covariates_HUC12, by = c("huc12_name", "huc12_tnmid")) %>% 
  select(ratio, latitude, longitude, elevation, huc12_name, huc12_tnmid) 

summary(df_size_baseline$ratio)

ggplot(data = df, mapping = aes(x = elevation, y = ratio))+
  geom_boxplot(outlier.size = .5, outlier.colour = "grey80")+ 
    labs(x = "Grouping", y = "Size Ratio")
df_high <- df %>% 
  group_by(elevation) %>% 
  summarise(mean = mean(ratio))
nrow(df[df$ratio > 1,])/nrow(df)




#mussel host
df <- left_join(df_host_baseline, NHDplusV2_NewEngCrop_mussel_covariates_HUC12, by = c("huc12_name", "huc12_tnmid")) %>% 
  select(host_ratio, latitude, longitude, elevation, huc12_name, huc12_tnmid) 

summary(df_host_baseline$host_ratio)

ggplot(data = df, mapping = aes(x = elevation, y = host_ratio))+
  geom_boxplot(outlier.size = .5, outlier.colour = "grey80")+ 
    labs(x = "Grouping", y = "Host Ratio")+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        axis.text = element_text(size = 8),
        axis.title = element_text(size = 12))
df_high <- df %>% 
  group_by(elevation) %>% 
  summarise(mean = mean(host_ratio))
nrow(df[df$host_ratio > 1,])/nrow(df)
test <- df[df$host_ratio > 1,]
  
#mussel life history strat
df <- left_join(df_strat_baseline, NHDplusV2_NewEngCrop_mussel_covariates_HUC12, by = c("huc12_name", "huc12_tnmid")) %>% 
  select(ratio, latitude, longitude, elevation, huc12_name, huc12_tnmid) 

summary(df_strat_baseline$ratio)

ggplot(data = df, mapping = aes(x = elevation, y = ratio))+
  geom_boxplot(outlier.size = .5, outlier.colour = "grey80")
df_high <- df %>% 
  group_by(elevation) %>% 
  summarise(mean = mean(ratio))
nrow(df[df$ratio > 1,])/nrow(df)
test <- df[df$ratio < 1,]

#mussel richness
df <- left_join(richness_baseline, NHDplusV2_NewEngCrop_mussel_covariates_HUC12, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  select(richness, latitude, longitude, elevation, name, tnmid) 

summary(richness_baseline$richness)

ggplot(data = df, mapping = aes(x = elevation, y = richness))+
  geom_boxplot(outlier.size = .5, outlier.colour = "grey80")
df_high <- df %>% 
  data.frame() %>% 
  group_by(elevation) %>% 
  summarise(mean = mean(richness, na.rm=T))


```