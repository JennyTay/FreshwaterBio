---
title: "Fish_and_Mussel_Biodiversity_Assessment"
author: "Jenny Rogers"
date: "2023-11-29"
output: html_document
---

```{r}
library(tidyverse)
library(lubridate)
library(sf)
library(readxl)
```


Read in fish and mussel projections and trait data

```{r}
#spatial file
huc12 <- st_read("C:/Users/jenrogers/Documents/necascFreshwaterBio/SpatialData/NHDplus/WBDHU12/WBDHU12_NE.shp")


#mussel predictions

load('ProjectResults/mussel_CC2080_proboccurrence.RData')
load('ProjectResults/mussel_baseline_proboccurrence.RData')
load('ProjectResults/mussel_CC2080_landcover_mgmt_proboccurrence.RData')
load('ProjectResults/mussel_CC2080_connectivity_mgmt_proboccurrence.RData')
load('ProjectResults/mussel_CC2080_forest_proboccurrence.RData')
load('ProjectResults/mussel_CC2080_landcover_impervious_proboccurrence.RData')
load('ProjectResults/mussel_CC2080_landcover_natural_proboccurrence.RData')

#fish predictions

load('ProjectResults/fish_cc_proboccurrence.RData')
load('ProjectResults/fish_baseline_proboccurrence.RData')
load('ProjectResults/fish_mg_cnt_proboccurrence.RData')
load('ProjectResults/fish_mg_proboccurrence.RData')
load('ProjectResults/fish_forest_proboccurrence.RData')
load('ProjectResults/fish_impervious_proboccurrence.RData')
load('ProjectResults/fish_natural_proboccurrence.RData')


#fish traits
load("C:/Users/jenrogers/Documents/necascFreshwaterBio/model_datafiles/fish_traits.RData")
temperature <- read_xlsx("C:/Users/jenrogers/Documents/necascFreshwaterBio/spp_data/thermalpref_origin_tolerance.xlsx",
                  sheet = 1,
                  range = cell_cols("A:G")) %>% 
  pivot_longer(2:7, names_to = "state", values_to = "tmp") %>% 
  filter(!is.na(tmp),
         !tmp == "eury",
         !(common_name %in% c("american brook lamprey") & tmp == "cold"),
         !(common_name %in% c("common shiner", "white sucker", "smallmouth bass", "fallfish") & tmp == "warm")) %>% 
  select(-state) %>% 
  unique()

origin <- read_xlsx("C:/Users/jenrogers/Documents/necascFreshwaterBio/spp_data/thermalpref_origin_tolerance.xlsx",
                  sheet = 2,
                  range = cell_cols("A:G"))%>% 
  pivot_longer(2:7, names_to = "state", values_to = "origin") %>% 
  filter(!is.na(origin),
         !(common_name == "spottail shiner" & origin == "introduced"),
         !origin == "unk") %>% 
  select(-state) %>%  
  unique()



#mussel traits
mussel_traits <- read_xlsx("C:/Users/jenrogers/Documents/necascFreshwaterBio/spp_data/mussel_traits.xlsx",
                           range = cell_cols("A:J")) %>% 
  filter(!is.na(common_name)) 
names(mussel_traits) <- c("common_name", "scientific_name", "status", "host", "size", "strat", "rank", "shell", "habitat", "brood")
# 
# mussel_traits_print <- mussel_traits %>%
#   select(common_name, scientific_name, size, shell, status, rank, host, strat, habitat) %>%
#   arrange(size, shell, status, rank, host, strat, habitat) %>%
#   mutate(common_name = str_to_title(common_name))
# write.csv(mussel_traits_print, "tmpfigures/paper2/musselgroups.csv")


#Fish clusters _bytemperature and _bystreamflow
cluster_temp <- read.csv("tmpfigures/fishclusters_bytemperature.csv")
cluster_temp <- cluster_temp %>% 
  select(-1) %>% 
  rename(cluster_TP = final.cluster)

cluster_flow <- read.csv("tmpfigures/fishclusters_bystreamflow.csv")
cluster_flow <- cluster_flow %>% 
  select(-1) %>% 
  rename(cluster_SF = final.cluster)

#mussel clusters 
cluster_mussel_flood <- read_excel("tmpfigures/musselclusters_manual.xlsx", sheet = 1)
cluster_mussel_temp <- read_excel("tmpfigures/musselclusters_manual.xlsx", sheet = 2)


```



Describe fish biodiversity
```{r}


#Baseline

fish_baseline_proboccurrence_huc12$common_name <- gsub(pattern = ".rds", replacement = "", x = fish_baseline_proboccurrence_huc12$common_name)
fish_baseline_proboccurrence_huc12$common_name <- gsub(pattern = "pres_", replacement = "", x = fish_baseline_proboccurrence_huc12$common_name)
fish_baseline_proboccurrence_huc12$common_name <- gsub(pattern = "\\.", replacement = " ", x = fish_baseline_proboccurrence_huc12$common_name)

#set all values less than 0.01 to be 0.01 to keep ratios reasonable
fish_baseline_proboccurrence_huc12$mean_prob_occ[fish_baseline_proboccurrence_huc12$mean_prob_occ<0.01] <- 0.01

#1)	Total summed probabilities of native species divided by the total summed probabilities of introduced species.

df_origin_baseline <- fish_baseline_proboccurrence_huc12 %>% 
  left_join(origin, by = "common_name") %>%
  filter(!is.na(origin)) %>% 
  group_by(huc12_name, huc12_tnmid, origin) %>% 
  summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
  pivot_wider(names_from = origin, values_from = total_summed_prob) %>% 
  mutate(origin_ratio = native/introduced)

shp_origin <- left_join(huc12, df_origin_baseline, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  mutate(taxa = "fish",
         scenario = "baseline",
         grp = "origin")

a <- ggplot(data = shp_origin)+
  geom_sf(aes(fill = origin_ratio), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = 14,
                       limits = c(1,27))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 7),
        legend.title = element_text(size = 10),
        legend.position = c(0.78, 0.21),
        legend.key.size = unit(.25, "cm"))+
    ggtitle(label = "A. Native:Introduced")+
  labs(fill = "Ratio")

summary(shp_origin$origin_ratio)  
  



#2)	Total summed probabilities of fluvial specialist and fluvial dependent species divided by the total summed probabilities of macrohabitat generalist species.
df_habitat_baseline <- fish_baseline_proboccurrence_huc12 %>% 
  left_join(final_traits, by = "common_name") %>%  
  filter(!is.na(tolerance)) %>%
  select(-c("strategy", "timing", "velocity")) %>% 
  group_by(huc12_name, huc12_tnmid, tolerance) %>% 
  summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
  pivot_wider(names_from = tolerance, values_from = total_summed_prob) %>% 
  mutate(habitat_ratio = (`fluvial specialist` + `fluvial dependent`) / generalist)

shp_habitat <- left_join(huc12, df_habitat_baseline, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  mutate(taxa = "fish",
         scenario = "baseline",
         grp = "habitat")

b <- ggplot(data = shp_habitat)+
  geom_sf(aes(fill = habitat_ratio), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = 7.5,
                       limits = c(0,15))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 7),
        legend.title = element_text(size = 10),
        legend.position = c(0.78, 0.21),
        legend.key.size = unit(.25, "cm"))+
    ggtitle(label = "B. FS+FD:MG")+
  labs(fill = "Ratio")




#3)	Total summed probabilities of cold-water species divided by the total summed probabilities of warm-water species.
df_temp_baseline <- fish_baseline_proboccurrence_huc12 %>% 
  left_join(temperature, by = "common_name") %>%
  filter(!is.na(tmp)) %>% 
  group_by(huc12_name, huc12_tnmid, tmp) %>% 
  summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
  pivot_wider(names_from = tmp, values_from = total_summed_prob) %>% 
  mutate(ratio = (cold/warm))

shp_temp <- left_join(huc12, df_temp_baseline, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  mutate(taxa = "fish",
         scenario = "baseline",
         grp = "temp")

c <- ggplot(data = shp_temp)+
  geom_sf(aes(fill = ratio), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = 7.5,
                       limits = c(0,15))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 7),
        legend.title = element_text(size = 10),
        legend.position = c(0.78, 0.21),
        legend.key.size = unit(.25, "cm"))+
    ggtitle(label = "C. Cold:Warm")+
  labs(fill = "Ratio")




#4)	Total summed probabilities of temperature cluster 1
df_tempclust1_baseline <- fish_baseline_proboccurrence_huc12 %>% 
  left_join(cluster_temp, by = "common_name") %>%
  group_by(huc12_name, huc12_tnmid, cluster_TP) %>% 
  summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
  pivot_wider(names_from = cluster_TP, values_from = total_summed_prob)

shp_tempclust1 <- left_join(huc12, df_tempclust1_baseline, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  mutate(taxa = "fish",
         scenario = "baseline",
         grp = "temp")

d <- ggplot(data = shp_tempclust1)+
  geom_sf(aes(fill = `1`), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = 1.0,
                       limits = c(0,2.0))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 7),
        legend.title = element_text(size = 10),
        legend.position = c(0.78, 0.21),
        legend.key.size = unit(.3, "cm"))+
    ggtitle(label = "A. Temperature Cluster 1")+
  labs(fill = "Occ.")




#5)	Total summed probabilities of temperature cluster 5
df_tempclust5_baseline <- fish_baseline_proboccurrence_huc12 %>% 
  left_join(cluster_temp, by = "common_name") %>%
  group_by(huc12_name, huc12_tnmid, cluster_TP) %>% 
  summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
  pivot_wider(names_from = cluster_TP, values_from = total_summed_prob)

shp_tempclust5 <- left_join(huc12, df_tempclust5_baseline, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  mutate(taxa = "fish",
         scenario = "baseline",
         grp = "temp")

e <- ggplot(data = shp_tempclust5)+
  geom_sf(aes(fill = `5`), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = 1.6,
                       limits = c(0,3.2))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 7),
        legend.title = element_text(size = 10),
        legend.position = c(0.78, 0.21),
        legend.key.size = unit(.3, "cm"))+
    ggtitle(label = "B. Temperature Cluster 5")+
  labs(fill = "Occ.")


#6)	Total summed probabilities of flow cluster 6
df_flowclust6_baseline <- fish_baseline_proboccurrence_huc12 %>% 
  left_join(cluster_flow, by = "common_name") %>%
  group_by(huc12_name, huc12_tnmid, cluster_SF) %>% 
  summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
  pivot_wider(names_from = cluster_SF, values_from = total_summed_prob)

shp_flowclust6 <- left_join(huc12, df_flowclust6_baseline, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  mutate(taxa = "fish",
         scenario = "baseline",
         grp = "flow")

f <- ggplot(data = shp_flowclust6)+
  geom_sf(aes(fill = `6`), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = 1.8,
                       limits = c(0,3.7))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 7),
        legend.title = element_text(size = 10),
        legend.position = c(0.78, 0.21),
        legend.key.size = unit(.3, "cm"))+
    ggtitle(label = "C. Streamflow Cluster 6")+
  labs(fill = "Occ.")




############################################





#Climate Change

fish_cc_proboccurrence_huc12$common_name <- gsub(pattern = ".rds", replacement = "", x = fish_cc_proboccurrence_huc12$common_name)
fish_cc_proboccurrence_huc12$common_name <- gsub(pattern = "pres_", replacement = "", x = fish_cc_proboccurrence_huc12$common_name)
fish_cc_proboccurrence_huc12$common_name <- gsub(pattern = "\\.", replacement = " ", x = fish_cc_proboccurrence_huc12$common_name)

fish_cc_proboccurrence_huc12$mean_prob_occ[fish_cc_proboccurrence_huc12$mean_prob_occ<0.01] <- 0.01

#1)	Total summed probabilities of native species divided by the total summed probabilities of introduced species.
df_origin_cc <- fish_cc_proboccurrence_huc12 %>% 
  left_join(origin, by = "common_name") %>%
  filter(!is.na(origin)) %>% 
  group_by(huc12_name, huc12_tnmid, origin) %>% 
  summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
  pivot_wider(names_from = origin, values_from = total_summed_prob) %>% 
  mutate(origin_ratio = native/introduced)

shp_origin_cc <- left_join(huc12, df_origin_cc, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  mutate(taxa = "fish",
         scenario = "Climate Change",
         grp = "origin")

g <- ggplot(data = shp_origin_cc)+
  geom_sf(aes(fill = origin_ratio), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = 7,
                       limits = c(.99,15))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 15),
        legend.position = c(0.78, 0.21),
        legend.key.size = unit(.25, "cm"))+
    ggtitle(label = "Native:Introduced - CC")+
  labs(fill = "Ratio")

  
  



#2)	Total summed probabilities of fluvial specialist and fluvial dependent species divided by the total summed probabilities of macrohabitat generalist species.
df_habitat_cc <- fish_cc_proboccurrence_huc12 %>% 
  left_join(final_traits, by = "common_name") %>%  
  filter(!is.na(tolerance)) %>%
  select(-c("strategy", "timing", "velocity")) %>% 
  group_by(huc12_name, huc12_tnmid, tolerance) %>% 
  summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
  pivot_wider(names_from = tolerance, values_from = total_summed_prob) %>% 
  mutate(habitat_ratio = (`fluvial specialist` + `fluvial dependent`) / generalist)

shp_habitat_cc <- left_join(huc12, df_habitat_cc, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  mutate(taxa = "fish",
         scenario = "Climate Change",
         grp = "habitat") 

h <- ggplot(data = shp_habitat_cc)+
  geom_sf(aes(fill = habitat_ratio), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = 4,
                       limits = c(0,8))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 15),
        legend.position = c(0.78, 0.21),
        legend.key.size = unit(.25, "cm"))+
    ggtitle(label = "FS+FD:MG - CC")+
  labs(fill = "Ratio")




#3)	Total summed probabilities of cold-water species divided by the total summed probabilities of warm-water species.
df_temp_cc <- fish_cc_proboccurrence_huc12 %>% 
  left_join(temperature, by = "common_name") %>%
  filter(!is.na(tmp)) %>% 
  group_by(huc12_name, huc12_tnmid, tmp) %>% 
  summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
  pivot_wider(names_from = tmp, values_from = total_summed_prob) %>% 
  mutate(ratio = cold/warm)

shp_temp_cc <- left_join(huc12, df_temp_cc, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  mutate(taxa = "fish",
         scenario = "Climate Change",
         grp = "temp")

i <- ggplot(data = shp_temp_cc)+
  geom_sf(aes(fill = ratio), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = 3.25,
                       limits = c(0,6.5))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 15),
        legend.position = c(0.78, 0.21),
        legend.key.size = unit(.25, "cm"))+
    ggtitle(label = "Cold:Warm - CC")+
  labs(fill = "Ratio")




#4)	Total summed probabilities of temperature cluster 1
df_tempclust1_cc <- fish_cc_proboccurrence_huc12 %>% 
  left_join(cluster_temp, by = "common_name") %>%
  group_by(huc12_name, huc12_tnmid, cluster_TP) %>% 
  summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
  pivot_wider(names_from = cluster_TP, values_from = total_summed_prob)

shp_tempclust1_cc <- left_join(huc12, df_tempclust1_cc, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  mutate(taxa = "fish",
         scenario = "Climate Change",
         grp = "temp")

j <- ggplot(data = shp_tempclust1_cc)+
  geom_sf(aes(fill = `1`), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = 1.5,
                       limits = c(0,3.0))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 7),
        legend.title = element_text(size = 10),
        legend.position = c(0.78, 0.21),
        legend.key.size = unit(.25, "cm"))+
    ggtitle(label = "Temp Cluster 1 - CC")+
  labs(fill = "Prob Occ.")




#5)	Total summed probabilities of temperature cluster 5
df_tempclust5_cc <- fish_cc_proboccurrence_huc12 %>% 
  left_join(cluster_temp, by = "common_name") %>%
  group_by(huc12_name, huc12_tnmid, cluster_TP) %>% 
  summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
  pivot_wider(names_from = cluster_TP, values_from = total_summed_prob)

shp_tempclust5_cc <- left_join(huc12, df_tempclust5_cc, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  mutate(taxa = "fish",
         scenario = "Climate Change",
         grp = "temp")

k <- ggplot(data = shp_tempclust5_cc)+
  geom_sf(aes(fill = `5`), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = 1.5,
                       limits = c(0,2.4))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 7),
        legend.title = element_text(size = 10),
        legend.position = c(0.78, 0.21),
        legend.key.size = unit(.25, "cm"))+
    ggtitle(label = "Temp Cluster 5 - CC")+
  labs(fill = "Prob Occ.")


#6)	Total summed probabilities of streamflow cluster 6
df_flowclust6_cc <- fish_cc_proboccurrence_huc12 %>% 
  left_join(cluster_flow, by = "common_name") %>%
  group_by(huc12_name, huc12_tnmid, cluster_SF) %>% 
  summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
  pivot_wider(names_from = cluster_SF, values_from = total_summed_prob)

shp_flowclust6 <- left_join(huc12, df_flowclust6_cc, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  mutate(taxa = "fish",
         scenario = "Climate Change",
         grp = "flow")

l <- ggplot(data = shp_flowclust6)+
  geom_sf(aes(fill = `6`), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = 1.5,
                       limits = c(0,3.0))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 7),
        legend.title = element_text(size = 10),
        legend.position = c(0.78, 0.21),
        legend.key.size = unit(.25, "cm"))+
    ggtitle(label = "Flow Cluster 6 - CC")+
  labs(fill = "Prob Occ.")





############################################





#Climate Change and all the management scenarios (forest, impervious, natural, and dam density)

fish_mg_proboccurrence_huc12$common_name <- gsub(pattern = ".rds", replacement = "", x = fish_mg_proboccurrence_huc12$common_name)
fish_mg_proboccurrence_huc12$common_name <- gsub(pattern = "pres_", replacement = "", x = fish_mg_proboccurrence_huc12$common_name)
fish_mg_proboccurrence_huc12$common_name <- gsub(pattern = "\\.", replacement = " ", x = fish_mg_proboccurrence_huc12$common_name)

fish_mg_proboccurrence_huc12$mean_prob_occ[fish_mg_proboccurrence_huc12$mean_prob_occ<0.01] <- 0.01

#1)	Total summed probabilities of native species divided by the total summed probabilities of introduced species.
df_origin_mg <- fish_mg_proboccurrence_huc12 %>% 
  left_join(origin, by = "common_name") %>%
  filter(!is.na(origin)) %>% 
  group_by(huc12_name, huc12_tnmid, origin) %>% 
  summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
  pivot_wider(names_from = origin, values_from = total_summed_prob) %>% 
  mutate(origin_ratio = native/introduced)

shp_origin_mg <- left_join(huc12, df_origin_mg, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  mutate(taxa = "fish",
         scenario = "Combined",
         grp = "origin")

m <- ggplot(data = shp_origin_mg)+
  geom_sf(aes(fill = origin_ratio), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = 7,
                       limits = c(.99,15))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 15))+
    ggtitle(label = "Native:Introduced - Combined")+
  labs(fill = "Ratio")

  
  



#2)	Total summed probabilities of fluvial specialist and fluvial dependent species divided by the total summed probabilities of macrohabitat generalist species.
df_habitat_mg <- fish_mg_proboccurrence_huc12 %>% 
  left_join(final_traits, by = "common_name") %>%  
  filter(!is.na(tolerance)) %>%
  select(-c("strategy", "timing", "velocity")) %>% 
  group_by(huc12_name, huc12_tnmid, tolerance) %>% 
  summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
  pivot_wider(names_from = tolerance, values_from = total_summed_prob) %>% 
  mutate(habitat_ratio = (`fluvial specialist` + `fluvial dependent`) / generalist)

shp_habitat_mg <- left_join(huc12, df_habitat_mg, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  mutate(taxa = "fish",
         scenario = "Combined",
         grp = "habitat")

n <- ggplot(data = shp_habitat_mg)+
  geom_sf(aes(fill = habitat_ratio), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = 4,
                       limits = c(0,8))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 15))+
    ggtitle(label = "FS+FD:MG - Combined")+
  labs(fill = "Ratio")




#3)	Total summed probabilities of cold-water species divided by the total summed probabilities of warm-water species.
df_temp_mg <- fish_mg_proboccurrence_huc12 %>% 
  left_join(temperature, by = "common_name") %>%
  filter(!is.na(tmp)) %>% 
  group_by(huc12_name, huc12_tnmid, tmp) %>% 
  summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
  pivot_wider(names_from = tmp, values_from = total_summed_prob) %>% 
  mutate(ratio = cold/warm)

shp_temp_mg <- left_join(huc12, df_temp_mg, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  mutate(taxa = "fish",
         scenario = "Combined",
         grp = "temp")

o <- ggplot(data = shp_temp_mg)+
  geom_sf(aes(fill = ratio), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = 3.25,
                       limits = c(0,6.5))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 15))+
    ggtitle(label = "Cold:Warm - Combined")+
  labs(fill = "Ratio")





#4)	Total summed probabilities of temperature cluster 1
df_tempclust1_mg <- fish_mg_proboccurrence_huc12 %>% 
  left_join(cluster_temp, by = "common_name") %>%
  group_by(huc12_name, huc12_tnmid, cluster_TP) %>% 
  summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
  pivot_wider(names_from = cluster_TP, values_from = total_summed_prob)

shp_tempclust1_mg <- left_join(huc12, df_tempclust1_mg, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  mutate(taxa = "fish",
         scenario = "Combined",
         grp = "temp")

p <- ggplot(data = shp_tempclust1_mg)+
  geom_sf(aes(fill = `1`), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = 1.5,
                       limits = c(0,3.0))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 7),
        legend.title = element_text(size = 10))+
    ggtitle(label = "Temperature Cluster 1 - Combined")+
  labs(fill = "Prob Occ.")




#5)	Total summed probabilities of temperature cluster 5
df_tempclust5_mg <- fish_mg_proboccurrence_huc12 %>% 
  left_join(cluster_temp, by = "common_name") %>%
  group_by(huc12_name, huc12_tnmid, cluster_TP) %>% 
  summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
  pivot_wider(names_from = cluster_TP, values_from = total_summed_prob)

shp_tempclust5_mg <- left_join(huc12, df_tempclust5_mg, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  mutate(taxa = "fish",
         scenario = "Combined",
         grp = "temp")

q <- ggplot(data = shp_tempclust5_mg)+
  geom_sf(aes(fill = `5`), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = 1.5,
                       limits = c(0,2.4))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 7),
        legend.title = element_text(size = 10))+
    ggtitle(label = "Temperature Cluster 5 - Combined")+
  labs(fill = "Prob Occ.")


#6)	Total summed probabilities of streamflow cluster 6
df_flowclust6_mg <- fish_mg_proboccurrence_huc12 %>% 
  left_join(cluster_flow, by = "common_name") %>%
  group_by(huc12_name, huc12_tnmid, cluster_SF) %>% 
  summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
  pivot_wider(names_from = cluster_SF, values_from = total_summed_prob)

shp_flowclust6_mg <- left_join(huc12, df_flowclust6_mg, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  mutate(taxa = "fish",
         scenario = "Combined",
         grp = "flow")

r <- ggplot(data = shp_flowclust6_mg)+
  geom_sf(aes(fill = `6`), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = 1.5,
                       limits = c(0,3.0))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 7),
        legend.title = element_text(size = 10))+
    ggtitle(label = "Streamflow Cluster 6 - Combined")+
  labs(fill = "Prob Occ.")




############################################





#Climate Change and dam density to 0

fish_mg_cnt_proboccurrence_huc12$common_name <- gsub(pattern = ".rds", replacement = "", x = fish_mg_cnt_proboccurrence_huc12$common_name)
fish_mg_cnt_proboccurrence_huc12$common_name <- gsub(pattern = "pres_", replacement = "", x = fish_mg_cnt_proboccurrence_huc12$common_name)
fish_mg_cnt_proboccurrence_huc12$common_name <- gsub(pattern = "\\.", replacement = " ", x = fish_mg_cnt_proboccurrence_huc12$common_name)

fish_mg_cnt_proboccurrence_huc12$mean_prob_occ[fish_mg_cnt_proboccurrence_huc12$mean_prob_occ<0.01] <- 0.01

#1)	Total summed probabilities of native species divided by the total summed probabilities of introduced species.
df_origin_mg_cnt <- fish_mg_cnt_proboccurrence_huc12 %>% 
  left_join(origin, by = "common_name") %>%
  filter(!is.na(origin)) %>% 
  group_by(huc12_name, huc12_tnmid, origin) %>% 
  summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
  pivot_wider(names_from = origin, values_from = total_summed_prob) %>% 
  mutate(origin_ratio = native/introduced)

shp_origin_mg_cnt <- left_join(huc12, df_origin_mg_cnt, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  mutate(taxa = "fish",
         scenario = "Dams",
         grp = "origin")

s <- ggplot(data = shp_origin_mg_cnt)+
  geom_sf(aes(fill = origin_ratio), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = 7,
                       limits = c(.99,15))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 15))+
    ggtitle(label = "Native:Introduced - Dams")+
  labs(fill = "Ratio")

  
  



#2)	Total summed probabilities of fluvial specialist and fluvial dependent species divided by the total summed probabilities of macrohabitat generalist species.
df_habitat_mg_cnt <- fish_mg_cnt_proboccurrence_huc12 %>% 
  left_join(final_traits, by = "common_name") %>%  
  filter(!is.na(tolerance)) %>%
  select(-c("strategy", "timing", "velocity")) %>% 
  group_by(huc12_name, huc12_tnmid, tolerance) %>% 
  summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
  pivot_wider(names_from = tolerance, values_from = total_summed_prob) %>% 
  mutate(habitat_ratio = (`fluvial specialist` + `fluvial dependent`) / generalist)

shp_habitat_mg_cnt <- left_join(huc12, df_habitat_mg_cnt, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  mutate(taxa = "fish",
         scenario = "Dams",
         grp = "habitat") 

t <- ggplot(data = shp_habitat_mg_cnt)+
  geom_sf(aes(fill = habitat_ratio), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = 4,
                       limits = c(0,8))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 15))+
    ggtitle(label = "FS + FD : MG - Dams")+
  labs(fill = "Ratio")




#3)	Total summed probabilities of cold-water species divided by the total summed probabilities of warm-water species.
df_temp_mg_cnt <- fish_mg_cnt_proboccurrence_huc12 %>% 
  left_join(temperature, by = "common_name") %>%
  filter(!is.na(tmp)) %>% 
  group_by(huc12_name, huc12_tnmid, tmp) %>% 
  summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
  pivot_wider(names_from = tmp, values_from = total_summed_prob) %>% 
  mutate(ratio = cold/warm)

shp_temp_mg_cnt <- left_join(huc12, df_temp_mg_cnt, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  mutate(taxa = "fish",
         scenario = "Dams",
         grp = "temp") 

u <- ggplot(data = shp_temp_mg_cnt)+
  geom_sf(aes(fill = ratio), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = 3.25,
                       limits = c(0,6.5))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 15))+
    ggtitle(label = "Cold : Warm - Dams")+
  labs(fill = "Ratio")




#4)	Total summed probabilities of temperature cluster 1
df_tempclust1_mg_cnt <- fish_mg_cnt_proboccurrence_huc12 %>% 
  left_join(cluster_temp, by = "common_name") %>%
  group_by(huc12_name, huc12_tnmid, cluster_TP) %>% 
  summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
  pivot_wider(names_from = cluster_TP, values_from = total_summed_prob)

shp_tempclust1_mg_cnt <- left_join(huc12, df_tempclust1_mg_cnt, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  mutate(taxa = "fish",
         scenario = "Dams",
         grp = "temp")

v <- ggplot(data = shp_tempclust1_mg_cnt)+
  geom_sf(aes(fill = `1`), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = 1.5,
                       limits = c(0,3.0))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 7),
        legend.title = element_text(size = 10))+
    ggtitle(label = "Temperature Cluster 1 - Dams")+
  labs(fill = "Prob Occ.")




#5)	Total summed probabilities of temperature cluster 5
df_tempclust5_mg_cnt <- fish_mg_proboccurrence_huc12 %>% 
  left_join(cluster_temp, by = "common_name") %>%
  group_by(huc12_name, huc12_tnmid, cluster_TP) %>% 
  summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
  pivot_wider(names_from = cluster_TP, values_from = total_summed_prob)

shp_tempclust5_mg_cnt <- left_join(huc12, df_tempclust5_mg_cnt, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  mutate(taxa = "fish",
         scenario = "Dams",
         grp = "temp")

w <- ggplot(data = shp_tempclust5_mg_cnt)+
  geom_sf(aes(fill = `5`), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = 1.5,
                       limits = c(0,2.4))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 7),
        legend.title = element_text(size = 10))+
    ggtitle(label = "Temperature Cluster 5 - Dams")+
  labs(fill = "Prob Occ.")


#6)	Total summed probabilities of streamflow cluster 6
df_flowclust6_mg_cnt <- fish_cc_proboccurrence_huc12 %>% 
  left_join(cluster_flow, by = "common_name") %>%
  group_by(huc12_name, huc12_tnmid, cluster_SF) %>% 
  summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
  pivot_wider(names_from = cluster_SF, values_from = total_summed_prob)

shp_flowclust6_mg_cnt <- left_join(huc12, df_flowclust6_mg_cnt, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  mutate(taxa = "fish",
         scenario = "Dams",
         grp = "flow")

x <- ggplot(data = shp_flowclust6_mg_cnt)+
  geom_sf(aes(fill = `6`), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = 1.5,
                       limits = c(0,3.0))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 7),
        legend.title = element_text(size = 10))+
    ggtitle(label = "Streamflow Cluster 6 - Dams")+
  labs(fill = "Prob Occ.")








############################################





#Climate Change and Forest watershed to 100%

fish_forest_proboccurrence_huc12$common_name <- gsub(pattern = ".rds", replacement = "", x = fish_forest_proboccurrence_huc12$common_name)
fish_forest_proboccurrence_huc12$common_name <- gsub(pattern = "pres_", replacement = "", x = fish_forest_proboccurrence_huc12$common_name)
fish_forest_proboccurrence_huc12$common_name <- gsub(pattern = "\\.", replacement = " ", x = fish_forest_proboccurrence_huc12$common_name)

fish_forest_proboccurrence_huc12$mean_prob_occ[fish_forest_proboccurrence_huc12$mean_prob_occ<0.01] <- 0.01

#1)	Total summed probabilities of native species divided by the total summed probabilities of introduced species.
df_origin_forest <- fish_forest_proboccurrence_huc12 %>% 
  left_join(origin, by = "common_name") %>%
  filter(!is.na(origin)) %>% 
  group_by(huc12_name, huc12_tnmid, origin) %>% 
  summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
  pivot_wider(names_from = origin, values_from = total_summed_prob) %>% 
  mutate(origin_ratio = native/introduced)

shp_origin_forest <- left_join(huc12, df_origin_forest, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  mutate(taxa = "fish",
         scenario = "Forest",
         grp = "origin")

org_forest <- ggplot(data = shp_origin_forest)+
  geom_sf(aes(fill = origin_ratio), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = 7,
                       limits = c(1,16.3))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 15))+
    ggtitle(label = "Native:Introduced - Forest")+
  labs(fill = "Ratio")

  
  



#2)	Total summed probabilities of fluvial specialist and fluvial dependent species divided by the total summed probabilities of macrohabitat generalist species.
df_habitat_forest <- fish_forest_proboccurrence_huc12 %>% 
  left_join(final_traits, by = "common_name") %>%  
  filter(!is.na(tolerance)) %>%
  select(-c("strategy", "timing", "velocity")) %>% 
  group_by(huc12_name, huc12_tnmid, tolerance) %>% 
  summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
  pivot_wider(names_from = tolerance, values_from = total_summed_prob) %>% 
  mutate(habitat_ratio = (`fluvial specialist` + `fluvial dependent`) / generalist)

shp_habitat_forest <- left_join(huc12, df_habitat_forest, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  mutate(taxa = "fish",
         scenario = "Forest",
         grp = "habitat") 

hab_forest <- ggplot(data = shp_habitat_forest)+
  geom_sf(aes(fill = habitat_ratio), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = 4,
                       limits = c(0,8))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 15))+
    ggtitle(label = "FS+FD:MG - Forest")+
  labs(fill = "Ratio")




#3)	Total summed probabilities of cold-water species divided by the total summed probabilities of warm-water species.
df_temp_forest <- fish_forest_proboccurrence_huc12 %>% 
  left_join(temperature, by = "common_name") %>%
  filter(!is.na(tmp)) %>% 
  group_by(huc12_name, huc12_tnmid, tmp) %>% 
  summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
  pivot_wider(names_from = tmp, values_from = total_summed_prob) %>% 
  mutate(ratio = cold/warm)

shp_temp_forest <- left_join(huc12, df_temp_forest, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  mutate(taxa = "fish",
         scenario = "Forest",
         grp = "temp") 

temp_forest <- ggplot(data = shp_temp_forest)+
  geom_sf(aes(fill = ratio), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = 3.25,
                       limits = c(0,6))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 15))+
    ggtitle(label = "Cold:Warm - Forest")+
  labs(fill = "Ratio")





#4)	Total summed probabilities of temperature cluster 1
df_tempclust1_forest <- fish_forest_proboccurrence_huc12 %>% 
  left_join(cluster_temp, by = "common_name") %>%
  group_by(huc12_name, huc12_tnmid, cluster_TP) %>% 
  summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
  pivot_wider(names_from = cluster_TP, values_from = total_summed_prob)

shp_tempclust1_forest <- left_join(huc12, df_tempclust1_forest, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  mutate(taxa = "fish",
         scenario = "Forest",
         grp = "temp")

pr <- ggplot(data = shp_tempclust1_forest)+
  geom_sf(aes(fill = `1`), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = 1.5,
                       limits = c(0,3.0))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 7),
        legend.title = element_text(size = 10))+
    ggtitle(label = "Temperature Cluster 1 - Forest")+
  labs(fill = "Prob Occ.")




#5)	Total summed probabilities of temperature cluster 5
df_tempclust5_forest <- fish_forest_proboccurrence_huc12 %>% 
  left_join(cluster_temp, by = "common_name") %>%
  group_by(huc12_name, huc12_tnmid, cluster_TP) %>% 
  summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
  pivot_wider(names_from = cluster_TP, values_from = total_summed_prob)

shp_tempclust5_forest <- left_join(huc12, df_tempclust5_forest, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  mutate(taxa = "fish",
         scenario = "Forest",
         grp = "temp")

qr <- ggplot(data = shp_tempclust5_forest)+
  geom_sf(aes(fill = `5`), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = 1.5,
                       limits = c(0,2.4))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 7),
        legend.title = element_text(size = 10))+
    ggtitle(label = "Temperature Cluster 5 - Forest")+
  labs(fill = "Prob Occ.")


#6)	Total summed probabilities of streamflow cluster 6
df_flowclust6_forest <- fish_forest_proboccurrence_huc12 %>% 
  left_join(cluster_flow, by = "common_name") %>%
  group_by(huc12_name, huc12_tnmid, cluster_SF) %>% 
  summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
  pivot_wider(names_from = cluster_SF, values_from = total_summed_prob)

shp_flowclust6_forest <- left_join(huc12, df_flowclust6_forest, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  mutate(taxa = "fish",
         scenario = "Forest",
         grp = "flow")

rp <- ggplot(data = shp_flowclust6_forest)+
  geom_sf(aes(fill = `6`), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = 1.5,
                       limits = c(0,3.0))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 7),
        legend.title = element_text(size = 10))+
    ggtitle(label = "Streamflow Cluster 6 - Forest")+
  labs(fill = "Prob Occ.")


############################################





#Climate Change and natural riparian land to 100%

fish_natural_proboccurrence_huc12$common_name <- gsub(pattern = ".rds", replacement = "", x = fish_natural_proboccurrence_huc12$common_name)
fish_natural_proboccurrence_huc12$common_name <- gsub(pattern = "pres_", replacement = "", x = fish_natural_proboccurrence_huc12$common_name)
fish_natural_proboccurrence_huc12$common_name <- gsub(pattern = "\\.", replacement = " ", x = fish_natural_proboccurrence_huc12$common_name)

fish_natural_proboccurrence_huc12$mean_prob_occ[fish_natural_proboccurrence_huc12$mean_prob_occ<0.01] <- 0.01

#1)	Total summed probabilities of native species divided by the total summed probabilities of introduced species.
df_origin_natural <- fish_natural_proboccurrence_huc12 %>% 
  left_join(origin, by = "common_name") %>%
  filter(!is.na(origin)) %>% 
  group_by(huc12_name, huc12_tnmid, origin) %>% 
  summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
  pivot_wider(names_from = origin, values_from = total_summed_prob) %>% 
  mutate(origin_ratio = native/introduced)

shp_origin_natural <- left_join(huc12, df_origin_natural, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  mutate(taxa = "fish",
         scenario = "Natural",
         grp = "origin")

org_natural <- ggplot(data = shp_origin_natural)+
  geom_sf(aes(fill = origin_ratio), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = 7,
                       limits = c(1,14.2))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 15))+
    ggtitle(label = "Native:Introduced - Natural")+
  labs(fill = "Ratio")

  
  



#2)	Total summed probabilities of fluvial specialist and fluvial dependent species divided by the total summed probabilities of macrohabitat generalist species.
df_habitat_natural <- fish_natural_proboccurrence_huc12 %>% 
  left_join(final_traits, by = "common_name") %>%  
  filter(!is.na(tolerance)) %>%
  select(-c("strategy", "timing", "velocity")) %>% 
  group_by(huc12_name, huc12_tnmid, tolerance) %>% 
  summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
  pivot_wider(names_from = tolerance, values_from = total_summed_prob) %>% 
  mutate(habitat_ratio = (`fluvial specialist` + `fluvial dependent`) / generalist)

shp_habitat_natural <- left_join(huc12, df_habitat_natural, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  mutate(taxa = "fish",
         scenario = "Natural",
         grp = "habitat") 

hab_natural <- ggplot(data = shp_habitat_natural)+
  geom_sf(aes(fill = habitat_ratio), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = 4,
                       limits = c(0,7.4))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 15))+
    ggtitle(label = "FS+FD:MG - Natural")+
  labs(fill = "Ratio")




#3)	Total summed probabilities of cold-water species divided by the total summed probabilities of warm-water species.
df_temp_natural <- fish_natural_proboccurrence_huc12 %>% 
  left_join(temperature, by = "common_name") %>%
  filter(!is.na(tmp)) %>% 
  group_by(huc12_name, huc12_tnmid, tmp) %>% 
  summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
  pivot_wider(names_from = tmp, values_from = total_summed_prob) %>% 
  mutate(ratio = cold/warm)

shp_temp_natural <- left_join(huc12, df_temp_natural, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  mutate(taxa = "fish",
         scenario = "Natural",
         grp = "temp") 

temp_natural <- ggplot(data = shp_temp_natural)+
  geom_sf(aes(fill = ratio), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = 3.25,
                       limits = c(0,6))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 15))+
    ggtitle(label = "Cold:Warm - Natural")+
  labs(fill = "Ratio")




#4)	Total summed probabilities of temperature cluster 1
df_tempclust1_natural <- fish_natural_proboccurrence_huc12 %>% 
  left_join(cluster_temp, by = "common_name") %>%
  group_by(huc12_name, huc12_tnmid, cluster_TP) %>% 
  summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
  pivot_wider(names_from = cluster_TP, values_from = total_summed_prob)

shp_tempclust1_natural <- left_join(huc12, df_tempclust1_natural, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  mutate(taxa = "fish",
         scenario = "Natural",
         grp = "temp")

pw <- ggplot(data = shp_tempclust1_natural)+
  geom_sf(aes(fill = `1`), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = 1.5,
                       limits = c(0,3.0))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 7),
        legend.title = element_text(size = 10))+
    ggtitle(label = "Temp Cluster 1 - Natural")+
  labs(fill = "Prob Occ.")




#5)	Total summed probabilities of temperature cluster 5
df_tempclust5_natural <- fish_natural_proboccurrence_huc12 %>% 
  left_join(cluster_temp, by = "common_name") %>%
  group_by(huc12_name, huc12_tnmid, cluster_TP) %>% 
  summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
  pivot_wider(names_from = cluster_TP, values_from = total_summed_prob)

shp_tempclust5_natural <- left_join(huc12, df_tempclust5_natural, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  mutate(taxa = "fish",
         scenario = "Natural",
         grp = "temp")

qw <- ggplot(data = shp_tempclust5_natural)+
  geom_sf(aes(fill = `5`), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = 1.5,
                       limits = c(0,2.4))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 7),
        legend.title = element_text(size = 10))+
    ggtitle(label = "Temp Cluster 5 - Natural")+
  labs(fill = "Prob Occ.")


#6)	Total summed probabilities of streamflow cluster 6
df_flowclust6_natural <- fish_natural_proboccurrence_huc12 %>% 
  left_join(cluster_flow, by = "common_name") %>%
  group_by(huc12_name, huc12_tnmid, cluster_SF) %>% 
  summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
  pivot_wider(names_from = cluster_SF, values_from = total_summed_prob)

shp_flowclust6_natural <- left_join(huc12, df_flowclust6_natural, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  mutate(taxa = "fish",
         scenario = "Natural",
         grp = "flow")

rw <- ggplot(data = shp_flowclust6_natural)+
  geom_sf(aes(fill = `6`), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = 1.5,
                       limits = c(0,3.0))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 7),
        legend.title = element_text(size = 10))+
    ggtitle(label = "Flow Cluster 6 - Natural")+
  labs(fill = "Prob Occ.")




############################################





#Climate Change and impervious riparian land to 0%

fish_impervious_proboccurrence_huc12$common_name <- gsub(pattern = ".rds", replacement = "", x = fish_impervious_proboccurrence_huc12$common_name)
fish_impervious_proboccurrence_huc12$common_name <- gsub(pattern = "pres_", replacement = "", x = fish_impervious_proboccurrence_huc12$common_name)
fish_impervious_proboccurrence_huc12$common_name <- gsub(pattern = "\\.", replacement = " ", x = fish_impervious_proboccurrence_huc12$common_name)

fish_impervious_proboccurrence_huc12$mean_prob_occ[fish_impervious_proboccurrence_huc12$mean_prob_occ<0.01] <- 0.01

#1)	Total summed probabilities of native species divided by the total summed probabilities of introduced species.
df_origin_impervious <- fish_impervious_proboccurrence_huc12 %>% 
  left_join(origin, by = "common_name") %>%
  filter(!is.na(origin)) %>% 
  group_by(huc12_name, huc12_tnmid, origin) %>% 
  summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
  pivot_wider(names_from = origin, values_from = total_summed_prob) %>% 
  mutate(origin_ratio = native/introduced)

shp_origin_impervious <- left_join(huc12, df_origin_impervious, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  mutate(taxa = "fish",
         scenario = "Impervious",
         grp = "origin")

org_impervious <- ggplot(data = shp_origin_impervious)+
  geom_sf(aes(fill = origin_ratio), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = 7,
                       limits = c(1,14.2))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 15))+
    ggtitle(label = "Native:Introduced - Impervious")+
  labs(fill = "Ratio")

  
  



#2)	Total summed probabilities of fluvial specialist and fluvial dependent species divided by the total summed probabilities of macrohabitat generalist species.
df_habitat_impervious <- fish_impervious_proboccurrence_huc12 %>% 
  left_join(final_traits, by = "common_name") %>%  
  filter(!is.na(tolerance)) %>%
  select(-c("strategy", "timing", "velocity")) %>% 
  group_by(huc12_name, huc12_tnmid, tolerance) %>% 
  summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
  pivot_wider(names_from = tolerance, values_from = total_summed_prob) %>% 
  mutate(habitat_ratio = (`fluvial specialist` + `fluvial dependent`) / generalist)

shp_habitat_impervious <- left_join(huc12, df_habitat_impervious, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  mutate(taxa = "fish",
         scenario = "Impervious",
         grp = "habitat") 

hab_impervious <- ggplot(data = shp_habitat_impervious)+
  geom_sf(aes(fill = habitat_ratio), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = 4,
                       limits = c(0,7.4))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 15))+
    ggtitle(label = "FS+FD:MG - Impervious")+
  labs(fill = "Ratio")




#3)	Total summed probabilities of cold-water species divided by the total summed probabilities of warm-water species.
df_temp_impervious <- fish_impervious_proboccurrence_huc12 %>% 
  left_join(temperature, by = "common_name") %>%
  filter(!is.na(tmp)) %>% 
  group_by(huc12_name, huc12_tnmid, tmp) %>% 
  summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
  pivot_wider(names_from = tmp, values_from = total_summed_prob) %>% 
  mutate(ratio = cold/warm)

shp_temp_impervious <- left_join(huc12, df_temp_impervious, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  mutate(taxa = "fish",
         scenario = "Impervious",
         grp = "temp") 

temp_impervious <- ggplot(data = shp_temp_impervious)+
  geom_sf(aes(fill = ratio), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = 3.25,
                       limits = c(0,6))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 15))+
    ggtitle(label = "Cold:Warm - Impervious")+
  labs(fill = "Ratio")




#4)	Total summed probabilities of temperature cluster 1
df_tempclust1_impervious <- fish_impervious_proboccurrence_huc12 %>% 
  left_join(cluster_temp, by = "common_name") %>%
  group_by(huc12_name, huc12_tnmid, cluster_TP) %>% 
  summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
  pivot_wider(names_from = cluster_TP, values_from = total_summed_prob)

shp_tempclust1_impervious <- left_join(huc12, df_tempclust1_impervious, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  mutate(taxa = "fish",
         scenario = "Impervious",
         grp = "temp")

pt <- ggplot(data = shp_tempclust1_impervious)+
  geom_sf(aes(fill = `1`), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = 1.5,
                       limits = c(0,3.0))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 7),
        legend.title = element_text(size = 10))+
    ggtitle(label = "Temperature Cluster 1 - Impervious")+
  labs(fill = "Prob Occ.")




#5)	Total summed probabilities of temperature cluster 5
df_tempclust5_impervious <- fish_impervious_proboccurrence_huc12 %>% 
  left_join(cluster_temp, by = "common_name") %>%
  group_by(huc12_name, huc12_tnmid, cluster_TP) %>% 
  summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
  pivot_wider(names_from = cluster_TP, values_from = total_summed_prob)

shp_tempclust5_impervious <- left_join(huc12, df_tempclust5_impervious, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  mutate(taxa = "fish",
         scenario = "Impervious",
         grp = "temp")

qt <- ggplot(data = shp_tempclust5_impervious)+
  geom_sf(aes(fill = `5`), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = 1.5,
                       limits = c(0,2.4))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 7),
        legend.title = element_text(size = 10))+
    ggtitle(label = "Temp Cluster 5 - Impervious")+
  labs(fill = "Prob Occ.")


#6)	Total summed probabilities of streamflow cluster 6
df_flowclust6_impervious <- fish_impervious_proboccurrence_huc12 %>% 
  left_join(cluster_flow, by = "common_name") %>%
  group_by(huc12_name, huc12_tnmid, cluster_SF) %>% 
  summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
  pivot_wider(names_from = cluster_SF, values_from = total_summed_prob)

shp_flowclust6_impervious <- left_join(huc12, df_flowclust6_impervious, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  mutate(taxa = "fish",
         scenario = "Impervious",
         grp = "flow")

rt <- ggplot(data = shp_flowclust6_impervious)+
  geom_sf(aes(fill = `6`), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = 1.5,
                       limits = c(0,3.0))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 7),
        legend.title = element_text(size = 10))+
    ggtitle(label = "Flow Cluster 6 - Impervious")+
  labs(fill = "Prob Occ.")




#################

# Change from baseline to future
# climate change ratio - baseline ratio
# positive value means the ratio has increased and the more vulnerable group is doing well
# negative value means the ratio has decreased and the more vulnerable group is doing poorly

unique(df_origin_baseline$huc12_name == df_origin_cc$huc12_name)
df_origin_cc$origin_ratio_change <- df_origin_cc$origin_ratio - df_origin_baseline$origin_ratio
shp_origin_chng <- left_join(huc12, df_origin_cc, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid"))

y <- ggplot(data = shp_origin_chng)+
  geom_sf(aes(fill = origin_ratio_change), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "white",
                        high = "red",
                        midpoint = 0,
                       limits = c(-17,7))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 7),
        legend.title = element_text(size = 10),
        legend.position = c(0.78, 0.21),
        legend.key.size = unit(.25, "cm"))+
    ggtitle(label = "D. Native:Introduced")+
  labs(fill = "Δ")

df_habitat_cc$habitat_ratio_change <- df_habitat_cc$habitat_ratio - df_habitat_baseline$habitat_ratio
shp_habitat_chng <- left_join(huc12, df_habitat_cc, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid"))

z <- ggplot(data = shp_habitat_chng)+
  geom_sf(aes(fill = habitat_ratio_change), color = NA)+
  scale_fill_gradient2(low = "blue",
                        high = "white",
                       limits = c(-12,0))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 7),
        legend.title = element_text(size = 10),
        legend.position = c(0.78, 0.21),
        legend.key.size = unit(.25, "cm"))+
    ggtitle(label = "E. FS+FD:MG")+
  labs(fill = "Δ")

df_temp_cc$temp_ratio_change <- df_temp_cc$ratio - df_temp_baseline$ratio
shp_temp_chng <- left_join(huc12, df_temp_cc, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid"))

aa <- ggplot(data = shp_temp_chng)+
  geom_sf(aes(fill = temp_ratio_change), color = NA)+
  scale_fill_gradient2(low = "blue",
                        high = "white",
                       limits = c(-10,0))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 7),
        legend.title = element_text(size = 10),
        legend.position = c(0.78, 0.21),
        legend.key.size = unit(.25, "cm"))+
    ggtitle(label = "F. Cold:Warm")+
  labs(fill = "Δ")

df_tempclust1_cc$tempclust1_change <- df_tempclust1_cc$`1` - df_tempclust1_baseline$`1`
shp_tempclust1_chng <- left_join(huc12, df_tempclust1_cc, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid"))

bb <- ggplot(data = shp_tempclust1_chng)+
  geom_sf(aes(fill = tempclust1_change), color = NA)+
  scale_fill_gradient2(low = "blue",
                        high = "red",
                       limits = c(-0.54,1.4))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 7),
        legend.title = element_text(size = 10),
        legend.position = c(0.78, 0.21),
        legend.key.size = unit(.25, "cm"))+
    ggtitle(label = "D. Temperature Cluster 1")+
  labs(fill = "Δ")


df_tempclust5_cc$tempclust5_change <- df_tempclust5_cc$`5` - df_tempclust5_baseline$`5`
shp_tempclust5_chng <- left_join(huc12, df_tempclust5_cc, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid"))

cc <- ggplot(data = shp_tempclust5_chng)+
  geom_sf(aes(fill = tempclust5_change), color = NA)+
  scale_fill_gradient2(low = "blue",
                        high = "white",
                       limits = c(-1.4,0))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 7),
        legend.title = element_text(size = 10),
        legend.position = c(0.78, 0.21),
        legend.key.size = unit(.25, "cm"))+
    ggtitle(label = "E. Temperature Cluster 5")+
  labs(fill = "Δ")

df_flowclust6_cc$flowclust6_change <- df_flowclust6_cc$`6` - df_flowclust6_baseline$`6`
shp_flowclust6_chng <- left_join(huc12, df_flowclust6_cc, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid"))

dd <- ggplot(data = shp_flowclust6_chng)+
  geom_sf(aes(fill = flowclust6_change), color = NA)+
  scale_fill_gradient2(low = "blue",
                        high = "white",
                       limits = c(-1.5,0))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 7),
        legend.title = element_text(size = 10),
        legend.position = c(0.78, 0.21),
        legend.key.size = unit(.25, "cm"))+
    ggtitle(label = "F. Streamlow Cluster 6")+
  labs(fill = "Δ")


fig1 <- gridExtra::grid.arrange(a,b, c,  y, z, aa, nrow = 2, ncol = 3)
ggsave(fig1, file = "tmpfigures/paper2/fig1_basline_change_fish.png", height = 7, width = 7, units = "in")

fig2 <- gridExtra::grid.arrange(d,e, f,  bb, cc, dd, nrow = 2, ncol = 3)
ggsave(fig2, file = "tmpfigures/paper2/fig2_basline_change_clusters_fish.png", height = 7, width = 7, units = "in")




```






Describe Mussel Biodiversity

```{r}


#Baseline


head(predictions_baseline)
mussel_baseline_proboccurrence_huc12 <- predictions_baseline %>%
  data.frame() %>% 
  select(huc12_name, huc12_tnmid, 40:51) %>% 
  filter(!is.na(alewifefloater),
         !is.na(huc12_name)) %>%
  pivot_longer(3:14, names_to = "common_name", values_to = "prob_occ") %>% 
  group_by(huc12_name, huc12_tnmid, common_name) %>% 
  summarise(mean_prob_occ = mean(prob_occ)) %>% 
  ungroup() %>% 
  mutate(scenario = "baseline", taxa = "mussel")

mussel_baseline_proboccurrence_huc12$common_name <- gsub(pattern = "\\.", replacement = " ", x = mussel_baseline_proboccurrence_huc12$common_name)

mussel_baseline_proboccurrence_huc12$common_name[mussel_baseline_proboccurrence_huc12$common_name == "alewifefloater"] <- "alewife floater"
mussel_baseline_proboccurrence_huc12$common_name[mussel_baseline_proboccurrence_huc12$common_name == "easternpearlshell"] <- "eastern pearlshell"
mussel_baseline_proboccurrence_huc12$common_name[mussel_baseline_proboccurrence_huc12$common_name == "easternpondmussel"] <- "eastern pondmussel"
mussel_baseline_proboccurrence_huc12$common_name[mussel_baseline_proboccurrence_huc12$common_name == "Tidewatermucket"] <- "tidewater mucket"
mussel_baseline_proboccurrence_huc12$common_name[mussel_baseline_proboccurrence_huc12$common_name == "yellowlampmussel"] <- "yellow lampmussel"

#remove the really small mean prob occurrences so the ratios arent too high
mussel_baseline_proboccurrence_huc12$mean_prob_occ[mussel_baseline_proboccurrence_huc12$mean_prob_occ<0.01] <- 0.01

#1)	Total summed probabilities of rare species divided by the total summed probabilities of common species.
df_status_baseline <- mussel_baseline_proboccurrence_huc12 %>% 
  left_join(mussel_traits, by = "common_name") %>%
  filter(!is.na(status)) %>% 
  group_by(huc12_name, huc12_tnmid, status) %>% 
  summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
  pivot_wider(names_from = status, values_from = total_summed_prob) %>% 
  mutate(status_ratio = rare/common)

shp_status <- left_join(huc12, df_status_baseline, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  mutate(taxa = "mussel",
         scenario = "baseline",
         grp = "status") 

ee <- ggplot(data = shp_status)+
  geom_sf(aes(fill = status_ratio), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = .5,
                       limits = c(0,1.1))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 7),
        legend.title = element_text(size = 10),
        title = element_text(size = 10),
        legend.position = c(0.78, 0.21),
        legend.key.size = unit(.25, "cm"))+
    ggtitle(label = "A. Rare:Common")+
  labs(fill = "Ratio")

  
  



#2)	Total summed probabilities of host specialist divided by the total summed probabilities of host generalist species.
df_host_baseline <- mussel_baseline_proboccurrence_huc12 %>% 
  left_join(mussel_traits, by = "common_name") %>%  
  filter(!is.na(host)) %>%
  group_by(huc12_name, huc12_tnmid, host) %>% 
  summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
  pivot_wider(names_from = host, values_from = total_summed_prob) %>% 
  mutate(host_ratio = (specialist / generalist))

shp_host <- left_join(huc12, df_host_baseline, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  mutate(taxa = "mussel",
         scenario = "baseline",
         grp = "host")

ff <- ggplot(data = shp_host)+
  geom_sf(aes(fill = host_ratio), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = .5,
                       limits = c(0,1.02))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 7),
        legend.title = element_text(size = 0),
        title = element_text(size = 10),
        legend.position = c(0.78, 0.21),
        legend.key.size = unit(.25, "cm"))+
    ggtitle(label = "B. Specialist:Generalist")+
  labs(fill = "Ratio")




#3)	Total summed probabilities of small species divided by the total summed probabilities of large species.
# df_size_baseline <- mussel_baseline_proboccurrence_huc12 %>% 
#   left_join(mussel_traits, by = "common_name") %>%
#   filter(!is.na(size)) %>% 
#   group_by(huc12_name, huc12_tnmid, size) %>% 
#   summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
#   pivot_wider(names_from = size, values_from = total_summed_prob) %>% 
#   mutate(ratio = (small/large))
# 
# shp_size <- left_join(huc12, df_size_baseline, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
#   mutate(taxa = "mussel",
#          scenario = "baseline",
#          grp = "size")
# 
# gg <- ggplot(data = shp_size)+
#   geom_sf(aes(fill = ratio), color = NA)+
#   scale_fill_gradient2(low = "blue",
#                         mid = "yellow",
#                         high = "red",
#                         midpoint = 6,
#                        limits = c(0,12))+
#     theme(panel.border = element_rect(colour = "black", fill = NA),
#           panel.grid.major = element_blank(),
#           panel.grid.minor = element_blank(),
#           panel.background = element_blank(),
#         strip.background = element_rect(fill = "grey50",
#                                         colour = "black"),
#         axis.text = element_blank(),
#         axis.ticks = element_blank(),
#         legend.text = element_text(size = 7),
#         legend.title = element_text(size = 10),
#         title = element_text(size = 10))+
#     ggtitle(label = "B. Small:large")+
#   labs(fill = "Ratio")



#4)	Total summed probabilities of equilibrium + periodic species divided by the total summed probabilities of opportunistic species.
# df_strat_baseline <- mussel_baseline_proboccurrence_huc12 %>% 
#   left_join(mussel_traits, by = "common_name") %>%
#   filter(!is.na(strat)) %>% 
#   group_by(huc12_name, huc12_tnmid, strat) %>% 
#   summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
#   pivot_wider(names_from = strat, values_from = total_summed_prob) %>% 
#   mutate(ratio = ((equilibrium + periodic) /opportunistic))
# 
# shp_strat <- left_join(huc12, df_strat_baseline, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
#   mutate(taxa = "mussel",
#          scenario = "baseline",
#          grp = "strategy")
# 
# hh <- ggplot(data = shp_strat)+
#   geom_sf(aes(fill = ratio), color = NA)+
#   scale_fill_gradient2(low = "blue",
#                         mid = "yellow",
#                         high = "red",
#                         midpoint = 8,
#                        limits = c(0,16))+
#     theme(panel.border = element_rect(colour = "black", fill = NA),
#           panel.grid.major = element_blank(),
#           panel.grid.minor = element_blank(),
#           panel.background = element_blank(),
#         strip.background = element_rect(fill = "grey50",
#                                         colour = "black"),
#         axis.text = element_blank(),
#         axis.ticks = element_blank(),
#         legend.text = element_text(size = 7),
#         legend.title = element_text(size = 10),
#         title = element_text(size = 10))+
#     ggtitle(label = "Equil : opportun")+
#   labs(fill = "Ratio")
# 
# 


#5)	Total summed probabilities of sensitive divided by the total summed probabilities of secure species.
# df_rank_baseline <- mussel_baseline_proboccurrence_huc12 %>% 
#   left_join(mussel_traits, by = "common_name") %>%
#   filter(!is.na(rank)) %>% 
#   group_by(huc12_name, huc12_tnmid, rank) %>% 
#   summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
#   pivot_wider(names_from = rank, values_from = total_summed_prob) %>% 
#   mutate(ratio = (sensitive /secure))
# 
# shp_rank <- left_join(huc12, df_rank_baseline, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
#   mutate(taxa = "mussel",
#          scenario = "baseline",
#          grp = "rank")
# 
# rank_baseline <- ggplot(data = shp_rank)+
#   geom_sf(aes(fill = ratio), color = NA)+
#   scale_fill_gradient2(low = "blue",
#                         mid = "yellow",
#                         high = "red",
#                         midpoint = 1.15,
#                        limits = c(0,2.31))+
#     theme(panel.border = element_rect(colour = "black", fill = NA),
#           panel.grid.major = element_blank(),
#           panel.grid.minor = element_blank(),
#           panel.background = element_blank(),
#         strip.background = element_rect(fill = "grey50",
#                                         colour = "black"),
#         axis.text = element_blank(),
#         axis.ticks = element_blank(),
#         legend.text = element_text(size = 7),
#         legend.title = element_text(size = 10),
#         title = element_text(size = 10))+
#     ggtitle(label = "sensitive : secure")+
#   labs(fill = "Ratio")
# 


#6)	Total summed probabilities of thin divided by the total summed probabilities of thick species.
# df_shell_baseline <- mussel_baseline_proboccurrence_huc12 %>% 
#   left_join(mussel_traits, by = "common_name") %>%
#   filter(!is.na(shell)) %>% 
#   group_by(huc12_name, huc12_tnmid, shell) %>% 
#   summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
#   pivot_wider(names_from = shell, values_from = total_summed_prob) %>% 
#   mutate(ratio = (thin /thick))
# 
# shp_shell <- left_join(huc12, df_shell_baseline, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
#   mutate(taxa = "mussel",
#          scenario = "baseline",
#          grp = "shell")
# 
# shell_baseline <- ggplot(data = shp_shell)+
#   geom_sf(aes(fill = ratio), color = NA)+
#   scale_fill_gradient2(low = "blue",
#                         mid = "yellow",
#                         high = "red",
#                         midpoint = 2,
#                        limits = c(0,4))+
#     theme(panel.border = element_rect(colour = "black", fill = NA),
#           panel.grid.major = element_blank(),
#           panel.grid.minor = element_blank(),
#           panel.background = element_blank(),
#         strip.background = element_rect(fill = "grey50",
#                                         colour = "black"),
#         axis.text = element_blank(),
#         axis.ticks = element_blank(),
#         legend.text = element_text(size = 7),
#         legend.title = element_text(size = 10),
#         title = element_text(size = 10))+
#     ggtitle(label = "Thin : thick")+
#   labs(fill = "Ratio")


#7)	Total summed probabilities of lotic divided by the total summed probabilities of generalist species.
df_musselhabitat_baseline <- mussel_baseline_proboccurrence_huc12 %>% 
  left_join(mussel_traits, by = "common_name") %>%
  filter(!is.na(habitat)) %>% 
  group_by(huc12_name, huc12_tnmid, habitat) %>% 
  summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
  pivot_wider(names_from = habitat, values_from = total_summed_prob) %>% 
  mutate(ratio = (lotic /generalist))

shp_musselhabitat <- left_join(huc12, df_musselhabitat_baseline, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  mutate(taxa = "mussel",
         scenario = "baseline",
         grp = "habitat")

musselhabitat_baseline <- ggplot(data = shp_musselhabitat)+
  geom_sf(aes(fill = ratio), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = 1.25,
                       limits = c(0,2.5))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 7),
        legend.title = element_text(size = 10),
        title = element_text(size = 10),
        legend.position = c(0.78, 0.21),
        legend.key.size = unit(.25, "cm"))+
    ggtitle(label = "C. Lotic:Lentic")+
  labs(fill = "Ratio")



#8)	Total summed probabilities of flood negative cluster
df_musselfloodclust_baseline <- mussel_baseline_proboccurrence_huc12 %>% 
  left_join(cluster_mussel_flood, by = "common_name") %>%
  group_by(huc12_name, huc12_tnmid, cluster_flood) %>% 
  summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
  pivot_wider(names_from = cluster_flood, values_from = total_summed_prob)

shp_musselfloodclust <- left_join(huc12, df_musselfloodclust_baseline, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  mutate(taxa = "mussel",
         scenario = "baseline",
         grp = "flood")

dp <- ggplot(data = shp_musselfloodclust)+
  geom_sf(aes(fill = `1 - flood negative`), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = 1.0,
                       limits = c(0,2.0))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 11),
        legend.title = element_text(size = 12),
        legend.position = c(0.78, 0.21),
        legend.key.size = unit(.4, "cm"))+
    ggtitle(label = "A. Mussel Flood Cluster")+
  labs(fill = "Occ.")

#9)	Total summed probabilities of temperature negative cluster
df_musseltempclust_baseline <- mussel_baseline_proboccurrence_huc12 %>% 
  left_join(cluster_mussel_temp, by = "common_name") %>%
  group_by(huc12_name, huc12_tnmid, cluster_temp) %>% 
  summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
  pivot_wider(names_from = cluster_temp, values_from = total_summed_prob)

shp_musseltempclust <- left_join(huc12, df_musseltempclust_baseline, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  mutate(taxa = "mussel",
         scenario = "baseline",
         grp = "temp")

dq <- ggplot(data = shp_musseltempclust)+
  geom_sf(aes(fill = `3 - temp negative`), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = 1.0,
                       limits = c(0,2.0))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 11),
        legend.title = element_text(size = 12),
        legend.position = c(0.78, 0.21),
        legend.key.size = unit(.4, "cm"))+
    ggtitle(label = "B. Mussel Temp Cluster")+
  labs(fill = "Occ.")

############################################





#Climate Change

head(prediction_cc)
mussel_cc_proboccurrence_huc12 <- prediction_cc %>%
  data.frame() %>% 
  select(huc12_name, huc12_tnmid, 44:55) %>% 
  filter(!is.na(alewifefloater),
         !is.na(huc12_name)) %>%
  pivot_longer(3:14, names_to = "common_name", values_to = "prob_occ") %>% 
  group_by(huc12_name, huc12_tnmid, common_name) %>% 
  summarise(mean_prob_occ = mean(prob_occ)) %>% 
  ungroup() %>% 
  mutate(scenario = "cc", taxa = "mussel")

mussel_cc_proboccurrence_huc12$common_name <- gsub(pattern = "\\.", replacement = " ", x = mussel_cc_proboccurrence_huc12$common_name)
mussel_cc_proboccurrence_huc12$common_name[mussel_cc_proboccurrence_huc12$common_name == "alewifefloater"] <- "alewife floater"
mussel_cc_proboccurrence_huc12$common_name[mussel_cc_proboccurrence_huc12$common_name == "easternpearlshell"] <- "eastern pearlshell"
mussel_cc_proboccurrence_huc12$common_name[mussel_cc_proboccurrence_huc12$common_name == "easternpondmussel"] <- "eastern pondmussel"
mussel_cc_proboccurrence_huc12$common_name[mussel_cc_proboccurrence_huc12$common_name == "Tidewatermucket"] <- "tidewater mucket"
mussel_cc_proboccurrence_huc12$common_name[mussel_cc_proboccurrence_huc12$common_name == "yellowlampmussel"] <- "yellow lampmussel"


mussel_cc_proboccurrence_huc12$mean_prob_occ[mussel_cc_proboccurrence_huc12$mean_prob_occ<0.01]<-0.01

#1)	Total summed probabilities of rare species divided by the total summed probabilities of common species.
df_status_cc <- mussel_cc_proboccurrence_huc12 %>% 
  left_join(mussel_traits, by = "common_name") %>%
  filter(!is.na(status)) %>% 
  group_by(huc12_name, huc12_tnmid, status) %>% 
  summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
  pivot_wider(names_from = status, values_from = total_summed_prob) %>% 
  mutate(status_ratio = rare/common)

shp_status_cc <- left_join(huc12, df_status_cc, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  mutate(taxa = "mussel",
         scenario = "Climate Change",
         grp = "status")

ii <- ggplot(data = shp_status_cc)+
  geom_sf(aes(fill = status_ratio), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = .26,
                       limits = c(0,.52))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 15),
        legend.position = c(0.78, 0.21),
        legend.key.size = unit(.25, "cm"))+
    ggtitle(label = "Rare:Common - CC")+
  labs(fill = "Ratio")

  
  



#2)	Total summed probabilities of host specialist divided by the total summed probabilities of host generalist species.
df_host_cc <- mussel_cc_proboccurrence_huc12 %>% 
  left_join(mussel_traits, by = "common_name") %>%  
  filter(!is.na(host)) %>%
  group_by(huc12_name, huc12_tnmid, host) %>% 
  summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
  pivot_wider(names_from = host, values_from = total_summed_prob) %>% 
  mutate(host_ratio = (specialist / generalist))

shp_host_cc <- left_join(huc12, df_host_cc, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  mutate(taxa = "mussel",
         scenario = "Climate Change",
         grp = "host")

jj <- ggplot(data = shp_host_cc)+
  geom_sf(aes(fill = host_ratio), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = .26,
                       limits = c(0,.57))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 15),
        legend.position = c(0.78, 0.21),
        legend.key.size = unit(.25, "cm"))+
    ggtitle(label = "Host specialist : generalist - CC")+
  labs(fill = "Ratio")



# #3)	Total summed probabilities of small species divided by the total summed probabilities of large species.
# df_size_cc <- mussel_cc_proboccurrence_huc12 %>% 
#   left_join(mussel_traits, by = "common_name") %>%
#   filter(!is.na(size)) %>% 
#   group_by(huc12_name, huc12_tnmid, size) %>% 
#   summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
#   pivot_wider(names_from = size, values_from = total_summed_prob) %>% 
#   mutate(ratio = (small/large))
# 
# shp_size_cc <- left_join(huc12, df_size_cc, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
#   mutate(taxa = "mussel",
#          scenario = "cc",
#          grp = "size")
# 
# kk <- ggplot(data = shp_size_cc)+
#   geom_sf(aes(fill = ratio), color = NA)+
#   scale_fill_gradient2(low = "blue",
#                         mid = "yellow",
#                         high = "red",
#                         midpoint = 5,
#                        limits = c(0,9))+
#     theme(panel.border = element_rect(colour = "black", fill = NA),
#           panel.grid.major = element_blank(),
#           panel.grid.minor = element_blank(),
#           panel.background = element_blank(),
#         strip.background = element_rect(fill = "grey50",
#                                         colour = "black"),
#         axis.text = element_blank(),
#         axis.ticks = element_blank(),
#         legend.text = element_text(size = 12),
#         legend.title = element_text(size = 15))+
#     ggtitle(label = "small : large - cc")+
#   labs(fill = "ratio")
# 


#4)	Total summed probabilities of equilibrium + periodic species divided by the total summed probabilities of opportunistic species.
# df_strat_cc <- mussel_cc_proboccurrence_huc12 %>% 
#   left_join(mussel_traits, by = "common_name") %>%
#   filter(!is.na(strat)) %>% 
#   group_by(huc12_name, huc12_tnmid, strat) %>% 
#   summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
#   pivot_wider(names_from = strat, values_from = total_summed_prob) %>% 
#   mutate(ratio = ((equilibrium + periodic) /opportunistic))
# 
# shp_strat_cc <- left_join(huc12, df_strat_cc, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
#   mutate(taxa = "mussel",
#          scenario = "cc",
#          grp = "strategy")
# 
# ll <- ggplot(data = shp_strat_cc)+
#   geom_sf(aes(fill = ratio), color = NA)+
#   scale_fill_gradient2(low = "blue",
#                         mid = "yellow",
#                         high = "red",
#                         midpoint = 5,
#                        limits = c(0,8))+
#     theme(panel.border = element_rect(colour = "black", fill = NA),
#           panel.grid.major = element_blank(),
#           panel.grid.minor = element_blank(),
#           panel.background = element_blank(),
#         strip.background = element_rect(fill = "grey50",
#                                         colour = "black"),
#         axis.text = element_blank(),
#         axis.ticks = element_blank(),
#         legend.text = element_text(size = 12),
#         legend.title = element_text(size = 15))+
#     ggtitle(label = "equil : opportun - cc")+
#   labs(fill = "ratio")
# 
# 
# #5)	Total summed probabilities of sensitive species divided by the total summed probabilities of secure species.
# df_rank_cc <- mussel_cc_proboccurrence_huc12 %>% 
#   left_join(mussel_traits, by = "common_name") %>%
#   filter(!is.na(rank)) %>% 
#   group_by(huc12_name, huc12_tnmid, rank) %>% 
#   summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
#   pivot_wider(names_from = rank, values_from = total_summed_prob) %>% 
#   mutate(ratio = (sensitive /secure))
# 
# shp_rank_cc <- left_join(huc12, df_rank_cc, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
#   mutate(taxa = "mussel",
#          scenario = "cc",
#          grp = "rank")
# 
# rank_cc <- ggplot(data = shp_rank_cc)+
#   geom_sf(aes(fill = ratio), color = NA)+
#   scale_fill_gradient2(low = "blue",
#                         mid = "yellow",
#                         high = "red",
#                         midpoint = .5,
#                        limits = c(0,1))+
#     theme(panel.border = element_rect(colour = "black", fill = NA),
#           panel.grid.major = element_blank(),
#           panel.grid.minor = element_blank(),
#           panel.background = element_blank(),
#         strip.background = element_rect(fill = "grey50",
#                                         colour = "black"),
#         axis.text = element_blank(),
#         axis.ticks = element_blank(),
#         legend.text = element_text(size = 12),
#         legend.title = element_text(size = 15))+
#     ggtitle(label = "sensitive : secure - cc")+
#   labs(fill = "ratio")
# 
# #6)	Total summed probabilities of thin species divided by the total summed probabilities of thick species.
# df_shell_cc <- mussel_cc_proboccurrence_huc12 %>% 
#   left_join(mussel_traits, by = "common_name") %>%
#   filter(!is.na(shell)) %>% 
#   group_by(huc12_name, huc12_tnmid, shell) %>% 
#   summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
#   pivot_wider(names_from = shell, values_from = total_summed_prob) %>% 
#   mutate(ratio = (thin /thick))
# 
# shp_shell_cc <- left_join(huc12, df_shell_cc, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
#   mutate(taxa = "mussel",
#          scenario = "cc",
#          grp = "shell")
# 
# shell_cc <- ggplot(data = shp_shell_cc)+
#   geom_sf(aes(fill = ratio), color = NA)+
#   scale_fill_gradient2(low = "blue",
#                         mid = "yellow",
#                         high = "red",
#                         midpoint = 1.5,
#                        limits = c(0,13))+
#     theme(panel.border = element_rect(colour = "black", fill = NA),
#           panel.grid.major = element_blank(),
#           panel.grid.minor = element_blank(),
#           panel.background = element_blank(),
#         strip.background = element_rect(fill = "grey50",
#                                         colour = "black"),
#         axis.text = element_blank(),
#         axis.ticks = element_blank(),
#         legend.text = element_text(size = 12),
#         legend.title = element_text(size = 15))+
#     ggtitle(label = "thin : thick - cc")+
#   labs(fill = "ratio")


#7)	Total summed probabilities of lotic species divided by the total summed probabilities of generalist species.
df_musselhabitat_cc <- mussel_cc_proboccurrence_huc12 %>% 
  left_join(mussel_traits, by = "common_name") %>%
  filter(!is.na(habitat)) %>% 
  group_by(huc12_name, huc12_tnmid, habitat) %>% 
  summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
  pivot_wider(names_from = habitat, values_from = total_summed_prob) %>% 
  mutate(ratio = (lotic /generalist))

shp_musselhabitat_cc <- left_join(huc12, df_musselhabitat_cc, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  mutate(taxa = "mussel",
         scenario = "Climate Change",
         grp = "habitat")

musselhabitat_cc <- ggplot(data = shp_musselhabitat_cc)+
  geom_sf(aes(fill = ratio), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = .5,
                       limits = c(0,1))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 15),
        legend.position = c(0.78, 0.21),
        legend.key.size = unit(.25, "cm"))+
    ggtitle(label = "lotic : generalist - CC")+
  labs(fill = "Ratio")


#8)	Total summed probabilities of flood negative cluster
df_musselfloodclust_cc <- mussel_cc_proboccurrence_huc12 %>% 
  left_join(cluster_mussel_flood, by = "common_name") %>%
  group_by(huc12_name, huc12_tnmid, cluster_flood) %>% 
  summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
  pivot_wider(names_from = cluster_flood, values_from = total_summed_prob)

shp_musselfloodclust <- left_join(huc12, df_musselfloodclust_cc, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  mutate(taxa = "mussel",
         scenario = "Climate Change",
         grp = "flood")

dr <- ggplot(data = shp_musselfloodclust)+
  geom_sf(aes(fill = `1 - flood negative`), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = 1.0,
                       limits = c(0,2.4))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 7),
        legend.title = element_text(size = 10),
        legend.position = c(0.78, 0.21),
        legend.key.size = unit(.3, "cm"))+
    ggtitle(label = "A. Mussel Flood Cluster - CC")+
  labs(fill = "Occ.")

#9)	Total summed probabilities of temperature negative cluster
df_musseltempclust_cc <- mussel_cc_proboccurrence_huc12 %>% 
  left_join(cluster_mussel_temp, by = "common_name") %>%
  group_by(huc12_name, huc12_tnmid, cluster_temp) %>% 
  summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
  pivot_wider(names_from = cluster_temp, values_from = total_summed_prob)

shp_musseltempclust <- left_join(huc12, df_musseltempclust_cc, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  mutate(taxa = "mussel",
         scenario = "Climate Change",
         grp = "temp")

ds <- ggplot(data = shp_musseltempclust)+
  geom_sf(aes(fill = `3 - temp negative`), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = 1.0,
                       limits = c(0,1))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 7),
        legend.title = element_text(size = 10),
        legend.position = c(0.78, 0.21),
        legend.key.size = unit(.25, "cm"))+
    ggtitle(label = "A. Mussel Temp Cluster - CC")+
  labs(fill = "Occ.")

############################################





#Climate Change and all the management actions combined

head(prediction_mg)
mussel_mg_proboccurrence_huc12 <- prediction_mg %>%
  data.frame() %>% 
  select(huc12_name, huc12_tnmid, 44:55) %>% 
  filter(!is.na(alewifefloater),
         !is.na(huc12_name)) %>%
  pivot_longer(3:14, names_to = "common_name", values_to = "prob_occ") %>% 
  group_by(huc12_name, huc12_tnmid, common_name) %>% 
  summarise(mean_prob_occ = mean(prob_occ)) %>% 
  ungroup() %>% 
  mutate(scenario = "Combined", taxa = "mussel")

mussel_mg_proboccurrence_huc12$common_name <- gsub(pattern = "\\.", replacement = " ", x = mussel_mg_proboccurrence_huc12$common_name)
mussel_mg_proboccurrence_huc12$common_name[mussel_mg_proboccurrence_huc12$common_name == "alewifefloater"] <- "alewife floater"
mussel_mg_proboccurrence_huc12$common_name[mussel_mg_proboccurrence_huc12$common_name == "easternpearlshell"] <- "eastern pearlshell"
mussel_mg_proboccurrence_huc12$common_name[mussel_mg_proboccurrence_huc12$common_name == "easternpondmussel"] <- "eastern pondmussel"
mussel_mg_proboccurrence_huc12$common_name[mussel_mg_proboccurrence_huc12$common_name == "Tidewatermucket"] <- "tidewater mucket"
mussel_mg_proboccurrence_huc12$common_name[mussel_mg_proboccurrence_huc12$common_name == "yellowlampmussel"] <- "yellow lampmussel"


mussel_mg_proboccurrence_huc12$mean_prob_occ[mussel_mg_proboccurrence_huc12$mean_prob_occ<0.01]<-0.01

#1)	Total summed probabilities of rare species divided by the total summed probabilities of common species.
df_status_mg <- mussel_mg_proboccurrence_huc12 %>% 
  left_join(mussel_traits, by = "common_name") %>%
  filter(!is.na(status)) %>% 
  group_by(huc12_name, huc12_tnmid, status) %>% 
  summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
  pivot_wider(names_from = status, values_from = total_summed_prob) %>% 
  mutate(status_ratio = rare/common)

shp_status_mg <- left_join(huc12, df_status_mg, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  mutate(taxa = "mussel",
         scenario = "Combined",
         grp = "status")

mm <- ggplot(data = shp_status_mg)+
  geom_sf(aes(fill = status_ratio), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = .26,
                       limits = c(0,.52))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 15))+
    ggtitle(label = "Rare:Common - Combined")+
  labs(fill = "Ratio")

  
  



#2)	Total summed probabilities of host specialist divided by the total summed probabilities of host generalist species.
df_host_mg <- mussel_mg_proboccurrence_huc12 %>% 
  left_join(mussel_traits, by = "common_name") %>%  
  filter(!is.na(host)) %>%
  group_by(huc12_name, huc12_tnmid, host) %>% 
  summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
  pivot_wider(names_from = host, values_from = total_summed_prob) %>% 
  mutate(host_ratio = (specialist / generalist))

shp_host_mg <- left_join(huc12, df_host_mg, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  mutate(taxa = "mussel",
         scenario = "Combined",
         grp = "host")

nn <- ggplot(data = shp_host_mg)+
  geom_sf(aes(fill = host_ratio), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = .26,
                       limits = c(0,.9))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 15))+
    ggtitle(label = "Specialist:Generalist - Combined")+
  labs(fill = "Ratio")



# #3)	Total summed probabilities of small species divided by the total summed probabilities of large species.
# df_size_mg <- mussel_mg_proboccurrence_huc12 %>% 
#   left_join(mussel_traits, by = "common_name") %>%
#   filter(!is.na(size)) %>% 
#   group_by(huc12_name, huc12_tnmid, size) %>% 
#   summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
#   pivot_wider(names_from = size, values_from = total_summed_prob) %>% 
#   mutate(ratio = (small/large))
# 
# shp_size_mg <- left_join(huc12, df_size_mg, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
#   mutate(taxa = "mussel",
#          scenario = "Riparian Restoration",
#          grp = "size")
# 
# oo <- ggplot(data = shp_size_mg)+
#   geom_sf(aes(fill = ratio), color = NA)+
#   scale_fill_gradient2(low = "blue",
#                         mid = "yellow",
#                         high = "red",
#                         midpoint = 5,
#                        limits = c(0,9))+
#     theme(panel.border = element_rect(colour = "black", fill = NA),
#           panel.grid.major = element_blank(),
#           panel.grid.minor = element_blank(),
#           panel.background = element_blank(),
#         strip.background = element_rect(fill = "grey50",
#                                         colour = "black"),
#         axis.text = element_blank(),
#         axis.ticks = element_blank(),
#         legend.text = element_text(size = 12),
#         legend.title = element_text(size = 15))+
#     ggtitle(label = "small : large - Riparian Restoration")+
#   labs(fill = "ratio")
# 
# 
# 
# #4)	Total summed probabilities of equilibrium + periodic species divided by the total summed probabilities of opportunistic species.
# df_strat_mg <- mussel_mg_proboccurrence_huc12 %>% 
#   left_join(mussel_traits, by = "common_name") %>%
#   filter(!is.na(strat)) %>% 
#   group_by(huc12_name, huc12_tnmid, strat) %>% 
#   summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
#   pivot_wider(names_from = strat, values_from = total_summed_prob) %>% 
#   mutate(ratio = ((equilibrium + periodic) /opportunistic))
# 
# shp_strat_mg <- left_join(huc12, df_strat_mg, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
#   mutate(taxa = "mussel",
#          scenario = "Riparian Restoration",
#          grp = "strategy")
# 
# pp <- ggplot(data = shp_strat_mg)+
#   geom_sf(aes(fill = ratio), color = NA)+
#   scale_fill_gradient2(low = "blue",
#                         mid = "yellow",
#                         high = "red",
#                         midpoint = 5,
#                        limits = c(0,8))+
#     theme(panel.border = element_rect(colour = "black", fill = NA),
#           panel.grid.major = element_blank(),
#           panel.grid.minor = element_blank(),
#           panel.background = element_blank(),
#         strip.background = element_rect(fill = "grey50",
#                                         colour = "black"),
#         axis.text = element_blank(),
#         axis.ticks = element_blank(),
#         legend.text = element_text(size = 12),
#         legend.title = element_text(size = 15))+
#     ggtitle(label = "equil : opportun - Riparian Restoration")+
#   labs(fill = "ratio")
# 
# 
# #5)	Total summed probabilities of senstive species divided by the total summed probabilities of secure species.
# df_rank_mg <- mussel_mg_proboccurrence_huc12 %>% 
#   left_join(mussel_traits, by = "common_name") %>%
#   filter(!is.na(rank)) %>% 
#   group_by(huc12_name, huc12_tnmid, rank) %>% 
#   summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
#   pivot_wider(names_from = rank, values_from = total_summed_prob) %>% 
#   mutate(ratio = (sensitive /secure))
# 
# shp_rank_mg <- left_join(huc12, df_rank_mg, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
#   mutate(taxa = "mussel",
#          scenario = "Riparian Restoration",
#          grp = "rank")
# 
# rank_mg <- ggplot(data = shp_rank_mg)+
#   geom_sf(aes(fill = ratio), color = NA)+
#   scale_fill_gradient2(low = "blue",
#                         mid = "yellow",
#                         high = "red",
#                         midpoint = 1.6,
#                        limits = c(0,3.73))+
#     theme(panel.border = element_rect(colour = "black", fill = NA),
#           panel.grid.major = element_blank(),
#           panel.grid.minor = element_blank(),
#           panel.background = element_blank(),
#         strip.background = element_rect(fill = "grey50",
#                                         colour = "black"),
#         axis.text = element_blank(),
#         axis.ticks = element_blank(),
#         legend.text = element_text(size = 12),
#         legend.title = element_text(size = 15))+
#     ggtitle(label = "sensitive : secure - Riparian Restoration")+
#   labs(fill = "ratio")
# 
# #6)	Total summed probabilities of thin species divided by the total summed probabilities of thick species.
# df_shell_mg <- mussel_mg_proboccurrence_huc12 %>% 
#   left_join(mussel_traits, by = "common_name") %>%
#   filter(!is.na(shell)) %>% 
#   group_by(huc12_name, huc12_tnmid, shell) %>% 
#   summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
#   pivot_wider(names_from = shell, values_from = total_summed_prob) %>% 
#   mutate(ratio = (thin /thick))
# 
# shp_shell_mg <- left_join(huc12, df_shell_mg, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
#   mutate(taxa = "mussel",
#          scenario = "Riparian Restoration",
#          grp = "shell")
# 
# shell_mg <- ggplot(data = shp_shell_mg)+
#   geom_sf(aes(fill = ratio), color = NA)+
#   scale_fill_gradient2(low = "blue",
#                         mid = "yellow",
#                         high = "red",
#                         midpoint = 3.34,
#                        limits = c(0,6.78))+
#     theme(panel.border = element_rect(colour = "black", fill = NA),
#           panel.grid.major = element_blank(),
#           panel.grid.minor = element_blank(),
#           panel.background = element_blank(),
#         strip.background = element_rect(fill = "grey50",
#                                         colour = "black"),
#         axis.text = element_blank(),
#         axis.ticks = element_blank(),
#         legend.text = element_text(size = 12),
#         legend.title = element_text(size = 15))+
#     ggtitle(label = "thin : thick - Riparian Restoration")+
#   labs(fill = "ratio")

#7)	Total summed probabilities of lotic species divided by the total summed probabilities of generalist species.
df_musselhabitat_mg <- mussel_mg_proboccurrence_huc12 %>% 
  left_join(mussel_traits, by = "common_name") %>%
  filter(!is.na(habitat)) %>% 
  group_by(huc12_name, huc12_tnmid, habitat) %>% 
  summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
  pivot_wider(names_from = habitat, values_from = total_summed_prob) %>% 
  mutate(ratio = (lotic /generalist))

shp_musselhabitat_mg <- left_join(huc12, df_musselhabitat_mg, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  mutate(taxa = "mussel",
         scenario = "Combined",
         grp = "habitat")

musselhabitat_mg <- ggplot(data = shp_musselhabitat_mg)+
  geom_sf(aes(fill = ratio), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = 1.25,
                       limits = c(0,2.53))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 15))+
    ggtitle(label = "Lotic:Lentic - Combined")+
  labs(fill = "Ratio")

#8)	Total summed probabilities of flood negative cluster
df_musselfloodclust_mg <- mussel_mg_proboccurrence_huc12 %>% 
  left_join(cluster_mussel_flood, by = "common_name") %>%
  group_by(huc12_name, huc12_tnmid, cluster_flood) %>% 
  summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
  pivot_wider(names_from = cluster_flood, values_from = total_summed_prob)

shp_musselfloodclust <- left_join(huc12, df_musselfloodclust_mg, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  mutate(taxa = "mussel",
         scenario = "Combined",
         grp = "flood")

dt <- ggplot(data = shp_musselfloodclust)+
  geom_sf(aes(fill = `1 - flood negative`), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = 1.0,
                       limits = c(0,2.0))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 7),
        legend.title = element_text(size = 10),
        legend.position = c(0.78, 0.21),
        legend.key.size = unit(.25, "cm"))+
    ggtitle(label = "A. Mussel Flood Cluster - Combined")+
  labs(fill = "Occ.")

#9)	Total summed probabilities of temperature negative cluster
df_musseltempclust_mg <- mussel_mg_proboccurrence_huc12 %>% 
  left_join(cluster_mussel_temp, by = "common_name") %>%
  group_by(huc12_name, huc12_tnmid, cluster_temp) %>% 
  summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
  pivot_wider(names_from = cluster_temp, values_from = total_summed_prob)

shp_musseltempclust <- left_join(huc12, df_musseltempclust_mg, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  mutate(taxa = "mussel",
         scenario = "Combined",
         grp = "temp")

du <- ggplot(data = shp_musseltempclust)+
  geom_sf(aes(fill = `3 - temp negative`), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = 1.0,
                       limits = c(0,2.0))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 7),
        legend.title = element_text(size = 10),
        legend.position = c(0.78, 0.21),
        legend.key.size = unit(.25, "cm"))+
    ggtitle(label = "A. Mussel Temp Cluster - Combined")+
  labs(fill = "Occ.")



############################################





#Climate Change and dam density = 0 mgmt

head(prediction_mg_cnt)
mussel_mg_cnt_proboccurrence_huc12 <- prediction_mg_cnt %>%
  data.frame() %>% 
  select(huc12_name, huc12_tnmid, 44:55) %>% 
  filter(!is.na(alewifefloater),
         !is.na(huc12_name)) %>%
  pivot_longer(3:14, names_to = "common_name", values_to = "prob_occ") %>% 
  group_by(huc12_name, huc12_tnmid, common_name) %>% 
  summarise(mean_prob_occ = mean(prob_occ)) %>% 
  ungroup() %>% 
  mutate(scenario = "Dam", taxa = "mussel")

mussel_mg_cnt_proboccurrence_huc12$common_name <- gsub(pattern = "\\.", replacement = " ", x = mussel_mg_cnt_proboccurrence_huc12$common_name)
mussel_mg_cnt_proboccurrence_huc12$common_name[mussel_mg_cnt_proboccurrence_huc12$common_name == "alewifefloater"] <- "alewife floater"
mussel_mg_cnt_proboccurrence_huc12$common_name[mussel_mg_cnt_proboccurrence_huc12$common_name == "easternpearlshell"] <- "eastern pearlshell"
mussel_mg_cnt_proboccurrence_huc12$common_name[mussel_mg_cnt_proboccurrence_huc12$common_name == "easternpondmussel"] <- "eastern pondmussel"
mussel_mg_cnt_proboccurrence_huc12$common_name[mussel_mg_cnt_proboccurrence_huc12$common_name == "Tidewatermucket"] <- "tidewater mucket"
mussel_mg_cnt_proboccurrence_huc12$common_name[mussel_mg_cnt_proboccurrence_huc12$common_name == "yellowlampmussel"] <- "yellow lampmussel"


mussel_mg_cnt_proboccurrence_huc12$mean_prob_occ[mussel_mg_cnt_proboccurrence_huc12$mean_prob_occ<0.01]<-0.01

#1)	Total summed probabilities of rare species divided by the total summed probabilities of common species.
df_status_mg_cnt <- mussel_mg_cnt_proboccurrence_huc12 %>% 
  left_join(mussel_traits, by = "common_name") %>%
  filter(!is.na(status)) %>% 
  group_by(huc12_name, huc12_tnmid, status) %>% 
  summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
  pivot_wider(names_from = status, values_from = total_summed_prob) %>% 
  mutate(status_ratio = rare/common)

shp_status_mg_cnt <- left_join(huc12, df_status_mg_cnt, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  mutate(taxa = "mussel",
         scenario = "Dam",
         grp = "status")

qq <- ggplot(data = shp_status_mg_cnt)+
  geom_sf(aes(fill = status_ratio), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = .26,
                       limits = c(0,.52))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 15))+
    ggtitle(label = "Rare:Common - Dam")+
  labs(fill = "Ratio")

  
  



#2)	Total summed probabilities of host specialist divided by the total summed probabilities of host generalist species.
df_host_mg_cnt <- mussel_mg_cnt_proboccurrence_huc12 %>% 
  left_join(mussel_traits, by = "common_name") %>%  
  filter(!is.na(host)) %>%
  group_by(huc12_name, huc12_tnmid, host) %>% 
  summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
  pivot_wider(names_from = host, values_from = total_summed_prob) %>% 
  mutate(host_ratio = (specialist / generalist))

shp_host_mg_cnt <- left_join(huc12, df_host_mg_cnt, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  mutate(taxa = "mussel",
         scenario = "Dam",
         grp = "host")

rr <- ggplot(data = shp_host_mg_cnt)+
  geom_sf(aes(fill = host_ratio), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = .26,
                       limits = c(0,.57))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 15))+
    ggtitle(label = "Specialist:Generalist - Dam")+
  labs(fill = "Ratio")



# #3)	Total summed probabilities of small species divided by the total summed probabilities of large species.
# df_size_mg_cnt <- mussel_mg_cnt_proboccurrence_huc12 %>% 
#   left_join(mussel_traits, by = "common_name") %>%
#   filter(!is.na(size)) %>% 
#   group_by(huc12_name, huc12_tnmid, size) %>% 
#   summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
#   pivot_wider(names_from = size, values_from = total_summed_prob) %>% 
#   mutate(ratio = (small/large))
# 
# shp_size_mg_cnt <- left_join(huc12, df_size_mg_cnt, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
#   mutate(taxa = "mussel",
#          scenario = "connectivity",
#          grp = "size")
# 
# ss <- ggplot(data = shp_size_mg_cnt)+
#   geom_sf(aes(fill = ratio), color = NA)+
#   scale_fill_gradient2(low = "blue",
#                         mid = "yellow",
#                         high = "red",
#                         midpoint = 5,
#                        limits = c(0,9))+
#     theme(panel.border = element_rect(colour = "black", fill = NA),
#           panel.grid.major = element_blank(),
#           panel.grid.minor = element_blank(),
#           panel.background = element_blank(),
#         strip.background = element_rect(fill = "grey50",
#                                         colour = "black"),
#         axis.text = element_blank(),
#         axis.ticks = element_blank(),
#         legend.text = element_text(size = 12),
#         legend.title = element_text(size = 15))+
#     ggtitle(label = "small : large - connectivity")+
#   labs(fill = "ratio")
# 
# 
# 
# #4)	Total summed probabilities of equilibrium + periodic species divided by the total summed probabilities of opportunistic species.
# df_strat_mg_cnt <- mussel_mg_cnt_proboccurrence_huc12 %>% 
#   left_join(mussel_traits, by = "common_name") %>%
#   filter(!is.na(strat)) %>% 
#   group_by(huc12_name, huc12_tnmid, strat) %>% 
#   summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
#   pivot_wider(names_from = strat, values_from = total_summed_prob) %>% 
#   mutate(ratio = ((equilibrium + periodic) /opportunistic))
# 
# shp_strat_mg_cnt <- left_join(huc12, df_strat_mg_cnt, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
#   mutate(taxa = "mussel",
#          scenario = "connectivity",
#          grp = "strategy")
# 
# tt <- ggplot(data = shp_strat_mg_cnt)+
#   geom_sf(aes(fill = ratio), color = NA)+
#   scale_fill_gradient2(low = "blue",
#                         mid = "yellow",
#                         high = "red",
#                         midpoint = 5,
#                        limits = c(0,8))+
#     theme(panel.border = element_rect(colour = "black", fill = NA),
#           panel.grid.major = element_blank(),
#           panel.grid.minor = element_blank(),
#           panel.background = element_blank(),
#         strip.background = element_rect(fill = "grey50",
#                                         colour = "black"),
#         axis.text = element_blank(),
#         axis.ticks = element_blank(),
#         legend.text = element_text(size = 12),
#         legend.title = element_text(size = 15))+
#     ggtitle(label = "equil : opportun - connectivity")+
#   labs(fill = "ratio")
# 
# 
# #5)	Total summed probabilities of senstive species divided by the total summed probabilities of secure species.
# df_rank_mg_cnt <- mussel_mg_cnt_proboccurrence_huc12 %>% 
#   left_join(mussel_traits, by = "common_name") %>%
#   filter(!is.na(rank)) %>% 
#   group_by(huc12_name, huc12_tnmid, rank) %>% 
#   summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
#   pivot_wider(names_from = rank, values_from = total_summed_prob) %>% 
#   mutate(ratio = (sensitive /secure))
# 
# shp_rank_mg_cnt <- left_join(huc12, df_rank_mg_cnt, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
#   mutate(taxa = "mussel",
#          scenario = "connectivity",
#          grp = "rank")
# 
# rank_mg_cnt <- ggplot(data = shp_rank_mg_cnt)+
#   geom_sf(aes(fill = ratio), color = NA)+
#   scale_fill_gradient2(low = "blue",
#                         mid = "yellow",
#                         high = "red",
#                         midpoint = 1,
#                        limits = c(0,2))+
#     theme(panel.border = element_rect(colour = "black", fill = NA),
#           panel.grid.major = element_blank(),
#           panel.grid.minor = element_blank(),
#           panel.background = element_blank(),
#         strip.background = element_rect(fill = "grey50",
#                                         colour = "black"),
#         axis.text = element_blank(),
#         axis.ticks = element_blank(),
#         legend.text = element_text(size = 12),
#         legend.title = element_text(size = 15))+
#     ggtitle(label = "senstive : secure - connectivity")+
#   labs(fill = "ratio")
# 
# 
# #6)	Total summed probabilities of thin species divided by the total summed probabilities of thick species.
# df_shell_mg_cnt <- mussel_mg_cnt_proboccurrence_huc12 %>% 
#   left_join(mussel_traits, by = "common_name") %>%
#   filter(!is.na(shell)) %>% 
#   group_by(huc12_name, huc12_tnmid, shell) %>% 
#   summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
#   pivot_wider(names_from = shell, values_from = total_summed_prob) %>% 
#   mutate(ratio = (thin /thick))
# 
# shp_shell_mg_cnt <- left_join(huc12, df_shell_mg_cnt, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
#   mutate(taxa = "mussel",
#          scenario = "connectivity",
#          grp = "shell")
# 
# shell_mg_cnt <- ggplot(data = shp_shell_mg_cnt)+
#   geom_sf(aes(fill = ratio), color = NA)+
#   scale_fill_gradient2(low = "blue",
#                         mid = "yellow",
#                         high = "red",
#                         midpoint = 5,
#                        limits = c(0,10))+
#     theme(panel.border = element_rect(colour = "black", fill = NA),
#           panel.grid.major = element_blank(),
#           panel.grid.minor = element_blank(),
#           panel.background = element_blank(),
#         strip.background = element_rect(fill = "grey50",
#                                         colour = "black"),
#         axis.text = element_blank(),
#         axis.ticks = element_blank(),
#         legend.text = element_text(size = 12),
#         legend.title = element_text(size = 15))+
#     ggtitle(label = "thin : thick - connectivity")+
#   labs(fill = "ratio")

#7)	Total summed probabilities of lotic species divided by the total summed probabilities of generalist species.
df_musselhabitat_mg_cnt <- mussel_mg_cnt_proboccurrence_huc12 %>% 
  left_join(mussel_traits, by = "common_name") %>%
  filter(!is.na(habitat)) %>% 
  group_by(huc12_name, huc12_tnmid, habitat) %>% 
  summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
  pivot_wider(names_from = habitat, values_from = total_summed_prob) %>% 
  mutate(ratio = (lotic /generalist))

shp_musselhabitat_mg_cnt <- left_join(huc12, df_musselhabitat_mg_cnt, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  mutate(taxa = "mussel",
         scenario = "Dam",
         grp = "habitat")

musselhabitat_mg_cnt <- ggplot(data = shp_musselhabitat_mg_cnt)+
  geom_sf(aes(fill = ratio), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = .7,
                       limits = c(0,1.4))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 15))+
    ggtitle(label = "Lotic:Lentic - Dam")+
  labs(fill = "Ratio")



#8)	Total summed probabilities of flood negative cluster
df_musselfloodclust_mg_cnt <- mussel_mg_cnt_proboccurrence_huc12 %>% 
  left_join(cluster_mussel_flood, by = "common_name") %>%
  group_by(huc12_name, huc12_tnmid, cluster_flood) %>% 
  summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
  pivot_wider(names_from = cluster_flood, values_from = total_summed_prob)

shp_musselfloodclust <- left_join(huc12, df_musselfloodclust_mg_cnt, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  mutate(taxa = "mussel",
         scenario = "Dam",
         grp = "flood")

dv <- ggplot(data = shp_musselfloodclust)+
  geom_sf(aes(fill = `1 - flood negative`), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = 1.0,
                       limits = c(0,2.0))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 7),
        legend.title = element_text(size = 10),
        legend.position = c(0.78, 0.21),
        legend.key.size = unit(.25, "cm"))+
    ggtitle(label = "A. Mussel Flood Cluster - Dam")+
  labs(fill = "Occ.")

#9)	Total summed probabilities of temperature negative cluster
df_musseltempclust_mg_cnt <- mussel_mg_cnt_proboccurrence_huc12 %>% 
  left_join(cluster_mussel_temp, by = "common_name") %>%
  group_by(huc12_name, huc12_tnmid, cluster_temp) %>% 
  summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
  pivot_wider(names_from = cluster_temp, values_from = total_summed_prob)

shp_musseltempclust <- left_join(huc12, df_musseltempclust_mg_cnt, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  mutate(taxa = "mussel",
         scenario = "Dam",
         grp = "temp")

dw <- ggplot(data = shp_musseltempclust)+
  geom_sf(aes(fill = `3 - temp negative`), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = 1.0,
                       limits = c(0,2.0))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 7),
        legend.title = element_text(size = 10),
        legend.position = c(0.78, 0.21),
        legend.key.size = unit(.25, "cm"))+
    ggtitle(label = "A. Mussel Temp Cluster - Dam")+
  labs(fill = "Occ.")



############################################





#Climate Change and Watershed Forest = 100%

head(prediction_forest)
mussel_forest_proboccurrence_huc12 <- prediction_forest %>%
  data.frame() %>% 
  select(huc12_name, huc12_tnmid, 44:55) %>% 
  filter(!is.na(alewifefloater),
         !is.na(huc12_name)) %>%
  pivot_longer(3:14, names_to = "common_name", values_to = "prob_occ") %>% 
  group_by(huc12_name, huc12_tnmid, common_name) %>% 
  summarise(mean_prob_occ = mean(prob_occ)) %>% 
  ungroup() %>% 
  mutate(scenario = "Forest", taxa = "mussel")

mussel_forest_proboccurrence_huc12$common_name <- gsub(pattern = "\\.", replacement = " ", x = mussel_forest_proboccurrence_huc12$common_name)
mussel_forest_proboccurrence_huc12$common_name[mussel_forest_proboccurrence_huc12$common_name == "alewifefloater"] <- "alewife floater"
mussel_forest_proboccurrence_huc12$common_name[mussel_forest_proboccurrence_huc12$common_name == "easternpearlshell"] <- "eastern pearlshell"
mussel_forest_proboccurrence_huc12$common_name[mussel_forest_proboccurrence_huc12$common_name == "easternpondmussel"] <- "eastern pondmussel"
mussel_forest_proboccurrence_huc12$common_name[mussel_forest_proboccurrence_huc12$common_name == "Tidewatermucket"] <- "tidewater mucket"
mussel_forest_proboccurrence_huc12$common_name[mussel_forest_proboccurrence_huc12$common_name == "yellowlampmussel"] <- "yellow lampmussel"


mussel_forest_proboccurrence_huc12$mean_prob_occ[mussel_forest_proboccurrence_huc12$mean_prob_occ<0.01]<-0.01

#1)	Total summed probabilities of rare species divided by the total summed probabilities of common species.
df_status_forest <- mussel_forest_proboccurrence_huc12 %>% 
  left_join(mussel_traits, by = "common_name") %>%
  filter(!is.na(status)) %>% 
  group_by(huc12_name, huc12_tnmid, status) %>% 
  summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
  pivot_wider(names_from = status, values_from = total_summed_prob) %>% 
  mutate(status_ratio = rare/common)

shp_status_forest <- left_join(huc12, df_status_forest, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  mutate(taxa = "mussel",
         scenario = "Forest",
         grp = "status")

qqr <- ggplot(data = shp_status_forest)+
  geom_sf(aes(fill = status_ratio), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = .26,
                       limits = c(0,.52))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 15))+
    ggtitle(label = "Rare:Common - Forest")+
  labs(fill = "Ratio")

  
  



#2)	Total summed probabilities of host specialist divided by the total summed probabilities of host generalist species.
df_host_forest <- mussel_forest_proboccurrence_huc12 %>% 
  left_join(mussel_traits, by = "common_name") %>%  
  filter(!is.na(host)) %>%
  group_by(huc12_name, huc12_tnmid, host) %>% 
  summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
  pivot_wider(names_from = host, values_from = total_summed_prob) %>% 
  mutate(host_ratio = (specialist / generalist))

shp_host_forest <- left_join(huc12, df_host_forest, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  mutate(taxa = "mussel",
         scenario = "Forest",
         grp = "host")

rrr <- ggplot(data = shp_host_forest)+
  geom_sf(aes(fill = host_ratio), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = .26,
                       limits = c(0,.57))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 15))+
    ggtitle(label = "Specialist:Generalist - Forest")+
  labs(fill = "Ratio")



#3)	Total summed probabilities of small species divided by the total summed probabilities of large species.
# df_size_forest <- mussel_forest_proboccurrence_huc12 %>% 
#   left_join(mussel_traits, by = "common_name") %>%
#   filter(!is.na(size)) %>% 
#   group_by(huc12_name, huc12_tnmid, size) %>% 
#   summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
#   pivot_wider(names_from = size, values_from = total_summed_prob) %>% 
#   mutate(ratio = (small/large))
# 
# shp_size_forest <- left_join(huc12, df_size_forest, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
#   mutate(taxa = "mussel",
#          scenario = "forest",
#          grp = "size")
# 
# ss <- ggplot(data = shp_size_forest)+
#   geom_sf(aes(fill = ratio), color = NA)+
#   scale_fill_gradient2(low = "blue",
#                         mid = "yellow",
#                         high = "red",
#                         midpoint = 5,
#                        limits = c(0,9))+
#     theme(panel.border = element_rect(colour = "black", fill = NA),
#           panel.grid.major = element_blank(),
#           panel.grid.minor = element_blank(),
#           panel.background = element_blank(),
#         strip.background = element_rect(fill = "grey50",
#                                         colour = "black"),
#         axis.text = element_blank(),
#         axis.ticks = element_blank(),
#         legend.text = element_text(size = 12),
#         legend.title = element_text(size = 15))+
#     ggtitle(label = "small : large - forest")+
#   labs(fill = "ratio")
# 
# 
# 
# #4)	Total summed probabilities of equilibrium + periodic species divided by the total summed probabilities of opportunistic species.
# df_strat_forest <- mussel_forest_proboccurrence_huc12 %>% 
#   left_join(mussel_traits, by = "common_name") %>%
#   filter(!is.na(strat)) %>% 
#   group_by(huc12_name, huc12_tnmid, strat) %>% 
#   summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
#   pivot_wider(names_from = strat, values_from = total_summed_prob) %>% 
#   mutate(ratio = ((equilibrium + periodic) /opportunistic))
# 
# shp_strat_forest <- left_join(huc12, df_strat_forest, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
#   mutate(taxa = "mussel",
#          scenario = "forest",
#          grp = "strategy")
# 
# tt <- ggplot(data = shp_strat_forest)+
#   geom_sf(aes(fill = ratio), color = NA)+
#   scale_fill_gradient2(low = "blue",
#                         mid = "yellow",
#                         high = "red",
#                         midpoint = 5,
#                        limits = c(0,8))+
#     theme(panel.border = element_rect(colour = "black", fill = NA),
#           panel.grid.major = element_blank(),
#           panel.grid.minor = element_blank(),
#           panel.background = element_blank(),
#         strip.background = element_rect(fill = "grey50",
#                                         colour = "black"),
#         axis.text = element_blank(),
#         axis.ticks = element_blank(),
#         legend.text = element_text(size = 12),
#         legend.title = element_text(size = 15))+
#     ggtitle(label = "equil : opportun - forest")+
#   labs(fill = "ratio")
# 
# 
# #5)	Total summed probabilities of senstive species divided by the total summed probabilities of secure species.
# df_rank_forest <- mussel_forest_proboccurrence_huc12 %>% 
#   left_join(mussel_traits, by = "common_name") %>%
#   filter(!is.na(rank)) %>% 
#   group_by(huc12_name, huc12_tnmid, rank) %>% 
#   summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
#   pivot_wider(names_from = rank, values_from = total_summed_prob) %>% 
#   mutate(ratio = (sensitive /secure))
# 
# shp_rank_forest <- left_join(huc12, df_rank_forest, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
#   mutate(taxa = "mussel",
#          scenario = "forest",
#          grp = "rank")
# 
# rank_forest <- ggplot(data = shp_rank_forest)+
#   geom_sf(aes(fill = ratio), color = NA)+
#   scale_fill_gradient2(low = "blue",
#                         mid = "yellow",
#                         high = "red",
#                         midpoint = 1,
#                        limits = c(0,2))+
#     theme(panel.border = element_rect(colour = "black", fill = NA),
#           panel.grid.major = element_blank(),
#           panel.grid.minor = element_blank(),
#           panel.background = element_blank(),
#         strip.background = element_rect(fill = "grey50",
#                                         colour = "black"),
#         axis.text = element_blank(),
#         axis.ticks = element_blank(),
#         legend.text = element_text(size = 12),
#         legend.title = element_text(size = 15))+
#     ggtitle(label = "senstive : secure - forest")+
#   labs(fill = "ratio")
# 
# 
# #6)	Total summed probabilities of thin species divided by the total summed probabilities of thick species.
# df_shell_forest <- mussel_forest_proboccurrence_huc12 %>% 
#   left_join(mussel_traits, by = "common_name") %>%
#   filter(!is.na(shell)) %>% 
#   group_by(huc12_name, huc12_tnmid, shell) %>% 
#   summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
#   pivot_wider(names_from = shell, values_from = total_summed_prob) %>% 
#   mutate(ratio = (thin /thick))
# 
# shp_shell_forest <- left_join(huc12, df_shell_forest, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
#   mutate(taxa = "mussel",
#          scenario = "forest",
#          grp = "shell")
# 
# shell_forest <- ggplot(data = shp_shell_forest)+
#   geom_sf(aes(fill = ratio), color = NA)+
#   scale_fill_gradient2(low = "blue",
#                         mid = "yellow",
#                         high = "red",
#                         midpoint = 5,
#                        limits = c(0,10))+
#     theme(panel.border = element_rect(colour = "black", fill = NA),
#           panel.grid.major = element_blank(),
#           panel.grid.minor = element_blank(),
#           panel.background = element_blank(),
#         strip.background = element_rect(fill = "grey50",
#                                         colour = "black"),
#         axis.text = element_blank(),
#         axis.ticks = element_blank(),
#         legend.text = element_text(size = 12),
#         legend.title = element_text(size = 15))+
#     ggtitle(label = "thin : thick - forest")+
#   labs(fill = "ratio")

#7)	Total summed probabilities of lotic species divided by the total summed probabilities of generalist species.
df_musselhabitat_forest <- mussel_forest_proboccurrence_huc12 %>% 
  left_join(mussel_traits, by = "common_name") %>%
  filter(!is.na(habitat)) %>% 
  group_by(huc12_name, huc12_tnmid, habitat) %>% 
  summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
  pivot_wider(names_from = habitat, values_from = total_summed_prob) %>% 
  mutate(ratio = (lotic /generalist))

shp_musselhabitat_forest <- left_join(huc12, df_musselhabitat_forest, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  mutate(taxa = "mussel",
         scenario = "Forest",
         grp = "habitat")

musselhabitat_forest <- ggplot(data = shp_musselhabitat_forest)+
  geom_sf(aes(fill = ratio), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = .7,
                       limits = c(0,1.4))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 15))+
    ggtitle(label = "Lotic:Lentic - Forest")+
  labs(fill = "Ratio")


#8)	Total summed probabilities of flood negative cluster
df_musselfloodclust_forest <- mussel_forest_proboccurrence_huc12 %>% 
  left_join(cluster_mussel_flood, by = "common_name") %>%
  group_by(huc12_name, huc12_tnmid, cluster_flood) %>% 
  summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
  pivot_wider(names_from = cluster_flood, values_from = total_summed_prob)

shp_musselfloodclust <- left_join(huc12, df_musselfloodclust_forest, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  mutate(taxa = "mussel",
         scenario = "Forest",
         grp = "flood")

dx <- ggplot(data = shp_musselfloodclust)+
  geom_sf(aes(fill = `1 - flood negative`), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = 1.0,
                       limits = c(0,2.0))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 7),
        legend.title = element_text(size = 10),
        legend.position = c(0.78, 0.21),
        legend.key.size = unit(.25, "cm"))+
    ggtitle(label = "A. Mussel Flood Cluster - Forest")+
  labs(fill = "Occ.")

#9)	Total summed probabilities of temperature negative cluster
df_musseltempclust_forest <- mussel_forest_proboccurrence_huc12 %>% 
  left_join(cluster_mussel_temp, by = "common_name") %>%
  group_by(huc12_name, huc12_tnmid, cluster_temp) %>% 
  summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
  pivot_wider(names_from = cluster_temp, values_from = total_summed_prob)

shp_musseltempclust <- left_join(huc12, df_musseltempclust_forest, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  mutate(taxa = "mussel",
         scenario = "Forest",
         grp = "temp")

dy <- ggplot(data = shp_musseltempclust)+
  geom_sf(aes(fill = `3 - temp negative`), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = 1.0,
                       limits = c(0,2.0))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 7),
        legend.title = element_text(size = 10),
        legend.position = c(0.78, 0.21),
        legend.key.size = unit(.25, "cm"))+
    ggtitle(label = "A. Mussel Temp Cluster - Forest")+
  labs(fill = "Occ.")




############################################




#Climate Change and riparian impervious = 0

head(prediction_impervious)
mussel_impervious_proboccurrence_huc12 <- prediction_impervious %>%
  data.frame() %>% 
  select(huc12_name, huc12_tnmid, 44:55) %>% 
  filter(!is.na(alewifefloater),
         !is.na(huc12_name)) %>%
  pivot_longer(3:14, names_to = "common_name", values_to = "prob_occ") %>% 
  group_by(huc12_name, huc12_tnmid, common_name) %>% 
  summarise(mean_prob_occ = mean(prob_occ)) %>% 
  ungroup() %>% 
  mutate(scenario = "Impervious", taxa = "mussel")

mussel_impervious_proboccurrence_huc12$common_name <- gsub(pattern = "\\.", replacement = " ", x = mussel_impervious_proboccurrence_huc12$common_name)
mussel_impervious_proboccurrence_huc12$common_name[mussel_impervious_proboccurrence_huc12$common_name == "alewifefloater"] <- "alewife floater"
mussel_impervious_proboccurrence_huc12$common_name[mussel_impervious_proboccurrence_huc12$common_name == "easternpearlshell"] <- "eastern pearlshell"
mussel_impervious_proboccurrence_huc12$common_name[mussel_impervious_proboccurrence_huc12$common_name == "easternpondmussel"] <- "eastern pondmussel"
mussel_impervious_proboccurrence_huc12$common_name[mussel_impervious_proboccurrence_huc12$common_name == "Tidewatermucket"] <- "tidewater mucket"
mussel_impervious_proboccurrence_huc12$common_name[mussel_impervious_proboccurrence_huc12$common_name == "yellowlampmussel"] <- "yellow lampmussel"


mussel_impervious_proboccurrence_huc12$mean_prob_occ[mussel_impervious_proboccurrence_huc12$mean_prob_occ<0.01]<-0.01

#1)	Total summed probabilities of rare species divided by the total summed probabilities of common species.
df_status_impervious <- mussel_impervious_proboccurrence_huc12 %>% 
  left_join(mussel_traits, by = "common_name") %>%
  filter(!is.na(status)) %>% 
  group_by(huc12_name, huc12_tnmid, status) %>% 
  summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
  pivot_wider(names_from = status, values_from = total_summed_prob) %>% 
  mutate(status_ratio = rare/common)

shp_status_impervious <- left_join(huc12, df_status_impervious, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  mutate(taxa = "mussel",
         scenario = "Impervious",
         grp = "status")

qqs <- ggplot(data = shp_status_impervious)+
  geom_sf(aes(fill = status_ratio), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = .26,
                       limits = c(0,.52))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 15))+
    ggtitle(label = "Rare:Common - Impervious")+
  labs(fill = "Ratio")

  
  



#2)	Total summed probabilities of host specialist divided by the total summed probabilities of host generalist species.
df_host_impervious <- mussel_impervious_proboccurrence_huc12 %>% 
  left_join(mussel_traits, by = "common_name") %>%  
  filter(!is.na(host)) %>%
  group_by(huc12_name, huc12_tnmid, host) %>% 
  summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
  pivot_wider(names_from = host, values_from = total_summed_prob) %>% 
  mutate(host_ratio = (specialist / generalist))

shp_host_impervious <- left_join(huc12, df_host_impervious, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  mutate(taxa = "mussel",
         scenario = "Impervious",
         grp = "host")

rrs <- ggplot(data = shp_host_impervious)+
  geom_sf(aes(fill = host_ratio), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = .26,
                       limits = c(0,.57))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 15))+
    ggtitle(label = "Specialist:Generalist - Impervious")+
  labs(fill = "Ratio")



# #3)	Total summed probabilities of small species divided by the total summed probabilities of large species.
# df_size_impervious <- mussel_impervious_proboccurrence_huc12 %>% 
#   left_join(mussel_traits, by = "common_name") %>%
#   filter(!is.na(size)) %>% 
#   group_by(huc12_name, huc12_tnmid, size) %>% 
#   summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
#   pivot_wider(names_from = size, values_from = total_summed_prob) %>% 
#   mutate(ratio = (small/large))
# 
# shp_size_impervious <- left_join(huc12, df_size_impervious, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
#   mutate(taxa = "mussel",
#          scenario = "impervious",
#          grp = "size")
# 
# ss <- ggplot(data = shp_size_impervious)+
#   geom_sf(aes(fill = ratio), color = NA)+
#   scale_fill_gradient2(low = "blue",
#                         mid = "yellow",
#                         high = "red",
#                         midpoint = 5,
#                        limits = c(0,9))+
#     theme(panel.border = element_rect(colour = "black", fill = NA),
#           panel.grid.major = element_blank(),
#           panel.grid.minor = element_blank(),
#           panel.background = element_blank(),
#         strip.background = element_rect(fill = "grey50",
#                                         colour = "black"),
#         axis.text = element_blank(),
#         axis.ticks = element_blank(),
#         legend.text = element_text(size = 12),
#         legend.title = element_text(size = 15))+
#     ggtitle(label = "small : large - impervious")+
#   labs(fill = "ratio")
# 
# 
# 
# #4)	Total summed probabilities of equilibrium + periodic species divided by the total summed probabilities of opportunistic species.
# df_strat_impervious <- mussel_impervious_proboccurrence_huc12 %>% 
#   left_join(mussel_traits, by = "common_name") %>%
#   filter(!is.na(strat)) %>% 
#   group_by(huc12_name, huc12_tnmid, strat) %>% 
#   summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
#   pivot_wider(names_from = strat, values_from = total_summed_prob) %>% 
#   mutate(ratio = ((equilibrium + periodic) /opportunistic))
# 
# shp_strat_impervious <- left_join(huc12, df_strat_impervious, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
#   mutate(taxa = "mussel",
#          scenario = "impervious",
#          grp = "strategy")
# 
# tt <- ggplot(data = shp_strat_impervious)+
#   geom_sf(aes(fill = ratio), color = NA)+
#   scale_fill_gradient2(low = "blue",
#                         mid = "yellow",
#                         high = "red",
#                         midpoint = 5,
#                        limits = c(0,8))+
#     theme(panel.border = element_rect(colour = "black", fill = NA),
#           panel.grid.major = element_blank(),
#           panel.grid.minor = element_blank(),
#           panel.background = element_blank(),
#         strip.background = element_rect(fill = "grey50",
#                                         colour = "black"),
#         axis.text = element_blank(),
#         axis.ticks = element_blank(),
#         legend.text = element_text(size = 12),
#         legend.title = element_text(size = 15))+
#     ggtitle(label = "equil : opportun - impervious")+
#   labs(fill = "ratio")
# 
# 
# #5)	Total summed probabilities of senstive species divided by the total summed probabilities of secure species.
# df_rank_impervious <- mussel_impervious_proboccurrence_huc12 %>% 
#   left_join(mussel_traits, by = "common_name") %>%
#   filter(!is.na(rank)) %>% 
#   group_by(huc12_name, huc12_tnmid, rank) %>% 
#   summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
#   pivot_wider(names_from = rank, values_from = total_summed_prob) %>% 
#   mutate(ratio = (sensitive /secure))
# 
# shp_rank_impervious <- left_join(huc12, df_rank_impervious, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
#   mutate(taxa = "mussel",
#          scenario = "impervious",
#          grp = "rank")
# 
# rank_wetland <- ggplot(data = shp_rank_impervious)+
#   geom_sf(aes(fill = ratio), color = NA)+
#   scale_fill_gradient2(low = "blue",
#                         mid = "yellow",
#                         high = "red",
#                         midpoint = 1,
#                        limits = c(0,2))+
#     theme(panel.border = element_rect(colour = "black", fill = NA),
#           panel.grid.major = element_blank(),
#           panel.grid.minor = element_blank(),
#           panel.background = element_blank(),
#         strip.background = element_rect(fill = "grey50",
#                                         colour = "black"),
#         axis.text = element_blank(),
#         axis.ticks = element_blank(),
#         legend.text = element_text(size = 12),
#         legend.title = element_text(size = 15))+
#     ggtitle(label = "senstive : secure - impervious")+
#   labs(fill = "ratio")
# 
# 
# #6)	Total summed probabilities of thin species divided by the total summed probabilities of thick species.
# df_shell_impervious <- mussel_impervious_proboccurrence_huc12 %>% 
#   left_join(mussel_traits, by = "common_name") %>%
#   filter(!is.na(shell)) %>% 
#   group_by(huc12_name, huc12_tnmid, shell) %>% 
#   summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
#   pivot_wider(names_from = shell, values_from = total_summed_prob) %>% 
#   mutate(ratio = (thin /thick))
# 
# shp_shell_impervious <- left_join(huc12, df_shell_impervious, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
#   mutate(taxa = "mussel",
#          scenario = "impervious",
#          grp = "shell")
# 
# shell_impervious <- ggplot(data = shp_shell_impervious)+
#   geom_sf(aes(fill = ratio), color = NA)+
#   scale_fill_gradient2(low = "blue",
#                         mid = "yellow",
#                         high = "red",
#                         midpoint = 5,
#                        limits = c(0,10))+
#     theme(panel.border = element_rect(colour = "black", fill = NA),
#           panel.grid.major = element_blank(),
#           panel.grid.minor = element_blank(),
#           panel.background = element_blank(),
#         strip.background = element_rect(fill = "grey50",
#                                         colour = "black"),
#         axis.text = element_blank(),
#         axis.ticks = element_blank(),
#         legend.text = element_text(size = 12),
#         legend.title = element_text(size = 15))+
#     ggtitle(label = "thin : thick - impervious")+
#   labs(fill = "ratio")

#7)	Total summed probabilities of lotic species divided by the total summed probabilities of generalist species.
df_musselhabitat_impervious <- mussel_impervious_proboccurrence_huc12 %>% 
  left_join(mussel_traits, by = "common_name") %>%
  filter(!is.na(habitat)) %>% 
  group_by(huc12_name, huc12_tnmid, habitat) %>% 
  summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
  pivot_wider(names_from = habitat, values_from = total_summed_prob) %>% 
  mutate(ratio = (lotic /generalist))

shp_musselhabitat_impervious <- left_join(huc12, df_musselhabitat_impervious, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  mutate(taxa = "mussel",
         scenario = "Impervious",
         grp = "habitat")

musselhabitat_impervious <- ggplot(data = shp_musselhabitat_impervious)+
  geom_sf(aes(fill = ratio), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = .7,
                       limits = c(0,1.4))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 15))+
    ggtitle(label = "Lotic:Lentic - Impervious")+
  labs(fill = "Ratio")


#8)	Total summed probabilities of flood negative cluster
df_musselfloodclust_impervious <- mussel_impervious_proboccurrence_huc12 %>% 
  left_join(cluster_mussel_flood, by = "common_name") %>%
  group_by(huc12_name, huc12_tnmid, cluster_flood) %>% 
  summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
  pivot_wider(names_from = cluster_flood, values_from = total_summed_prob)

shp_musselfloodclust <- left_join(huc12, df_musselfloodclust_impervious, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  mutate(taxa = "mussel",
         scenario = "Impervious",
         grp = "flood")

dz <- ggplot(data = shp_musselfloodclust)+
  geom_sf(aes(fill = `1 - flood negative`), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = 1.0,
                       limits = c(0,2.0))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 7),
        legend.title = element_text(size = 10),
        legend.position = c(0.78, 0.21),
        legend.key.size = unit(.25, "cm"))+
    ggtitle(label = "A. Mussel Flood Cluster - Impervious")+
  labs(fill = "Occ.")

#9)	Total summed probabilities of temperature negative cluster
df_musseltempclust_impervious <- mussel_impervious_proboccurrence_huc12 %>% 
  left_join(cluster_mussel_temp, by = "common_name") %>%
  group_by(huc12_name, huc12_tnmid, cluster_temp) %>% 
  summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
  pivot_wider(names_from = cluster_temp, values_from = total_summed_prob)

shp_musseltempclust <- left_join(huc12, df_musseltempclust_impervious, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  mutate(taxa = "mussel",
         scenario = "Impervious",
         grp = "temp")

da <- ggplot(data = shp_musseltempclust)+
  geom_sf(aes(fill = `3 - temp negative`), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = 1.0,
                       limits = c(0,2.0))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 7),
        legend.title = element_text(size = 10),
        legend.position = c(0.78, 0.21),
        legend.key.size = unit(.25, "cm"))+
    ggtitle(label = "A. Mussel Temp Cluster - Impervious")+
  labs(fill = "Occ.")




############################################




#Climate Change and riparian natural = 100%

head(prediction_natural)
mussel_natural_proboccurrence_huc12 <- prediction_natural %>%
  data.frame() %>% 
  select(huc12_name, huc12_tnmid, 44:55) %>% 
  filter(!is.na(alewifefloater),
         !is.na(huc12_name)) %>%
  pivot_longer(3:14, names_to = "common_name", values_to = "prob_occ") %>% 
  group_by(huc12_name, huc12_tnmid, common_name) %>% 
  summarise(mean_prob_occ = mean(prob_occ)) %>% 
  ungroup() %>% 
  mutate(scenario = "Natural", taxa = "mussel")

mussel_natural_proboccurrence_huc12$common_name <- gsub(pattern = "\\.", replacement = " ", x = mussel_natural_proboccurrence_huc12$common_name)
mussel_natural_proboccurrence_huc12$common_name[mussel_natural_proboccurrence_huc12$common_name == "alewifefloater"] <- "alewife floater"
mussel_natural_proboccurrence_huc12$common_name[mussel_natural_proboccurrence_huc12$common_name == "easternpearlshell"] <- "eastern pearlshell"
mussel_natural_proboccurrence_huc12$common_name[mussel_natural_proboccurrence_huc12$common_name == "easternpondmussel"] <- "eastern pondmussel"
mussel_natural_proboccurrence_huc12$common_name[mussel_natural_proboccurrence_huc12$common_name == "Tidewatermucket"] <- "tidewater mucket"
mussel_natural_proboccurrence_huc12$common_name[mussel_natural_proboccurrence_huc12$common_name == "yellowlampmussel"] <- "yellow lampmussel"


mussel_natural_proboccurrence_huc12$mean_prob_occ[mussel_natural_proboccurrence_huc12$mean_prob_occ<0.01]<-0.01

#1)	Total summed probabilities of rare species divided by the total summed probabilities of common species.
df_status_natural <- mussel_natural_proboccurrence_huc12 %>% 
  left_join(mussel_traits, by = "common_name") %>%
  filter(!is.na(status)) %>% 
  group_by(huc12_name, huc12_tnmid, status) %>% 
  summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
  pivot_wider(names_from = status, values_from = total_summed_prob) %>% 
  mutate(status_ratio = rare/common)

shp_status_natural <- left_join(huc12, df_status_natural, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  mutate(taxa = "mussel",
         scenario = "Natural",
         grp = "status")

qqa <- ggplot(data = shp_status_natural)+
  geom_sf(aes(fill = status_ratio), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = .26,
                       limits = c(0,.52))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 15))+
    ggtitle(label = "Rare:Common - Natural")+
  labs(fill = "Ratio")

  
  



#2)	Total summed probabilities of host specialist divided by the total summed probabilities of host generalist species.
df_host_natural <- mussel_natural_proboccurrence_huc12 %>% 
  left_join(mussel_traits, by = "common_name") %>%  
  filter(!is.na(host)) %>%
  group_by(huc12_name, huc12_tnmid, host) %>% 
  summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
  pivot_wider(names_from = host, values_from = total_summed_prob) %>% 
  mutate(host_ratio = (specialist / generalist))

shp_host_natural <- left_join(huc12, df_host_natural, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  mutate(taxa = "mussel",
         scenario = "Natural",
         grp = "host")

rra <- ggplot(data = shp_host_natural)+
  geom_sf(aes(fill = host_ratio), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = .26,
                       limits = c(0,.57))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 15))+
    ggtitle(label = "Specialist:Generalist - Natural")+
  labs(fill = "Ratio")



#3)	Total summed probabilities of small species divided by the total summed probabilities of large species.
# df_size_natural <- mussel_natural_proboccurrence_huc12 %>% 
#   left_join(mussel_traits, by = "common_name") %>%
#   filter(!is.na(size)) %>% 
#   group_by(huc12_name, huc12_tnmid, size) %>% 
#   summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
#   pivot_wider(names_from = size, values_from = total_summed_prob) %>% 
#   mutate(ratio = (small/large))
# 
# shp_size_natural <- left_join(huc12, df_size_natural, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
#   mutate(taxa = "mussel",
#          scenario = "natural",
#          grp = "size")
# 
# ss <- ggplot(data = shp_size_natural)+
#   geom_sf(aes(fill = ratio), color = NA)+
#   scale_fill_gradient2(low = "blue",
#                         mid = "yellow",
#                         high = "red",
#                         midpoint = 5,
#                        limits = c(0,9))+
#     theme(panel.border = element_rect(colour = "black", fill = NA),
#           panel.grid.major = element_blank(),
#           panel.grid.minor = element_blank(),
#           panel.background = element_blank(),
#         strip.background = element_rect(fill = "grey50",
#                                         colour = "black"),
#         axis.text = element_blank(),
#         axis.ticks = element_blank(),
#         legend.text = element_text(size = 12),
#         legend.title = element_text(size = 15))+
#     ggtitle(label = "small : large - natural")+
#   labs(fill = "ratio")
# 
# 
# 
# #4)	Total summed probabilities of equilibrium + periodic species divided by the total summed probabilities of opportunistic species.
# df_strat_natural <- mussel_natural_proboccurrence_huc12 %>% 
#   left_join(mussel_traits, by = "common_name") %>%
#   filter(!is.na(strat)) %>% 
#   group_by(huc12_name, huc12_tnmid, strat) %>% 
#   summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
#   pivot_wider(names_from = strat, values_from = total_summed_prob) %>% 
#   mutate(ratio = ((equilibrium + periodic) /opportunistic))
# 
# shp_strat_natural <- left_join(huc12, df_strat_natural, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
#   mutate(taxa = "mussel",
#          scenario = "natural",
#          grp = "strategy")
# 
# tt <- ggplot(data = shp_strat_natural)+
#   geom_sf(aes(fill = ratio), color = NA)+
#   scale_fill_gradient2(low = "blue",
#                         mid = "yellow",
#                         high = "red",
#                         midpoint = 5,
#                        limits = c(0,8))+
#     theme(panel.border = element_rect(colour = "black", fill = NA),
#           panel.grid.major = element_blank(),
#           panel.grid.minor = element_blank(),
#           panel.background = element_blank(),
#         strip.background = element_rect(fill = "grey50",
#                                         colour = "black"),
#         axis.text = element_blank(),
#         axis.ticks = element_blank(),
#         legend.text = element_text(size = 12),
#         legend.title = element_text(size = 15))+
#     ggtitle(label = "equil : opportun - natural")+
#   labs(fill = "ratio")
# 
# 
# #5)	Total summed probabilities of senstive species divided by the total summed probabilities of secure species.
# df_rank_natural <- mussel_natural_proboccurrence_huc12 %>% 
#   left_join(mussel_traits, by = "common_name") %>%
#   filter(!is.na(rank)) %>% 
#   group_by(huc12_name, huc12_tnmid, rank) %>% 
#   summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
#   pivot_wider(names_from = rank, values_from = total_summed_prob) %>% 
#   mutate(ratio = (sensitive /secure))
# 
# shp_rank_natural <- left_join(huc12, df_rank_natural, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
#   mutate(taxa = "mussel",
#          scenario = "natural",
#          grp = "rank")
# 
# rank_wetland <- ggplot(data = shp_rank_natural)+
#   geom_sf(aes(fill = ratio), color = NA)+
#   scale_fill_gradient2(low = "blue",
#                         mid = "yellow",
#                         high = "red",
#                         midpoint = 1,
#                        limits = c(0,2))+
#     theme(panel.border = element_rect(colour = "black", fill = NA),
#           panel.grid.major = element_blank(),
#           panel.grid.minor = element_blank(),
#           panel.background = element_blank(),
#         strip.background = element_rect(fill = "grey50",
#                                         colour = "black"),
#         axis.text = element_blank(),
#         axis.ticks = element_blank(),
#         legend.text = element_text(size = 12),
#         legend.title = element_text(size = 15))+
#     ggtitle(label = "senstive : secure - natural")+
#   labs(fill = "ratio")
# 
# 
# #6)	Total summed probabilities of thin species divided by the total summed probabilities of thick species.
# df_shell_natural <- mussel_natural_proboccurrence_huc12 %>% 
#   left_join(mussel_traits, by = "common_name") %>%
#   filter(!is.na(shell)) %>% 
#   group_by(huc12_name, huc12_tnmid, shell) %>% 
#   summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
#   pivot_wider(names_from = shell, values_from = total_summed_prob) %>% 
#   mutate(ratio = (thin /thick))
# 
# shp_shell_natural <- left_join(huc12, df_shell_natural, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
#   mutate(taxa = "mussel",
#          scenario = "natural",
#          grp = "shell")
# 
# shell_natural <- ggplot(data = shp_shell_natural)+
#   geom_sf(aes(fill = ratio), color = NA)+
#   scale_fill_gradient2(low = "blue",
#                         mid = "yellow",
#                         high = "red",
#                         midpoint = 5,
#                        limits = c(0,10))+
#     theme(panel.border = element_rect(colour = "black", fill = NA),
#           panel.grid.major = element_blank(),
#           panel.grid.minor = element_blank(),
#           panel.background = element_blank(),
#         strip.background = element_rect(fill = "grey50",
#                                         colour = "black"),
#         axis.text = element_blank(),
#         axis.ticks = element_blank(),
#         legend.text = element_text(size = 12),
#         legend.title = element_text(size = 15))+
#     ggtitle(label = "thin : thick - natural")+
#   labs(fill = "ratio")

#7)	Total summed probabilities of lotic species divided by the total summed probabilities of generalist species.
df_musselhabitat_natural <- mussel_natural_proboccurrence_huc12 %>% 
  left_join(mussel_traits, by = "common_name") %>%
  filter(!is.na(habitat)) %>% 
  group_by(huc12_name, huc12_tnmid, habitat) %>% 
  summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
  pivot_wider(names_from = habitat, values_from = total_summed_prob) %>% 
  mutate(ratio = (lotic /generalist))

shp_musselhabitat_natural <- left_join(huc12, df_musselhabitat_natural, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  mutate(taxa = "mussel",
         scenario = "Natural",
         grp = "habitat")

musselhabitat_natural <- ggplot(data = shp_musselhabitat_natural)+
  geom_sf(aes(fill = ratio), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = .7,
                       limits = c(0,1.4))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 15))+
    ggtitle(label = "Lotic:Lentic - Natural")+
  labs(fill = "Ratio")


#8)	Total summed probabilities of flood negative cluster
df_musselfloodclust_natural <- mussel_natural_proboccurrence_huc12 %>% 
  left_join(cluster_mussel_flood, by = "common_name") %>%
  group_by(huc12_name, huc12_tnmid, cluster_flood) %>% 
  summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
  pivot_wider(names_from = cluster_flood, values_from = total_summed_prob)

shp_musselfloodclust <- left_join(huc12, df_musselfloodclust_natural, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  mutate(taxa = "mussel",
         scenario = "Natural",
         grp = "flood")

db <- ggplot(data = shp_musselfloodclust)+
  geom_sf(aes(fill = `1 - flood negative`), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = 1.0,
                       limits = c(0,2.0))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 7),
        legend.title = element_text(size = 10),
        legend.position = c(0.78, 0.21),
        legend.key.size = unit(.25, "cm"))+
    ggtitle(label = "A. Mussel Flood Cluster - Natural")+
  labs(fill = "Occ.")

#9)	Total summed probabilities of temperature negative cluster
df_musseltempclust_natural <- mussel_natural_proboccurrence_huc12 %>% 
  left_join(cluster_mussel_temp, by = "common_name") %>%
  group_by(huc12_name, huc12_tnmid, cluster_temp) %>% 
  summarise(total_summed_prob = sum(mean_prob_occ)) %>% 
  pivot_wider(names_from = cluster_temp, values_from = total_summed_prob)

shp_musseltempclust <- left_join(huc12, df_musseltempclust_natural, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  mutate(taxa = "mussel",
         scenario = "Natural",
         grp = "temp")

dc <- ggplot(data = shp_musseltempclust)+
  geom_sf(aes(fill = `3 - temp negative`), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = 1.0,
                       limits = c(0,2.0))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 7),
        legend.title = element_text(size = 10),
        legend.position = c(0.78, 0.21),
        legend.key.size = unit(.25, "cm"))+
    ggtitle(label = "A. Mussel Temp Cluster - Natural")+
  labs(fill = "Occ.")


#################

# Change from baseline to future
# climate change ratio - baseline ratio
# positive value means the ratio has increased and the more vulnerable group is doing well
# negative value means the ratio has decreased and the more vulnerable group is doing poorly

unique(df_status_baseline$huc12_name == df_status_cc$huc12_name)
df_status_cc$status_ratio_change <- df_status_cc$status_ratio - df_status_baseline$status_ratio
shp_status_chng <- left_join(huc12, df_status_cc, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid"))

uu <- ggplot(data = shp_status_chng)+
  geom_sf(aes(fill = status_ratio_change), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "white",
                        high = "red",
                        midpoint = 0,
                       limits = c(-.8,.5))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 10),
        legend.title = element_text(size = 12),
        title = element_text(size = 10),
        legend.position = c(0.78, 0.21),
        legend.key.size = unit(.3, "cm"))+
    ggtitle(label = "E. Rare:common")+
  labs(fill = "Δ")

df_host_cc$host_ratio_change <- df_host_cc$host_ratio - df_host_baseline$host_ratio
shp_host_chng <- left_join(huc12, df_host_cc, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid"))

vv <- ggplot(data = shp_host_chng)+
  geom_sf(aes(fill = host_ratio_change), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "white",
                        high = "red",
                        midpoint = 0,
                       limits = c(-1,1))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 7),
        legend.title = element_text(size = 10),
        title = element_text(size = 10),
        legend.position = c(0.78, 0.21),
        legend.key.size = unit(.3, "cm"))+
    ggtitle(label = "F. Specialist:Generalist")+
  labs(fill = "Δ")

# df_size_cc$size_ratio_change <- df_size_cc$ratio - df_size_baseline$ratio
# shp_size_chng <- left_join(huc12, df_size_cc, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid"))
# 
# ww <- ggplot(data = shp_size_chng)+
#   geom_sf(aes(fill = size_ratio_change), color = NA)+
#   scale_fill_gradient2(low = "blue",
#                         mid = "white",
#                         high = "red",
#                         midpoint = 0,
#                        limits = c(-7.3,4.4))+
#     theme(panel.border = element_rect(colour = "black", fill = NA),
#           panel.grid.major = element_blank(),
#           panel.grid.minor = element_blank(),
#           panel.background = element_blank(),
#         strip.background = element_rect(fill = "grey50",
#                                         colour = "black"),
#         axis.text = element_blank(),
#         axis.ticks = element_blank(),
#         legend.text = element_text(size = 7),
#         legend.title = element_text(size = 10),
#         title = element_text(size = 10))+
#     ggtitle(label = "E. Small:large")+
#   labs(fill = "Δ")
# 
# 
# 
# df_strat_cc$strat_ratio_change <- df_strat_cc$ratio - df_strat_baseline$ratio
# shp_strat_chng <- left_join(huc12, df_strat_cc, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid"))
# 
# xx <- ggplot(data = shp_strat_chng)+
#   geom_sf(aes(fill = strat_ratio_change), color = NA)+
#   scale_fill_gradient2(low = "blue",
#                         mid = "white",
#                         high = "red",
#                         midpoint = 0,
#                        limits = c(-12,4))+
#     theme(panel.border = element_rect(colour = "black", fill = NA),
#           panel.grid.major = element_blank(),
#           panel.grid.minor = element_blank(),
#           panel.background = element_blank(),
#         strip.background = element_rect(fill = "grey50",
#                                         colour = "black"),
#         axis.text = element_blank(),
#         axis.ticks = element_blank(),
#         legend.text = element_text(size = 7),
#         legend.title = element_text(size = 10),
#         title = element_text(size = 10))+
#     ggtitle(label = "equib : opp")+
#   labs(fill = "Δ")
# 
# 
# df_rank_cc$rank_ratio_change <- df_rank_cc$ratio - df_rank_baseline$ratio
# shp_rank_chng <- left_join(huc12, df_rank_cc, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid"))
# 
# rank_cc_change <- ggplot(data = shp_rank_chng)+
#   geom_sf(aes(fill = rank_ratio_change), color = NA)+
#   scale_fill_gradient2(low = "blue",
#                         mid = "white",
#                         high = "red",
#                         midpoint = 0,
#                        limits = c(-2.6,.2))+
#     theme(panel.border = element_rect(colour = "black", fill = NA),
#           panel.grid.major = element_blank(),
#           panel.grid.minor = element_blank(),
#           panel.background = element_blank(),
#         strip.background = element_rect(fill = "grey50",
#                                         colour = "black"),
#         axis.text = element_blank(),
#         axis.ticks = element_blank(),
#         legend.text = element_text(size = 7),
#         legend.title = element_text(size = 10),
#         title = element_text(size = 10))+
#     ggtitle(label = "sensitive : secure")+
#   labs(fill = "Δ")
# 
# 
# df_shell_cc$shell_ratio_change <- df_shell_cc$ratio - df_shell_baseline$ratio
# shp_shell_chng <- left_join(huc12, df_shell_cc, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid"))
# 
# shell_cc_change <- ggplot(data = shp_shell_chng)+
#   geom_sf(aes(fill = shell_ratio_change), color = NA)+
#   scale_fill_gradient2(low = "blue",
#                         mid = "white",
#                         high = "red",
#                         midpoint = 0,
#                        limits = c(-2.2,12.3))+
#     theme(panel.border = element_rect(colour = "black", fill = NA),
#           panel.grid.major = element_blank(),
#           panel.grid.minor = element_blank(),
#           panel.background = element_blank(),
#         strip.background = element_rect(fill = "grey50",
#                                         colour = "black"),
#         axis.text = element_blank(),
#         axis.ticks = element_blank(),
#         legend.text = element_text(size = 7),
#         legend.title = element_text(size = 10),
#         title = element_text(size = 10))+
#     ggtitle(label = "thin : thick")+
#   labs(fill = "Δ")


df_musselhabitat_cc$musselhabitat_ratio_change <- df_musselhabitat_cc$ratio - df_musselhabitat_baseline$ratio
shp_musselhabitat_chng <- left_join(huc12, df_musselhabitat_cc, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid"))

musselhabitat_cc_change <- ggplot(data = shp_musselhabitat_chng)+
  geom_sf(aes(fill = musselhabitat_ratio_change), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "white",
                        high = "red",
                        midpoint = 0,
                       limits = c(-1.5,0.5))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 7),
        legend.title = element_text(size = 10),
        title = element_text(size = 10),
        legend.position = c(0.78, 0.21),
        legend.key.size = unit(.3, "cm"))+
    ggtitle(label = "G. Lotic:Lentic")+
  labs(fill = "Δ")





df_musselfloodclust_cc$musselfloodclust_change <- df_musselfloodclust_cc$`1 - flood negative` - df_musselfloodclust_baseline$`1 - flood negative`
shp_musselfloodclust_chng <- left_join(huc12, df_musselfloodclust_cc, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid"))

musselfloodclust_cc_change <- ggplot(data = shp_musselfloodclust_chng)+
  geom_sf(aes(fill = musselfloodclust_change), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "white",
                        high = "red",
                        midpoint = 0,
                       limits = c(-2,1))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        title = element_text(size = 10),
        legend.text = element_text(size = 11),
        legend.title = element_text(size = 12),
        legend.position = c(0.78, 0.21),
        legend.key.size = unit(.4, "cm"))+
    ggtitle(label = "C. Mussel Negative Flood Change")+
  labs(fill = "Δ")



df_musseltempclust_cc$musseltempclust_change <- df_musseltempclust_cc$`3 - temp negative` - df_musseltempclust_baseline$`3 - temp negative`
shp_musseltempclust_chng <- left_join(huc12, df_musseltempclust_cc, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid"))

musseltempclust_cc_change <- ggplot(data = shp_musseltempclust_chng)+
  geom_sf(aes(fill = musseltempclust_change), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "white",
                        high = "red",
                        midpoint = 0,
                       limits = c(-2.01,0.13))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        title = element_text(size = 10),
        legend.text = element_text(size = 11),
        legend.title = element_text(size = 12),
        legend.position = c(0.78, 0.21),
        legend.key.size = unit(.4, "cm"))+
    ggtitle(label = "D. Mussel Negative Temp Change")+
  labs(fill = "Δ")


########## Change in overall mussel species richness






#change from baseline to climate change for each species

prediction_cc <- data.frame(prediction_cc)
predictions_baseline <- data.frame(predictions_baseline)
prediction_mg <- data.frame(prediction_mg)
prediction_mg_cnt <- data.frame(prediction_mg_cnt)
prediction_forest <- data.frame(prediction_forest)
prediction_impervious <- data.frame(prediction_impervious)
prediction_natural <- data.frame(prediction_natural)

cc <- as.matrix(prediction_cc[, 44:55])
bl <- as.matrix(predictions_baseline[, 44:55])

change <- (cc - bl)
change <- data.frame(change)
change <- cbind(predictions_baseline[1:3], change)

change <- left_join(huc12, change, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid", "areasqkm" = "huc12_areasqkm"))

names(change) <- gsub("\\.", " ", names(change))


#sample plot
change <- change %>% 
  filter(name != "Long Island Sound Deep")

ggplot(data = change)+
  geom_sf(aes(fill = `eastern floater`), linewidth = .02)+
  scale_fill_gradient2(low = "red2",
                        mid = "white",
                        high = "green4",
                        midpoint = 0,
                       limits = c(-1,1))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 15),
        legend.title = element_text(size = 20))+
    ggtitle(label = "eastern floater")+
  labs(fill = "Δ P")

ggsave(paste("tmpfigures/baseline_mussel_predictions/tidewatermucket_change.png"), 
    plot = last_plot(),
    width = 18,
    height = 12,
    units = "cm",
    dpi = 300) 



#species richness in the baseline
richness_baseline <- predictions_baseline %>% 
  select(1,3,44:55) %>% 
  pivot_longer(3:14, names_to = "common_name", values_to = "prob") %>% 
  mutate(occurrence = ifelse(common_name %in% c("alewifefloater", "brook.floater", "dwarf.wedgemussel", "easternpondmussel", "Tidewatermucket", "yellowlampmussel") &
                                                  prob > 0.1 , 1,
                                                ifelse(common_name %in% c("creeper", "eastern.elliptio", "eastern.floater", "eastern.lampmussel", "easternpearlshell", "triangle.floater") & prob > 0.5, 1, 0)))  %>% 
  group_by(huc12_name, huc12_tnmid) %>% 
  summarise(richness = sum(occurrence))


richness_baseline <- left_join(huc12, richness_baseline, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  mutate(taxa = "mussel",
         scenario = "baseline",
         grp = "richness")

  
base_rich_muss <- ggplot(data = richness_baseline)+
  geom_sf(aes(fill = richness), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = 4.5,
                       limits = c(0,9))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 7),
        legend.title = element_text(size = 10),
        legend.position = c(0.78, 0.21),
        legend.key.size = unit(.3, "cm"))+
    ggtitle(label = "D. Species Richness")+
  labs(fill = "Richness")




#species richness in climate change
richness_cc <- prediction_cc %>% 
  select(1,3,44:55) %>% 
  pivot_longer(3:14, names_to = "common_name", values_to = "prob") %>% 
  mutate(occurrence = ifelse(common_name %in% c("alewifefloater", "brook.floater", "dwarf.wedgemussel", "easternpondmussel", "Tidewatermucket", "yellowlampmussel") &
                                                  prob > 0.1 , 1,
                                                ifelse(common_name %in% c("creeper", "eastern.elliptio", "eastern.floater", "eastern.lampmussel", "easternpearlshell", "triangle.floater") & prob > 0.5, 1, 0)))  %>% 
  group_by(huc12_name, huc12_tnmid) %>% 
  summarise(richness = sum(occurrence))

richness_cc <- left_join(huc12, richness_cc, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  mutate(taxa = "mussel",
         scenario = "cc",
         grp = "richness")


cc_rich_muss <- ggplot(data = richness_cc)+
  geom_sf(aes(fill = richness), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = 5,
                       limits = c(0,10))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 15),
        legend.title = element_text(size = 20))+
    ggtitle(label = "CC Species Richness")+
  labs(fill = "Richness")




#species richness in climate change and all  mgmt
richness_mg <- prediction_mg %>% 
  data.frame() %>% 
  select(1,3,44:55) %>% 
  pivot_longer(3:14, names_to = "common_name", values_to = "prob") %>% 
  mutate(occurrence = ifelse(common_name %in% c("alewifefloater", "brook.floater", "dwarf.wedgemussel", "easternpondmussel", "Tidewatermucket", "yellowlampmussel") &
                                                  prob > 0.1 , 1,
                                                ifelse(common_name %in% c("creeper", "eastern.elliptio", "eastern.floater", "eastern.lampmussel", "easternpearlshell", "triangle.floater") & prob > 0.5, 1, 0)))  %>% 
  group_by(huc12_name, huc12_tnmid) %>% 
  summarise(richness = sum(occurrence))

richness_mg <- left_join(huc12, richness_mg, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  mutate(taxa = "mussel",
         scenario = "Riparian Restoration",
         grp = "richness")


mg_rich_muss <- ggplot(data = richness_mg)+
  geom_sf(aes(fill = richness), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = 5,
                       limits = c(0,10))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 15),
        legend.title = element_text(size = 20))+
    ggtitle(label = "All Restoration Species Richness")+
  labs(fill = "Richness")




#species richness in climate change and connectivity mgmt
richness_mg_cnt <- prediction_mg_cnt %>% 
  data.frame() %>% 
  select(1,3,44:55) %>% 
  pivot_longer(3:14, names_to = "common_name", values_to = "prob") %>% 
  mutate(occurrence = ifelse(common_name %in% c("alewifefloater", "brook.floater", "dwarf.wedgemussel", "easternpondmussel", "Tidewatermucket", "yellowlampmussel") &
                                                  prob > 0.1 , 1,
                                                ifelse(common_name %in% c("creeper", "eastern.elliptio", "eastern.floater", "eastern.lampmussel", "easternpearlshell", "triangle.floater") & prob > 0.5, 1, 0)))  %>% 
  group_by(huc12_name, huc12_tnmid) %>% 
  summarise(richness = sum(occurrence))

richness_mg_cnt <- left_join(huc12, richness_mg_cnt, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  mutate(taxa = "mussel",
         scenario = "connectivity",
         grp = "richness")


cnt_rich_muss <- ggplot(data = richness_mg_cnt)+
  geom_sf(aes(fill = richness), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = 5,
                       limits = c(0,10))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 15),
        legend.title = element_text(size = 20))+
    ggtitle(label = "CC_mg_cnt Species Richness")+
  labs(fill = "Richness")






#species richness in climate change and Forest mgmt
richness_forest <- prediction_forest %>% 
  data.frame() %>% 
  select(1,3,44:55) %>% 
  pivot_longer(3:14, names_to = "common_name", values_to = "prob") %>% 
  mutate(occurrence = ifelse(common_name %in% c("alewifefloater", "brook.floater", "dwarf.wedgemussel", "easternpondmussel", "Tidewatermucket", "yellowlampmussel") &
                                                  prob > 0.1 , 1,
                                                ifelse(common_name %in% c("creeper", "eastern.elliptio", "eastern.floater", "eastern.lampmussel", "easternpearlshell", "triangle.floater") & prob > 0.5, 1, 0)))  %>% 
  group_by(huc12_name, huc12_tnmid) %>% 
  summarise(richness = sum(occurrence))

richness_forest <- left_join(huc12, richness_forest, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  mutate(taxa = "mussel",
         scenario = "forest",
         grp = "richness")


forest_rich_muss <- ggplot(data = richness_forest)+
  geom_sf(aes(fill = richness), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = 4,
                       limits = c(0,8))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 15),
        legend.title = element_text(size = 20))+
    ggtitle(label = "CC_forest Species Richness")+
  labs(fill = "Richness")





#species richness in climate change and riparian impervious managemnet
richness_impervious <- prediction_impervious %>% 
  data.frame() %>% 
  select(1,3,44:55) %>% 
  pivot_longer(3:14, names_to = "common_name", values_to = "prob") %>% 
  mutate(occurrence = ifelse(common_name %in% c("alewifefloater", "brook.floater", "dwarf.wedgemussel", "easternpondmussel", "Tidewatermucket", "yellowlampmussel") &
                                                  prob > 0.1 , 1,
                                                ifelse(common_name %in% c("creeper", "eastern.elliptio", "eastern.floater", "eastern.lampmussel", "easternpearlshell", "triangle.floater") & prob > 0.5, 1, 0)))  %>% 
  group_by(huc12_name, huc12_tnmid) %>% 
  summarise(richness = sum(occurrence))

richness_impervious <- left_join(huc12, richness_impervious, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  mutate(taxa = "mussel",
         scenario = "impervious",
         grp = "richness")


imp_rich_muss <- ggplot(data = richness_impervious)+
  geom_sf(aes(fill = richness), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = 2.5,
                       limits = c(0,5))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 15),
        legend.title = element_text(size = 20))+
    ggtitle(label = "CC_Impervious Species Richness")+
  labs(fill = "Richness")






#species richness in climate change and riparian natural managemnet
richness_natural <- prediction_natural %>% 
  data.frame() %>% 
  select(1,3,44:55) %>% 
  pivot_longer(3:14, names_to = "common_name", values_to = "prob") %>% 
  mutate(occurrence = ifelse(common_name %in% c("alewifefloater", "brook.floater", "dwarf.wedgemussel", "easternpondmussel", "Tidewatermucket", "yellowlampmussel") &
                                                  prob > 0.1 , 1,
                                                ifelse(common_name %in% c("creeper", "eastern.elliptio", "eastern.floater", "eastern.lampmussel", "easternpearlshell", "triangle.floater") & prob > 0.5, 1, 0)))  %>% 
  group_by(huc12_name, huc12_tnmid) %>% 
  summarise(richness = sum(occurrence))

richness_natural <- left_join(huc12, richness_natural, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  mutate(taxa = "mussel",
         scenario = "natural",
         grp = "richness")


nat_rich_muss <- ggplot(data = richness_natural)+
  geom_sf(aes(fill = richness), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = 2.5,
                       limits = c(0,5))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 15),
        legend.title = element_text(size = 20))+
    ggtitle(label = "CC_natural Species Richness")+
  labs(fill = "Richness")


#change in species richness: climate change - baseline

change_richness <- data.frame(
  "tnmid" = huc12$tnmid,
  "name" = huc12$name,
  "huc12" = huc12$huc12,
  "richness_change" = richness_cc$richness - richness_baseline$richness
)


change_richness <- left_join(huc12, change_richness, by = c("name", "tnmid", "huc12"))

  
ccc <- ggplot(data = change_richness)+
  geom_sf(aes(fill = richness_change), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "white",
                        high = "red",
                        midpoint = 0,
                       limits = c(min(change_richness$richness_change, na.rm = T), max(change_richness$richness_change, na.rm = T)))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 7),
        legend.title = element_text(size = 10),
        title = element_text(size = 10),
        legend.position = c(0.78, 0.21),
        legend.key.size = unit(.3, "cm"))+
    ggtitle(label = "H. Species Richness")+
  labs(fill = "Δ")



fig3 <- gridExtra::grid.arrange(ee,ff, musselhabitat_baseline, base_rich_muss,  
                                uu, vv, musselhabitat_cc_change, ccc, nrow = 2, ncol = 4)
ggsave(fig3, file = "tmpfigures/paper2/fig3_baseline_change_mussel.png", height = 10, width = 16, units = "in")

fig4 <- gridExtra::grid.arrange(dp,dq, 
                                musselfloodclust_cc_change, musseltempclust_cc_change, nrow = 2, ncol = 2)
ggsave(fig4, file = "tmpfigures/paper2/fig4_baseline_change_mussel_clusters.png", height = 10, width = 8, units = "in")




# #align change in richess values with change in the climate change varaibles
# covariates_bl <- NHDplusV2_NewEngCrop_mussel_covariates_HUC12 %>% 
#   select(huc12_name, huc12_tnmid, annual_mean_summer_temp, BFI_HIST, LO7Q1DT_HIST, CFM_HIST, W95_HIST, logMJJA_HIST)
# 
# #Climate change streamflow and temperature variables
# covariates_cc <- NHDplusV2_NewEngCrop_2080 %>% 
#   data.frame() %>% 
#   rename(annual_mean_summer_temp = annual_mean_summer_temp_pls_4,
#          BFI_HIST = BFI_2080,
#          LO7Q1DT_HIST = LO7Q1DT_2080,
#          CFM_HIST = CFM_2080,
#          W95_HIST = W95_2080,
#          logMJJA_HIST = logMJJA_2080) %>% 
#   select(huc12_name, huc12_tnmid, annual_mean_summer_temp, BFI_HIST, LO7Q1DT_HIST, CFM_HIST, W95_HIST, logMJJA_HIST) %>% 
#   group_by(huc12_name, huc12_tnmid) %>% 
#   summarise(annual_mean_summer_temp = mean(annual_mean_summer_temp, na.rm = T),
#             BFI_HIST = mean(BFI_HIST, na.rm = T),
#             LO7Q1DT_HIST = mean(LO7Q1DT_HIST, na.rm = T),
#             CFM_HIST = mean(CFM_HIST, na.rm = T),
#             W95_HIST = mean(W95_HIST, na.rm = T),
#             logMJJA_HIST = mean(logMJJA_HIST, na.rm = T))
# 
# 
# sum(names(covariates_bl) == names(covariates_cc)) #45
# sum(covariates_bl$huc12_name == covariates_cc$huc12_name, na.rm = T) #423
# 
# bl_cov <- covariates_bl %>% 
#   ungroup() %>% 
#   select(annual_mean_summer_temp, W95_HIST, logMJJA_HIST) %>% 
#   mutate(mjja_hist = exp(logMJJA_HIST)) %>% 
#   as.matrix()
# 
# cc_cov <- covariates_cc %>% 
#   ungroup() %>% 
#   select(annual_mean_summer_temp, W95_HIST, logMJJA_HIST) %>% 
#   mutate(mjja_hist = exp(logMJJA_HIST)) %>% 
#   as.matrix()
# 
# change_cov <- (cc_cov - bl_cov)
# change_cov <- data.frame(change_cov)
# change_cov <- cbind(covariates_bl[1:2], change_cov)
# 
# 
# change_cov <- left_join(huc12, change_cov, by = c("huc12_name", "huc12_tnmid"))%>% 
#   filter(huc12_name != "Long Island Sound Deep")
# 
#   
# ggplot(data = change_cov)+
#   geom_sf(aes(fill = annual_mean_summer_temp))+
#     theme(panel.border = element_rect(colour = "black", fill = NA),
#           panel.grid.major = element_blank(),
#           panel.grid.minor = element_blank(),
#           panel.background = element_blank(),
#         axis.text = element_blank(),
#         axis.ticks = element_blank(),
#         legend.text = element_text(size = 15),
#         legend.title = element_text(size = 20))+
#     ggtitle(label = "Annual mean summer temp Change")+
#   labs(fill = "Δ T(°C)")
# 
# ggsave(paste("tmpfigures/baseline_mussel_predictions/temp_change.png"), 
#     plot = last_plot(),
#     width = 18,
#     height = 12,
#     units = "cm",
#     dpi = 300)  
# 
# 
# change_richness <- change_richness %>% 
#   data.frame() %>% 
#   select(huc12_tnmid, huc12_name, richness_change)
# df <- left_join(change_cov, change_richness, by = c("huc10_name", "huc10_tnmid"))
# 
# df <- df %>% 
#   filter(!is.na(annual_mean_summer_temp))
# 
# r2 <- round(cor(df$richness_change, df$annual_mean_summer_temp),2)
# cor.test(df$richness_change, df$W95_HIST)
# label <- paste("R2 = ",  r2, sep = "")
# 
# ggplot(data = df, mapping = aes(x = annual_mean_summer_temp, y = richness_change))+
#   geom_jitter(alpha = 0.1, size = 3)+
#   geom_smooth(method = "lm", linewidth = 2, color = "red")+
#   labs(y = "Change in Richness",
#        x = "Change in Summer Stream Temperature (°C)")+
#     theme(panel.border = element_rect(colour = "black", fill = NA),
#           panel.grid.major = element_blank(),
#           panel.grid.minor = element_blank(),
#           panel.background = element_blank(),
#           axis.title = element_text(size = 17),
#           axis.text = element_text(size = 17))+
#   annotate("text",x=3,y=-3,label=r2 ,parse=TRUE, color = "red", size = 5)
# 

```

!!!! In the following section, we probably need to copy al the code and make figures for the new mussel clusters 

Here, We will overlay the different maps  to get 
1. 'best' watersheds in the baseline
2. most climate vulnerable (ie which have the biggest negative change)
3. most climate resistent (ie which have the least negative change)
4. which have the biggest increase in positive change with the mgmt scenario

```{r}
#1. 
#first we need to standardize each of the ratios so that the 'larger' ratios are not considered more important than the 'smaller' ratios

#make a matrix of all the ratio columns and then scale them and then add them together and then cbind back to the HUC12 and plot
#there are two ways I am going to look at best:
#1. the watersheds that maximize the fish origin ratio and the mussel spp richess 
#2. the watersheds that maximuz the spp that might be most vulnerable to cliamte change (fish temp, fish habitat, mussel size, mussel strat)

#this looks at the ratios of combined groups in the baseline
df <- scale(as.matrix(data.frame(
  "x1" = shp_origin$origin_ratio,
  "x2" = shp_habitat$habitat_ratio,
  "x3" = shp_temp$ratio,
  "x4" =  shp_status$status_ratio,
  "x5" = shp_host$host_ratio,
  "x8" = richness_baseline$richness,
  "x11" = shp_musselhabitat$ratio,
  "x12" = shp_musseltempclust$`4 - temp positive`)))

#native fish and mussel richness
native <- data.frame(df) %>% 
  mutate(native = x1 +x8)

#FS fish and mussel
habitat <- data.frame(df) %>% 
  mutate(habitat = x2 + x11)

#cold water fish and temperature negative mussels
climvul <- data.frame(df) %>%
  mutate(climvul = x3 + x12)

# best <- data.frame(df) %>% 
#   mutate(best = x1 + x2 + x3 + x4 + x5 + x6 + x7 + x8)

huc12 <- st_read("C:/Users/jenrogers/Documents/necascFreshwaterBio/SpatialData/NHDplus/WBDHU12/WBDHU12_NE.shp")

huc12$native <- native$native
huc12$climvul <- climvul$climvul
huc12$habitat <- habitat$habitat

aaaa <- ggplot(data = huc12)+
  geom_sf(aes(fill = native), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = 1,
                       limits = c(-3,4.2))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 7),
        legend.title = element_text(size = 10))+
    ggtitle(label = "A. Native")+
  labs(fill = "Sum")

bbbb <- ggplot(data = huc12)+
  geom_sf(aes(fill = climvul), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = 3.3,
                       limits = c(-3,10.3))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 7),
        legend.title = element_text(size = 10))+
    ggtitle(label = "B. Cold water")+
  labs(fill = "Sum")

cccc <- ggplot(data = huc12)+
  geom_sf(aes(fill = habitat), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = 1.5,
                       limits = c(-3,7.4))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 7),
        legend.title = element_text(size = 10))+
    ggtitle(label = "C. Lotic Dependent")+
  labs(fill = "Sum")


load("C:/Users/jenrogers/Documents/necascFreshwaterBio/model_datafiles/NHDplusV2_NewEngCrop_mussel_covariates_HUC12.RData")
NHDplusV2_NewEngCrop_mussel_covariates_HUC12 <- NHDplusV2_NewEngCrop_mussel_covariates_HUC12 %>%  
  mutate(WatershedArea = ifelse(logWsAreaSqKm > 2.561496, "Large", "Small")) %>%  #that is the mean logWsAreaSqKm
  mutate(latitude  = ifelse(lat > 44.51944, "High latitude",
                            ifelse(lat < 42.97004, "Low latitude", "Mid latitude"))) %>% 
  mutate(elevation  = ifelse(ElevCat > 181.4322 , "High elevation", "Low elevation")) 

NHDplusV2_NewEngCrop_mussel_covariates_HUC12$latitude <- 
  factor(NHDplusV2_NewEngCrop_mussel_covariates_HUC12$latitude, levels = c("Low latitude", "Mid latitude", "High latitude"))

NHDplusV2_NewEngCrop_mussel_covariates_HUC12$elevation <- 
  factor(NHDplusV2_NewEngCrop_mussel_covariates_HUC12$elevation, levels = c("Low elevation", "Mid elevation", "High elevation"))

NHDplusV2_NewEngCrop_mussel_covariates_HUC12$WatershedArea <- 
  factor(NHDplusV2_NewEngCrop_mussel_covariates_HUC12$WatershedArea, levels = c("Small", "Large"))


huc12 <- left_join(huc12, NHDplusV2_NewEngCrop_mussel_covariates_HUC12, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  filter(!is.na(elevation),
         !is.na(latitude),
         !is.na(WatershedArea)) 

huc12describe <- huc12 %>% 
  data.frame() %>% 
  group_by(elevation, latitude) %>% 
  summarise(native = mean(native, na.rm = T))
huc12describe <- huc12 %>%
  data.frame() %>%
  group_by(elevation, latitude) %>%
  summarise(climvul = mean(climvul, na.rm = T))
huc12describe <- huc12 %>% 
  data.frame() %>% 
  group_by(elevation, latitude) %>% 
  summarise(habitat = mean(habitat, na.rm = T))


#2. most climate vulnerable (ie which have the biggest negative change)
#this looks at the ratios of vulnerable to not vulnerable
df <- scale(as.matrix(data.frame(
  "x1" = shp_origin_chng$origin_ratio_change,
  "x2" = shp_habitat_chng$habitat_ratio_change,
  "x3" = shp_temp_chng$temp_ratio_change,
  "x4" = shp_status_chng$status_ratio_change,
  "x5" = shp_host_chng$host_ratio_change,
  "x8" = change_richness$richness_change,
  "x11" = shp_musselhabitat_chng$musselhabitat_ratio_change,
  "x12" = shp_musseltempclust_chng$musseltempclust_change)))


native <- data.frame(df) %>% 
  mutate(native = x1 +x8)

climvul <- data.frame(df) %>%
  mutate(climvul = x3 + x12)

habitat <- data.frame(df) %>% 
  mutate(habitat = x2 + x11)

huc12 <- st_read("C:/Users/jenrogers/Documents/necascFreshwaterBio/SpatialData/NHDplus/WBDHU12/WBDHU12_NE.shp")


huc12$native <- native$native
huc12$climvul <- climvul$climvul
huc12$habitat <- habitat$habitat

dddd <- ggplot(data = huc12)+
  geom_sf(aes(fill = native), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "white",
                        high = "red",
                        midpoint = 0,
                       limits = c(-6,3.4))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 7),
        legend.title = element_text(size = 10))+
    ggtitle(label = "D. Native")+
  labs(fill = "Sum")

eeee <- ggplot(data = huc12)+
  geom_sf(aes(fill = climvul), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "white",
                        high = "red",
                        midpoint = 0,
                       limits = c(-5,10))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 7),
        legend.title = element_text(size = 10))+
    ggtitle(label = "E. Cold Water")+
  labs(fill = "Sum")

ffff <- ggplot(data = huc12)+
  geom_sf(aes(fill = habitat), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "white",
                        high = "red",
                        midpoint = 0,
                       limits = c(-9,3))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 7),
        legend.title = element_text(size = 10))+
    ggtitle(label = "F. Lotic Dependent")+
  labs(fill = "Sum")

fig5 <- gridExtra::grid.arrange(aaaa,bbbb, cccc, dddd, eeee, ffff, nrow = 2, ncol = 3)
ggsave(fig5, file = "tmpfigures/paper2/fig5_baseline_change_mussel_and_fish.png")

huc12 <- left_join(huc12, NHDplusV2_NewEngCrop_mussel_covariates_HUC12, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  filter(!is.na(elevation),
         !is.na(latitude)) 
huc12describe <- huc12 %>% 
  data.frame() %>% 
  group_by(elevation, latitude) %>% 
  summarise(native = mean(native, na.rm = T))
huc12describe <- huc12 %>%
  data.frame() %>%
  group_by(elevation, latitude) %>%
  summarise(climvul = mean(climvul, na.rm = T))
huc12describe <- huc12 %>% 
  data.frame() %>% 
  group_by(elevation, latitude) %>% 
  summarise(habitat = mean(habitat, na.rm = T))



#make dot plot figure showing values of each metric (facet) by scenaio (color)

load("C:/Users/jenrogers/Documents/necascFreshwaterBio/model_datafiles/NHDv2_huc_state_join.RData")

df1 <- shp_habitat %>% 
  select(name, tnmid, taxa, scenario, grp, habitat_ratio) %>% 
  rename(ratio = habitat_ratio)
df2 <- shp_habitat_cc %>% 
  select(name, tnmid, taxa, scenario, grp, habitat_ratio) %>% 
  rename(ratio = habitat_ratio)
df3 <- shp_habitat_mg %>% 
  select(name, tnmid, taxa, scenario, grp, habitat_ratio) %>% 
  rename(ratio = habitat_ratio)
df4 <- shp_habitat_mg_cnt %>% 
  select(name, tnmid, taxa, scenario, grp, habitat_ratio) %>% 
  rename(ratio = habitat_ratio)
df4a <- shp_habitat_forest %>% 
  select(name, tnmid, taxa, scenario, grp, habitat_ratio) %>% 
  rename(ratio = habitat_ratio)
df4b <- shp_habitat_natural %>% 
  select(name, tnmid, taxa, scenario, grp, habitat_ratio) %>% 
  rename(ratio = habitat_ratio)
df4c <- shp_habitat_impervious %>% 
  select(name, tnmid, taxa, scenario, grp, habitat_ratio) %>% 
  rename(ratio = habitat_ratio)


df5 <- shp_origin %>% 
  select(name, tnmid, taxa, scenario, grp, origin_ratio) %>% 
  rename(ratio = origin_ratio)
df6 <- shp_origin_cc %>% 
  select(name, tnmid, taxa, scenario, grp, origin_ratio) %>% 
  rename(ratio = origin_ratio)
df7 <- shp_origin_mg %>% 
  select(name, tnmid, taxa, scenario, grp, origin_ratio) %>% 
  rename(ratio = origin_ratio)
df8 <- shp_origin_mg_cnt %>% 
  select(name, tnmid, taxa, scenario, grp, origin_ratio) %>% 
  rename(ratio = origin_ratio)
df8a <- shp_origin_forest %>% 
  select(name, tnmid, taxa, scenario, grp, origin_ratio) %>% 
  rename(ratio = origin_ratio)
df8b <- shp_origin_natural %>% 
  select(name, tnmid, taxa, scenario, grp, origin_ratio) %>% 
  rename(ratio = origin_ratio)
df8c <- shp_origin_impervious %>% 
  select(name, tnmid, taxa, scenario, grp, origin_ratio) %>% 
  rename(ratio = origin_ratio)

df9 <- shp_temp %>% 
  select(name, tnmid, taxa, scenario, grp, ratio) 
df10 <- shp_temp_cc %>% 
  select(name, tnmid, taxa, scenario, grp, ratio)
df11 <- shp_temp_mg %>% 
  select(name, tnmid, taxa, scenario, grp, ratio) 
df12 <- shp_temp_mg_cnt %>% 
  select(name, tnmid, taxa, scenario, grp, ratio)
df12a <- shp_temp_forest %>% 
  select(name, tnmid, taxa, scenario, grp, ratio)
df12b <- shp_temp_natural %>% 
  select(name, tnmid, taxa, scenario, grp, ratio)
df12c <- shp_temp_impervious %>% 
  select(name, tnmid, taxa, scenario, grp, ratio)

df13 <- shp_status %>% 
  select(name, tnmid, taxa, scenario, grp, status_ratio)%>% 
  rename(ratio = status_ratio) 
df14 <- shp_status_cc %>% 
  select(name, tnmid, taxa, scenario, grp, status_ratio)%>% 
  rename(ratio = status_ratio)
df15 <- shp_status_mg %>% 
  select(name, tnmid, taxa, scenario, grp, status_ratio) %>% 
  rename(ratio = status_ratio)
df16 <- shp_status_mg_cnt %>% 
  select(name, tnmid, taxa, scenario, grp, status_ratio)%>% 
  rename(ratio = status_ratio)
df16a <- shp_status_forest %>% 
  select(name, tnmid, taxa, scenario, grp, status_ratio)%>% 
  rename(ratio = status_ratio)
df16b <- shp_status_natural %>% 
  select(name, tnmid, taxa, scenario, grp, status_ratio)%>% 
  rename(ratio = status_ratio)
df16c <- shp_status_impervious %>% 
  select(name, tnmid, taxa, scenario, grp, status_ratio)%>% 
  rename(ratio = status_ratio)

df16d <- shp_host %>% 
  select(name, tnmid, taxa, scenario, grp, host_ratio)%>% 
  rename(ratio = host_ratio) 
df16e <- shp_host_cc %>% 
  select(name, tnmid, taxa, scenario, grp, host_ratio)%>% 
  rename(ratio = host_ratio)
df16f <- shp_host_mg %>% 
  select(name, tnmid, taxa, scenario, grp, host_ratio) %>% 
  rename(ratio = host_ratio)
df16g <- shp_host_mg_cnt %>% 
  select(name, tnmid, taxa, scenario, grp, host_ratio)%>% 
  rename(ratio = host_ratio)
df16h <- shp_host_forest %>% 
  select(name, tnmid, taxa, scenario, grp, host_ratio)%>% 
  rename(ratio = host_ratio)
df16i <- shp_host_natural %>% 
  select(name, tnmid, taxa, scenario, grp, host_ratio)%>% 
  rename(ratio = host_ratio)
df16j <- shp_host_impervious %>% 
  select(name, tnmid, taxa, scenario, grp, host_ratio)%>% 
  rename(ratio = host_ratio)

# df17 <- shp_size %>% 
#   select(name, tnmid, taxa, scenario, grp, ratio) 
# df18 <- shp_size_cc %>% 
#   select(name, tnmid, taxa, scenario, grp, ratio)
# df19 <- shp_size_mg %>% 
#   select(name, tnmid, taxa, scenario, grp, ratio)
# df20 <- shp_size_mg_cnt %>% 
#   select(name, tnmid, taxa, scenario, grp, ratio)
# df20a <- shp_size_forest %>% 
#   select(name, tnmid, taxa, scenario, grp, ratio)
# df20b <- shp_size_wetland %>% 
#   select(name, tnmid, taxa, scenario, grp, ratio)
# 
# 
# df21 <- shp_strat %>% 
#   select(name, tnmid, taxa, scenario, grp, ratio) 
# df22 <- shp_strat_cc %>% 
#   select(name, tnmid, taxa, scenario, grp, ratio)
# df23 <- shp_strat_mg %>% 
#   select(name, tnmid, taxa, scenario, grp, ratio)
# df24 <- shp_strat_mg_cnt %>% 
#   select(name, tnmid, taxa, scenario, grp, ratio)
# df24a <- shp_strat_forest %>% 
#   select(name, tnmid, taxa, scenario, grp, ratio)
# df24b <- shp_strat_wetland %>% 
#   select(name, tnmid, taxa, scenario, grp, ratio)
# 
# 
# df29 <- shp_rank %>% 
#   select(name, tnmid, taxa, scenario, grp, ratio) 
# df30 <- shp_rank_cc %>% 
#   select(name, tnmid, taxa, scenario, grp, ratio)
# df31 <- shp_rank_mg %>% 
#   select(name, tnmid, taxa, scenario, grp, ratio)
# df32 <- shp_rank_mg_cnt %>% 
#   select(name, tnmid, taxa, scenario, grp, ratio)
# df33 <- shp_rank_forest %>% 
#   select(name, tnmid, taxa, scenario, grp, ratio)
# df34 <- shp_rank_wetland %>% 
#   select(name, tnmid, taxa, scenario, grp, ratio)
# 
# df35 <- shp_shell %>% 
#   select(name, tnmid, taxa, scenario, grp, ratio) 
# df36 <- shp_shell_cc %>% 
#   select(name, tnmid, taxa, scenario, grp, ratio)
# df37 <- shp_shell_mg %>% 
#   select(name, tnmid, taxa, scenario, grp, ratio)
# df38 <- shp_shell_mg_cnt %>% 
#   select(name, tnmid, taxa, scenario, grp, ratio)
# df39 <- shp_shell_forest %>% 
#   select(name, tnmid, taxa, scenario, grp, ratio)
# df40 <- shp_shell_wetland %>% 
#   select(name, tnmid, taxa, scenario, grp, ratio)

df41 <- shp_musselhabitat %>% 
  select(name, tnmid, taxa, scenario, grp, ratio) 
df42 <- shp_musselhabitat_cc %>% 
  select(name, tnmid, taxa, scenario, grp, ratio)
df43 <- shp_musselhabitat_mg %>% 
  select(name, tnmid, taxa, scenario, grp, ratio)
df44 <- shp_musselhabitat_mg_cnt %>% 
  select(name, tnmid, taxa, scenario, grp, ratio)
df45 <- shp_musselhabitat_forest %>% 
  select(name, tnmid, taxa, scenario, grp, ratio)
df46 <- shp_musselhabitat_natural %>% 
  select(name, tnmid, taxa, scenario, grp, ratio)
df47 <- shp_musselhabitat_impervious %>% 
  select(name, tnmid, taxa, scenario, grp, ratio)

df25 <- richness_baseline %>% 
  select(name, tnmid, taxa, scenario, grp, richness) 
df26 <- richness_cc %>% 
  select(name, tnmid, taxa, scenario, grp, richness)
df27 <- richness_mg %>% 
  select(name, tnmid, taxa, scenario, grp, richness)
df28 <- richness_mg_cnt %>% 
  select(name, tnmid, taxa, scenario, grp, richness)
df28a <- richness_forest %>% 
  select(name, tnmid, taxa, scenario, grp, richness)
df28b <- richness_natural %>% 
  select(name, tnmid, taxa, scenario, grp, richness)
df28c <- richness_impervious %>% 
  select(name, tnmid, taxa, scenario, grp, richness)



final <- rbind(df1,df2, df3, df4, df4a, df4b, df5, df6, df7, df8, df8a, df8b, df8c ,df9, df10, df11, df12, df12a, df12b,  df12c, df13, df14, df15, df16, df16a, df16b, df16c, df16d, df16e, df16f, df16g, df16h, df16i, df16j, df41, df42, df43, df44, df45, df46, df47)
final$scenario <- str_to_title(final$scenario)
final$grp <- str_to_title(final$grp)

richness <- rbind(df25, df26, df27, df28, df28a, df28b, df28c)
richness$scenario <- str_to_title(richness$scenario)


load("C:/Users/jenrogers/Documents/necascFreshwaterBio/model_datafiles/NHDplusV2_NewEngCrop_mussel_covariates_HUC12.RData")
NHDplusV2_NewEngCrop_mussel_covariates_HUC12 <- NHDplusV2_NewEngCrop_mussel_covariates_HUC12 %>%
   mutate(WatershedArea = ifelse(logWsAreaSqKm > 2.561496, "Large", "Small")) %>%  #that is the mean logWsAreaSqKm
  mutate(latitude  = ifelse(lat > 44.51944, "High latitude",
                            ifelse(lat < 42.97004, "Low latitude", "Mid latitude"))) %>% 
  mutate(elevation  = ifelse(ElevCat > 181.4322 , "High elevation", "Low elevation")) 

NHDplusV2_NewEngCrop_mussel_covariates_HUC12$latitude <- 
  factor(NHDplusV2_NewEngCrop_mussel_covariates_HUC12$latitude, levels = c("Low latitude", "Mid latitude", "High latitude"))

NHDplusV2_NewEngCrop_mussel_covariates_HUC12$elevation <- 
  factor(NHDplusV2_NewEngCrop_mussel_covariates_HUC12$elevation, levels = c("Low elevation", "Mid elevation", "High elevation"))

NHDplusV2_NewEngCrop_mussel_covariates_HUC12$WatershedArea <- 
  factor(NHDplusV2_NewEngCrop_mussel_covariates_HUC12$WatershedArea, levels = c("Small", "Large"))


final <- left_join(final, NHDplusV2_NewEngCrop_mussel_covariates_HUC12, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  filter(!is.na(elevation),
         !is.na(latitude)) 

ggplot(data = final[final$taxa == "fish",], aes(x = grp, y = ratio, fill = scenario), color = "black")+
  geom_boxplot(position=position_dodge(width=.75),
               outlier.size = 0.1,
               outlier.colour = "grey50")+
  geom_hline(yintercept = 1, color= "red", linetype = "dashed")+
  coord_flip(ylim = c(0, 10))+
  theme(panel.border = element_rect(colour = "black", fill = NA),
        axis.text = element_text(size = 10),
        axis.title = element_text(size = 15),
        axis.title.y = element_blank(),
        title = element_text(size = 15))+
  labs(y = "Ratio")+
  facet_wrap(~elevation)
ggsave(
    filename = "C:/Users/jenrogers/Documents/git/FreshwaterBio/FreshwaterBio/tmpfigures/paper2/fishcompare.png",
    plot = last_plot(),
    width = 19,
    height = 10,
    units = "cm",
    dpi = 200
  )

ggplot(data = final[final$taxa == "mussel",], aes(x = grp, y = ratio, fill = scenario), color = "black")+
  geom_boxplot(position=position_dodge(width=.75),
               outlier.size = 0.1,
               outlier.colour = "grey50")+
  geom_hline(yintercept = 1, color= "red", linetype = "dashed")+
  coord_flip(ylim = c(0, 2.5))+
  theme(panel.border = element_rect(colour = "black", fill = NA),
        axis.text = element_text(size = 10),
        axis.title = element_text(size = 15),
        axis.title.y = element_blank(),
        title = element_text(size = 15))+
  labs(y = "Ratio")+
  facet_wrap(~elevation)
ggsave(
    filename = "C:/Users/jenrogers/Documents/git/FreshwaterBio/FreshwaterBio/tmpfigures/paper2/musselcompare.png",
    plot = last_plot(),
    width = 19,
    height = 10,
    units = "cm",
    dpi = 200
  )


richness2 <- left_join(richness, NHDplusV2_NewEngCrop_mussel_covariates_HUC12, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  filter(!is.na(elevation),
         !is.na(latitude)) 

ggplot(data = richness2[richness2$taxa == "mussel",], aes(x = scenario, y = richness), color = "black")+
  geom_boxplot(outlier.size = 0.1,
               outlier.colour = "grey50")+
  coord_flip(ylim = c(0, 10))+
  theme(panel.border = element_rect(colour = "black", fill = NA),
        axis.text = element_text(size = 10),
        axis.title = element_text(size = 15),
        axis.title.y = element_blank(),
        title = element_text(size = 15))+
  labs(y = "Richness")+
  facet_wrap(~elevation)
ggsave(
    filename = "C:/Users/jenrogers/Documents/git/FreshwaterBio/FreshwaterBio/tmpfigures/paper2/musselrichnesscompare.png",
    plot = last_plot(),
    width = 19,
    height = 10,
    units = "cm",
    dpi = 200
  )
stats <- richness2 %>% 
  data.frame() %>% 
  select(elevation, taxa, grp, scenario, richness) %>% 
  filter(!is.na(richness)) %>% 
  group_by(elevation, taxa, grp, scenario) %>% 
  summarise(mean = mean(richness)) %>% 
  arrange(elevation, taxa, grp, scenario)


stats <- final %>% 
  data.frame() %>% 
  select(elevation, taxa, grp, scenario, ratio) %>% 
  filter(!is.na(ratio)) %>% 
  group_by(elevation, taxa, grp, scenario) %>% 
  summarise(grt = round((sum(ratio >1)/n()),5),
            mean = mean(ratio)) %>% 
  arrange(elevation, taxa, grp, scenario)

# #calculate p values between baseline and climate change ratios
# fishhigh <- final %>%
#   data.frame() %>% 
#   filter(elevation == "High elevation" & taxa == "fish")
# t.test(fishhigh[fishhigh$grp == "temp" & fishhigh$scenario == "baseline",]$ratio, 
#        fishhigh[fishhigh$grp == "temp" & fishhigh$scenario == "cc",]$ratio, conf.level = 0.9972222)
# t.test(fishhigh[fishhigh$grp == "habitat" & fishhigh$scenario == "baseline",]$ratio, 
#        fishhigh[fishhigh$grp == "habitat" & fishhigh$scenario == "cc",]$ratio, conf.level = 0.9972222)
# t.test(fishhigh[fishhigh$grp == "origin" & fishhigh$scenario == "baseline",]$ratio, 
#        fishhigh[fishhigh$grp == "origin" & fishhigh$scenario == "cc",]$ratio, conf.level = 0.9972222)
# 
# 
# #calculate p values between climate change and connectivity ratios
# t.test(fishhigh[fishhigh$grp == "temp" & fishhigh$scenario == "cnt",]$ratio, 
#        fishhigh[fishhigh$grp == "temp" & fishhigh$scenario == "cc",]$ratio, conf.level = 0.9972222)
# t.test(fishhigh[fishhigh$grp == "habitat" & fishhigh$scenario == "cnt",]$ratio, 
#        fishhigh[fishhigh$grp == "habitat" & fishhigh$scenario == "cc",]$ratio, conf.level = 0.9972222)
# t.test(fishhigh[fishhigh$grp == "origin" & fishhigh$scenario == "cnt",]$ratio, 
#        fishhigh[fishhigh$grp == "origin" & fishhigh$scenario == "cc",]$ratio, conf.level = 0.95)


#now we want to average the values for 'habitat' 'vulnerability' and 'all' and make the boxplots again (numbers will be meaningless because they will have been scaled)
#we need to scale each scenario using the baseline mean and sd values
#scale the variables using the means and sd used to scale the variables in the baseline condition


df <- data.frame(
  "x1" = shp_origin$origin_ratio,
  "x2" = shp_habitat$habitat_ratio,
  "x3" = shp_temp$ratio,
  "x4" =  shp_status$status_ratio,
  "x5" = shp_host$host_ratio,
  "x10" = shp_musselhabitat$ratio,
  "x11" = richness_baseline$richness)

means <- sapply(df, mean, na.rm = T)
sd <- sapply(df, sd, na.rm = T)
df <- data.frame(scale(as.matrix(df)))
  
df2 <- data.frame(
  "x12" = shp_origin_cc$origin_ratio,
  "x13" = shp_habitat_cc$habitat_ratio,
  "x14" = shp_temp_cc$ratio,
  "x15" =  shp_status_cc$status_ratio,
  "x16" = shp_host_cc$host_ratio,
  "x21" = shp_musselhabitat_cc$ratio,
  "x22" = richness_cc$richness)
  
df2 <- sweep(df2, 2, means, FUN = '-') 
df2 <- sweep(df2, 2, sd, FUN = '/') 
 
  
  df3 <- data.frame(
  "x23" = shp_origin_mg$origin_ratio,
  "x24" = shp_habitat_mg$habitat_ratio,
  "x25" = shp_temp_mg$ratio,
  "x26" =  shp_status_mg$status_ratio,
  "x27" = shp_host_mg$host_ratio,
  "x32" = shp_musselhabitat_mg$ratio,
  "x33" = richness_mg$richness)
df3 <- sweep(df3, 2, means, FUN = '-') 
df3 <- sweep(df3, 2, sd, FUN = '/') 
   
  
df4 <- data.frame(
  "x34" = shp_origin_mg_cnt$origin_ratio,
  "x35" = shp_habitat_mg_cnt$habitat_ratio,
  "x36" = shp_temp_mg_cnt$ratio,
  "x37" =  shp_status_mg_cnt$status_ratio,
  "x38" = shp_host_mg_cnt$host_ratio,
  "x43" = shp_musselhabitat_mg_cnt$ratio,
  "x44" = richness_mg_cnt$richness)

df4 <- sweep(df4, 2, means, FUN = '-') 
df4 <- sweep(df4, 2, sd, FUN = '/') 


df5 <- data.frame(
  "x45" = shp_origin_forest$origin_ratio,
  "x46" = shp_habitat_forest$habitat_ratio,
  "x47" = shp_temp_forest$ratio,
  "x48" = shp_status_forest$status_ratio,
  "x49" = shp_host_forest$host_ratio,
  "x54" = shp_musselhabitat_forest$ratio,
  "x55" = richness_forest$richness)
  
df5 <- sweep(df5, 2, means, FUN = '-') 
df5 <- sweep(df5, 2, sd, FUN = '/') 



df6 <- data.frame(
  "x56" = shp_origin_natural$origin_ratio,
  "x57" = shp_habitat_natural$habitat_ratio,
  "x58" = shp_temp_natural$ratio,
  "x59" =  shp_status_natural$status_ratio,
  "x60" = shp_host_natural$host_ratio,
  "x65" = shp_musselhabitat_natural$ratio,
  "x66" = richness_natural$richness)
  
df6 <- sweep(df6, 2, means, FUN = '-') 
df6 <- sweep(df6, 2, sd, FUN = '/') 


df7 <- data.frame(
  "x67" = shp_origin_impervious$origin_ratio,
  "x68" = shp_habitat_impervious$habitat_ratio,
  "x69" = shp_temp_impervious$ratio,
  "x70" =  shp_status_impervious$status_ratio,
  "x71" = shp_host_impervious$host_ratio,
  "x72" = shp_musselhabitat_impervious$ratio,
  "x73" = richness_impervious$richness)
  
df7 <- sweep(df7, 2, means, FUN = '-') 
df7 <- sweep(df7, 2, sd, FUN = '/') 



df <- cbind(df, df2, df3, df4, df5, df6, df7)



new2 <- df %>% 
  mutate(native_baseline = x1 + x11,
         native_cc = x12 + x22,
         native_mg = x23 + x33,
         native_cnt = x34 + x44,
         native_forest = x45 + x55,
         native_natural = x56 + x66,
         native_impervious = x67 + x73,
         
         habitat_baseline = x2 +x10,
         habitat_cc = x13 + x21,
         habitat_mg = x24 + x32,
         habitat_cnt =  x35 + x43,
         habitat_forest = x46 + x54,
         habitat_natural = x57 +x65,
         habitat_impervious = x68 +x72
         ) %>% 
  select(50:63) %>% 
  pivot_longer(cols = 1:14, values_to = "value", names_to = "grp_scenario") %>% 
  separate(grp_scenario, sep = "_", into = c("grp", "scenario")) %>% 
  filter(!is.na(value))

ggplot(data = new2, aes(x = grp, y = value, fill = scenario), color = "black")+
  geom_boxplot(position=position_dodge(width=.75),
               outlier.size = 0.1,
               outlier.colour = "grey50")+
  coord_flip(ylim = c(-3, 5))+
  theme(panel.border = element_rect(colour = "black", fill = NA),
        axis.text = element_text(size = 10),
        axis.title = element_text(size = 15),
        axis.title.y = element_blank(),
        title = element_text(size = 15))+
  labs(y = "Value")

ggsave(
    filename = "C:/Users/jenrogers/Documents/git/FreshwaterBio/FreshwaterBio/tmpfigures/paper2/Fig8.png",
    plot = last_plot(),
    width = 19,
    height = 10,
    units = "cm",
    dpi = 200
  )


```

left off here!!!!

Here we calcualte some summary stats for the manuscript
```{r}

load("C:/Users/jenrogers/Documents/necascFreshwaterBio/model_datafiles/NHDplusV2_NewEngCrop_mussel_covariates_HUC12.RData")
NHDplusV2_NewEngCrop_mussel_covariates_HUC12 <- NHDplusV2_NewEngCrop_mussel_covariates_HUC12 %>%  
  mutate(latitude  = ifelse(lat > 44.51944, "High latitude",
                            ifelse(lat < 42.97004, "Low latitude", "Mid latitude"))) %>% 
  mutate(elevation  = ifelse(ElevCat > 181.4322 , "High elevation", "Low elevation")) %>% 
  mutate(longitude  = ifelse(long > -71.27307, "East", "West")) 

NHDplusV2_NewEngCrop_mussel_covariates_HUC12$latitude <- 
  factor(NHDplusV2_NewEngCrop_mussel_covariates_HUC12$latitude, levels = c("Low latitude", "Mid latitude", "High latitude"))
NHDplusV2_NewEngCrop_mussel_covariates_HUC12$elevation <- 
  factor(NHDplusV2_NewEngCrop_mussel_covariates_HUC12$elevation, levels = c("Low elevation", "Mid elevation", "High elevation"))


#fish origin  
df <- left_join(df_origin_baseline, NHDplusV2_NewEngCrop_mussel_covariates_HUC12, by = c("huc12_name", "huc12_tnmid")) %>% 
  select(origin_ratio, latitude, longitude, elevation, huc12_name, huc12_tnmid) 

summary(df_origin_baseline$origin_ratio)

ggplot(data = df, mapping = aes(x = elevation, y = origin_ratio))+
  geom_boxplot(outlier.size = .5, outlier.colour = "grey80")+ 
    labs(x = "Grouping", y = "Origin Ratio")
df_high <- df %>% 
  group_by(latitude) %>% 
  summarise(mean = mean(origin_ratio))




#fish habitat
df <- left_join(df_habitat_baseline, NHDplusV2_NewEngCrop_mussel_covariates_HUC12, by = c("huc12_name", "huc12_tnmid")) %>% 
  select(habitat_ratio, latitude, longitude, elevation, huc12_name, huc12_tnmid) 

summary(df_habitat_baseline$habitat_ratio)

ggplot(data = df, mapping = aes(x = elevation, y = habitat_ratio))+
  geom_boxplot(outlier.size = .5, outlier.colour = "grey80")+ 
    labs(x = "Grouping", y = "Habitat Ratio")
df_high <- df %>% 
  group_by(elevation) %>% 
  summarise(mean = mean(habitat_ratio))


#fish temp baseline
df <- left_join(df_temp_baseline, NHDplusV2_NewEngCrop_mussel_covariates_HUC12, by = c("huc12_name", "huc12_tnmid")) %>% 
  select(ratio, latitude, longitude, elevation, huc12_name, huc12_tnmid) 

summary(df_temp_baseline$ratio)

ggplot(data = df, mapping = aes(x = elevation, y = ratio))+
  geom_boxplot(outlier.size = .5, outlier.colour = "grey80")+ 
    labs(x = "Grouping", y = "Temp Ratio")
df_high <- df %>% 
  group_by(elevation) %>% 
  summarise(mean = mean(ratio))


#mussel status
df <- left_join(df_status_baseline, NHDplusV2_NewEngCrop_mussel_covariates_HUC12, by = c("huc12_name", "huc12_tnmid")) %>% 
  select(status_ratio, latitude, longitude, elevation, huc12_name, huc12_tnmid) 

summary(df_status_baseline$status_ratio)

ggplot(data = df, mapping = aes(x = elevation, y = status_ratio))+
  geom_boxplot(outlier.size = .5, outlier.colour = "grey80")+ 
    labs(x = "Grouping", y = "Temp Ratio")
df_high <- df %>% 
  group_by(elevation) %>% 
  summarise(mean = mean(status_ratio))
nrow(df[df$status_ratio > 1,])/nrow(df)
test <- df[df$status_ratio > 1,]


#mussel size
df <- left_join(df_size_baseline, NHDplusV2_NewEngCrop_mussel_covariates_HUC12, by = c("huc12_name", "huc12_tnmid")) %>% 
  select(ratio, latitude, longitude, elevation, huc12_name, huc12_tnmid) 

summary(df_size_baseline$ratio)

ggplot(data = df, mapping = aes(x = elevation, y = ratio))+
  geom_boxplot(outlier.size = .5, outlier.colour = "grey80")+ 
    labs(x = "Grouping", y = "Size Ratio")
df_high <- df %>% 
  group_by(elevation) %>% 
  summarise(mean = mean(ratio))
nrow(df[df$ratio > 1,])/nrow(df)




#mussel host
df <- left_join(df_host_baseline, NHDplusV2_NewEngCrop_mussel_covariates_HUC12, by = c("huc12_name", "huc12_tnmid")) %>% 
  select(host_ratio, latitude, longitude, elevation, huc12_name, huc12_tnmid) 

summary(df_host_baseline$host_ratio)

ggplot(data = df, mapping = aes(x = elevation, y = host_ratio))+
  geom_boxplot(outlier.size = .5, outlier.colour = "grey80")+ 
    labs(x = "Grouping", y = "Host Ratio")+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        axis.text = element_text(size = 8),
        axis.title = element_text(size = 12))
df_high <- df %>% 
  group_by(elevation) %>% 
  summarise(mean = mean(host_ratio))
nrow(df[df$host_ratio > 1,])/nrow(df)
test <- df[df$host_ratio > 1,]
  
#mussel life history strat
df <- left_join(df_strat_baseline, NHDplusV2_NewEngCrop_mussel_covariates_HUC12, by = c("huc12_name", "huc12_tnmid")) %>% 
  select(ratio, latitude, longitude, elevation, huc12_name, huc12_tnmid) 

summary(df_strat_baseline$ratio)

ggplot(data = df, mapping = aes(x = elevation, y = ratio))+
  geom_boxplot(outlier.size = .5, outlier.colour = "grey80")
df_high <- df %>% 
  group_by(elevation) %>% 
  summarise(mean = mean(ratio))
nrow(df[df$ratio > 1,])/nrow(df)
test <- df[df$ratio < 1,]

#mussel richness
df <- left_join(richness_baseline, NHDplusV2_NewEngCrop_mussel_covariates_HUC12, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid")) %>% 
  select(richness, latitude, longitude, elevation, name, tnmid) 

summary(richness_baseline$richness)

ggplot(data = df, mapping = aes(x = elevation, y = richness))+
  geom_boxplot(outlier.size = .5, outlier.colour = "grey80")
df_high <- df %>% 
  data.frame() %>% 
  group_by(elevation) %>% 
  summarise(mean = mean(richness, na.rm=T))


```