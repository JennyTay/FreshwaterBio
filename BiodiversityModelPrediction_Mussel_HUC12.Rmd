---
title: "BiodiversityModelPrediction_Mussel_HUC12"
author: "Jenny Rogers"
date: "2023-04-14"
output: html_document
---


In this script we model the probability of freshwater mussel occurrence at the HUC12 scale - I copied the script from "BiodiversityModel_Mussel.Rmd and just made changes so that everything was at the HUC12 scale instead of the HUC10 scale. The other difference is that the host fish variables have changed, so we model the different host fish predictions and average to HUC12

```{r}
library(tidyverse)
library(sf)
library(glmmTMB)


```


```{r}
#mussel data
load("C:/Users/jenrogers/Documents/necascFreshwaterBio/model_datafiles/mussel_occurrence.RData")
load("C:/Users/jenrogers/Documents/necascFreshwaterBio/model_datafiles/mussel_count_with_zeros.RData")
mussel_shp <- st_read("C:/Users/jenrogers/Documents/necascFreshwaterBio/SpatialData/sppdata/all_mussel_event.shp")

#mussel event and hydrography join
load("C:/Users/jenrogers/Documents/necascFreshwaterBio/model_datafiles/mussel_event_huc_join.RData")
load("C:/Users/jenrogers/Documents/necascFreshwaterBio/model_datafiles/mussel_event_flowline_join.RData")
load("C:/Users/jenrogers/Documents/necascFreshwaterBio/model_datafiles/mussel_event_flowlineV2_join.RData")

#watershed shape files
huc8 <- st_read("C:/Users/jenrogers/Documents/necascFreshwaterBio/SpatialData/NHDplus/WBDHU8/WBDHU8_NE.shp")
huc10 <- st_read("C:/Users/jenrogers/Documents/necascFreshwaterBio/SpatialData/NHDplus/WBDHU10/WBDHU10_NE.shp")
huc12 <- st_read("C:/Users/jenrogers/Documents/necascFreshwaterBio/SpatialData/NHDplus/WBDHU12/WBDHU12_NE.shp")

#load New England state data
states <- st_read("C:/Users/jenrogers/Documents/necascFreshwaterBio/SpatialData/newenglandshape/NEWENGLAND_POLY.shp")


```

Baseline predictions


need to calculate the baseline host fish distributions at the HUC12 scale (we also did this in the biodiveristyModel_mussel_HUC12 file)

Host fish distributions at HUC12 scale.  This predicts the host fish distributions in the baseline condition. 
When we want to do mussel predictions in future time periods, we will need to redo this calcuation changing out the covariate data file for one with climate change and/or the management scenarios.  The new data sets need to be scaled according to the same mean and sd as the baseline.
```{r}

#load in covariates for the fish model and scale
load(file = "C:/Users/jenrogers/Documents/necascFreshwaterBio/model_datafiles/NHDplusV2_NewEngCrop_covariates.RData")

#need to scal the variavles
test <- NHDplusV2_NewEngCrop %>% 
  data.frame() %>% 
  select(-geometry)

test <- test[,c(7:8, 10:39)]

#scale data
test <- data.frame(scale(test))

NHDplusV2_NewEngCrop <- cbind((NHDplusV2_NewEngCrop)[,c(1:6, 9)], test)







#Host fish variable 1 for the mussel model  - to be included in the model for all species of mussels:
#The predicted probability of occurrence of all fish (summed by stream reach – representing the total probability of occurrence of all species within a given reach) and averaged over a HUC12 – ultimately representing the average summed probability of occurrence of any fish species within a HUC12
#using the zprob from the prop abund model

file.list <- list.files("C:/Users/jenrogers/Documents/necascFreshwaterBio/model_objects", pattern = "propabun_")

i <- 1

mdl <- readRDS(paste("C:/Users/jenrogers/Documents/necascFreshwaterBio/model_objects/", file.list[i], sep = ""))
  
predictions <- data.frame("test" = (1 - (predict(mdl, newdata = NHDplusV2_NewEngCrop, type = "zprob")))) #do 1 - predict because we want prob of occurrence, not the prob of a zero
names(predictions)[1] <- file.list[i]




for (i in 2:53) { 
  
  
   mdl <- readRDS(paste("C:/Users/jenrogers/Documents/necascFreshwaterBio/model_objects/", file.list[i], sep = ""))
  
  tmp <- data.frame("test" = (1 - (predict(mdl, newdata = NHDplusV2_NewEngCrop, type = "zprob"))))
  names(tmp)[1] <- file.list[i]
  
  predictions <- cbind(predictions, tmp)
  
  
}

colnames(predictions) <- gsub("propabun_", "pres_", colnames(predictions)) #the probabun is the title of the model, but we used the zero predict option so we need to change the column names


#join the predictions to the list of comids
NHDplusV2_NewEngCrop_baseline <- cbind(NHDplusV2_NewEngCrop, predictions)

#average by HUC10 becuase that is the scale we are modeling mussels
fish_host_prob_occ <- NHDplusV2_NewEngCrop_baseline %>%
  data.frame() %>% 
  select(huc12_name, huc12_tnmid, COMID, 40:92) %>% 
  filter(!is.na(pres_brook.trout.rds),
         !is.na(huc12_name)) %>%
  pivot_longer(4:56, names_to = "common_name", values_to = "prob_occ") %>% 
  group_by(huc12_name, huc12_tnmid, COMID) %>% 
  summarise(total_prob_occ = sum(prob_occ)) %>% 
  ungroup() %>% 
  group_by(huc12_name, huc12_tnmid) %>% 
  summarise(mean_prob_occ = mean(total_prob_occ))
  






#fish host covariate with proportional abundance for the perferred host fish. (Variable 3 and 4)


file.list <- list.files("C:/Users/jenrogers/Documents/necascFreshwaterBio/model_objects", pattern = "propabun_")

i <- 1

mdl <- readRDS(paste("C:/Users/jenrogers/Documents/necascFreshwaterBio/model_objects/", file.list[i], sep = ""))
  
predictions <- data.frame("test" = predict(mdl, newdata = NHDplusV2_NewEngCrop, type = "response"))
names(predictions)[1] <- file.list[i]




for (i in 2:53) { 
  
  
   mdl <- readRDS(paste("C:/Users/jenrogers/Documents/necascFreshwaterBio/model_objects/", file.list[i], sep = ""))
  
  tmp <- data.frame("test" = predict(mdl, newdata = NHDplusV2_NewEngCrop, type = "response"))
  names(tmp)[1] <- file.list[i]
  
  predictions <- cbind(predictions, tmp)
  
  
}

#select only the columns for preferred host fish
predictions <- predictions %>% 
  select("propabun_brown trout.rds", "propabun_rainbow trout.rds", "propabun_atlantic salmon.rds", "propabun_brook trout.rds",
         "propabun_yellow perch.rds", "propabun_white perch.rds", "propabun_largemouth bass.rds", "propabun_bluegill.rds", "propabun_pumpkinseed.rds", 
         "propabun_redbreast sunfish.rds", )
names(predictions) <- gsub("propabun_", "", names(predictions))
names(predictions) <- gsub(".rds", "", names(predictions))
names(predictions) <- gsub("\\.", " ", names(predictions))


#join the predictions to the list of comids
NHDplusV2_NewEngCrop_baseline <- cbind(NHDplusV2_NewEngCrop, predictions)

#average by HUC10 becuase that is the scale we are modeling mussels
fish_host_propabun <- NHDplusV2_NewEngCrop_baseline %>%
  data.frame() %>% 
  select(COMID, huc12_name, huc12_tnmid, 40:49) %>% 
  filter(!is.na(brook.trout),
         !is.na(huc12_name)) %>%
  mutate(sumYLamp = white.perch + yellow.perch,
         sumEPear = brown.trout + rainbow.trout + atlantic.salmon + brook.trout,
         sumEpond = yellow.perch + largemouth.bass + bluegill + pumpkinseed + redbreast.sunfish) %>% 
  group_by(huc12_name, huc12_tnmid) %>% 
  summarise(TMuck_perferredhost = mean(white.perch),
            YLamp_perferredhost = mean(sumYLamp),
            EPear_perferredhost = mean(sumEPear),
            Epond_perferredhost = mean(sumEpond))




#Variable at the HUC12 scale showing if the non-modeled host fish has occurred in that HUC12 (Variable 2)
#fish data
load("C:/Users/jenrogers/Documents/necascFreshwaterBio/model_datafiles/fish_event_huc_join.RData")
load('C:/Users/jenrogers/Documents/necascFreshwaterBio/spp_data/tidydata/all_fish_presence.RData')

df <- left_join(fish_presence, fish_event_huc_join, by = "UID") %>% 
  filter(stock == "natural") %>% 
  select(huc12_name, huc12_tnmid, common_name) %>% 
  unique() %>% 
  filter(common_name %in% c("striped bass", 
                            "rainbow smelt", "american shad", "alewife", "blueback herring",
                            "ninespine stickleback", "three-spined stickleback", "fourspine stickleback"))



huc12 <- huc12 %>% 
  data.frame() %>% 
  select(name, tnmid) %>%
  rename(huc12_name = name, huc12_tnmid = tnmid) %>% 
  unique()
fish <- unique(df$common_name)

#make a dataframe that has each UID repeated for each fish spp
absence <- data.frame('huc12_name' = rep(huc12$huc12_name, each = 8,),
                      'huc12_tnmid' = rep(huc12$huc12_tnmid, each = 8))
absence$common_name <- rep(fish, times = nrow(huc12))
#keep only rows in the absence list that are no in the fish_presence list
keep <- anti_join(absence, df, by = c("huc12_name", "huc12_tnmid", "common_name"))

#add presence absence information
keep$occurrence <- 0
df$occurrence <- 1



#bind the presence and absence columns together
fish_host_occ <- rbind(df, keep)
fish_host_occ <- fish_host_occ %>% 
  arrange(huc12_name, huc12_tnmid) %>% 
  pivot_wider(names_from = common_name, values_from = occurrence)

rm(absence, fish_presence, keep)
rm(fish, huc12)

fish_host_occ$YLamp_notmodeledhost <- fish_host_occ$`striped bass`
fish_host_occ$Epond_notmodeledhost <- ifelse(fish_host_occ$`three-spined stickleback` == 1 |
                                                 fish_host_occ$`fourspine stickleback` == 1 |
                                                 fish_host_occ$`ninespine stickleback` == 1,
                                               1, 0)
fish_host_occ$Afloa_notmodeledhost <- ifelse(fish_host_occ$alewife == 1 |
                                                 fish_host_occ$`blueback herring` == 1 |
                                                 fish_host_occ$`american shad` == 1 |
                                                 fish_host_occ$`rainbow smelt` == 1,
                                               1, 0)


fish_host_occ <- fish_host_occ %>% 
  select(huc12_name, huc12_tnmid, YLamp_notmodeledhost, Epond_notmodeledhost, Afloa_notmodeledhost)





# #fish host covariate with probability of presence by spp
# 
# file.list <- list.files("C:/Users/jenrogers/Documents/necascFreshwaterBio/model_objects", pattern = "pres_")
# 
# i <- 1
# 
# mdl <- readRDS(paste("C:/Users/jenrogers/Documents/necascFreshwaterBio/model_objects/", file.list[i], sep = ""))
#   
# predictions <- data.frame("test" = predict(mdl, newdata = NHDplusV2_NewEngCrop, type = "response"))
# names(predictions)[1] <- file.list[i]
# 
# 
# 
# 
# for (i in 2:57) { 
#   
#   
#    mdl <- readRDS(paste("C:/Users/jenrogers/Documents/necascFreshwaterBio/model_objects/", file.list[i], sep = ""))
#   
#   tmp <- data.frame("test" = predict(mdl, newdata = NHDplusV2_NewEngCrop, type = "response"))
#   names(tmp)[1] <- file.list[i]
#   
#   predictions <- cbind(predictions, tmp)
#   
#   
# }
# 
# 
# #join the predictions to the list of comids
# NHDplusV2_NewEngCrop_baseline <- cbind(NHDplusV2_NewEngCrop, predictions)
# 
# #average by HUC10 becuase that is the scale we are modeling mussels
# fish_host_prob_occ <- NHDplusV2_NewEngCrop_baseline %>%
#   data.frame() %>% 
#   select(huc10_name, huc10_tnmid, 40:96) %>% 
#   filter(!is.na(pres_brook.trout.rds),
#          !is.na(huc10_name)) %>%
#   pivot_longer(3:59, names_to = "common_name", values_to = "prob_occ") %>% 
#   group_by(huc10_name, huc10_tnmid) %>% 
#   summarise(total_prob_occ = sum(prob_occ))
#   
# 
# 
# 
# 
# 
# #fish host covariate with proportional abundance by family. First do prop abund model. then add within a family
# 
# 
# file.list <- list.files("C:/Users/jenrogers/Documents/necascFreshwaterBio/model_objects", pattern = "propabun_")
# 
# i <- 1
# 
# mdl <- readRDS(paste("C:/Users/jenrogers/Documents/necascFreshwaterBio/model_objects/", file.list[i], sep = ""))
#   
# predictions <- data.frame("test" = predict(mdl, newdata = NHDplusV2_NewEngCrop, type = "response"))
# names(predictions)[1] <- file.list[i]
# 
# 
# 
# 
# for (i in 2:57) { 
#   
#   
#    mdl <- readRDS(paste("C:/Users/jenrogers/Documents/necascFreshwaterBio/model_objects/", file.list[i], sep = ""))
#   
#   tmp <- data.frame("test" = predict(mdl, newdata = NHDplusV2_NewEngCrop, type = "response"))
#   names(tmp)[1] <- file.list[i]
#   
#   predictions <- cbind(predictions, tmp)
#   
#   
# }
# 
# 
# #join the predictions to the list of comids
# NHDplusV2_NewEngCrop_baseline <- cbind(NHDplusV2_NewEngCrop, predictions)
# 
# #average by HUC10 becuase that is the scale we are modeling mussels
# fish_host_propabun <- NHDplusV2_NewEngCrop_baseline %>%
#   data.frame() %>% 
#   select(huc10_name, huc10_tnmid, 40:96) %>% 
#   filter(!is.na(propabun_brook.trout.rds),
#          !is.na(huc10_name)) %>% 
#   group_by(huc10_name, huc10_tnmid) %>% 
#   summarise_all(mean) %>% 
#   pivot_longer(3:59, names_to = "common_name", values_to = "propabun")
# fish_host_propabun$common_name <- gsub("propabun_", "", fish_host_propabun$common_name)
# fish_host_propabun$common_name <- gsub(".rds", "", fish_host_propabun$common_name)
# fish_host_propabun$common_name <- gsub("\\.", " ", fish_host_propabun$common_name)
# 
# #add family information
# fish_host_propabun <- fish_host_propabun %>% 
#   mutate(family = ifelse(common_name%in% c("american brook lamprey"), "Petromyzontidae",
#                          ifelse(common_name %in% c("american eel"), "Anguillidae",
#                                 ifelse(common_name%in% c("atlantic salmon", "brook trout", "brown trout", "rainbow trout", "round whitefish"), "Salmonidae",
#                                        ifelse(common_name %in% c("banded killifish"), "Fundulidae",
#                                               ifelse(common_name %in% c("banded sunfish", "black crappie", "bluegill", "green sunfish", "largemouth bass", "pumpkinseed", "redbreast sunfish", "rock bass", "smallmouth bass"), "Centrarchidae",
#                                                      ifelse(common_name %in% c("bluntnose minnow", "bridle shiner", "common carp", "common shiner", "creek chub", "cutlips minnow", "eastern blacknose dace", "eastern silvery minnow", "fallfish", "fathead minnow", "finescale dace", "golden shiner", "lake chub", "longnose dace", "mimic shiner", "redbelly dace", "rosyface shiner", "rosyside dace", "spotfin shiner", "spottail shiner"), "Cyprinidae",
#                                                             ifelse(common_name %in% c("bowfin"), "Amiidae",
#                                                                    ifelse(common_name %in% c("brook stickleback"), "Gasterosteidae",
#                                                                           ifelse(common_name %in% c("brown bullhead", "channel catfish", "margined madtom", "white catfish"), "Ictaluridae",
#                                                                                  ifelse(common_name %in% c("burbot"), "Lotidae",
#                                                                                         ifelse(common_name %in% c("central mudminnow"), "Umbridae" ,
#                                                                                                ifelse(common_name %in% c("chain pickerel", "northern pike", "redfin pickerel"), "Esocidae",
#                                                                                                       ifelse(common_name %in% c("creek chubsucker", "longnose sucker", "white sucker", "yellow bullhead"), "Catostomidae",
#                                                                                                              ifelse(common_name %in% c("slimy sculpin"), "Cottidae", "Percidae")
#                                                                                                              ))))))))))))))
# 
# #swamp darter", "tessellated darter", "walleye", "yellow perch" are percidae
# 
# #group by family for total proportional abundance by family
# fish_host_propabun <- fish_host_propabun %>% 
#   group_by(huc10_name, huc10_tnmid, family) %>% 
#   summarise(propabun = sum(propabun)) %>% 
#   pivot_wider(names_from = family, values_from = propabun) %>% 
#   select(-Gasterosteidae) #its zero in every observation


#plot fish host prob of occurrence
huc12 <- st_read("C:/Users/jenrogers/Documents/necascFreshwaterBio/SpatialData/NHDplus/WBDHU12/WBDHU12_NE.shp")
huc12 <- huc12 %>% 
  rename("huc12_name" = "name",
         "huc12_tnmid" = "tnmid")
plot <- left_join(huc12, fish_host_propabun, by = c("huc12_name", "huc12_tnmid"))%>% 
  left_join(fish_host_occ, by = c("huc12_name", "huc12_tnmid"))%>% 
  left_join(fish_host_prob_occ, by = c("huc12_name", "huc12_tnmid"))%>% 
  filter(huc12_name != "Long Island Sound")

  
ggplot(data = plot)+
  geom_sf(aes(fill = EPear_perferredhost), color = NA)+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank())+
  labs(fill = "EPear_perferredhost")

ggsave(paste("tmpfigures/Afloa_notmodeledhost.png"), 
    plot = last_plot(),
    width = 18,
    height = 12,
    units = "cm",
    dpi = 300)  


```




Load in the HUC12 mussel covariates,  join the host fish distributions, and scale
```{r}

load("C:/Users/jenrogers/Documents/necascFreshwaterBio/model_datafiles/NHDplusV2_NewEngCrop_mussel_covariates_HUC12.RData")

covariates <- left_join(NHDplusV2_NewEngCrop_mussel_covariates_HUC12, fish_host_prob_occ, by = c("huc12_name", "huc12_tnmid"))

covariates <- left_join(covariates, fish_host_propabun, by = c("huc12_name", "huc12_tnmid"))

covariates <- left_join(covariates, fish_host_occ, by = c("huc12_name", "huc12_tnmid"))


#scale mussel covariates
test <- covariates[,c(3:38)]

means <- sapply(test, mean, na.rm = T)
save(means, file = "C:/Users/jenrogers/Documents/necascFreshwaterBio/model_datafiles/musselcovariates_scaling_mean.RData")
sd <- sapply(test, sd, na.rm = T)
save(sd, file = "C:/Users/jenrogers/Documents/necascFreshwaterBio/model_datafiles/musselcovariates_scaling_sd.RData")


#scale data
test <- data.frame(scale(test))

covariates <- cbind((covariates)[,c(1:2)], test)





```

Load in the mussel models and apply them to the baseline data

```{r}

file.list <- list.files("C:/Users/jenrogers/Documents/necascFreshwaterBio/model_objects", pattern = "mussel_")

i <- 1

mdl <- readRDS(paste("C:/Users/jenrogers/Documents/necascFreshwaterBio/model_objects/", file.list[i], sep = ""))
  
predictions <- data.frame("test" = predict(mdl, newdata = covariates, type = "response"))
names(predictions)[1] <- file.list[i]




for (i in 2:12) { 
  
  
   mdl <- readRDS(paste("C:/Users/jenrogers/Documents/necascFreshwaterBio/model_objects/", file.list[i], sep = ""))
  
  tmp <- data.frame("test" = predict(mdl, newdata = covariates, type = "response"))
  names(tmp)[1] <- file.list[i]
  
  predictions <- cbind(predictions, tmp)
  
  
}

names(predictions) <- gsub(pattern = ".rds", replacement = "", x = names(predictions))
names(predictions) <- gsub(pattern = "mussel_", replacement = "", x = names(predictions))

#join the predictions to the list of comids
predictions <- cbind(covariates, predictions)

huc12 <- st_read("C:/Users/jenrogers/Documents/necascFreshwaterBio/SpatialData/NHDplus/WBDHU12/WBDHU12_NE.shp")
huc12 <- huc12 %>% 
  select(tnmid, areasqkm , name)%>% 
  rename(huc12_areasqkm = areasqkm, huc12_name= name, huc12_tnmid = tnmid)
huc12 <- huc12[!duplicated(huc12$huc12_tnmid),]#Remove the duplicated TNMID fields

predictions_baseline <- left_join(huc12, predictions, by = c("huc12_name", "huc12_tnmid"))


#sample plot
shp <- left_join(mussel_event_huc_join, mussel_occurrence, by = "UID") %>% 
  filter(!is.na(live_occurrence)) %>% 
  filter(live_occurrence == 1) %>% 
  filter(huc12_name != "Long Island Sound Deep")
predictions_baseline <- predictions_baseline %>% 
  filter(huc12_name != "Long Island Sound Deep")


  
ggplot(data = predictions_baseline)+
  geom_sf(aes(fill = `easternpondmussel`), color = NA)+
  scale_fill_gradient2(low = "grey60",
                        mid = "yellow",
                        high = "green3",
                        midpoint = 0.5,
                       limits = c(0,1))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 15))+
    ggtitle(label = "easternpondmussel")+
  labs(fill = "Probability")+
  geom_sf(data =shp[shp$common_name == "eastern pondmussel",], 
          aes(color = live_occurrence), color = "black", size = .5)

ggsave(paste("tmpfigures/baseline_mussel_predictions/yellowlampmussel.png"), 
    plot = last_plot(),
    width = 18,
    height = 12,
    units = "cm",
    dpi = 300) 


```
 
 CLIMATE CHANGE SCENARIO
 Now, calculate mussel probability of occurrence with the climate change scenario for 2080
 first, re-calculate the host fish covariates with the climate change data
```{r}

#climate change

#load the 2080 file that has the projected stream temperature and streamflow covariate values
load("C:/Users/jenrogers/Documents/necascFreshwaterBio/model_datafiles/NHDplusV2_NewEngCrop_covariates_2080.RData")


#need to get the variables named the same as the baseline dataframe and need to order the variables in the same way so that we can scale them
test <- NHDplusV2_NewEngCrop_2080 %>% 
  data.frame() %>% 
  select(7:8, 10:39) %>% 
  rename(annual_mean_summer_temp = annual_mean_summer_temp_pls_4,
         BFI_HIST = BFI_2080,
         LO7Q1DT_HIST = LO7Q1DT_2080,
         CFM_HIST = CFM_2080,
         W95_HIST = W95_2080,
         logMJJA_HIST = logMJJA_2080) %>% 
  select(1:2, 27:31, 3:24, 32, 25:26)

#load means and sd of the baseline covariates so we can scale the future data appropriates
load("C:/Users/jenrogers/Documents/necascFreshwaterBio/model_datafiles/fishcovariates_scaling_mean.RData")
load("C:/Users/jenrogers/Documents/necascFreshwaterBio/model_datafiles/fishcovariates_scaling_sd.RData")



#scale the variables using the means and sd used to scale the variables in the baseline condition
test <- sweep(test, 2, means, FUN = '-') 
test <- sweep(test, 2, sd, FUN = '/')  

#join the scaled variables back to 
NHDplusV2_NewEngCrop_cc <- cbind((NHDplusV2_NewEngCrop_2080)[,c(1:6, 9)], test)



#Host fish variable 1 for the mussel model  - to be included in the model for all species of mussels:
#The predicted probability of occurrence of all fish (summed by stream reach – representing the total probability of occurrence of all species within a given reach) and averaged over a HUC12 – ultimately representing the average summed probability of occurrence of any fish species within a HUC12
#using the zprob from the prop abund model

file.list <- list.files("C:/Users/jenrogers/Documents/necascFreshwaterBio/model_objects", pattern = "propabun_")

i <- 1

mdl <- readRDS(paste("C:/Users/jenrogers/Documents/necascFreshwaterBio/model_objects/", file.list[i], sep = ""))
  
predictions_cc <- data.frame("test" = (1 - (predict(mdl, newdata = NHDplusV2_NewEngCrop_cc, type = "zprob")))) #do 1 - predict because we want prob of occurrence, not the prob of a zero
names(predictions_cc)[1] <- file.list[i]




for (i in 2:53) { 
  
  
   mdl <- readRDS(paste("C:/Users/jenrogers/Documents/necascFreshwaterBio/model_objects/", file.list[i], sep = ""))
  
  tmp <- data.frame("test" = (1 - (predict(mdl, newdata = NHDplusV2_NewEngCrop_cc, type = "zprob"))))
  names(tmp)[1] <- file.list[i]
  
  predictions_cc <- cbind(predictions_cc, tmp)
  
  
}

colnames(predictions_cc) <- gsub("propabun_", "pres_", colnames(predictions_cc)) #the probabun is the title of the model, but we used the zero predict option so we need to change the column names


#join the predictions_cc to the list of comids
tmp <- cbind(NHDplusV2_NewEngCrop_cc, predictions_cc)

#average by HUC10 becuase that is the scale we are modeling mussels
fish_host_prob_occ_cc <- tmp %>%
  data.frame() %>% 
  select(huc12_name, huc12_tnmid, COMID, 40:92) %>% 
  filter(!is.na(pres_brook.trout.rds),
         !is.na(huc12_name)) %>%
  pivot_longer(4:56, names_to = "common_name", values_to = "prob_occ") %>% 
  group_by(huc12_name, huc12_tnmid, COMID) %>% 
  summarise(total_prob_occ = sum(prob_occ)) %>% 
  ungroup() %>% 
  group_by(huc12_name, huc12_tnmid) %>% 
  summarise(mean_prob_occ = mean(total_prob_occ))
  






#fish host covariate with proportional abundance for the perferred host fish. (Variable 3 and 4)


file.list <- list.files("C:/Users/jenrogers/Documents/necascFreshwaterBio/model_objects", pattern = "propabun_")

i <- 1

mdl <- readRDS(paste("C:/Users/jenrogers/Documents/necascFreshwaterBio/model_objects/", file.list[i], sep = ""))
  
predictions_cc <- data.frame("test" = predict(mdl, newdata = NHDplusV2_NewEngCrop_cc, type = "response"))
names(predictions_cc)[1] <- file.list[i]




for (i in 2:53) { 
  
  
   mdl <- readRDS(paste("C:/Users/jenrogers/Documents/necascFreshwaterBio/model_objects/", file.list[i], sep = ""))
  
  tmp <- data.frame("test" = predict(mdl, newdata = NHDplusV2_NewEngCrop_cc, type = "response"))
  names(tmp)[1] <- file.list[i]
  
  predictions_cc <- cbind(predictions_cc, tmp)
  
  
}

#select only the columns for preferred host fish
predictions_cc <- predictions_cc %>% 
  select("propabun_brown trout.rds", "propabun_rainbow trout.rds", "propabun_atlantic salmon.rds", "propabun_brook trout.rds",
         "propabun_yellow perch.rds", "propabun_white perch.rds", "propabun_largemouth bass.rds", "propabun_bluegill.rds", "propabun_pumpkinseed.rds", 
         "propabun_redbreast sunfish.rds", )
names(predictions_cc) <- gsub("propabun_", "", names(predictions_cc))
names(predictions_cc) <- gsub(".rds", "", names(predictions_cc))
#names(predictions_cc) <- gsub("\\.", " ", names(predictions_cc))


#join the predictions to the list of comids
tmp <- cbind(NHDplusV2_NewEngCrop_cc, predictions_cc)

#average by HUC10 becuase that is the scale we are modeling mussels
fish_host_propabun_cc <- tmp %>%
  data.frame() %>% 
  select(COMID, huc12_name, huc12_tnmid, 40:49) %>% 
  filter(!is.na(brook.trout),
         !is.na(huc12_name)) %>%
  mutate(sumYLamp = white.perch + yellow.perch,
         sumEPear = brown.trout + rainbow.trout + atlantic.salmon + brook.trout,
         sumEpond = yellow.perch + largemouth.bass + bluegill + pumpkinseed + redbreast.sunfish) %>% 
  group_by(huc12_name, huc12_tnmid) %>% 
  summarise(TMuck_perferredhost = mean(white.perch),
            YLamp_perferredhost = mean(sumYLamp),
            EPear_perferredhost = mean(sumEPear),
            Epond_perferredhost = mean(sumEpond))




#Variable at the HUC12 scale showing if the non-modeled host fish has occurred in that HUC12 (Variable 2)
#fish data
load("C:/Users/jenrogers/Documents/necascFreshwaterBio/model_datafiles/fish_event_huc_join.RData")
load('C:/Users/jenrogers/Documents/necascFreshwaterBio/spp_data/tidydata/all_fish_presence.RData')

fish_event_huc_join <- fish_event_huc_join %>% 
  data.frame() %>% 
  select(-geometry)

df <- left_join(fish_presence, fish_event_huc_join, by = "UID") %>% 
  filter(stock == "natural") %>% 
  select(huc12_name, huc12_tnmid, common_name) %>% 
  unique() %>% 
  filter(common_name %in% c("striped bass", 
                            "rainbow smelt", "american shad", "alewife", "blueback herring",
                            "ninespine stickleback", "three-spined stickleback", "fourspine stickleback"))


huc12 <- st_read("C:/Users/jenrogers/Documents/necascFreshwaterBio/SpatialData/NHDplus/WBDHU12/WBDHU12_NE.shp")
huc12 <- huc12 %>% 
  data.frame() %>% 
  select(name, tnmid) %>%
  rename(huc12_name = name, huc12_tnmid = tnmid) %>% 
  unique()
fish <- unique(df$common_name)

#make a dataframe that has each UID repeated for each fish spp
absence <- data.frame('huc12_name' = rep(huc12$huc12_name, each = 8,),
                      'huc12_tnmid' = rep(huc12$huc12_tnmid, each = 8))
absence$common_name <- rep(fish, times = nrow(huc12))
#keep only rows in the absence list that are no in the fish_presence list
keep <- anti_join(absence, df, by = c("huc12_name", "huc12_tnmid", "common_name"))

#add presence absence information
keep$occurrence <- 0
df$occurrence <- 1



#bind the presence and absence columns together
fish_host_occ <- rbind(df, keep)
fish_host_occ <- fish_host_occ %>% 
  arrange(huc12_name, huc12_tnmid) %>% 
  pivot_wider(names_from = common_name, values_from = occurrence)

rm(absence, fish_presence, keep)
rm(fish, huc12)

fish_host_occ$YLamp_notmodeledhost <- fish_host_occ$`striped bass`
fish_host_occ$Epond_notmodeledhost <- ifelse(fish_host_occ$`three-spined stickleback` == 1 |
                                                 fish_host_occ$`fourspine stickleback` == 1 |
                                                 fish_host_occ$`ninespine stickleback` == 1,
                                               1, 0)
fish_host_occ$Afloa_notmodeledhost <- ifelse(fish_host_occ$alewife == 1 |
                                                 fish_host_occ$`blueback herring` == 1 |
                                                 fish_host_occ$`american shad` == 1 |
                                                 fish_host_occ$`rainbow smelt` == 1,
                                               1, 0)


fish_host_occ <- fish_host_occ %>% 
  select(huc12_name, huc12_tnmid, YLamp_notmodeledhost, Epond_notmodeledhost, Afloa_notmodeledhost)




#the correct host fish files for the climate change scenario include: fish_host_occ, fish_host_prob_occ_cc, fish_host_propabun_cc

```







apply the predictions to the climate change projections for flow and temperature


```{r}

load("C:/Users/jenrogers/Documents/necascFreshwaterBio/model_datafiles/NHDplusV2_NewEngCrop_mussel_covariates_HUC12.RData")

covariates_cc <- left_join(NHDplusV2_NewEngCrop_mussel_covariates_HUC12, fish_host_prob_occ_cc, by = c("huc12_name", "huc12_tnmid"))

covariates_cc <- left_join(covariates_cc, fish_host_propabun_cc, by = c("huc12_name", "huc12_tnmid"))

covariates_cc <- left_join(covariates_cc, fish_host_occ, by = c("huc12_name", "huc12_tnmid"))


#load the 2080 file that has the projected stream temperature and streamflow covariate values
load("C:/Users/jenrogers/Documents/necascFreshwaterBio/model_datafiles/NHDplusV2_NewEngCrop_covariates_2080.RData")


#average by huc10 all the projected flow and temperature variables
test <- NHDplusV2_NewEngCrop_2080 %>% 
  data.frame() %>% 
  rename(annual_mean_summer_temp = annual_mean_summer_temp_pls_4,
         BFI_HIST = BFI_2080,
         LO7Q1DT_HIST = LO7Q1DT_2080,
         CFM_HIST = CFM_2080,
         W95_HIST = W95_2080,
         logMJJA_HIST = logMJJA_2080) %>% 
  select(huc12_name, huc12_tnmid, annual_mean_summer_temp, BFI_HIST, LO7Q1DT_HIST, CFM_HIST, W95_HIST, logMJJA_HIST) %>% 
  group_by(huc12_name, huc12_tnmid) %>% 
  summarise(annual_mean_summer_temp = mean(annual_mean_summer_temp, na.rm = T),
            BFI_HIST = mean(BFI_HIST, na.rm = T),
            LO7Q1DT_HIST = mean(LO7Q1DT_HIST, na.rm = T),
            CFM_HIST = mean(CFM_HIST, na.rm = T),
            W95_HIST = mean(W95_HIST, na.rm = T),
            logMJJA_HIST = mean(logMJJA_HIST, na.rm = T))



#need to order the new dataframe correctly and scale using the means and sd from the baseline data

#remove the current flow and temperature values from the baseline file and add in the 2080 projections
order <- names(covariates)
covariates_cc2 <- covariates_cc %>% 
  select(-c(annual_mean_summer_temp, BFI_HIST, LO7Q1DT_HIST, CFM_HIST, W95_HIST, logMJJA_HIST)) %>% #remove the baseline values for these variables
  left_join(test, by = c("huc12_name", "huc12_tnmid")) %>%  #add in the projected 2080 values
  select(all_of(order))

#load the values used to scale the mussel covariates
load("C:/Users/jenrogers/Documents/necascFreshwaterBio/model_datafiles/musselcovariates_scaling_mean.RData")
load("C:/Users/jenrogers/Documents/necascFreshwaterBio/model_datafiles/musselcovariates_scaling_sd.RData")



#scale the variables using the means and sd used to scale the variables in the baseline condition
test <- covariates_cc2[,c(3:38)]
test <- sweep(test, 2, means, FUN = '-') 
test <- sweep(test, 2, sd, FUN = '/')  

#join the scaled variables back to the full dataset
covariates_cc <- cbind((covariates_cc2)[,c(1:2)], test)



#apply models to the climate change covariates
file.list <- list.files("C:/Users/jenrogers/Documents/necascFreshwaterBio/model_objects", pattern = "mussel_")

i <- 1

mdl <- readRDS(paste("C:/Users/jenrogers/Documents/necascFreshwaterBio/model_objects/", file.list[i], sep = ""))
  
predictions <- data.frame("test" = predict(mdl, newdata = covariates_cc, type = "response"))
names(predictions)[1] <- file.list[i]




for (i in 2:12) { 
  
  
   mdl <- readRDS(paste("C:/Users/jenrogers/Documents/necascFreshwaterBio/model_objects/", file.list[i], sep = ""))
  
  tmp <- data.frame("test" = predict(mdl, newdata = covariates_cc, type = "response"))
  names(tmp)[1] <- file.list[i]
  
  predictions <- cbind(predictions, tmp)
  
  
}

names(predictions) <- gsub(pattern = ".rds", replacement = "", x = names(predictions))
names(predictions) <- gsub(pattern = "mussel_", replacement = "", x = names(predictions))

#join the predictions to the list of comids
prediction_cc <- cbind(covariates_cc, predictions)

huc12 <- st_read("C:/Users/jenrogers/Documents/necascFreshwaterBio/SpatialData/NHDplus/WBDHU12/WBDHU12_NE.shp")
huc12 <- huc12 %>% 
  select(tnmid, areasqkm , name)%>% 
  rename(huc12_areasqkm = areasqkm, huc12_name= name, huc12_tnmid = tnmid)
huc12 <- huc12[!duplicated(huc12$huc12_tnmid),]#Remove the duplicated TNMID fields

prediction_cc <- left_join(huc12, prediction_cc, by = c("huc12_name", "huc12_tnmid"))




#sample plot
shp <- left_join(mussel_event_huc_join, mussel_occurrence, by = "UID") %>% 
  filter(!is.na(live_occurrence)) %>% 
  filter(live_occurrence == 1) %>% 
  filter(huc12_name != "Long Island Sound Deep")
prediction_cc <- prediction_cc %>% 
  filter(huc12_name != "Long Island Sound Deep")


  
ggplot(data = prediction_cc)+
  geom_sf(aes(fill = `yellowlampmussel`), color = NA)+
  scale_fill_gradient2(low = "grey60",
                        mid = "yellow",
                        high = "green3",
                        midpoint = 0.5,
                       limits = c(0,1))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 15))+
    ggtitle(label = "yellow lampmussel")+
  labs(fill = "Probability")+
  geom_sf(data =shp[shp$common_name == "yellow lampmussel",], 
          aes(color = live_occurrence), color = "black", size = .5)

ggsave(paste("tmpfigures/baseline_mussel_predictions/dwarfwedgemussel_cc.png"), 
    plot = last_plot(),
    width = 18,
    height = 12,
    units = "cm",
    dpi = 300) 

```





species richness, change in species richness, change for each species
```{r}
#change from baseline to climate change for each species

prediction_cc <- data.frame(prediction_cc)
predictions_baseline <- data.frame(predictions_baseline)

#save data files with mussel predictions for baseline and climate change
save(prediction_cc, file = 'ProjectResults/mussel_CC2080_proboccurrence.RData')
save(predictions_baseline, file = 'ProjectResults/mussel_baseline_proboccurrence.RData')

cc <- as.matrix(prediction_cc[, 40:51])
bl <- as.matrix(predictions_baseline[, 40:51])

change <- (cc - bl)
change <- data.frame(change)
change <- cbind(predictions_baseline[1:3], change)

change <- left_join(huc12, change, by = c("huc12_name", "huc12_tnmid", "huc12_areasqkm"))

names(change) <- gsub("\\.", " ", names(change))


#sample plot
shp <- left_join(mussel_event_huc_join, mussel_occurrence, by = "UID") %>% 
  filter(!is.na(live_occurrence)) %>% 
  filter(live_occurrence == 1) %>% 
  filter(huc12_name != "Long Island Sound Deep")
change <- change %>% 
  filter(huc12_name != "Long Island Sound Deep")


  
ggplot(data = change)+
  geom_sf(aes(fill = `eastern floater`), linewidth = .02)+
  scale_fill_gradient2(low = "red2",
                        mid = "white",
                        high = "green4",
                        midpoint = 0,
                       limits = c(-1,1))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 15),
        legend.title = element_text(size = 20))+
    ggtitle(label = "eastern floater")+
  labs(fill = "Δ P")

ggsave(paste("tmpfigures/baseline_mussel_predictions/tidewatermucket_change.png"), 
    plot = last_plot(),
    width = 18,
    height = 12,
    units = "cm",
    dpi = 300) 



#species richness in the baseline
richness_baseline <- predictions_baseline %>% 
  select(1,3,40:51) %>% 
  pivot_longer(3:14, names_to = "common_name", values_to = "prob") %>% 
  mutate(occurrence = ifelse(common_name %in% c("alewifefloater", "brook.floater", "dwarf.wedgemussel", "easternpondmussel", "Ttidewatermucket", "yellowlampmussel") &
                                                  prob > 0.1 , 1,
                                                ifelse(common_name %in% c("creeper", "eastern.elliptio", "eastern.floater", "eastern.lampmussel", "easternpearlshell", "triangle.floater") & prob > 0.5, 1, 0)))  %>% 
  group_by(huc12_name, huc12_tnmid) %>% 
  summarise(richness = sum(occurrence))


baseline <- left_join(huc12, richness_baseline, by = c("huc12_name", "huc12_tnmid"))%>% 
  filter(huc12_name != "Long Island Sound Deep")

  
ggplot(data = baseline)+
  geom_sf(aes(fill = richness))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 15),
        legend.title = element_text(size = 20))+
    ggtitle(label = "Baseline Species Richness")+
  labs(fill = "Richness")

ggsave(paste("tmpfigures/baseline_mussel_predictions/mussel_richness_baseline.png"), 
    plot = last_plot(),
    width = 18,
    height = 12,
    units = "cm",
    dpi = 300) 





#species richness in climate change
richness_cc <- prediction_cc %>% 
  select(1,3,40:51) %>% 
  pivot_longer(3:14, names_to = "common_name", values_to = "prob") %>% 
  mutate(occurrence = ifelse(common_name %in% c("alewifefloater", "brook.floater", "dwarf.wedgemussel", "easternpondmussel", "Ttidewatermucket", "yellowlampmussel") &
                                                  prob > 0.1 , 1,
                                                ifelse(common_name %in% c("creeper", "eastern.elliptio", "eastern.floater", "eastern.lampmussel", "easternpearlshell", "triangle.floater") & prob > 0.5, 1, 0)))  %>% 
  group_by(huc12_name, huc12_tnmid) %>% 
  summarise(richness = sum(occurrence))






#change in species richness: climate change - baseline

change_richness <- data.frame(
  "huc12_tnmid" = richness_baseline[,1],
  "huc12_name" = richness_baseline[,2],
  "richness_change" = richness_cc$richness - richness_baseline$richness
)


change_richness <- left_join(huc12, change_richness, by = c("huc12_name", "huc12_tnmid"))%>% 
  filter(huc12_name != "Long Island Sound Deep")

  
ggplot(data = change_richness)+
  geom_sf(aes(fill = richness_change))+
  scale_fill_gradient2(low = "red2",
                        mid = "white",
                        high = "green4",
                        midpoint = 0,
                       limits = c(min(change_richness$richness_change, na.rm = T), max(change_richness$richness_change, na.rm = T)))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 15),
        legend.title = element_text(size = 20))+
    ggtitle(label = "Change Species Richness")+
  labs(fill = "	Δ Richness")

ggsave(paste("tmpfigures/baseline_mussel_predictions/mussel_richness_change.png"), 
    plot = last_plot(),
    width = 18,
    height = 12,
    units = "cm",
    dpi = 300) 





#align change in richess values with change in the climate change varaibles
covariates_bl <- NHDplusV2_NewEngCrop_mussel_covariates_HUC12 %>% 
  select(huc12_name, huc12_tnmid, annual_mean_summer_temp, BFI_HIST, LO7Q1DT_HIST, CFM_HIST, W95_HIST, logMJJA_HIST)

#Climate change streamflow and temperature variables
covariates_cc <- NHDplusV2_NewEngCrop_2080 %>% 
  data.frame() %>% 
  rename(annual_mean_summer_temp = annual_mean_summer_temp_pls_4,
         BFI_HIST = BFI_2080,
         LO7Q1DT_HIST = LO7Q1DT_2080,
         CFM_HIST = CFM_2080,
         W95_HIST = W95_2080,
         logMJJA_HIST = logMJJA_2080) %>% 
  select(huc12_name, huc12_tnmid, annual_mean_summer_temp, BFI_HIST, LO7Q1DT_HIST, CFM_HIST, W95_HIST, logMJJA_HIST) %>% 
  group_by(huc12_name, huc12_tnmid) %>% 
  summarise(annual_mean_summer_temp = mean(annual_mean_summer_temp, na.rm = T),
            BFI_HIST = mean(BFI_HIST, na.rm = T),
            LO7Q1DT_HIST = mean(LO7Q1DT_HIST, na.rm = T),
            CFM_HIST = mean(CFM_HIST, na.rm = T),
            W95_HIST = mean(W95_HIST, na.rm = T),
            logMJJA_HIST = mean(logMJJA_HIST, na.rm = T))


sum(names(covariates_bl) == names(covariates_cc)) #45
sum(covariates_bl$huc12_name == covariates_cc$huc12_name, na.rm = T) #423

bl_cov <- covariates_bl %>% 
  ungroup() %>% 
  select(annual_mean_summer_temp, W95_HIST, logMJJA_HIST) %>% 
  mutate(mjja_hist = exp(logMJJA_HIST)) %>% 
  as.matrix()

cc_cov <- covariates_cc %>% 
  ungroup() %>% 
  select(annual_mean_summer_temp, W95_HIST, logMJJA_HIST) %>% 
  mutate(mjja_hist = exp(logMJJA_HIST)) %>% 
  as.matrix()

change_cov <- (cc_cov - bl_cov)
change_cov <- data.frame(change_cov)
change_cov <- cbind(covariates_bl[1:2], change_cov)


change_cov <- left_join(huc12, change_cov, by = c("huc12_name", "huc12_tnmid"))%>% 
  filter(huc12_name != "Long Island Sound Deep")

  
ggplot(data = change_cov)+
  geom_sf(aes(fill = annual_mean_summer_temp))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        legend.text = element_text(size = 15),
        legend.title = element_text(size = 20))+
    ggtitle(label = "Annual mean summer temp Change")+
  labs(fill = "Δ T(°C)")

ggsave(paste("tmpfigures/baseline_mussel_predictions/temp_change.png"), 
    plot = last_plot(),
    width = 18,
    height = 12,
    units = "cm",
    dpi = 300)  


change_richness <- change_richness %>% 
  data.frame() %>% 
  select(huc12_tnmid, huc12_name, richness_change)
df <- left_join(change_cov, change_richness, by = c("huc10_name", "huc10_tnmid"))

df <- df %>% 
  filter(!is.na(annual_mean_summer_temp))

r2 <- round(cor(df$richness_change, df$annual_mean_summer_temp),2)
cor.test(df$richness_change, df$W95_HIST)
label <- paste("R2 = ",  r2, sep = "")

ggplot(data = df, mapping = aes(x = annual_mean_summer_temp, y = richness_change))+
  geom_jitter(alpha = 0.1, size = 3)+
  geom_smooth(method = "lm", linewidth = 2, color = "red")+
  labs(y = "Change in Richness",
       x = "Change in Summer Stream Temperature (°C)")+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
          axis.title = element_text(size = 17),
          axis.text = element_text(size = 17))+
  annotate("text",x=3,y=-3,label=r2 ,parse=TRUE, color = "red", size = 5)



```

