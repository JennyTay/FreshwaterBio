---
title: "BiodiversityModel_Mussel_HUC12"
author: "Jenny Rogers"
date: "2023-07-06"
output: html_document
---

```{r}
library(tidyverse)
library(sf)
library(glmmTMB)
library(caret)
library(lme4)

```


```{r}
#watershed shape files
huc8 <- st_read("C:/Users/jenrogers/Documents/necascFreshwaterBio/SpatialData/NHDplus/WBDHU8/WBDHU8_NE.shp")
huc10 <- st_read("C:/Users/jenrogers/Documents/necascFreshwaterBio/SpatialData/NHDplus/WBDHU10/WBDHU10_NE.shp")
huc12 <- st_read("C:/Users/jenrogers/Documents/necascFreshwaterBio/SpatialData/NHDplus/WBDHU12/WBDHU12_NE.shp")

#load New England state data
states <- st_read("C:/Users/jenrogers/Documents/necascFreshwaterBio/SpatialData/newenglandshape/NEWENGLAND_POLY.shp")


```

In this script we model the probability of freshwater mussel occurrence at the HUC12 scale - I copied the script from "BiodiversityModel_Mussel.Rmd and just made changes so that everything was at the HUC12 scale instead of the HUC10 scale.  I was originally planning on redoing the mussel model to be at the stream reach scale (by COMID), but when I went back to the musselanalysis file, I remembered that the spatial join of each mussel sampling event to the stream reach excluded too many surveys because many surveys were too far from a stream reach to be successfully joined to a line, so were able to use a lot more data if we use them at the HUC12 scale. 

In the first chunk, we prepare the host fish covariate data by reading in the fish model and predicting in the baseline for presence/absence and proportional abundance

In the second part of the script, we use a logistic regression model using environmental covariates and fish host distribution to model each mussel individually 

In the third part of the script we model species richness and shannon index by HUC10

In the forth part of the script we model proportional abundance of mussel traits using a multinomial logistic regression


Part 1: prepare host fish covariates
```{r}


load(file = "C:/Users/jenrogers/Documents/necascFreshwaterBio/model_datafiles/NHDplusV2_NewEngCrop_covariates.RData")

#need to scal the variavles
test <- NHDplusV2_NewEngCrop %>% 
  data.frame() %>% 
  select(-geometry)

test <- test[,c(7:8, 10:39)]

#scale data
test <- data.frame(scale(test))

NHDplusV2_NewEngCrop <- cbind((NHDplusV2_NewEngCrop)[,c(1:6, 9)], test)






#fish host covariate with probability of presence by spp (using the logistic regression model)
# 
# file.list <- list.files("C:/Users/jenrogers/Documents/necascFreshwaterBio/model_objects", pattern = "pres_")
# 
# i <- 1
# 
# mdl <- readRDS(paste("C:/Users/jenrogers/Documents/necascFreshwaterBio/model_objects/", file.list[i], sep = ""))
#   
# predictions <- data.frame("test" = predict(mdl, newdata = NHDplusV2_NewEngCrop, type = "response"))
# names(predictions)[1] <- file.list[i]
# 
# 
# 
# 
# for (i in 2:57) { 
#   
#   
#    mdl <- readRDS(paste("C:/Users/jenrogers/Documents/necascFreshwaterBio/model_objects/", file.list[i], sep = ""))
#   
#   tmp <- data.frame("test" = predict(mdl, newdata = NHDplusV2_NewEngCrop, type = "response"))
#   names(tmp)[1] <- file.list[i]
#   
#   predictions <- cbind(predictions, tmp)
#   
#   
# }
# 
# 
# #join the predictions to the list of comids
# NHDplusV2_NewEngCrop_baseline <- cbind(NHDplusV2_NewEngCrop, predictions)
# 
# #average by HUC10 becuase that is the scale we are modeling mussels
# fish_host_prob_occ <- NHDplusV2_NewEngCrop_baseline %>%
#   data.frame() %>% 
#   select(huc10_name, huc10_tnmid, 40:96) %>% 
#   filter(!is.na(pres_brook.trout.rds),
#          !is.na(huc10_name)) %>%
#   pivot_longer(3:59, names_to = "common_name", values_to = "prob_occ") %>% 
#   group_by(huc10_name, huc10_tnmid) %>% 
#   summarise(total_prob_occ = sum(prob_occ))
#   









#Host fish variable 1 for the mussel model  - to be included in the model for all species of mussels:
#The predicted probability of occurrence of all fish (summed by stream reach – representing the total probability of occurrence of all species within a given reach) and averaged over a HUC12 – ultimately representing the average summed probability of occurrence of any fish species within a HUC12
#using the zprob from the prop abund model

file.list <- list.files("C:/Users/jenrogers/Documents/necascFreshwaterBio/model_objects", pattern = "propabun_")

i <- 1

mdl <- readRDS(paste("C:/Users/jenrogers/Documents/necascFreshwaterBio/model_objects/", file.list[i], sep = ""))
  
predictions <- data.frame("test" = (1 - (predict(mdl, newdata = NHDplusV2_NewEngCrop, type = "zprob")))) #do 1 - predict because we want prob of occurrence, not the prob of a zero
names(predictions)[1] <- file.list[i]




for (i in 2:53) { 
  
  
   mdl <- readRDS(paste("C:/Users/jenrogers/Documents/necascFreshwaterBio/model_objects/", file.list[i], sep = ""))
  
  tmp <- data.frame("test" = (1 - (predict(mdl, newdata = NHDplusV2_NewEngCrop, type = "zprob"))))
  names(tmp)[1] <- file.list[i]
  
  predictions <- cbind(predictions, tmp)
  
  
}

colnames(predictions) <- gsub("propabun_", "pres_", colnames(predictions)) #the probabun is the title of the model, but we used the zero predict option so we need to change the column names


#join the predictions to the list of comids
NHDplusV2_NewEngCrop_baseline <- cbind(NHDplusV2_NewEngCrop, predictions)

#average by HUC10 becuase that is the scale we are modeling mussels
fish_host_prob_occ <- NHDplusV2_NewEngCrop_baseline %>%
  data.frame() %>% 
  select(huc12_name, huc12_tnmid, COMID, 40:92) %>% 
  filter(!is.na(pres_brook.trout.rds),
         !is.na(huc12_name)) %>%
  pivot_longer(4:56, names_to = "common_name", values_to = "prob_occ") %>% 
  group_by(huc12_name, huc12_tnmid, COMID) %>% 
  summarise(total_prob_occ = sum(prob_occ)) %>% 
  ungroup() %>% 
  group_by(huc12_name, huc12_tnmid) %>% 
  summarise(mean_prob_occ = mean(total_prob_occ))
  






#fish host covariate with proportional abundance for the perferred host fish. (Variable 3 and 4)


file.list <- list.files("C:/Users/jenrogers/Documents/necascFreshwaterBio/model_objects", pattern = "propabun_")

i <- 1

mdl <- readRDS(paste("C:/Users/jenrogers/Documents/necascFreshwaterBio/model_objects/", file.list[i], sep = ""))
  
predictions <- data.frame("test" = predict(mdl, newdata = NHDplusV2_NewEngCrop, type = "response"))
names(predictions)[1] <- file.list[i]




for (i in 2:53) { 
  
  
   mdl <- readRDS(paste("C:/Users/jenrogers/Documents/necascFreshwaterBio/model_objects/", file.list[i], sep = ""))
  
  tmp <- data.frame("test" = predict(mdl, newdata = NHDplusV2_NewEngCrop, type = "response"))
  names(tmp)[1] <- file.list[i]
  
  predictions <- cbind(predictions, tmp)
  
  
}

#select only the columns for preferred host fish
predictions <- predictions %>% 
  select("propabun_brown trout.rds", "propabun_rainbow trout.rds", "propabun_atlantic salmon.rds", "propabun_brook trout.rds",
         "propabun_yellow perch.rds", "propabun_white perch.rds", "propabun_largemouth bass.rds", "propabun_bluegill.rds", "propabun_pumpkinseed.rds", 
         "propabun_redbreast sunfish.rds", )
names(predictions) <- gsub("propabun_", "", names(predictions))
names(predictions) <- gsub(".rds", "", names(predictions))
names(predictions) <- gsub("\\.", " ", names(predictions))


#join the predictions to the list of comids
NHDplusV2_NewEngCrop_baseline <- cbind(NHDplusV2_NewEngCrop, predictions)

#average by HUC10 becuase that is the scale we are modeling mussels
fish_host_propabun <- NHDplusV2_NewEngCrop_baseline %>%
  data.frame() %>% 
  select(COMID, huc12_name, huc12_tnmid, 40:49) %>% 
  filter(!is.na(brook.trout),
         !is.na(huc12_name)) %>%
  mutate(sumYLamp = white.perch + yellow.perch,
         sumEPear = brown.trout + rainbow.trout + atlantic.salmon + brook.trout,
         sumEpond = yellow.perch + largemouth.bass + bluegill + pumpkinseed + redbreast.sunfish) %>% 
  group_by(huc12_name, huc12_tnmid) %>% 
  summarise(TMuck_perferredhost = mean(white.perch),
            YLamp_perferredhost = mean(sumYLamp),
            EPear_perferredhost = mean(sumEPear),
            Epond_perferredhost = mean(sumEpond))




#Variable at the HUC12 scale showing if the non-modeled host fish has occurred in that HUC12 (Variable 2)
#fish data
load("C:/Users/jenrogers/Documents/necascFreshwaterBio/model_datafiles/fish_event_huc_join.RData")
load('C:/Users/jenrogers/Documents/necascFreshwaterBio/spp_data/tidydata/all_fish_presence.RData')

df <- left_join(fish_presence, fish_event_huc_join, by = "UID") %>% 
  filter(stock == "natural") %>% 
  select(huc12_name, huc12_tnmid, common_name) %>% 
  unique() %>% 
  filter(common_name %in% c("striped bass", 
                            "rainbow smelt", "american shad", "alewife", "blueback herring",
                            "ninespine stickleback", "three-spined stickleback", "fourspine stickleback"))



huc12 <- huc12 %>% 
  data.frame() %>% 
  select(name, tnmid) %>%
  unique()
fish <- unique(df$common_name)

#make a dataframe that has each UID repeated for each fish spp
absence <- data.frame('huc12_name' = rep(huc12$name, each = 8,),
                      'huc12_tnmid' = rep(huc12$tnmid, each = 8))
absence$common_name <- rep(fish, times = nrow(huc12))
#keep only rows in the absence list that are no in the fish_presence list
keep <- anti_join(absence, df, by = c("huc12_name", "huc12_tnmid", "common_name"))

#add presence absence information
keep$occurrence <- 0
df$occurrence <- 1



#bind the presence and absence columns together
fish_host_occ <- rbind(df, keep)
fish_host_occ <- fish_host_occ %>% 
  arrange(huc12_name, huc12_tnmid) %>% 
  pivot_wider(names_from = common_name, values_from = occurrence)

rm(absence, fish_presence, keep)
rm(fish, huc12)

fish_host_occ$YLamp_notmodeledhost <- fish_host_occ$`striped bass`
fish_host_occ$Epond_notmodeledhost <- ifelse(fish_host_occ$`three-spined stickleback` == 1 |
                                                 fish_host_occ$`fourspine stickleback` == 1 |
                                                 fish_host_occ$`ninespine stickleback` == 1,
                                               1, 0)
fish_host_occ$Afloa_notmodeledhost <- ifelse(fish_host_occ$alewife == 1 |
                                                 fish_host_occ$`blueback herring` == 1 |
                                                 fish_host_occ$`american shad` == 1 |
                                                 fish_host_occ$`rainbow smelt` == 1,
                                               1, 0)


fish_host_occ <- fish_host_occ %>% 
  select(huc12_name, huc12_tnmid, YLamp_notmodeledhost, Epond_notmodeledhost, Afloa_notmodeledhost)




#fish host covariate with proportional abundance by family. First do prop abund model. then add within a family

# 
# file.list <- list.files("C:/Users/jenrogers/Documents/necascFreshwaterBio/model_objects", pattern = "propabun_")
# 
# i <- 1
# 
# mdl <- readRDS(paste("C:/Users/jenrogers/Documents/necascFreshwaterBio/model_objects/", file.list[i], sep = ""))
#   
# predictions <- data.frame("test" = predict(mdl, newdata = NHDplusV2_NewEngCrop, type = "response"))
# names(predictions)[1] <- file.list[i]
# 
# 
# 
# 
# for (i in 2:53) { 
#   
#   
#    mdl <- readRDS(paste("C:/Users/jenrogers/Documents/necascFreshwaterBio/model_objects/", file.list[i], sep = ""))
#   
#   tmp <- data.frame("test" = predict(mdl, newdata = NHDplusV2_NewEngCrop, type = "response"))
#   names(tmp)[1] <- file.list[i]
#   
#   predictions <- cbind(predictions, tmp)
#   
#   
# }
# 
# 
# #join the predictions to the list of comids
# NHDplusV2_NewEngCrop_baseline <- cbind(NHDplusV2_NewEngCrop, predictions)
# 
# #average by HUC10 becuase that is the scale we are modeling mussels
# fish_host_propabun <- NHDplusV2_NewEngCrop_baseline %>%
#   data.frame() %>% 
#   select(huc10_name, huc10_tnmid, 40:96) %>% 
#   filter(!is.na(propabun_brook.trout.rds),
#          !is.na(huc10_name)) %>% 
#   group_by(huc10_name, huc10_tnmid) %>% 
#   summarise_all(mean) %>% 
#   pivot_longer(3:59, names_to = "common_name", values_to = "propabun")
# fish_host_propabun$common_name <- gsub("propabun_", "", fish_host_propabun$common_name)
# fish_host_propabun$common_name <- gsub(".rds", "", fish_host_propabun$common_name)
# fish_host_propabun$common_name <- gsub("\\.", " ", fish_host_propabun$common_name)
# 
# #add family information
# fish_host_propabun <- fish_host_propabun %>% 
#   mutate(family = ifelse(common_name%in% c("american brook lamprey"), "Petromyzontidae",
#                          ifelse(common_name %in% c("american eel"), "Anguillidae",
#                                 ifelse(common_name%in% c("atlantic salmon", "brook trout", "brown trout", "rainbow trout", "round whitefish"), "Salmonidae",
#                                        ifelse(common_name %in% c("banded killifish"), "Fundulidae",
#                                               ifelse(common_name %in% c("banded sunfish", "black crappie", "bluegill", "green sunfish", "largemouth bass", "pumpkinseed", "redbreast sunfish", "rock bass", "smallmouth bass"), "Centrarchidae",
#                                                      ifelse(common_name %in% c("bluntnose minnow", "bridle shiner", "common carp", "common shiner", "creek chub", "cutlips minnow", "eastern blacknose dace", "eastern silvery minnow", "fallfish", "fathead minnow", "finescale dace", "golden shiner", "lake chub", "longnose dace", "mimic shiner", "redbelly dace", "rosyface shiner", "rosyside dace", "spotfin shiner", "spottail shiner"), "Cyprinidae",
#                                                             ifelse(common_name %in% c("bowfin"), "Amiidae",
#                                                                    ifelse(common_name %in% c("brook stickleback"), "Gasterosteidae",
#                                                                           ifelse(common_name %in% c("brown bullhead", "channel catfish", "margined madtom", "white catfish"), "Ictaluridae",
#                                                                                  ifelse(common_name %in% c("burbot"), "Lotidae",
#                                                                                         ifelse(common_name %in% c("central mudminnow"), "Umbridae" ,
#                                                                                                ifelse(common_name %in% c("chain pickerel", "northern pike", "redfin pickerel"), "Esocidae",
#                                                                                                       ifelse(common_name %in% c("creek chubsucker", "longnose sucker", "white sucker", "yellow bullhead"), "Catostomidae",
#                                                                                                              ifelse(common_name %in% c("slimy sculpin"), "Cottidae", "Percidae")
#                                                                                                              ))))))))))))))
# 
# #swamp darter", "tessellated darter", "walleye", "yellow perch" are percidae
# 
# #group by family for total proportional abundance by family
# fish_host_propabun <- fish_host_propabun %>% 
#   group_by(huc10_name, huc10_tnmid, family) %>% 
#   summarise(propabun = sum(propabun)) %>% 
#   pivot_wider(names_from = family, values_from = propabun) %>% 
#   select(-Gasterosteidae) #its zero in every observation
# 
# 
# 
# 
# 
# 


```






Part 2: logistic regression to model each mussel species presence and absence probability
```{r}

#load datafiles



#mussel data
load("C:/Users/jenrogers/Documents/necascFreshwaterBio/model_datafiles/mussel_occurrence.RData")
load("C:/Users/jenrogers/Documents/necascFreshwaterBio/model_datafiles/mussel_count_with_zeros.RData")
fish_shp <- st_read("C:/Users/jenrogers/Documents/necascFreshwaterBio/SpatialData/sppdata/all_mussel_event.shp")

#mussel event and hydrography join
load("C:/Users/jenrogers/Documents/necascFreshwaterBio/model_datafiles/mussel_event_huc_join.RData")
load("C:/Users/jenrogers/Documents/necascFreshwaterBio/model_datafiles/mussel_event_flowline_join.RData")
load("C:/Users/jenrogers/Documents/necascFreshwaterBio/model_datafiles/mussel_event_flowlineV2_join.RData")

#watershed shape files
huc8 <- st_read("C:/Users/jenrogers/Documents/necascFreshwaterBio/SpatialData/NHDplus/WBDHU8/WBDHU8_NE.shp")
huc10 <- st_read("C:/Users/jenrogers/Documents/necascFreshwaterBio/SpatialData/NHDplus/WBDHU10/WBDHU10_NE.shp")
huc12 <- st_read("C:/Users/jenrogers/Documents/necascFreshwaterBio/SpatialData/NHDplus/WBDHU12/WBDHU12_NE.shp")

#load New England state data
states <- st_read("C:/Users/jenrogers/Documents/necascFreshwaterBio/SpatialData/newenglandshape/NEWENGLAND_POLY.shp")


#environmental covariates
load("C:/Users/jenrogers/Documents/necascFreshwaterBio/model_datafiles/mussel_covariates_byhuc12.RData")





#join mussel_occurrence data to the mussel event huc join so that we can get presence and absence by huc10
occ <- left_join(mussel_occurrence, mussel_event_huc_join, by = "UID")
#there are tons of rows with NA for all the HUC information - this is because we removed all the lentic surveys from the mussel_event_huc_join data file, but those are still
#present in the mussel_occurrence data file.
occ <- occ %>% 
  data.frame() %>% 
  filter(!is.na(huc12_name)) %>% 
  group_by(huc12_name, huc12_tnmid, common_name) %>% 
  summarise(live_occurrence = max(live_occurrence, na.rm = T),
            shell_occurrence = max(shell_occurrence, na.rm = T))

#how many occurrences of each species
df <- occ %>% 
  filter(live_occurrence ==1) %>% 
  group_by(common_name) %>% 
  summarise(count = n())

#join occurrence data by huc12 to the covariate dataset for the model
#first need to remove all repeated rows of huc12 covariates
mussel_covariates <- mussel_covariates_huc12 %>% 
  data.frame() %>% 
  select(-c(UID, state, date, project, source, waterbody, waterbody2,
            huc8_tnmid, huc8_areasqkm,
            huc10_tnmid, huc10_areasqkm,huc10_name,
            geometry)) %>% 
  unique()

#join the covariates to the fish_host_prob_occ - the total probabiity of occuurence for each spp summed in a huc10
mussel_covariates <- left_join(mussel_covariates, fish_host_prob_occ, by = c("huc12_name", "huc12_tnmid"))

#join the covariates to the fish_host_propabun by family prop abun predictions
mussel_covariates <- left_join(mussel_covariates, fish_host_propabun, by = c("huc12_name", "huc12_tnmid"))

#join the covariates to the fish_host_occ by family prop abun predictions
mussel_covariates <- left_join(mussel_covariates, fish_host_occ, by = c("huc12_name", "huc12_tnmid"))

#scale mussel covariates
test <- mussel_covariates[,c(5:40)]

#scale data
test <- data.frame(scale(test))

mussel_covariates <- cbind((mussel_covariates)[,c(1:4)], test)



dat <- left_join(occ, mussel_covariates, by = c("huc12_name", "huc12_tnmid"))




#plot curves of each species and the bivariate relationship with each covariate

dat2 <- dat %>% 
  filter(common_name == "brook floater")


for (i in 8:length(names(dat2))) {
  
ggplot(data = dat2, mapping = aes(x = dat2[[i]], y = live_occurrence))+
  geom_jitter(size = 2, alpha = .2, height = .05)+
  geom_smooth(method = "glm", 
    method.args = list(family = "binomial"))+
  labs(x = names(dat2[i]), y = "Live Occurrence")
 
ggsave(paste("tmpfigures/mussel_pres-abs_log_reg_plots/", "bfkfl_", names(dat2[i]), ".png", sep = ""), 
    plot = last_plot(),
    width = 18,
    height = 12,
    units = "cm",
    dpi = 300) 
  
}


#do a series of bivariate models between each mussel spp pres/abs to see what variables are important to each spp,
#each mussel spp can have a different model

for (j in unique(dat$common_name)) {

dat2 <- dat %>% 
  filter(common_name == j)

  mdl <- glm(live_occurrence ~ lat,
           data = dat2,
             family = "binomial")

results <- 
  data.frame(
    "variable" = names(dat2[i]),
    "estimate" = summary(mdl)$coefficients[2,1],
    "std_er" = summary(mdl)$coefficients[2,2],
    "p_val" = summary(mdl)$coefficients[2,4],
    "common_name" = unique(dat2$common_name))

results <- results %>% 
  mutate(LB = estimate -1.96*std_er,
         UB = estimate + 1.96*std_er,
         OR = exp(estimate),
         OR_LB = exp(LB),
         OR_UB = exp(UB))




for (i in 8:length(names(dat2))) {

  mdl <- glm(live_occurrence ~ dat2[[i]],
           data = dat2,
             family = "binomial")

results2 <- 
  data.frame(
    "variable" = names(dat2[i]),
    "estimate" = round(summary(mdl)$coefficients[2,1],2),
    "std_er" = round(summary(mdl)$coefficients[2,2],2),
    "p_val" = round(summary(mdl)$coefficients[2,4],2),
    "common_name" = unique(dat2$common_name))

results2 <- results2 %>% 
  mutate(LB = round(estimate -1.96*std_er,2),
         UB = round(estimate + 1.96*std_er,2),
         OR = round(exp(estimate),2),
         OR_LB = round(exp(LB),2),
         OR_UB = round(exp(UB),2))

results <- rbind(results, results2)

results <- results %>% 
  filter(p_val<0.05) %>% 
  arrange(p_val)

write.csv(results, file = paste("tmpfigures/", unique(dat2$common_name), "_coef.csv", sep = ""))





}

ggplot(data = results, aes(x = variable, y = estimate))+
  geom_point(size = 2)+
  geom_errorbar(aes(ymin = LB, ymax = UB), width = .2)+
  coord_flip()+
  geom_hline(yintercept = 0, color  = "red", linetype = "dashed", linewidth = 1)+
  theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        axis.text = element_text(size = 6),
        axis.title = element_text(size = 15),
        axis.title.y = element_blank(),
        title = element_text(size = 15))+
    ggtitle(label = unique(results$common_name))

ggsave(
    filename = paste("C:/Users/jenrogers/Documents/git/FreshwaterBio/FreshwaterBio/tmpfigures/mussel_log_odd_plots/", unique(results$common_name),  ".png", sep = ""),
    plot = last_plot(),
    width = 14,
    height = 9,
    units = "cm",
    dpi = 200)

print(j)

}


#cluster fish and mussels



load(file =  "C:/Users/jenrogers/Documents/necascFreshwaterBio/model_datafiles/fish_occurrence.RData")
load(file =  "C:/Users/jenrogers/Documents/necascFreshwaterBio/model_datafiles/fish_event_huc_join.RData")

fish_event_huc_join <- fish_event_huc_join %>% 
  data.frame() %>% 
  select(-geometry)

load(file =  "C:/Users/jenrogers/Documents/necascFreshwaterBio/model_datafiles/mussel_occurrence.RData")
load(file =  "C:/Users/jenrogers/Documents/necascFreshwaterBio/model_datafiles/mussel_event_huc_join.RData")

mussel_event_huc_join <- mussel_event_huc_join %>% 
  data.frame() %>% 
  select(-geometry)

#cluster based on co-occurnece at the HUC8 scale

fish <- left_join(fish_occurrence, fish_event_huc_join, by = "UID") %>%
  filter(stock == "natural",
         !is.na(huc8_name),
         common_name %in% c("american eel", "white perch", "rosyside dace", "channel catfish", "bowfin", "round whitefish", 
                            "white catfish", "spotfin shiner", "mimic shiner", "finescale dace", "american brook lamprey", 
                            "eastern silvery minnow", "rosyface shiner", "walleye", "cutlips minnow", "green sunfish", 
                            "brook stickleback", "common carp", "central mudminnow", "northern pike", "bridle shiner", 
                            "swamp darter", "lake chub", "banded killifish", "margined madtom", "burbot", "black crappie", 
                            "spottail shiner", "redbelly dace", "creek chubsucker", "banded sunfish", "fathead minnow", 
                            "bluntnose minnow", "redbreast sunfish", "rock bass", "rainbow trout", "longnose sucker", 
                            "smallmouth bass", "yellow bullhead", "redfin pickerel", "yellow perch", "brown bullhead", 
                            "atlantic salmon", "golden shiner", "chain pickerel", "bluegill", "brown trout", "tessellated darter", 
                            "largemouth bass", "fallfish", "common shiner", "creek chub", "pumpkinseed", "slimy sculpin", 
                            "longnose dace", "white sucker", "eastern blacknose dace", "brook trout")) %>% 
  select(common_name, scientific_name, occurrence, huc8_tnmid , huc8_name) %>% 
  group_by(common_name, huc8_tnmid , huc8_name) %>% 
  summarise(occurrence = max(occurrence, na.rm = T)) %>% 
  ungroup()


mussel <- left_join(mussel_occurrence, mussel_event_huc_join, by = "UID")%>%
  select(common_name, scientific_name, live_occurrence, huc8_tnmid , huc8_name) %>% 
  filter(!is.na(huc8_name)) %>% 
  rename(occurrence = live_occurrence)%>% 
  group_by(common_name, huc8_tnmid , huc8_name) %>% 
  summarise(occurrence = max(occurrence, na.rm = T))%>% 
  ungroup()



names(fish)
names(mussel)

dat <- rbind(fish, mussel)


dat <- dat %>%
  select(huc8_name, common_name, occurrence) %>%
  pivot_wider(names_from = common_name, values_from = occurrence) %>% 
  column_to_rownames(var = "huc8_name")

test <- t(dat)
colnames(test) <- rownames(dat)

dist_mat <- dist(test, method = "binary")

hclust_avg <- hclust(dist_mat, method = "average")
hclust_avg$labels<- names(dat)

png(height = 10, width = 15, file = "tmpfigures/fish_mussel_hclust_byhuc8.png", units = "in", res = 150, type = "cairo")

plot(hclust_avg)
dev.off()



#cluster based on co-occurrence at the HUC10 scale


fish <- left_join(fish_occurrence, fish_event_huc_join, by = "UID") %>%
  filter(stock == "natural",
         !is.na(huc10_name),
         common_name %in% c("american eel", "white perch", "rosyside dace", "channel catfish", "bowfin", "round whitefish", 
                            "white catfish", "spotfin shiner", "mimic shiner", "finescale dace", "american brook lamprey", 
                            "eastern silvery minnow", "rosyface shiner", "walleye", "cutlips minnow", "green sunfish", 
                            "brook stickleback", "common carp", "central mudminnow", "northern pike", "bridle shiner", 
                            "swamp darter", "lake chub", "banded killifish", "margined madtom", "burbot", "black crappie", 
                            "spottail shiner", "redbelly dace", "creek chubsucker", "banded sunfish", "fathead minnow", 
                            "bluntnose minnow", "redbreast sunfish", "rock bass", "rainbow trout", "longnose sucker", 
                            "smallmouth bass", "yellow bullhead", "redfin pickerel", "yellow perch", "brown bullhead", 
                            "atlantic salmon", "golden shiner", "chain pickerel", "bluegill", "brown trout", "tessellated darter", 
                            "largemouth bass", "fallfish", "common shiner", "creek chub", "pumpkinseed", "slimy sculpin", 
                            "longnose dace", "white sucker", "eastern blacknose dace", "brook trout")) %>% 
  select(common_name, scientific_name, occurrence, huc10_tnmid , huc10_name) %>% 
  group_by(common_name, huc10_tnmid , huc10_name) %>% 
  summarise(occurrence = max(occurrence, na.rm = T)) %>% 
  ungroup()


mussel <- left_join(mussel_occurrence, mussel_event_huc_join, by = "UID")%>%
  select(common_name, scientific_name, live_occurrence, huc10_tnmid , huc10_name) %>% 
  filter(!is.na(huc10_name)) %>% 
  rename(occurrence = live_occurrence)%>% 
  group_by(common_name, huc10_tnmid , huc10_name) %>% 
  summarise(occurrence = max(occurrence, na.rm = T))%>% 
  ungroup()



names(fish)
names(mussel)

dat <- rbind(fish, mussel)
dat$huc10_name <- paste(dat$huc10_name, dat$huc10_tnmid, sep = "_")


dat <- dat %>%
  select(huc10_name, common_name, occurrence) %>%
  pivot_wider(names_from = common_name, values_from = occurrence) %>% 
  column_to_rownames(var = "huc10_name")

test <- t(dat)
colnames(test) <- rownames(dat)

dist_mat <- dist(test, method = "binary")

hclust_avg <- hclust(dist_mat, method = "average")
hclust_avg$labels<- names(dat)

png(height = 10, width = 15, file = "tmpfigures/fish_mussel_hclust_byhuc10.png", units = "in", res = 150, type = "cairo")

plot(hclust_avg)
dev.off()







#logistic regression model for mussel occurrence
#remove mussels that are not found in enough watersheds
dat <- dat %>% 
  filter(common_name %in% c("alewife floater", "eastern elliptio", "brook floater", "creeper", "dwarf wedgemussel", "eastern floater",
                            "eastern lampmussel", "eastern pearlshell", "eastern pondmussel", "tidewater mucket",
                            "triangle floater", "yellow lampmussel"))
#of the remaining spp, some are more common than others.
#for the validation of rare spp, we want to use a threshold of 0.1 meaning if the prob of occurrence >0.1 than we predict they occur
########rare spp that need their own model bc they have specialist host fish: tidewater mucket, yellow lampmussel, eastern pond mussel, alewife floater - can do the rest in a loop with just the one host fish variable
#for the validation of common spp, we want to use a threshold of 0.5 meaning if the prob of occurrence >0.5 then we predict they occur
########common spp that need their own model due to specialist host fish - eastern pearlshell, can do the rest in a loop.

####Rare spp : Tidewater mucket
dat_TM <- dat %>% 
  filter(common_name %in% c("tidewater mucket"))
n_obs <- nrow(dat_TM)
permuted_rows <- sample(n_obs)
dat_TM <- dat_TM[permuted_rows,]
split <- round(n_obs * 0.8)
set.seed(32435)
train <- dat_TM[1:split, ]
test <- dat_TM[(split+1):n_obs, ]

mdl <- glm(live_occurrence ~ 
             lat +
             long +
             ElevCat +
             CaOWs +
             RunoffWs +
             pollutionWs +
             WWTPMajorDensWs +
             KffactWs +
             annual_mean_summer_temp + 
             W95_HIST +
             logMJJA_HIST + 
             pctForest_ws +
             PctOw_Ws +  
             PctImp_WsRp100 +  
             pctAg_Ws + 
             huc12_damden_sqkm +
             huc8_damcount +
             mean_prob_occ +
             TMuck_perferredhost,
             data = train,
             family = "binomial")

summary(mdl)
saveRDS(mdl, "C:/Users/jenrogers/Documents/necascFreshwaterBio/model_objects/mussel_Tidewatermucket.rds")

results_TM <- 
  data.frame(
    "estimate" = summary(mdl)$coefficients[,1],
    "std_er" = summary(mdl)$coefficients[,2],
    "p_val" = summary(mdl)$coefficients[,4],
    "variable" = rownames(summary(mdl)$coefficients),
    "common_name" = "tidewater mucket")


#use model to predict on testing data
predict_resp <- predict(mdl, test, type = 'response') #the predicted value


#compare the predicted zeros to the actual zeros
compare <- data.frame(
  "common_name" = test$common_name,
  "occurrence" = factor(test$live_occurrence, levels = c(1,0)),
  "pred_occurrence" = factor(ifelse(predict_resp > 0.1, 1, 0), levels = levels(factor(test$live_occurrence, levels = c(1,0))))
)


#validations for the predicted occurrence vs the actual occurrence
cm <- confusionMatrix(reference = compare$occurrence, data = compare$pred_occurrence)

val_zero_prob_TM <- data.frame(
  "common_name" = unique(train$common_name),
  "test_dat_pres" = nrow(test[test$live_occurrence == 1,]),
  "test_dat_abs" = nrow(test[test$live_occurrence == 0,]),
  "train_dat_pres" = nrow(train[train$live_occurrence == 1, ]),
  "train_dat_abs" = nrow(train[train$live_occurrence == 0, ]),
  "accuracy" = cm$overall[1],
  "sensitivity" = cm$byClass[1],
  "Specificity" = cm$byClass[2],
  "Pos Pred Value" = cm$byClass[3],
  "Neg Pred Value" = cm$byClass[4]
)



####Rare spp : alewife floater
dat_AF <- dat %>% 
  filter(common_name %in% c("alewife floater"))
n_obs <- nrow(dat_AF)
permuted_rows <- sample(n_obs)
dat_AF <- dat_AF[permuted_rows,]
split <- round(n_obs * 0.8)
set.seed(32435)
train <- dat_AF[1:split, ]
test <- dat_AF[(split+1):n_obs, ]

mdl <- glm(live_occurrence ~ 
             lat +
             long +
             ElevCat +
             CaOWs +
             RunoffWs +
             pollutionWs +
             WWTPMajorDensWs +
             KffactWs +
             annual_mean_summer_temp + 
             W95_HIST +
             logMJJA_HIST + 
             pctForest_ws +
             PctOw_Ws +  
             PctImp_WsRp100 +  
             pctAg_Ws + 
             huc12_damden_sqkm +
             huc8_damcount +
             mean_prob_occ +
             Afloa_notmodeledhost,
             data = train,
             family = "binomial")

summary(mdl)
saveRDS(mdl, "C:/Users/jenrogers/Documents/necascFreshwaterBio/model_objects/mussel_alewifefloater.rds")

results_AF <- 
  data.frame(
    "estimate" = summary(mdl)$coefficients[,1],
    "std_er" = summary(mdl)$coefficients[,2],
    "p_val" = summary(mdl)$coefficients[,4],
    "variable" = rownames(summary(mdl)$coefficients),
    "common_name" = "alewife floater")


#use model to predict on testing data
predict_resp <- predict(mdl, test, type = 'response') #the predicted value


#compare the predicted zeros to the actual zeros
compare <- data.frame(
  "common_name" = test$common_name,
  "occurrence" = factor(test$live_occurrence, levels = c(1,0)),
  "pred_occurrence" = factor(ifelse(predict_resp > 0.1, 1, 0), levels = levels(factor(test$live_occurrence, levels = c(1,0))))
)


#validations for the predicted occurrence vs the actual occurrence
cm <- confusionMatrix(reference = compare$occurrence, data = compare$pred_occurrence)

val_zero_prob_AF <- data.frame(
  "common_name" = unique(train$common_name),
  "test_dat_pres" = nrow(test[test$live_occurrence == 1,]),
  "test_dat_abs" = nrow(test[test$live_occurrence == 0,]),
  "train_dat_pres" = nrow(train[train$live_occurrence == 1, ]),
  "train_dat_abs" = nrow(train[train$live_occurrence == 0, ]),
  "accuracy" = cm$overall[1],
  "sensitivity" = cm$byClass[1],
  "Specificity" = cm$byClass[2],
  "Pos Pred Value" = cm$byClass[3],
  "Neg Pred Value" = cm$byClass[4]
)



####Rare spp : Yellow lampmussel
dat_YL <- dat %>% 
  filter(common_name %in% c("yellow lampmussel"))
n_obs <- nrow(dat_YL)
permuted_rows <- sample(n_obs)
dat_YL <- dat_YL[permuted_rows,]
split <- round(n_obs * 0.8)
set.seed(32435)
train <- dat_YL[1:split, ]
test <- dat_YL[(split+1):n_obs, ]

mdl <- glm(live_occurrence ~ 
             lat +
             long +
             ElevCat +
             CaOWs +
             RunoffWs +
             pollutionWs +
             WWTPMajorDensWs +
             KffactWs +
             annual_mean_summer_temp + 
             W95_HIST +
             logMJJA_HIST + 
             pctForest_ws +
             PctOw_Ws +  
             PctImp_WsRp100 +  
             pctAg_Ws + 
             huc12_damden_sqkm +
             huc8_damcount +
             mean_prob_occ +
             YLamp_perferredhost +
             YLamp_notmodeledhost,
             data = train,
             family = "binomial")

summary(mdl)
saveRDS(mdl, "C:/Users/jenrogers/Documents/necascFreshwaterBio/model_objects/mussel_yellowlampmussel.rds")

results_YL <- 
  data.frame(
    "estimate" = summary(mdl)$coefficients[,1],
    "std_er" = summary(mdl)$coefficients[,2],
    "p_val" = summary(mdl)$coefficients[,4],
    "variable" = rownames(summary(mdl)$coefficients),
    "common_name" = "yellow lampmussel")


#use model to predict on testing data
predict_resp <- predict(mdl, test, type = 'response') #the predicted value


#compare the predicted zeros to the actual zeros
compare <- data.frame(
  "common_name" = test$common_name,
  "occurrence" = factor(test$live_occurrence, levels = c(1,0)),
  "pred_occurrence" = factor(ifelse(predict_resp > 0.1, 1, 0), levels = levels(factor(test$live_occurrence, levels = c(1,0))))
)


#validations for the predicted occurrence vs the actual occurrence
cm <- confusionMatrix(reference = compare$occurrence, data = compare$pred_occurrence)

val_zero_prob_YL <- data.frame(
  "common_name" = unique(train$common_name),
  "test_dat_pres" = nrow(test[test$live_occurrence == 1,]),
  "test_dat_abs" = nrow(test[test$live_occurrence == 0,]),
  "train_dat_pres" = nrow(train[train$live_occurrence == 1, ]),
  "train_dat_abs" = nrow(train[train$live_occurrence == 0, ]),
  "accuracy" = cm$overall[1],
  "sensitivity" = cm$byClass[1],
  "Specificity" = cm$byClass[2],
  "Pos Pred Value" = cm$byClass[3],
  "Neg Pred Value" = cm$byClass[4]
)





####Rare spp : eastern pondmussel
dat_EP <- dat %>% 
  filter(common_name %in% c("eastern pondmussel"))
n_obs <- nrow(dat_EP)
permuted_rows <- sample(n_obs)
dat_EP <- dat_EP[permuted_rows,]
split <- round(n_obs * 0.8)
set.seed(32435)
train <- dat_EP[1:split, ]
test <- dat_EP[(split+1):n_obs, ]

mdl <- glm(live_occurrence ~ 
             lat +
             long +
             ElevCat +
             CaOWs +
             RunoffWs +
             pollutionWs +
             WWTPMajorDensWs +
             KffactWs +
             annual_mean_summer_temp + 
             W95_HIST +
             logMJJA_HIST + 
             pctForest_ws +
             PctOw_Ws +  
             PctImp_WsRp100 +  
             pctAg_Ws + 
             huc12_damden_sqkm +
             huc8_damcount +
             mean_prob_occ +
             Epond_perferredhost +
             Epond_notmodeledhost,
             data = train,
             family = "binomial")

summary(mdl)
saveRDS(mdl, "C:/Users/jenrogers/Documents/necascFreshwaterBio/model_objects/mussel_easternpondmussel.rds")

results_Epond <- 
  data.frame(
    "estimate" = summary(mdl)$coefficients[,1],
    "std_er" = summary(mdl)$coefficients[,2],
    "p_val" = summary(mdl)$coefficients[,4],
    "variable" = rownames(summary(mdl)$coefficients),
    "common_name" = "eastern pondmussel")


#use model to predict on testing data
predict_resp <- predict(mdl, test, type = 'response') #the predicted value


#compare the predicted zeros to the actual zeros
compare <- data.frame(
  "common_name" = test$common_name,
  "occurrence" = factor(test$live_occurrence, levels = c(1,0)),
  "pred_occurrence" = factor(ifelse(predict_resp > 0.1, 1, 0), levels = levels(factor(test$live_occurrence, levels = c(1,0))))
)


#validations for the predicted occurrence vs the actual occurrence
cm <- confusionMatrix(reference = compare$occurrence, data = compare$pred_occurrence)

val_zero_prob_Epond <- data.frame(
  "common_name" = unique(train$common_name),
  "test_dat_pres" = nrow(test[test$live_occurrence == 1,]),
  "test_dat_abs" = nrow(test[test$live_occurrence == 0,]),
  "train_dat_pres" = nrow(train[train$live_occurrence == 1, ]),
  "train_dat_abs" = nrow(train[train$live_occurrence == 0, ]),
  "accuracy" = cm$overall[1],
  "sensitivity" = cm$byClass[1],
  "Specificity" = cm$byClass[2],
  "Pos Pred Value" = cm$byClass[3],
  "Neg Pred Value" = cm$byClass[4]
)









####Rare spp - the remaining rare spp that are generalist 
dat_rare <- dat %>% 
  filter(common_name %in% c("dwarf wedgemussel", "brook floater"))
dat2 <- dat_rare %>% 
  filter(common_name == "brook floater")
n_obs <- nrow(dat2)
permuted_rows <- sample(n_obs)
dat2 <- dat2[permuted_rows,]
split <- round(n_obs * 0.8)
set.seed(32435)
train <- dat2[1:split, ]
test <- dat2[(split+1):n_obs, ]

mdl <- glm(live_occurrence ~ 
             lat +
             long +
             ElevCat +
             CaOWs +
             RunoffWs +
             pollutionWs +
             WWTPMajorDensWs +
             KffactWs +
             annual_mean_summer_temp + 
             W95_HIST +
             logMJJA_HIST + 
             pctForest_ws +
             PctOw_Ws +  
             PctImp_WsRp100 +  
             pctAg_Ws + 
             huc12_damden_sqkm +
             huc8_damcount +
             mean_prob_occ,
             data = train,
             family = "binomial")

summary(mdl)
saveRDS(mdl, paste("C:/Users/jenrogers/Documents/necascFreshwaterBio/model_objects/mussel_", unique(dat_rare$common_name)[1], ".rds", sep = ""))

results <- 
  data.frame(
    "estimate" = summary(mdl)$coefficients[,1],
    "std_er" = summary(mdl)$coefficients[,2],
    "p_val" = summary(mdl)$coefficients[,4],
    "variable" = rownames(summary(mdl)$coefficients),
    "common_name" = "brook floater")


#use model to predict on testing data
predict_resp <- predict(mdl, test, type = 'response') #the predicted value


#compare the predicted zeros to the actual zeros
compare <- data.frame(
  "common_name" = test$common_name,
  "occurrence" = factor(test$live_occurrence, levels = c(1,0)),
  "pred_occurrence" = factor(ifelse(predict_resp > 0.1, 1, 0), levels = levels(factor(test$live_occurrence, levels = c(1,0))))
)


#validations for the predicted occurrence vs the actual occurrence
cm <- confusionMatrix(reference = compare$occurrence, data = compare$pred_occurrence)

val_zero_prob <- data.frame(
  "common_name" = unique(train$common_name),
  "test_dat_pres" = nrow(test[test$live_occurrence == 1,]),
  "test_dat_abs" = nrow(test[test$live_occurrence == 0,]),
  "train_dat_pres" = nrow(train[train$live_occurrence == 1, ]),
  "train_dat_abs" = nrow(train[train$live_occurrence == 0, ]),
  "accuracy" = cm$overall[1],
  "sensitivity" = cm$byClass[1],
  "Specificity" = cm$byClass[2],
  "Pos Pred Value" = cm$byClass[3],
  "Neg Pred Value" = cm$byClass[4]
)




for (i in 2:length(unique(dat_rare$common_name))) {
 
dat2 <- dat_rare %>% 
  filter(common_name == unique(dat_rare$common_name)[i])
n_obs <- nrow(dat2)
permuted_rows <- sample(n_obs)
dat2 <- dat2[permuted_rows,]
split <- round(n_obs * 0.8)
set.seed(32435)
train <- dat2[1:split, ]
test <- dat2[(split+1):n_obs, ]
  
 
mdl <- glm(live_occurrence ~ 
             lat +
             long +
             ElevCat +
             CaOWs +
             RunoffWs +
             pollutionWs +
             WWTPMajorDensWs +
             KffactWs +
             annual_mean_summer_temp + 
             W95_HIST +
             logMJJA_HIST + 
             pctForest_ws +
             PctOw_Ws +  
             PctImp_WsRp100 +  
             pctAg_Ws + 
             huc12_damden_sqkm +
             huc8_damcount +
             mean_prob_occ,
             data = train,
             family = "binomial")

saveRDS(mdl, paste("C:/Users/jenrogers/Documents/necascFreshwaterBio/model_objects/mussel_", unique(dat_rare$common_name)[i], ".rds", sep = ""))

results2 <- 
  data.frame(
    "estimate" = summary(mdl)$coefficients[,1],
    "std_er" = summary(mdl)$coefficients[,2],
    "p_val" = summary(mdl)$coefficients[,4],
    "variable" = rownames(summary(mdl)$coefficients),
    "common_name" = unique(dat_rare$common_name)[i]) 

results <- rbind(results, results2)


#use model to predict on testing data
predict_resp <- predict(mdl, test, type = 'response') #the predicted value


#compare the predicted zeros to the actual zeros
compare <- data.frame(
  "common_name" = test$common_name,
  "occurrence" = factor(test$live_occurrence, levels = c(1,0)),
  "pred_occurrence" = factor(ifelse(predict_resp > 0.1, 1, 0), levels = levels(factor(test$live_occurrence, levels = c(1,0))))
)


#validations for the predicted occurrence vs the actual occurrence
cm <- confusionMatrix(reference = compare$occurrence, data = compare$pred_occurrence)

val2 <- data.frame(
  "common_name" = unique(train$common_name),
  "test_dat_pres" = nrow(test[test$live_occurrence == 1,]),
  "test_dat_abs" = nrow(test[test$live_occurrence == 0,]),
  "train_dat_pres" = nrow(train[train$live_occurrence == 1, ]),
  "train_dat_abs" = nrow(train[train$live_occurrence == 0, ]),
  "accuracy" = cm$overall[1],
  "sensitivity" = cm$byClass[1],
  "Specificity" = cm$byClass[2],
  "Pos Pred Value" = cm$byClass[3],
  "Neg Pred Value" = cm$byClass[4]
)

val_zero_prob <- rbind(val_zero_prob, val2)

print(unique(dat_rare$common_name)[i])
  
  

 
}










#common spp 
#start with eastern pearlshell that is the only common spp that is a specialist and has its own model

#set aside 20% for validation and put 80% into the calibration dataset
dat_common <- dat %>% 
  filter(!common_name %in% c("brook floater", "alewife floater", "dwarf wedgemussel", "tidewater mucket", "yellow lampmussel", "eastern pondmussel"))
dat2 <- dat_common %>% 
  filter(common_name == "eastern pearlshell")
n_obs <- nrow(dat2)
permuted_rows <- sample(n_obs)
dat2 <- dat2[permuted_rows,]
split <- round(n_obs * 0.8)
set.seed(32435)
train <- dat2[1:split, ]
test <- dat2[(split+1):n_obs, ]


mdl <- glm(live_occurrence ~ 
             lat +
             long +
             ElevCat +
             CaOWs +
             RunoffWs +
             pollutionWs +
             WWTPMajorDensWs +
             KffactWs +
             annual_mean_summer_temp + 
             W95_HIST +
             logMJJA_HIST + 
             pctForest_ws +
             PctOw_Ws +  
             PctImp_WsRp100 +  
             pctAg_Ws + 
             huc12_damden_sqkm +
             huc8_damcount +
             mean_prob_occ +
             EPear_perferredhost,
             data = train,
             family = "binomial")

summary(mdl)
saveRDS(mdl, "C:/Users/jenrogers/Documents/necascFreshwaterBio/model_objects/mussel_easternpearlshell.rds")

results_Epearl <- 
  data.frame(
    "estimate" = summary(mdl)$coefficients[,1],
    "std_er" = summary(mdl)$coefficients[,2],
    "p_val" = summary(mdl)$coefficients[,4],
    "variable" = rownames(summary(mdl)$coefficients),
    "common_name" = "eastern pearlshell")


#use model to predict on testing data
predict_resp <- predict(mdl, test, type = 'response') #the predicted value


#compare the predicted zeros to the actual zeros
compare <- data.frame(
  "common_name" = test$common_name,
  "occurrence" = factor(test$live_occurrence, levels = c(1,0)),
  "pred_occurrence" = factor(ifelse(predict_resp > 0.5, 1, 0), levels = levels(factor(test$live_occurrence, levels = c(1,0))))
)


#validations for the predicted occurrence vs the actual occurrence
cm <- confusionMatrix(reference = compare$occurrence, data = compare$pred_occurrence)

val_zero_prob_Epearl <- data.frame(
  "common_name" = unique(train$common_name),
  "test_dat_pres" = nrow(test[test$live_occurrence == 1,]),
  "test_dat_abs" = nrow(test[test$live_occurrence == 0,]),
  "train_dat_pres" = nrow(train[train$live_occurrence == 1, ]),
  "train_dat_abs" = nrow(train[train$live_occurrence == 0, ]),
  "accuracy" = cm$overall[1],
  "sensitivity" = cm$byClass[1],
  "Specificity" = cm$byClass[2],
  "Pos Pred Value" = cm$byClass[3],
  "Neg Pred Value" = cm$byClass[4]
)











#common spp that are generalist (remove the specialist spp and eastern pearlshell)
#set aside 20% for validation and put 80% into the calibration dataset
dat_common <- dat %>% 
  filter(!common_name %in% c("brook floater", "alewife floater", "dwarf wedgemussel", "tidewater mucket", "yellow lampmussel", "eastern pondmussel", "eastern pearlshell")) %>% 
  filter(live_occurrence == 0 | live_occurrence ==1)
dat2 <- dat_common %>% 
  filter(common_name == "creeper")
n_obs <- nrow(dat2)
permuted_rows <- sample(n_obs)
dat2 <- dat2[permuted_rows,]
split <- round(n_obs * 0.8)
set.seed(32435)
train <- dat2[1:split, ]
test <- dat2[(split+1):n_obs, ]


mdl <- glm(live_occurrence ~ 
             lat +
             long +
             ElevCat +
             CaOWs +
             RunoffWs +
             pollutionWs +
             WWTPMajorDensWs +
             KffactWs +
             annual_mean_summer_temp + 
             W95_HIST +
             logMJJA_HIST + 
             pctForest_ws +
             PctOw_Ws +  
             PctImp_WsRp100 +  
             pctAg_Ws + 
             huc12_damden_sqkm +
             huc8_damcount +
             mean_prob_occ,
             data = train,
             family = "binomial")

summary(mdl)
saveRDS(mdl, paste("C:/Users/jenrogers/Documents/necascFreshwaterBio/model_objects/mussel_", unique(dat2$common_name)[1], ".rds", sep = ""))

results_common <- 
  data.frame(
    "estimate" = summary(mdl)$coefficients[,1],
    "std_er" = summary(mdl)$coefficients[,2],
    "p_val" = summary(mdl)$coefficients[,4],
    "variable" = rownames(summary(mdl)$coefficients),
    "common_name" = "creeper")


#use model to predict on testing data
predict_resp <- predict(mdl, test, type = 'response') #the predicted value


#compare the predicted zeros to the actual zeros
compare <- data.frame(
  "common_name" = test$common_name,
  "occurrence" = factor(test$live_occurrence, levels = c(1,0)),
  "pred_occurrence" = factor(ifelse(predict_resp > 0.5, 1, 0), levels = levels(factor(test$live_occurrence, levels = c(1,0))))
)


#validations for the predicted occurrence vs the actual occurrence
cm <- confusionMatrix(reference = compare$occurrence, data = compare$pred_occurrence)

val_zero_prob_common <- data.frame(
  "common_name" = unique(train$common_name),
  "test_dat_pres" = nrow(test[test$live_occurrence == 1,]),
  "test_dat_abs" = nrow(test[test$live_occurrence == 0,]),
  "train_dat_pres" = nrow(train[train$live_occurrence == 1, ]),
  "train_dat_abs" = nrow(train[train$live_occurrence == 0, ]),
  "accuracy" = cm$overall[1],
  "sensitivity" = cm$byClass[1],
  "Specificity" = cm$byClass[2],
  "Pos Pred Value" = cm$byClass[3],
  "Neg Pred Value" = cm$byClass[4]
)




for (i in 2:length(unique(dat_common$common_name))) {
 
dat2 <- dat_common %>% 
  filter(common_name == unique(dat_common$common_name)[i])
n_obs <- nrow(dat2)
permuted_rows <- sample(n_obs)
dat2 <- dat2[permuted_rows,]
split <- round(n_obs * 0.8)
set.seed(32435)
train <- dat2[1:split, ]
test <- dat2[(split+1):n_obs, ]
  
 
mdl <- glm(live_occurrence ~ 
             lat +
             long +
             ElevCat +
             CaOWs +
             RunoffWs +
             pollutionWs +
             WWTPMajorDensWs +
             KffactWs +
             annual_mean_summer_temp + 
             W95_HIST +
             logMJJA_HIST + 
             pctForest_ws +
             PctOw_Ws +  
             PctImp_WsRp100 +  
             pctAg_Ws + 
             huc12_damden_sqkm +
             huc8_damcount +
             mean_prob_occ,
             data = train,
             family = "binomial")

saveRDS(mdl, paste("C:/Users/jenrogers/Documents/necascFreshwaterBio/model_objects/mussel_", unique(dat_common$common_name)[i], ".rds", sep = ""))

results2 <- 
  data.frame(
    "estimate" = summary(mdl)$coefficients[,1],
    "std_er" = summary(mdl)$coefficients[,2],
    "p_val" = summary(mdl)$coefficients[,4],
    "variable" = rownames(summary(mdl)$coefficients),
    "common_name" = unique(dat_common$common_name)[i]) 

results_common <- rbind(results_common, results2)


#use model to predict on testing data
predict_resp <- predict(mdl, test, type = 'response') #the predicted value


#compare the predicted zeros to the actual zeros
compare <- data.frame(
  "common_name" = test$common_name,
  "occurrence" = factor(test$live_occurrence, levels = c(1,0)),
  "pred_occurrence" = factor(ifelse(predict_resp > 0.5, 1, 0), levels = levels(factor(test$live_occurrence, levels = c(1,0))))
)


#validations for the predicted occurrence vs the actual occurrence
cm <- confusionMatrix(reference = compare$occurrence, data = compare$pred_occurrence)

val2 <- data.frame(
  "common_name" = unique(train$common_name),
  "test_dat_pres" = nrow(test[test$live_occurrence == 1,]),
  "test_dat_abs" = nrow(test[test$live_occurrence == 0,]),
  "train_dat_pres" = nrow(train[train$live_occurrence == 1, ]),
  "train_dat_abs" = nrow(train[train$live_occurrence == 0, ]),
  "accuracy" = cm$overall[1],
  "sensitivity" = cm$byClass[1],
  "Specificity" = cm$byClass[2],
  "Pos Pred Value" = cm$byClass[3],
  "Neg Pred Value" = cm$byClass[4]
)

val_zero_prob_common <- rbind(val_zero_prob_common, val2)

print(unique(dat_common$common_name)[i])
  
  

 
}


val_zero_prob <- rbind(val_zero_prob, val_zero_prob_Epond, val_zero_prob_YL, val_zero_prob_AF, val_zero_prob_TM, 
                       val_zero_prob_common, val_zero_prob_Epearl)
write.csv(val_zero_prob, file = "tmpfigures/val_zero_prob_with_host.csv")
results <- rbind(results, results_Epond, results_YL, results_AF, results_TM,
                 results_common, results_Epearl)
results <- results %>% 
  filter(p_val <0.1) %>%  
  mutate(odds = exp(estimate),
         up = estimate + (1.64 * std_er),#90% confidence interval
         up_odds = exp(up),
         lw = estimate - (1.64 * std_er),
         lw_odds = exp(lw)) %>% 
  filter(variable !="(Intercept)") %>% 
  arrange(common_name) %>% 
  select(common_name, variable, odds, up_odds, lw_odds, p_val)
write.csv(results, file = "tmpfigures/mussel_results_with_host.csv")



for (i in 1:12) {
  
ggplot(data = results[results$common_name == unique(results$common_name)[i],], aes(x = variable, y = odds))+
  geom_point(size = 2)+
  geom_errorbar(aes(ymin = lw_odds, ymax = up_odds), width = .2)+
  coord_flip()+
  geom_hline(yintercept = 1, color  = "red", linetype = "dashed", linewidth = 1)+
  theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        axis.text = element_text(size = 12),
        axis.title = element_text(size = 15),
        axis.title.y = element_blank(),
        title = element_text(size = 15))+
    ggtitle(label = unique(results$common_name)[i])

ggsave(
    filename = paste("C:/Users/jenrogers/Documents/git/FreshwaterBio/FreshwaterBio/tmpfigures/mussel_log_odd_plots_multivariate/", unique(results$common_name)[i],  ".png", sep = ""),
    plot = last_plot(),
    width = 14,
    height = 9,
    units = "cm",
    dpi = 200)

print(i)
}







# #####without host
# 
# 
# #### Rare spp 
# 
# dat_rare <- dat %>% 
#   filter(common_name %in% c("dwarf wedgemussel", "tidewater mucket", "yellow lampmussel", "eastern pondmussel", "brook floater", "alewife floater"))
# dat2 <- dat_rare %>% 
#   filter(common_name == "alewife floater")
# n_obs <- nrow(dat2)
# permuted_rows <- sample(n_obs)
# dat2 <- dat2[permuted_rows,]
# split <- round(n_obs * 0.8)
# set.seed(32435)
# train <- dat2[1:split, ]
# test <- dat2[(split+1):n_obs, ]
# 
# 
# mdl <- glm(live_occurrence ~ 
#              lat +
#              long +
#              ElevCat +
#              CaOWs +
#              RunoffWs +
#              pollutionWs +
#              WWTPMajorDensWs +
#              KffactWs +
#              annual_mean_summer_temp + 
#              W95_HIST +
#              logMJJA_HIST + 
#              pctForest_ws +
#              PctOw_Ws +  
#              PctImp_WsRp100 +  
#              pctAg_Ws + 
#              huc12_damden_sqkm +
#              huc8_damcount,
#              data = train,
#              family = "binomial")
# 
# summary(mdl)
# saveRDS(mdl, paste("C:/Users/jenrogers/Documents/necascFreshwaterBio/model_objects/mussel_", unique(dat$common_name)[1], ".rds", sep = ""))
# 
# results <- 
#   data.frame(
#     "estimate" = summary(mdl)$coefficients[,1],
#     "std_er" = summary(mdl)$coefficients[,2],
#     "p_val" = summary(mdl)$coefficients[,4],
#     "variable" = rownames(summary(mdl)$coefficients),
#     "common_name" = "alewife floater")
# 
# 
# #use model to predict on testing data
# predict_resp <- predict(mdl, test, type = 'response') #the predicted value
# 
# 
# #compare the predicted zeros to the actual zeros
# compare <- data.frame(
#   "common_name" = test$common_name,
#   "occurrence" = factor(test$live_occurrence, levels = c(1,0)),
#   "pred_occurrence" = factor(ifelse(predict_resp > 0.1, 1, 0), levels = levels(factor(test$live_occurrence, levels = c(1,0))))
# )
# 
# 
# #validations for the predicted occurrence vs the actual occurrence
# cm <- confusionMatrix(reference = compare$occurrence, data = compare$pred_occurrence)
# 
# val_zero_prob <- data.frame(
#   "common_name" = unique(train$common_name),
#   "test_dat_pres" = nrow(test[test$live_occurrence == 1,]),
#   "test_dat_abs" = nrow(test[test$live_occurrence == 0,]),
#   "train_dat_pres" = nrow(train[train$live_occurrence == 1, ]),
#   "train_dat_abs" = nrow(train[train$live_occurrence == 0, ]),
#   "accuracy" = cm$overall[1],
#   "sensitivity" = cm$byClass[1],
#   "Specificity" = cm$byClass[2],
#   "Pos Pred Value" = cm$byClass[3],
#   "Neg Pred Value" = cm$byClass[4]
# )
# 
# 
# 
# 
# for (i in 2:length(unique(dat_rare$common_name))) {
#  
# dat2 <- dat_rare %>% 
# filter(common_name == unique(dat_rare$common_name)[i])
# n_obs <- nrow(dat2)
# permuted_rows <- sample(n_obs)
# dat2 <- dat2[permuted_rows,]
# split <- round(n_obs * 0.8)
# set.seed(32435)
# train <- dat2[1:split, ]
# test <- dat2[(split+1):n_obs, ]
#   
#  
# mdl <- glm(live_occurrence ~ 
#              lat +
#              long +
#              ElevCat +
#              CaOWs +
#              RunoffWs +
#              pollutionWs +
#              WWTPMajorDensWs +
#              KffactWs +
#              annual_mean_summer_temp + 
#              W95_HIST +
#              logMJJA_HIST + 
#              pctForest_ws +
#              PctOw_Ws +  
#              PctImp_WsRp100 +  
#              pctAg_Ws + 
#              huc12_damden_sqkm +
#              huc8_damcount,
#              data = train,
#              family = "binomial")
# 
# summary(mdl)
# saveRDS(mdl, paste("C:/Users/jenrogers/Documents/necascFreshwaterBio/model_objects/mussel_", unique(dat$common_name)[i], ".rds", sep = ""))
# 
# results2 <- 
#   data.frame(
#     "estimate" = summary(mdl)$coefficients[,1],
#     "std_er" = summary(mdl)$coefficients[,2],
#     "p_val" = summary(mdl)$coefficients[,4],
#     "variable" = rownames(summary(mdl)$coefficients),
#     "common_name" = unique(dat$common_name)[i]) 
# 
# results <- rbind(results, results2)
# 
# 
# #use model to predict on testing data
# predict_resp <- predict(mdl, test, type = 'response') #the predicted value
# 
# 
# #compare the predicted zeros to the actual zeros
# compare <- data.frame(
#   "common_name" = test$common_name,
#   "occurrence" = factor(test$live_occurrence, levels = c(1,0)),
#   "pred_occurrence" = factor(ifelse(predict_resp > 0.1, 1, 0), levels = levels(factor(test$live_occurrence, levels = c(1,0))))
# )
# 
# 
# #validations for the predicted occurrence vs the actual occurrence
# cm <- confusionMatrix(reference = compare$occurrence, data = compare$pred_occurrence)
# 
# val2 <- data.frame(
#   "common_name" = unique(train$common_name),
#   "test_dat_pres" = nrow(test[test$live_occurrence == 1,]),
#   "test_dat_abs" = nrow(test[test$live_occurrence == 0,]),
#   "train_dat_pres" = nrow(train[train$live_occurrence == 1, ]),
#   "train_dat_abs" = nrow(train[train$live_occurrence == 0, ]),
#   "accuracy" = cm$overall[1],
#   "sensitivity" = cm$byClass[1],
#   "Specificity" = cm$byClass[2],
#   "Pos Pred Value" = cm$byClass[3],
#   "Neg Pred Value" = cm$byClass[4]
# )
# 
# val_zero_prob <- rbind(val_zero_prob, val2)
# 
# print(unique(dat_rare$common_name)[i])
#   
#   
# 
#  
# }
# 
# 
# 
# 
# 
# 
# 
# 
# 
# #common spp
# 
# #set aside 20% for validation and put 80% into the calibration dataset
# dat_common <- dat %>% 
#   filter(!common_name %in% c("brook floater", "alewife floater", "dwarf wedgemussel", "tidewater mucket", "yellow lampmussel", "eastern pondmussel"))
# dat2 <- dat_common %>% 
#   filter(common_name == "creeper")
# n_obs <- nrow(dat2)
# permuted_rows <- sample(n_obs)
# dat2 <- dat2[permuted_rows,]
# split <- round(n_obs * 0.8)
# set.seed(32435)
# train <- dat2[1:split, ]
# test <- dat2[(split+1):n_obs, ]
# 
# 
# mdl <- glm(live_occurrence ~ 
#              lat +
#              long +
#              ElevCat +
#              CaOWs +
#              RunoffWs +
#              pollutionWs +
#              WWTPMajorDensWs +
#              KffactWs +
#              annual_mean_summer_temp + 
#              W95_HIST +
#              logMJJA_HIST + 
#              pctForest_ws +
#              PctOw_Ws +  
#              PctImp_WsRp100 +  
#              pctAg_Ws + 
#              huc12_damden_sqkm +
#              huc8_damcount,
#              data = train,
#              family = "binomial")
# 
# summary(mdl)
# saveRDS(mdl, paste("C:/Users/jenrogers/Documents/necascFreshwaterBio/model_objects/mussel_", unique(dat$common_name)[1], ".rds", sep = ""))
# 
# results <- 
#   data.frame(
#     "estimate" = summary(mdl)$coefficients[,1],
#     "std_er" = summary(mdl)$coefficients[,2],
#     "p_val" = summary(mdl)$coefficients[,4],
#     "variable" = rownames(summary(mdl)$coefficients),
#     "common_name" = "alewife floater")
# 
# 
# #use model to predict on testing data
# predict_resp <- predict(mdl, test, type = 'response') #the predicted value
# 
# 
# #compare the predicted zeros to the actual zeros
# compare <- data.frame(
#   "common_name" = test$common_name,
#   "occurrence" = factor(test$live_occurrence, levels = c(1,0)),
#   "pred_occurrence" = factor(ifelse(predict_resp > 0.5, 1, 0), levels = levels(factor(test$live_occurrence, levels = c(1,0))))
# )
# 
# 
# #validations for the predicted occurrence vs the actual occurrence
# cm <- confusionMatrix(reference = compare$occurrence, data = compare$pred_occurrence)
# 
# val_zero_prob_common <- data.frame(
#   "common_name" = unique(train$common_name),
#   "test_dat_pres" = nrow(test[test$live_occurrence == 1,]),
#   "test_dat_abs" = nrow(test[test$live_occurrence == 0,]),
#   "train_dat_pres" = nrow(train[train$live_occurrence == 1, ]),
#   "train_dat_abs" = nrow(train[train$live_occurrence == 0, ]),
#   "accuracy" = cm$overall[1],
#   "sensitivity" = cm$byClass[1],
#   "Specificity" = cm$byClass[2],
#   "Pos Pred Value" = cm$byClass[3],
#   "Neg Pred Value" = cm$byClass[4]
# )
# 
# 
# 
# 
# for (i in 2:length(unique(dat_common$common_name))) {
#  
# dat2 <- dat_common %>% 
# filter(common_name == unique(dat_common$common_name)[i])
# n_obs <- nrow(dat2)
# permuted_rows <- sample(n_obs)
# dat2 <- dat2[permuted_rows,]
# split <- round(n_obs * 0.8)
# set.seed(32435)
# train <- dat2[1:split, ]
# test <- dat2[(split+1):n_obs, ]
#   
#  
# mdl <- glm(live_occurrence ~ 
#              lat +
#              long +
#              ElevCat +
#              CaOWs +
#              RunoffWs +
#              pollutionWs +
#              WWTPMajorDensWs +
#              KffactWs +
#              annual_mean_summer_temp + 
#              W95_HIST +
#              logMJJA_HIST + 
#              pctForest_ws +
#              PctOw_Ws +  
#              PctImp_WsRp100 +  
#              pctAg_Ws + 
#              huc12_damden_sqkm +
#              huc8_damcount,
#              data = train,
#              family = "binomial")
# 
# summary(mdl)
# saveRDS(mdl, paste("C:/Users/jenrogers/Documents/necascFreshwaterBio/model_objects/mussel_", unique(dat_common$common_name)[i], ".rds", sep = ""))
# 
# results2 <- 
#   data.frame(
#     "estimate" = summary(mdl)$coefficients[,1],
#     "std_er" = summary(mdl)$coefficients[,2],
#     "p_val" = summary(mdl)$coefficients[,4],
#     "variable" = rownames(summary(mdl)$coefficients),
#     "common_name" = unique(dat_common$common_name)[i]) 
# 
# results <- rbind(results, results2)
# 
# 
# #use model to predict on testing data
# predict_resp <- predict(mdl, test, type = 'response') #the predicted value
# 
# 
# #compare the predicted zeros to the actual zeros
# compare <- data.frame(
#   "common_name" = test$common_name,
#   "occurrence" = factor(test$live_occurrence, levels = c(1,0)),
#   "pred_occurrence" = factor(ifelse(predict_resp > 0.5, 1, 0), levels = levels(factor(test$live_occurrence, levels = c(1,0))))
# )
# 
# 
# #validations for the predicted occurrence vs the actual occurrence
# cm <- confusionMatrix(reference = compare$occurrence, data = compare$pred_occurrence)
# 
# val2 <- data.frame(
#   "common_name" = unique(train$common_name),
#   "test_dat_pres" = nrow(test[test$live_occurrence == 1,]),
#   "test_dat_abs" = nrow(test[test$live_occurrence == 0,]),
#   "train_dat_pres" = nrow(train[train$live_occurrence == 1, ]),
#   "train_dat_abs" = nrow(train[train$live_occurrence == 0, ]),
#   "accuracy" = cm$overall[1],
#   "sensitivity" = cm$byClass[1],
#   "Specificity" = cm$byClass[2],
#   "Pos Pred Value" = cm$byClass[3],
#   "Neg Pred Value" = cm$byClass[4]
# )
# 
# val_zero_prob_common <- rbind(val_zero_prob_common, val2)
# 
# print(unique(dat_common$common_name)[i])
#   
#   
# 
#  
# }
# 
# 
# val_zero_prob <- rbind(val_zero_prob, val_zero_prob_common)
# 
# withouthost <- val_zero_prob
# write.csv(withouthost, file = "tmpfigures/val_zero_prob_without_host.csv")
# 
# 
# #compare with and without host fish in the  model
# final <- left_join(withhost, withouthost, by = "common_name")
# final <- final %>% 
#   select("common_name", "test_dat_pres.x",  "test_dat_abs.x",  "train_dat_pres.x", "train_dat_abs.x",
#          "sensitivity.x", "sensitivity.y", "Specificity.x", "Specificity.y") %>% 
#   rename(test_dat_pres = "test_dat_pres.x",  
#          test_dat_abs = "test_dat_abs.x",  
#          train_dat_pres = "train_dat_pres.x", 
#          train_dat_abs = "train_dat_abs.x",
#          sen_with_host =  "sensitivity.x",
#          sen_without_host = "sensitivity.y",
#          spe_with_host = "Specificity.x",
#          spe_without_host = "Specificity.y")


#experimented with Random Forest
# rf <- randomForest(as.factor(live_occurrence) ~ 
#                         lat +
#                         long +
#                         ElevCat +
#                         CaOWs +
#                         RunoffWs +
#                         pollutionWs +
#                         WWTPMajorDensWs +
#                         KffactWs +
#                         annual_mean_summer_temp + 
#                         W95_HIST +
#                         logMJJA_HIST + 
#                         pctForest_ws +
#                        PctOw_Ws +  
#                         PctImp_WsRp100 +  
#                         pctAg_Ws + 
#                         huc12_damden_sqkm +
#                         huc8_damcount + Percidae,
#                     data = dat2)
#  rf
# 

rownames(results) <- NULL

results <- results %>% 
  mutate(CIlow = estimate - (1.96*std_er),
         CIhigh = estimate + (1.96*std_er),
         OR = exp(estimate),
         ORCIlow = exp(CIlow),
         ORCIhigh = exp(CIhigh)) %>% 
  arrange(OR) %>% 
  filter(variable != "(Intercept)")

```




Part 3: Species richness and shannon index

```{r}


#calcuate species richness by HUC10, HUC8, and then beta (huc10/HUC8)

#join mussel_occurrence data to the mussel event huc join so that we can get presence and absence by huc10
occ <- left_join(mussel_occurrence, mussel_event_huc_join, by = "UID")
occ <- left_join(occ, mussel_count_with_zeros, by = c("UID", "common_name", "scientific_name"))
names(occ)
occ <- occ %>% 
  select(UID, common_name, scientific_name, live_occurrence, shell_occurrence, live_count, shell_count, 6:20)
names(occ)
#there are tons of rows with NA for all the HUC information - this is because we removed all the lentic surveys from the mussel_event_huc_join data file, but those are still
#present in the mussel_occurrence data file.
occ <- occ %>% 
  filter(!is.na(huc10_name)) 


huc10_richness <- occ %>% 
  select(common_name, scientific_name, live_occurrence, huc10_name, huc10_tnmid, huc8_name) %>% 
  unique() %>% 
  group_by(huc10_tnmid, huc10_name, huc8_name) %>% 
  summarise(alpha_richness = sum(live_occurrence, na.rm = T))
  
huc8_richness <- occ %>% 
  select(common_name, scientific_name, live_occurrence, huc8_name, huc8_tnmid) %>% 
  unique() %>% 
  group_by(huc8_tnmid, huc8_name) %>% 
  summarise(gamma_richness = sum(live_occurrence, na.rm = T))

richness <- left_join(huc8_richness, huc10_richness, by = "huc8_name") %>% 
  mutate(beta_richness = alpha_richness / gamma_richness)




#calculate shannon weiner by huc10



#need to get the number of surveys in each HUC so we can divide abundance by the number of surveys
surveycounts <- left_join(mussel_count_with_zeros, 
                          mussel_event_huc_join, 
                          by = "UID") %>% 
   select(UID, huc10_name, huc10_tnmid) %>% 
   unique() %>% 
   group_by(huc10_name, huc10_tnmid) %>% 
   summarise(suveynum = n())



shannon1 <- mussel_count_with_zeros %>% 
  filter(live_count>0,
         !is.na(live_count),
         !is.na(common_name))

#count of each spp by huc
shannon <- left_join(mussel_event_huc_join, shannon1, by = "UID") %>%
  data.frame() %>% 
  filter(!is.na(live_count),
         !is.na(common_name)) %>% 
  group_by(huc10_name, huc10_tnmid, common_name) %>% 
  summarise(n = sum(live_count)) %>% 
  data.frame()

shannon <- left_join(shannon, surveycounts, by = c("huc10_tnmid", "huc10_name")) %>% 
  mutate(n1 = n/suveynum)

#Total sum of all counts of all spp
shannon2 <- left_join(mussel_event_huc_join, shannon1, by = "UID") %>%
  data.frame() %>% 
  filter(!is.na(live_count),
         !is.na(common_name)) %>% 
  group_by(huc10_name, huc10_tnmid)%>% 
  summarise(N = sum(live_count)) %>% 
  data.frame()

shannon2 <- left_join(shannon2, surveycounts, by = c("huc10_tnmid", "huc10_name")) %>% 
  mutate(N1 = N/suveynum)

shannon3 <- left_join(shannon, shannon2, by = c("huc10_tnmid", "huc10_name")) %>% 
  mutate(tmp = n1/N1,
         tmp2 = log(tmp),
         tmp3 = tmp * tmp2) %>% 
  group_by(huc10_name, huc10_tnmid) %>% 
  summarise(shannonwiener = -(sum(tmp3)))


huc10 <- huc10 %>% 
  filter(States != "CN")

dat <- left_join(huc10, shannon3, by = c("Name" = "huc10_name"))

hist(dat$shannonwiener)

dat$shannonwiener <- as.numeric(dat$shannonwiener)

ggplot()+
  geom_sf(data = dat, lwd = 0.2,
          aes(fill = shannonwiener))+
  scale_fill_gradient2(low = "red",
  mid = "white",
  high = "blue",
  midpoint = mean(dat$shannonwiener, na.rm = T))+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
          axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks = element_blank())+
    labs(title = "Shannon Wiener (H`), huc10 scale",
    fill = "H`")+
  geom_sf(data = states, fill = NA, lwd = 0.25, color = "black")+
  geom_sf(data = huc8, fill = NA, lwd = 0.25, color = "black")








#join occurrence data by huc10 to the covariate dataset for the model
#remove all repeated rows of huc10 covariates
mussel_covariates <- mussel_covariates_huc10 %>% 
  data.frame() %>% 
  select(-c(UID, state, date, project, source, waterbody, waterbody2,
            huc8_tnmid, huc8_areasqkm, huc8_name,
            huc12_tnmid, huc12_areasqkm,huc12_name,
            geometry)) %>% 
  unique()


dat <- left_join(richness, mussel_covariates, by = c("huc10_name", "huc10_tnmid"))
dat2 <- left_join(shannon3, mussel_covariates, by = c("huc10_name", "huc10_tnmid"))

names(richness)
names(shannon3)





#glm model for spp richness by HUC10
#logistic regression model for mussel occurrence



mdl <- glm(alpha_richness ~ 
             lat +
             long +
             ElevCat +
             CaOWs +
             RunoffWs +
             pollutionWs +
             WWTPMajorDensWs +
             KffactWs +
             annual_mean_summer_temp + 
             W95_HIST +
             logMJJA_HIST + 
             pctForest_ws +
             PctOw_Ws +  
             PctImp_WsRp100 +  
             pctAg_Ws + 
             huc12_damden_sqkm +
             huc8_damcount,
             data = dat,
             family = "poisson")

summary(mdl)
saveRDS(mdl, "C:/Users/jenrogers/Documents/necascFreshwaterBio/model_objects/mussel_alpharichness.rds")





dat$beta_richness[dat$beta_richness == 1] <- 0.99
dat$beta_richness[dat$beta_richness == 0] <- 0.01

mdl <- glm(beta_richness ~ 
             lat +
             long +
             ElevCat +
             CaOWs +
             RunoffWs +
             pollutionWs +
             WWTPMajorDensWs +
             KffactWs +
             annual_mean_summer_temp + 
             W95_HIST +
             logMJJA_HIST + 
             pctForest_ws +
             PctOw_Ws +  
             PctImp_WsRp100 +  
             pctAg_Ws + 
             huc12_damden_sqkm +
             huc8_damcount,
             data = dat,
             family = beta_family())

summary(mdl)
saveRDS(mdl, "C:/Users/jenrogers/Documents/necascFreshwaterBio/model_objects/mussel_alpharichness.rds")



#glm model for shannon weiner by HUC10

mdl <- lm(shannonwiener ~ 
             lat +
             long +
             ElevCat +
             CaOWs +
             RunoffWs +
             pollutionWs +
             WWTPMajorDensWs +
             KffactWs +
             annual_mean_summer_temp + 
             W95_HIST +
             logMJJA_HIST + 
             pctForest_ws +
             PctOw_Ws +  
             PctImp_WsRp100 +  
             pctAg_Ws + 
             huc12_damden_sqkm +
             huc8_damcount,
             data = dat2)

summary(mdl)




```




Part 4: multinomial logistic regression model to predict proportional abundance of mussel traits

```{r}


#attribute mussel occurrence by trait
#drought tolerance: https://doi.org/10.1002/aqc.3884
####Body size, 
####physiological temperature tolerance  
#####life history strategy


#join mussel_occurrence data to the mussel event huc join so that we can get proportional abundance of each trait by huc10




#join occurrence data by huc10 to the covariate dataset for the model




#remove all repeated rows of huc10 covariates




#multinomial logistc regression model of proportional abundance of each trait



```