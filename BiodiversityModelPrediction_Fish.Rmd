---
title: "Biodiversity Model Prediction"
author: "Jenny Rogers"
date: "2022-12-07"
output: html_document
---



```{r}

library(tidyverse)
library(sf)
library(glmmTMB)
library(readxl)



```

proportional abundance predictions
```{r}

load(file = "C:/Users/jenrogers/Documents/necascFreshwaterBio/model_datafiles/NHDplusV2_NewEngCrop_covariates.RData")


file.list <- list.files("C:/Users/jenrogers/Documents/necascFreshwaterBio/model_objects")


for (i in 1:57) { 
  
  
   mdl <- readRDS(paste("C:/Users/jenrogers/Documents/necascFreshwaterBio/model_objects/", file.list[i], sep = ""))
  
  NHDplusV2_NewEngCrop$baseline_predict <- predict(mdl, newdata = NHDplusV2_NewEngCrop, type = "response")
  
ggplot(data = NHDplusV2_NewEngCrop)+
  geom_sf(aes(color = baseline_predict))+
  scale_color_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = 0.5)
  
}


#stream reach scale spp proportional abuncnae

#predict the model on the historical data
pred_data <- dat[,11:42]
predict <- predict(mdl, newdata = pred_data, type = "response")
compare <- data.frame("propabun" = dat$propabun, "prediction" = predict)



#plot
dat$prediction <- compare$prediction
tmp <- left_join(fish_shp, dat, by ="UID") %>% 
  mutate(pres = as.factor(ifelse(prediction > 0.1, 1, 0)))
ggplot(data = tmp[!is.na(tmp$prediction),])+
  geom_sf(aes(fill=pres, size = prediction), pch = 21, col = "black")

ggplot(data = tmp[!is.na(tmp$prediction),])+
  geom_sf(aes(fill= prediction, size = prediction), pch = 21, col = "black")

#predict the model on all of the flows lines, not just the training data 



```

Predict presence absence of each fish in baseline years

```{r}

load(file = "C:/Users/jenrogers/Documents/necascFreshwaterBio/model_datafiles/NHDplusV2_NewEngCrop_covariates.RData")

#need to scal the variavles
test <- NHDplusV2_NewEngCrop %>% 
  data.frame() %>% 
  select(-geometry)

test <- test[,c(7:8, 10:39)]

#we need to scale these variables, but first I will calucate the mean and sd of each column, bc we will need to use these values to scale these variables in the predicted scenarios

means <- sapply(test, mean, na.rm = T)
save(means, file = "C:/Users/jenrogers/Documents/necascFreshwaterBio/model_datafiles/fishcovariates_scaling_mean.RData")
sd <- sapply(test, sd, na.rm = T)
save(sd, file = "C:/Users/jenrogers/Documents/necascFreshwaterBio/model_datafiles/fishcovariates_scaling_sd.RData")

#scale data
test <- data.frame(scale(test))

NHDplusV2_NewEngCrop <- cbind((NHDplusV2_NewEngCrop)[,c(1:6, 9)], test)





file.list <- list.files("C:/Users/jenrogers/Documents/necascFreshwaterBio/model_objects", pattern = "pres_")

i <- 1

mdl <- readRDS(paste("C:/Users/jenrogers/Documents/necascFreshwaterBio/model_objects/", file.list[i], sep = ""))
  
predictions <- data.frame("test" = predict(mdl, newdata = NHDplusV2_NewEngCrop, type = "response"))
names(predictions)[1] <- file.list[i]




for (i in 2:57) { 
  
  
   mdl <- readRDS(paste("C:/Users/jenrogers/Documents/necascFreshwaterBio/model_objects/", file.list[i], sep = ""))
  
  tmp <- data.frame("test" = predict(mdl, newdata = NHDplusV2_NewEngCrop, type = "response"))
  names(tmp)[1] <- file.list[i]
  
  predictions <- cbind(predictions, tmp)
  
  
}


#join the predictions to the list of comids
NHDplusV2_NewEngCrop_baseline <- cbind(NHDplusV2_NewEngCrop, predictions)

#sample plot
ggplot(data = NHDplusV2_NewEngCrop_baseline)+
  geom_sf(aes(color = pres_creek.chub.rds))+
  scale_color_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = 0.5)



#this calcuated the total number of HUC12s that have an average P(occurrece)>0.05 for the baseline conditions
head(NHDplusV2_NewEngCrop_baseline)
tmp_baseline <- NHDplusV2_NewEngCrop_baseline %>% 
  data.frame() %>% 
  select(huc12_tnmid, huc12_name, 40:96) %>% 
  pivot_longer(3:59, names_to = "common_name") %>% 
  group_by(huc12_tnmid, huc12_name, common_name) %>% 
  summarise(mean_prob = mean(value, na.rm = T)) %>% 
  filter(mean_prob >0.05) %>%
  ungroup() %>% 
  group_by(common_name) %>% 
  summarise(count = n(),
            avg_prob = mean(mean_prob))

#watershed shape files
huc12 <- st_read("C:/Users/jenrogers/Documents/necascFreshwaterBio/SpatialData/NHDplus/WBDHU12/WBDHU12_NE.shp")
huc12 <- huc12 %>% 
  select(name, tnmid)
#align prediction results with the unscaled covariates and make plots
load(file = "C:/Users/jenrogers/Documents/necascFreshwaterBio/model_datafiles/NHDplusV2_NewEngCrop_covariates.RData")
pred <- cbind(NHDplusV2_NewEngCrop, predictions)
pred <- pred %>%
  data.frame %>% 
  pivot_longer(40:96, values_to = "prob", names_to = "common_name") %>% 
  mutate(occurrence = ifelse(prob>0.3, 1, 0))
pred$common_name <- gsub("pres_", "", pred$common_name)
pred$common_name <- gsub(".rds", "", pred$common_name)
pred$common_name <- gsub("\\.", " ", pred$common_name)
#join to trait data so we can filter for certain temperature groups or origin
#fish traits
load("C:/Users/jenrogers/Documents/necascFreshwaterBio/model_datafiles/fish_traits.RData")
temperature <- read_xlsx("C:/Users/jenrogers/Documents/necascFreshwaterBio/spp_data/thermalpref_origin_tolerance.xlsx",
                  sheet = 1,
                  range = cell_cols("A:G")) %>% 
  pivot_longer(2:7, names_to = "state", values_to = "tmp") %>% 
  filter(!is.na(tmp),
         !tmp == "eury",
         !(common_name %in% c("american brook lamprey") & tmp == "cold"),
         !(common_name %in% c("common shiner", "white sucker", "smallmouth bass", "fallfish") & tmp == "warm")) %>% 
  select(-state) %>% 
  unique()

origin <- read_xlsx("C:/Users/jenrogers/Documents/necascFreshwaterBio/spp_data/thermalpref_origin_tolerance.xlsx",
                  sheet = 2,
                  range = cell_cols("A:G"))%>% 
  pivot_longer(2:7, names_to = "state", values_to = "origin") %>% 
  filter(!is.na(origin),
         !(common_name == "spottail shiner" & origin == "introduced"),
         !origin == "unk") %>% 
  select(-state) %>%  
  unique()

pred <- pred %>% 
  left_join(temperature, by = "common_name") %>% 
  left_join(origin, by = "common_name")

#plot cold water native species richness
coldnat <- pred %>% 
  select(huc12_name, huc12_tnmid, common_name, tmp, origin, occurrence) %>% 
  unique() %>% 
  filter(tmp == "cold" & origin == "native" & occurrence == 1) %>%
  group_by(huc12_name, huc12_tnmid) %>% 
  summarise(coldnatrichness = n())
coldnat <- left_join(huc12, coldnat, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid"))
ggplot(data = coldnat)+
  geom_sf(aes(fill = coldnatrichness, color = coldnatrichness))

#plot cool water native species richness
coolnat <- pred %>% 
  select(huc12_name, huc12_tnmid, common_name, tmp, origin, occurrence) %>% 
  unique() %>% 
  filter(tmp == "cool" & origin == "native" & occurrence == 1) %>%
  group_by(huc12_name, huc12_tnmid) %>% 
  summarise(coolnatrichness = n())
coolnat <- left_join(huc12, coolnat, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid"))
ggplot(data = coolnat)+
  geom_sf(aes(fill = coolnatrichness, color = coolnatrichness))

#plot warm water native species richness
warmnat <- pred %>% 
  select(huc12_name, huc12_tnmid, common_name, tmp, origin, occurrence) %>% 
  unique() %>% 
  filter(tmp == "warm" & origin == "native" & occurrence == 1) %>%
  group_by(huc12_name, huc12_tnmid) %>% 
  summarise(warmnatrichness = n())
warmnat <- left_join(huc12, warmnat, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid"))
ggplot(data = warmnat)+
  geom_sf(aes(fill = warmnatrichness, color = warmnatrichness))

#plot warm water nonnative species richness
warmnonnat <- pred %>% 
  select(huc12_name, huc12_tnmid, common_name, tmp, origin, occurrence) %>% 
  unique() %>% 
  filter(tmp == "warm" & origin == "introduced" & occurrence == 1) %>%
  group_by(huc12_name, huc12_tnmid) %>% 
  summarise(warmnonnatrichness = n())
warmnonnat <- left_join(huc12, warmnonnat, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid"))
ggplot(data = warmnonnat)+
  geom_sf(aes(fill = warmnonnatrichness, color = warmnonnatrichness))

#plot native species beta richness
nathuc12 <- pred %>% 
  select(huc8_name, huc8_tnmid, huc12_name, huc12_tnmid, common_name, origin, occurrence) %>% 
  unique() %>% 
  filter(origin == "native" & occurrence == 1) %>%
  group_by(huc8_name, huc8_tnmid, huc12_name, huc12_tnmid) %>% 
  summarise(nathuc12_alpharichness = n())

nathuc8 <- pred %>% 
  select(huc8_name, huc8_tnmid, common_name, origin, occurrence) %>% 
  unique() %>% 
  filter(origin == "native" & occurrence == 1) %>%
  group_by(huc8_name, huc8_tnmid) %>% 
  summarise(nathuc8_gammarichness = n())
beta <- left_join(nathuc12, nathuc8, by = c("huc8_name", "huc8_tnmid")) %>% 
  mutate(beta_richness = nathuc12_alpharichness / nathuc8_gammarichness)

beta <- left_join(huc12, beta, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid"))
ggplot(data = beta)+
  geom_sf(aes(fill = beta_richness, color = beta_richness))

#plot probability of brook trout occurrence
brktrt <- pred %>% 
  select(huc12_name, huc12_tnmid, common_name, prob) %>% 
  unique() %>% 
  filter(common_name == "brook trout") %>%
  group_by(huc12_name, huc12_tnmid) %>% 
  summarise(brktrt_prob = mean(prob, na.rm = T))
brktrt <- left_join(huc12, brktrt, by = c("name" = "huc12_name", "tnmid" = "huc12_tnmid"))
ggplot(data = brktrt)+
  geom_sf(aes(fill = brktrt_prob, color = brktrt_prob))


coldnat <- coldnat %>% 
  data.frame() %>% 
  select(-geometry)
coolnat <- coolnat %>% 
  data.frame() %>% 
  select(-geometry)
warmnat <- warmnat %>% 
  data.frame() %>% 
  select(-geometry)
warmnonnat <- warmnonnat %>% 
  data.frame() %>% 
  select(-geometry)
beta <- beta %>% 
  data.frame() %>% 
  select(-geometry)
brktrt <- brktrt %>% 
  data.frame() %>% 
  select(-geometry)

trends <- left_join(coldnat, coolnat, by = c("name", "tnmid"))
trends <- trends %>% 
  left_join(warmnat, by = c("name", "tnmid")) %>% 
  left_join(warmnonnat, by = c("name", "tnmid")) %>% 
  left_join(beta, by = c("name", "tnmid")) %>% 
  left_join(brktrt, by = c("name", "tnmid"))
              

huc12cov <- NHDplusV2_NewEngCrop %>%
  data.frame() %>% 
  select(huc12_name, huc12_tnmid, 7, 8, 10:39) %>% 
  group_by(huc12_name, huc12_tnmid) %>% 
  summarise_all(mean, na.rm = T)

trends <- left_join(trends, huc12cov, by = c("name"= "huc12_name", "tnmid" = "huc12_tnmid"))




#climate change

#load the 2080 file that has the projected stream temperature and streamflow covariate values
load("C:/Users/jenrogers/Documents/necascFreshwaterBio/model_datafiles/NHDplusV2_NewEngCrop_covariates_2080.RData")


#need to get the variables named the same as the baseline dataframe and need to order the variables in the same way so that we can scale them
test <- NHDplusV2_NewEngCrop_2080 %>% 
  data.frame() %>% 
  select(7:8, 10:39) %>% 
  rename(annual_mean_summer_temp = annual_mean_summer_temp_pls_4,
         BFI_HIST = BFI_2080,
         LO7Q1DT_HIST = LO7Q1DT_2080,
         CFM_HIST = CFM_2080,
         W95_HIST = W95_2080,
         logMJJA_HIST = logMJJA_2080) %>% 
  select(1:2, 27:31, 3:24, 32, 25:26)


#scale the variables using the means and sd used to scale the variables in the baseline condition
test <- sweep(test, 2, means, FUN = '-') 
test <- sweep(test, 2, sd, FUN = '/')  

#join the scaled variables back to 
NHDplusV2_NewEngCrop_cc <- cbind((NHDplusV2_NewEngCrop_2080)[,c(1:6, 9)], test)

#this is what I did for NAB but now we're using the actual climate change scnearios prepared above
#NHDplusV2_NewEngCrop_cc <- NHDplusV2_NewEngCrop %>% 
#  mutate(annual_mean_summer_temp = annual_mean_summer_temp + 2
#         )



file.list <- list.files("C:/Users/jenrogers/Documents/necascFreshwaterBio/model_objects", pattern = "pres_")

i <- 1

mdl <- readRDS(paste("C:/Users/jenrogers/Documents/necascFreshwaterBio/model_objects/", file.list[i], sep = ""))
  
predictions_cc <- data.frame("test" = predict(mdl, newdata = NHDplusV2_NewEngCrop_cc, type = "response"))
names(predictions_cc)[1] <- file.list[i]




for (i in 2:57) { 
  
  
   mdl <- readRDS(paste("C:/Users/jenrogers/Documents/necascFreshwaterBio/model_objects/", file.list[i], sep = ""))
  
  tmp <- data.frame("test" = predict(mdl, newdata = NHDplusV2_NewEngCrop_cc, type = "response"))
  names(tmp)[1] <- file.list[i]
  
  predictions_cc <- cbind(predictions_cc, tmp)
  
  
}


#join the predictions_cc to the list of comids
NHDplusV2_NewEngCrop_cc <- cbind(NHDplusV2_NewEngCrop_cc, predictions_cc)

#sample plot
ggplot(data = NHDplusV2_NewEngCrop_cc)+
  geom_sf(aes(color = pres_brook.trout.rds))+
  scale_color_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = 0.5)



#this calcuated the total number of HUC12s that have an average P(occurrece)>0.05 for the climate change conditions
head(NHDplusV2_NewEngCrop_cc)
tmp_cc <- NHDplusV2_NewEngCrop_cc %>% 
  data.frame() %>% 
  select(huc12_tnmid, huc12_name, 40:96) %>% 
  pivot_longer(3:59, names_to = "common_name") %>% 
  group_by(huc12_tnmid, huc12_name, common_name) %>% 
  summarise(mean_prob = mean(value, na.rm = T)) %>% 
  filter(mean_prob >0.05) %>%
  ungroup() %>% 
  group_by(common_name) %>% 
  summarise(count_cc = n(),
            avg_prob_cc = mean(mean_prob))




#climate change and connectivity reduction


#need to get the variables named the same as the baseline dataframe and need to order the variables in the same way so that we can scale them
test <- NHDplusV2_NewEngCrop_2080 %>% 
  data.frame() %>% 
  select(7:8, 10:39) %>% 
  rename(annual_mean_summer_temp = annual_mean_summer_temp_pls_4,
         BFI_HIST = BFI_2080,
         LO7Q1DT_HIST = LO7Q1DT_2080,
         CFM_HIST = CFM_2080,
         W95_HIST = W95_2080,
         logMJJA_HIST = logMJJA_2080) %>% 
  mutate(huc8_damcount = huc8_damcount * 1.5,
         huc12_damden_sqkm = huc12_damden_sqkm * 1.5,
         logRdCrsCat = logRdCrsCat * 1.5) %>% 
  select(1:2, 27:31, 3:24, 32, 25:26)


#scale the variables using the means and sd used to scale the variables in the baseline condition
test <- sweep(test, 2, means, FUN = '-') 
test <- sweep(test, 2, sd, FUN = '/')  

#join the scaled variables back to 
NHDplusV2_NewEngCrop_cc_dvlp_cnnctv <- cbind((NHDplusV2_NewEngCrop_2080)[,c(1:6, 9)], test)


#this is a scenario we used for NAB the devleopment scenario
# NHDplusV2_NewEngCrop_ccdvlp <- NHDplusV2_NewEngCrop %>% 
#   mutate(annual_mean_summer_temp = annual_mean_summer_temp + 2,
#          PctImp_Ws = PctImp_Ws+2,
#          pctAg_Ws = pctAg_Ws+2,
#          logRdCrsCat = logRdCrsCat+2,
#          huc12_damden_sqkm = huc12_damden_sqkm+2,
#          huc8_damcount = huc8_damcount+2
#          )



file.list <- list.files("C:/Users/jenrogers/Documents/necascFreshwaterBio/model_objects", pattern = "pres_")

i <- 1

mdl <- readRDS(paste("C:/Users/jenrogers/Documents/necascFreshwaterBio/model_objects/", file.list[i], sep = ""))
  
predictions_ccdvlp_cnnctv <- data.frame("test" = predict(mdl, newdata = NHDplusV2_NewEngCrop_cc_dvlp_cnnctv, type = "response"))
names(predictions_ccdvlp_cnnctv)[1] <- file.list[i]




for (i in 2:57) { 
  
  
   mdl <- readRDS(paste("C:/Users/jenrogers/Documents/necascFreshwaterBio/model_objects/", file.list[i], sep = ""))
  
  tmp <- data.frame("test" = predict(mdl, newdata = NHDplusV2_NewEngCrop_cc_dvlp_cnnctv, type = "response"))
  names(tmp)[1] <- file.list[i]
  
  predictions_ccdvlp_cnnctv <- cbind(predictions_ccdvlp_cnnctv, tmp)
  
  
}


#join the predictions_ccdvlp_cnnctv to the list of comids
NHDplusV2_NewEngCrop_cc_dvlp_cnnctv <- cbind(NHDplusV2_NewEngCrop_cc_dvlp_cnnctv, predictions_ccdvlp_cnnctv)

#sample plot
ggplot(data = NHDplusV2_NewEngCrop_cc_dvlp_cnnctv)+
  geom_sf(aes(color = pres_brook.trout.rds))+
  scale_color_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = 0.5)



#this calcuated the total number of HUC8s that have an average P(occurrece)>0.05 for the climate change and connectivity reduction conditions
head(NHDplusV2_NewEngCrop_cc_dvlp_cnnctv)
tmp_ccdvlp_cnnctv <- NHDplusV2_NewEngCrop_cc_dvlp_cnnctv %>% 
  data.frame() %>% 
  select(huc12_tnmid, huc12_name, 40:96) %>% 
  pivot_longer(3:59, names_to = "common_name") %>% 
  group_by(huc12_tnmid, huc12_name, common_name) %>% 
  summarise(mean_prob = mean(value, na.rm = T)) %>% 
  filter(mean_prob >0.05) %>%
  ungroup() %>% 
  group_by(common_name) %>% 
  summarise(count_ccdvlp_cnnctv = n(),
            avg_prob_ccdvlp_cnnctv = mean(mean_prob))



#climate change and connectivity improvements


#need to get the variables named the same as the baseline dataframe and need to order the variables in the same way so that we can scale them
test <- NHDplusV2_NewEngCrop_2080 %>% 
  data.frame() %>% 
  select(7:8, 10:39) %>% 
  rename(annual_mean_summer_temp = annual_mean_summer_temp_pls_4,
         BFI_HIST = BFI_2080,
         LO7Q1DT_HIST = LO7Q1DT_2080,
         CFM_HIST = CFM_2080,
         W95_HIST = W95_2080,
         logMJJA_HIST = logMJJA_2080) %>% 
  mutate(huc8_damcount = huc8_damcount * .75,
         huc12_damden_sqkm = huc12_damden_sqkm * .75,
         logRdCrsCat = logRdCrsCat * .75) %>% 
  select(1:2, 27:31, 3:24, 32, 25:26)


#scale the variables using the means and sd used to scale the variables in the baseline condition
test <- sweep(test, 2, means, FUN = '-') 
test <- sweep(test, 2, sd, FUN = '/')  

#join the scaled variables back to 
NHDplusV2_NewEngCrop_cc_mgmt_cnnctv <- cbind((NHDplusV2_NewEngCrop_2080)[,c(1:6, 9)], test)



file.list <- list.files("C:/Users/jenrogers/Documents/necascFreshwaterBio/model_objects", pattern = "pres_")

i <- 1

mdl <- readRDS(paste("C:/Users/jenrogers/Documents/necascFreshwaterBio/model_objects/", file.list[i], sep = ""))
  
predictions_ccmgmt_cnnctv <- data.frame("test" = predict(mdl, newdata = NHDplusV2_NewEngCrop_cc_mgmt_cnnctv, type = "response"))
names(predictions_ccmgmt_cnnctv)[1] <- file.list[i]




for (i in 2:57) { 
  
  
   mdl <- readRDS(paste("C:/Users/jenrogers/Documents/necascFreshwaterBio/model_objects/", file.list[i], sep = ""))
  
  tmp <- data.frame("test" = predict(mdl, newdata = NHDplusV2_NewEngCrop_cc_mgmt_cnnctv, type = "response"))
  names(tmp)[1] <- file.list[i]
  
  predictions_ccmgmt_cnnctv <- cbind(predictions_ccmgmt_cnnctv, tmp)
  
  
}


#join the predictions_ccmgmt_cnnctv to the list of comids
NHDplusV2_NewEngCrop_cc_mgmt_cnnctv <- cbind(NHDplusV2_NewEngCrop_cc_mgmt_cnnctv, predictions_ccmgmt_cnnctv)

#sample plot
ggplot(data = NHDplusV2_NewEngCrop_cc_mgmt_cnnctv)+
  geom_sf(aes(color = pres_brook.trout.rds))+
  scale_color_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = 0.5)



#this calcuated the total number of HUC8s that have an average P(occurrece)>0.05 for the climate change and connectivity improvement conditions
head(NHDplusV2_NewEngCrop_cc_mgmt_cnnctv)
tmp_ccmgmt_cnnctv <- NHDplusV2_NewEngCrop_cc_mgmt_cnnctv %>% 
  data.frame() %>% 
  select(huc12_tnmid, huc12_name, 40:96) %>% 
  pivot_longer(3:59, names_to = "common_name") %>% 
  group_by(huc12_tnmid, huc12_name, common_name) %>% 
  summarise(mean_prob = mean(value, na.rm = T)) %>% 
  filter(mean_prob >0.05) %>%
  ungroup() %>% 
  group_by(common_name) %>% 
  summarise(count_ccmgmt_cnnctv = n(),
            avg_prob_ccmgmt_cnnctv = mean(mean_prob))







#climate change and land cover developments (ie increase in ag and impervious)


#need to get the variables named the same as the baseline dataframe and need to order the variables in the same way so that we can scale them
test <- NHDplusV2_NewEngCrop_2080 %>% 
  data.frame() %>% 
  select(7:8, 10:39) %>% 
  rename(annual_mean_summer_temp = annual_mean_summer_temp_pls_4,
         BFI_HIST = BFI_2080,
         LO7Q1DT_HIST = LO7Q1DT_2080,
         CFM_HIST = CFM_2080,
         W95_HIST = W95_2080,
         logMJJA_HIST = logMJJA_2080) %>% 
  mutate(PctImp_Ws = PctImp_Ws * 1.5,
         pctAg_Ws = pctAg_Ws * 1.5) %>% 
  select(1:2, 27:31, 3:24, 32, 25:26)


#scale the variables using the means and sd used to scale the variables in the baseline condition
test <- sweep(test, 2, means, FUN = '-') 
test <- sweep(test, 2, sd, FUN = '/')  

#join the scaled variables back to 
NHDplusV2_NewEngCrop_cc_dvlp_cvr <- cbind((NHDplusV2_NewEngCrop_2080)[,c(1:6, 9)], test)



file.list <- list.files("C:/Users/jenrogers/Documents/necascFreshwaterBio/model_objects", pattern = "pres_")

i <- 1

mdl <- readRDS(paste("C:/Users/jenrogers/Documents/necascFreshwaterBio/model_objects/", file.list[i], sep = ""))
  
predictions_ccdvlp_cvr <- data.frame("test" = predict(mdl, newdata = NHDplusV2_NewEngCrop_cc_dvlp_cvr, type = "response"))
names(predictions_ccdvlp_cvr)[1] <- file.list[i]




for (i in 2:57) { 
  
  
   mdl <- readRDS(paste("C:/Users/jenrogers/Documents/necascFreshwaterBio/model_objects/", file.list[i], sep = ""))
  
  tmp <- data.frame("test" = predict(mdl, newdata = NHDplusV2_NewEngCrop_cc_dvlp_cvr, type = "response"))
  names(tmp)[1] <- file.list[i]
  
  predictions_ccdvlp_cvr <- cbind(predictions_ccdvlp_cvr, tmp)
  
  
}


#join the predictions_ccdvlp_cvr to the list of comids
NHDplusV2_NewEngCrop_cc_dvlp_cvr <- cbind(NHDplusV2_NewEngCrop_cc_dvlp_cvr, predictions_ccdvlp_cvr)

#sample plot
ggplot(data = NHDplusV2_NewEngCrop_cc_dvlp_cvr)+
  geom_sf(aes(color = pres_brook.trout.rds))+
  scale_color_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = 0.5)



#this calcuated the total number of HUC8s that have an average P(occurrece)>0.05 for the climate change and increased ag and impervious
head(NHDplusV2_NewEngCrop_cc_dvlp_cvr)
tmp_ccdvlp_cvr <- NHDplusV2_NewEngCrop_cc_dvlp_cvr %>% 
  data.frame() %>% 
  select(huc12_tnmid, huc12_name, 40:96) %>% 
  pivot_longer(3:59, names_to = "common_name") %>% 
  group_by(huc12_tnmid, huc12_name, common_name) %>% 
  summarise(mean_prob = mean(value, na.rm = T)) %>% 
  filter(mean_prob >0.05) %>%
  ungroup() %>% 
  group_by(common_name) %>% 
  summarise(count_ccdvlp_cvr = n(),
            avg_prob_ccdvlp_cvr = mean(mean_prob))




#climate change and land cover improvements (ie reduced  ag and impervious)


#need to get the variables named the same as the baseline dataframe and need to order the variables in the same way so that we can scale them
test <- NHDplusV2_NewEngCrop_2080 %>% 
  data.frame() %>% 
  select(7:8, 10:39) %>% 
  rename(annual_mean_summer_temp = annual_mean_summer_temp_pls_4,
         BFI_HIST = BFI_2080,
         LO7Q1DT_HIST = LO7Q1DT_2080,
         CFM_HIST = CFM_2080,
         W95_HIST = W95_2080,
         logMJJA_HIST = logMJJA_2080) %>% 
  mutate(PctImp_Ws = PctImp_Ws * .75,
         pctAg_Ws = pctAg_Ws * .75) %>% 
  select(1:2, 27:31, 3:24, 32, 25:26)


#scale the variables using the means and sd used to scale the variables in the baseline condition
test <- sweep(test, 2, means, FUN = '-') 
test <- sweep(test, 2, sd, FUN = '/')  

#join the scaled variables back to 
NHDplusV2_NewEngCrop_cc_mgmt_cvr <- cbind((NHDplusV2_NewEngCrop_2080)[,c(1:6, 9)], test)



file.list <- list.files("C:/Users/jenrogers/Documents/necascFreshwaterBio/model_objects", pattern = "pres_")

i <- 1

mdl <- readRDS(paste("C:/Users/jenrogers/Documents/necascFreshwaterBio/model_objects/", file.list[i], sep = ""))
  
predictions_ccmgmt_cvr <- data.frame("test" = predict(mdl, newdata = NHDplusV2_NewEngCrop_cc_mgmt_cvr, type = "response"))
names(predictions_ccmgmt_cvr)[1] <- file.list[i]




for (i in 2:57) { 
  
  
   mdl <- readRDS(paste("C:/Users/jenrogers/Documents/necascFreshwaterBio/model_objects/", file.list[i], sep = ""))
  
  tmp <- data.frame("test" = predict(mdl, newdata = NHDplusV2_NewEngCrop_cc_mgmt_cvr, type = "response"))
  names(tmp)[1] <- file.list[i]
  
  predictions_ccmgmt_cvr <- cbind(predictions_ccmgmt_cvr, tmp)
  
  
}


#join the predictions_ccmgmt_cvr to the list of comids
NHDplusV2_NewEngCrop_cc_mgmt_cvr <- cbind(NHDplusV2_NewEngCrop_cc_mgmt_cvr, predictions_ccmgmt_cvr)

#sample plot
ggplot(data = NHDplusV2_NewEngCrop_cc_mgmt_cvr)+
  geom_sf(aes(color = pres_brook.trout.rds))+
  scale_color_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = 0.5)



#this calcuated the total number of HUC8s that have an average P(occurrece)>0.05 for the climate change and reduced ag and impervious
head(NHDplusV2_NewEngCrop_cc_mgmt_cvr)
tmp_ccmgmt_cvr <- NHDplusV2_NewEngCrop_cc_mgmt_cvr %>% 
  data.frame() %>% 
  select(huc12_tnmid, huc12_name, 40:96) %>% 
  pivot_longer(3:59, names_to = "common_name") %>% 
  group_by(huc12_tnmid, huc12_name, common_name) %>% 
  summarise(mean_prob = mean(value, na.rm = T)) %>% 
  filter(mean_prob >0.05) %>%
  ungroup() %>% 
  group_by(common_name) %>% 
  summarise(count_ccmgmt_cvr = n(),
            avg_prob_ccmgmt_cvr = mean(mean_prob))









#climate change and Development

NHDplusV2_NewEngCrop_ccdvlp <- NHDplusV2_NewEngCrop %>% 
  mutate(annual_mean_summer_temp = annual_mean_summer_temp + 2,
         PctImp_Ws = PctImp_Ws+2,
         pctAg_Ws = pctAg_Ws+2,
         logRdCrsCat = logRdCrsCat+2,
         huc12_damden_sqkm = huc12_damden_sqkm+2,
         huc8_damcount = huc8_damcount+2
         )



file.list <- list.files("C:/Users/jenrogers/Documents/necascFreshwaterBio/model_objects", pattern = "pres_")

i <- 1

mdl <- readRDS(paste("C:/Users/jenrogers/Documents/necascFreshwaterBio/model_objects/", file.list[i], sep = ""))
  
predictions_ccdvlp <- data.frame("test" = predict(mdl, newdata = NHDplusV2_NewEngCrop_ccdvlp, type = "response"))
names(predictions_ccdvlp)[1] <- file.list[i]




for (i in 2:57) { 
  
  
   mdl <- readRDS(paste("C:/Users/jenrogers/Documents/necascFreshwaterBio/model_objects/", file.list[i], sep = ""))
  
  tmp <- data.frame("test" = predict(mdl, newdata = NHDplusV2_NewEngCrop_ccdvlp, type = "response"))
  names(tmp)[1] <- file.list[i]
  
  predictions_ccdvlp <- cbind(predictions_ccdvlp, tmp)
  
  
}


#join the predictions_ccdvlp to the list of comids
NHDplusV2_NewEngCrop_ccdvlp <- cbind(NHDplusV2_NewEngCrop_ccdvlp, predictions_ccdvlp)

#sample plot
ggplot(data = NHDplusV2_NewEngCrop_ccdvlp)+
  geom_sf(aes(color = pres_brook.trout.rds))+
  scale_color_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = 0.5)



#this calcuated the total number of HUC8s that have an average P(occurrece)>0.05 for the mgmt conditions
head(NHDplusV2_NewEngCrop_ccdvlp)
tmp_ccdvlp <- NHDplusV2_NewEngCrop_ccdvlp %>% 
  data.frame() %>% 
  select(huc12_tnmid, huc12_name, 40:96) %>% 
  pivot_longer(3:59, names_to = "common_name") %>% 
  group_by(huc12_tnmid, huc12_name, common_name) %>% 
  summarise(mean_prob = mean(value, na.rm = T)) %>% 
  filter(mean_prob >0.05) %>%
  ungroup() %>% 
  group_by(common_name) %>% 
  summarise(count_ccdvlp = n(),
            avg_prob_ccdvlp = mean(mean_prob))







#climate change and management

NHDplusV2_NewEngCrop_ccmgmt <- NHDplusV2_NewEngCrop %>% 
  mutate(annual_mean_summer_temp = annual_mean_summer_temp + 2,
         PctImp_Ws = PctImp_Ws-2,
         pctAg_Ws = pctAg_Ws-2,
         logRdCrsCat = logRdCrsCat-2,
         huc12_damden_sqkm = huc12_damden_sqkm-2,
         huc8_damcount = huc8_damcount-2
         )



file.list <- list.files("C:/Users/jenrogers/Documents/necascFreshwaterBio/model_objects", pattern = "pres_")

i <- 1

mdl <- readRDS(paste("C:/Users/jenrogers/Documents/necascFreshwaterBio/model_objects/", file.list[i], sep = ""))
  
predictions_ccmgmt <- data.frame("test" = predict(mdl, newdata = NHDplusV2_NewEngCrop_ccmgmt, type = "response"))
names(predictions_ccmgmt)[1] <- file.list[i]




for (i in 2:57) { 
  
  
   mdl <- readRDS(paste("C:/Users/jenrogers/Documents/necascFreshwaterBio/model_objects/", file.list[i], sep = ""))
  
  tmp <- data.frame("test" = predict(mdl, newdata = NHDplusV2_NewEngCrop_ccmgmt, type = "response"))
  names(tmp)[1] <- file.list[i]
  
  predictions_ccmgmt <- cbind(predictions_ccmgmt, tmp)
  
  
}


#join the predictions_ccmgmt to the list of comids
NHDplusV2_NewEngCrop_ccmgmt <- cbind(NHDplusV2_NewEngCrop_ccmgmt, predictions_ccmgmt)

#sample plot
ggplot(data = NHDplusV2_NewEngCrop_ccmgmt)+
  geom_sf(aes(color = pres_brook.trout.rds))+
  scale_color_gradient2(low = "blue",
                        mid = "yellow",
                        high = "red",
                        midpoint = 0.5)



#this calcuated the total number of HUC8s that have an average P(occurrece)>0.05 for the mgmt conditions
head(NHDplusV2_NewEngCrop_ccmgmt)
tmp_ccmgmt <- NHDplusV2_NewEngCrop_ccmgmt %>% 
  data.frame() %>% 
  select(huc12_tnmid, huc12_name, 40:96) %>% 
  pivot_longer(3:59, names_to = "common_name") %>% 
  group_by(huc12_tnmid, huc12_name, common_name) %>% 
  summarise(mean_prob = mean(value, na.rm = T)) %>% 
  filter(mean_prob >0.05) %>%
  ungroup() %>% 
  group_by(common_name) %>% 
  summarise(count_ccmgmt = n(),
            avg_prob_ccmgmt = mean(mean_prob))










compare <- full_join(tmp_baseline, tmp_cc, by  = "common_name")

compare <- full_join(compare, tmp_ccdvlp, by  = "common_name")

compare <- full_join(compare, tmp_ccmgmt, by  = "common_name")


names(compare)

compare <- compare %>% 
  mutate(base_ccmgmt = round(((count_ccmgmt - count)/count*100),0),
         base_ccdvlp = round(((count_ccdvlp - count )/count*100),0),
         base_cc = round(((count_cc - count)/count*100),0),
         basep_ccmgmtp = round(((avg_prob_ccmgmt - avg_prob)/avg_prob*100),0),
         basep_ccdvlpp = round(((avg_prob_ccdvlp - avg_prob)/avg_prob*100),0),
         basep_ccp = round(((avg_prob_cc - avg_prob)/avg_prob*100),0))

compare$common_name <- gsub(".rds", "", compare$common_name)

compare$common_name <- gsub("pres_", "", compare$common_name)

compare$common_name <- gsub("\\.", " ", compare$common_name)

#remove spp that didnt have model convergence
compare <- compare %>% 
  filter(! common_name %in% c("bowfin", "white catfish", "rosyside dace", 
                              "mimic shiner", "walleye", "round whitefish", 
                              "roseface shiner",  "spotfin shiner"))

load("C:/Users/jenrogers/Documents/necascFreshwaterBio/model_datafiles/fish_occurrence.RData")
names <- fish_occurrence %>% 
  select(common_name, scientific_name) %>% 
  unique()

compare <- left_join(compare, names, by = "common_name") %>% 
  select(scientific_name, 1:15) %>% 
  arrange(desc(count))

write.csv(compare, file = "C:/Users/jenrogers/Documents/git/FreshwaterBio/FreshwaterBio/tmpfigures/presabs_predictions.csv")



#calcuate spp richness by huc12 for each basin

#fish traits
load("C:/Users/jenrogers/Documents/necascFreshwaterBio/model_datafiles/fish_traits.RData")
temperature <- read_xlsx("C:/Users/jenrogers/Documents/necascFreshwaterBio/spp_data/thermalpref_origin_tolerance.xlsx",
                  sheet = 1,
                  range = cell_cols("A:H")) %>% 
  select(common_name, all) %>% 
  rename(tmp = all)
origin <- read_xlsx("C:/Users/jenrogers/Documents/necascFreshwaterBio/spp_data/thermalpref_origin_tolerance.xlsx",
                  sheet = 2,
                  range = cell_cols("A:G"))%>% 
  pivot_longer(2:7, names_to = "state", values_to = "origin") %>% 
  filter(state == "MA") %>% 
  select(common_name, origin)
#Even though the origin vary by state, for now, were just going to use the MA designations


#### species richness by origin for the climate change, baseline, dvlp conn, dvlp cvr, mgmt conn, and mgmt cvr


tmp_cc <- NHDplusV2_NewEngCrop_cc %>% 
  data.frame() %>% 
  select(huc12_tnmid, huc12_name, 40:96) %>% 
  pivot_longer(3:59, names_to = "common_name") 
tmp_cc$common_name <- gsub(".rds", "", tmp_cc$common_name)
tmp_cc$common_name <- gsub("pres_", "", tmp_cc$common_name)
tmp_cc$common_name <- gsub("\\.", " ", tmp_cc$common_name)

tmp_cc <- tmp_cc %>% 
  left_join(final_traits, by = "common_name") %>% 
  left_join(origin, by = "common_name") %>% 
  left_join(temperature, by = "common_name") %>%  
  group_by(huc12_tnmid, huc12_name, origin, common_name) %>% 
  summarise(mean_prob = mean(value, na.rm = T)) %>% 
  filter(mean_prob >0.05) %>%
  ungroup() %>% 
  group_by(huc12_tnmid, huc12_name, origin) %>% 
  summarise(rich_cc = n()) %>% 
  pivot_wider(names_from = origin, values_from = rich_cc) %>% 
  mutate(sum = sum(native, introduced, na.rm = T),
         prop_native_cc = native/sum) %>% 
  select(-introduced, -native, -'NA', -sum)



tmp_ccdvlp_cnnctv <- NHDplusV2_NewEngCrop_cc_dvlp_cnnctv %>% 
  data.frame() %>% 
  select(huc12_tnmid, huc12_name, 40:96) %>% 
  pivot_longer(3:59, names_to = "common_name") 
tmp_ccdvlp_cnnctv$common_name <- gsub(".rds", "", tmp_ccdvlp_cnnctv$common_name)
tmp_ccdvlp_cnnctv$common_name <- gsub("pres_", "", tmp_ccdvlp_cnnctv$common_name)
tmp_ccdvlp_cnnctv$common_name <- gsub("\\.", " ", tmp_ccdvlp_cnnctv$common_name)

tmp_ccdvlp_cnnctv <-  tmp_ccdvlp_cnnctv %>% 
  left_join(final_traits, by = "common_name") %>% 
  left_join(origin, by = "common_name")  %>% 
  left_join(temperature, by = "common_name") %>%  
  group_by(huc12_tnmid, huc12_name, origin, common_name) %>% 
  summarise(mean_prob = mean(value, na.rm = T)) %>% 
  filter(mean_prob >0.05) %>%
  ungroup() %>% 
  group_by(huc12_tnmid, huc12_name, origin) %>% 
  summarise(rich_ccdvlp_cnnctv = n())%>% 
  pivot_wider(names_from = origin, values_from = rich_ccdvlp_cnnctv) %>% 
  mutate(sum = sum(native, introduced, na.rm = T),
         prop_native_ccdvlp_cnnctv = native/sum) %>% 
  select(-introduced, -native, -'NA', -sum)



tmp_ccdvlp_cvr <- NHDplusV2_NewEngCrop_cc_dvlp_cvr %>% 
  data.frame() %>% 
  select(huc12_tnmid, huc12_name, 40:96) %>% 
  pivot_longer(3:59, names_to = "common_name") 
tmp_ccdvlp_cvr$common_name <- gsub(".rds", "", tmp_ccdvlp_cvr$common_name)
tmp_ccdvlp_cvr$common_name <- gsub("pres_", "", tmp_ccdvlp_cvr$common_name)
tmp_ccdvlp_cvr$common_name <- gsub("\\.", " ", tmp_ccdvlp_cvr$common_name)

tmp_ccdvlp_cvr <-  tmp_ccdvlp_cvr %>% 
  left_join(final_traits, by = "common_name") %>% 
  left_join(origin, by = "common_name")  %>% 
  left_join(temperature, by = "common_name") %>%  
  group_by(huc12_tnmid, huc12_name, origin, common_name) %>% 
  summarise(mean_prob = mean(value, na.rm = T)) %>% 
  filter(mean_prob >0.05) %>%
  ungroup() %>% 
  group_by(huc12_tnmid, huc12_name, origin) %>% 
  summarise(rich_ccdvlp_cvr = n())%>% 
  pivot_wider(names_from = origin, values_from = rich_ccdvlp_cvr) %>% 
  mutate(sum = sum(native, introduced, na.rm = T),
         prop_native_ccdvlp_cvr = native/sum) %>% 
  select(-introduced, -native, -'NA', -sum)


tmp_ccmgmt_cnnctv <- NHDplusV2_NewEngCrop_cc_mgmt_cnnctv %>% 
  data.frame() %>% 
  select(huc12_tnmid, huc12_name, 40:96) %>% 
  pivot_longer(3:59, names_to = "common_name") 
tmp_ccmgmt_cnnctv$common_name <- gsub(".rds", "", tmp_ccmgmt_cnnctv$common_name)
tmp_ccmgmt_cnnctv$common_name <- gsub("pres_", "", tmp_ccmgmt_cnnctv$common_name)
tmp_ccmgmt_cnnctv$common_name <- gsub("\\.", " ", tmp_ccmgmt_cnnctv$common_name)

tmp_ccmgmt_cnnctv <- tmp_ccmgmt_cnnctv %>% 
  left_join(final_traits, by = "common_name") %>% 
  left_join(origin, by = "common_name")  %>% 
  left_join(temperature, by = "common_name") %>%  
  group_by(huc12_tnmid, huc12_name, origin, common_name) %>% 
  summarise(mean_prob = mean(value, na.rm = T)) %>% 
  filter(mean_prob >0.05) %>%
  ungroup() %>% 
  group_by(huc12_tnmid, huc12_name, origin) %>% 
  summarise(rich_ccmgmt_cnnctv = n()) %>% 
  pivot_wider(names_from = origin, values_from = rich_ccmgmt_cnnctv) %>% 
  mutate(sum = sum(native, introduced, na.rm = T),
         prop_native_ccmgmt_cnnctv = native/sum) %>% 
  select(-introduced, -native, -'NA', -sum)


tmp_ccmgmt_cvr <- NHDplusV2_NewEngCrop_cc_mgmt_cvr %>% 
  data.frame() %>% 
  select(huc12_tnmid, huc12_name, 40:96) %>% 
  pivot_longer(3:59, names_to = "common_name") 
tmp_ccmgmt_cvr$common_name <- gsub(".rds", "", tmp_ccmgmt_cvr$common_name)
tmp_ccmgmt_cvr$common_name <- gsub("pres_", "", tmp_ccmgmt_cvr$common_name)
tmp_ccmgmt_cvr$common_name <- gsub("\\.", " ", tmp_ccmgmt_cvr$common_name)

tmp_ccmgmt_cvr <- tmp_ccmgmt_cvr %>% 
  left_join(final_traits, by = "common_name") %>% 
  left_join(origin, by = "common_name")  %>% 
  left_join(temperature, by = "common_name") %>%  
  group_by(huc12_tnmid, huc12_name, origin, common_name) %>% 
  summarise(mean_prob = mean(value, na.rm = T)) %>% 
  filter(mean_prob >0.05) %>%
  ungroup() %>% 
  group_by(huc12_tnmid, huc12_name, origin) %>% 
  summarise(rich_ccmgmt_cvr = n()) %>% 
  pivot_wider(names_from = origin, values_from = rich_ccmgmt_cvr) %>% 
  mutate(sum = sum(native, introduced, na.rm = T),
         prop_native_ccmgmt_cvr = native/sum) %>% 
  select(-introduced, -native, -'NA', -sum)



tmp_baseline <- NHDplusV2_NewEngCrop_baseline %>% 
  data.frame() %>% 
  select(huc12_tnmid, huc12_name, 40:96) %>% 
  pivot_longer(3:59, names_to = "common_name") 
tmp_baseline$common_name <- gsub(".rds", "", tmp_baseline$common_name)
tmp_baseline$common_name <- gsub("pres_", "", tmp_baseline$common_name)
tmp_baseline$common_name <- gsub("\\.", " ", tmp_baseline$common_name)

tmp_baseline <- tmp_baseline %>% 
  left_join(final_traits, by = "common_name") %>% 
  left_join(origin, by = "common_name")  %>% 
  left_join(temperature, by = "common_name") %>%  
  group_by(huc12_tnmid, huc12_name, origin, common_name) %>% 
  summarise(mean_prob = mean(value, na.rm = T)) %>% 
  filter(mean_prob >0.05) %>%
  ungroup() %>% 
  group_by(huc12_tnmid, huc12_name, origin) %>% 
  summarise(rich_baseline = n())%>% 
  pivot_wider(names_from = origin, values_from = rich_baseline) %>% 
  mutate(sum = sum(native, introduced, na.rm = T),
         prop_native_baseline = native/sum) %>% 
  select(-introduced, -native, -'NA', -sum)



huc8 <- st_read("C:/Users/jenrogers/Documents/necascFreshwaterBio/SpatialData/NHDplus/WBDHU8/WBDHU8_NE.shp")
huc12 <- st_read("C:/Users/jenrogers/Documents/necascFreshwaterBio/SpatialData/NHDplus/WBDHU12/WBDHU12_NE.shp")

states <- st_read("C:/Users/jenrogers/Documents/necascFreshwaterBio/SpatialData/newenglandshape/NEWENGLAND_POLY.shp")

sf_use_s2(FALSE)

huc12 <- huc12 %>% 
  select(tnmid, areasqkm , name) %>% 
  rename(huc12_areasqkm = areasqkm, huc12_name= name, huc12_tnmid = tnmid)
huc12 <- huc12[!duplicated(huc12$huc12_tnmid),]#Remove the duplicated TNMID fields
#this df needs aditional editting
#Outlet Missisquoi River - HUc12_name this is the same shape, but it actually has two separate tnmid
#Outlet Sutton River and Riviere Sutton are the same shape, but have different HUC 12 names and have different tnmid
#Ruiss Coslett-Riviere Aux Brochets vs Groat Creek are the same shape with different names and tmnid

huc12 <- huc12 %>% 
  filter(huc12_tnmid != "{7964F492-75EA-4AA7-8E77-A96D99348771}",
         huc12_name != "Riviere Sutton",
         huc12_name != "Ruiss Coslett-Riviere Aux Brochets")


# huc8 <- huc8 %>% 
#   select(tnmid, areasqkm, name) %>% 
#   rename(huc8_areasqkm = areasqkm, huc8_name= name, huc8_tnmid = tnmid)
# huc8 <- huc8[!duplicated(huc8$huc8_tnmid),]#Remove the duplicated TNMID fields


# huc8 <- left_join(huc8, tmp_baseline, by = "huc8_name")
# huc8 <- left_join(huc8, tmp_cc, by = "huc8_name")
# huc8 <- left_join(huc8, tmp_ccdvlp, by = "huc8_name")
# huc8 <- left_join(huc8, tmp_ccmgmt, by = "huc8_name")

huc12 <- left_join(huc12, tmp_baseline, by = c("huc12_tnmid", "huc12_name"))
huc12 <- left_join(huc12, tmp_cc, by = c("huc12_tnmid", "huc12_name"))
huc12 <- left_join(huc12, tmp_ccdvlp_cnnctv, by = c("huc12_tnmid", "huc12_name"))
huc12 <- left_join(huc12, tmp_ccdvlp_cvr, by = c("huc12_tnmid", "huc12_name"))
huc12 <- left_join(huc12, tmp_ccmgmt_cnnctv, by = c("huc12_tnmid", "huc12_name"))
huc12 <- left_join(huc12, tmp_ccmgmt_cvr, by = c("huc12_tnmid", "huc12_name"))

#calcuate change in climate change from baseline, but change in the other two from climate change
huc12 <- huc12 %>% 
  mutate(change_ccdvlp_cnnctv = prop_native_ccdvlp_cnnctv - prop_native_baseline,
         change_ccdvlp_crv = prop_native_ccdvlp_cvr - prop_native_baseline,
         change_ccmgmt_cnnctv = prop_native_ccmgmt_cnnctv - prop_native_baseline,
         change_ccmgmt_crv = prop_native_ccmgmt_cvr - prop_native_baseline,
         change_cc = prop_native_cc - prop_native_baseline)

#plot absolute values of proportaional richness of native spp
huc12a <- huc12 %>% 
  select(3:9) %>% 
  pivot_longer(2:7, names_to = "scenario", values_to = "prop_richness") %>% 
  filter(!is.na(prop_richness))
huc12a$scenario[huc12a$scenario == "prop_native_baseline"] <- "baseline"
huc12a$scenario[huc12a$scenario == "prop_native_cc"] <- "cc"
huc12a$scenario[huc12a$scenario == "prop_native_ccdvlp_cnnctv"] <- "cc + dvlp + cnn"
huc12a$scenario[huc12a$scenario == "prop_native_ccdvlp_cvr"] <- "cc + dvlp + cvr"
huc12a$scenario[huc12a$scenario == "prop_native_ccmgmt_cnnctv"] <- "cc + mgmt + cnn"
huc12a$scenario[huc12a$scenario == "prop_native_ccmgmt_cvr"] <- "cc + mgmt + cvr"


ggplot(data = huc12a)+
  geom_sf(aes(fill = prop_richness), color = NA)+
  scale_fill_viridis_c()+
  facet_wrap(~scenario, nrow = 2)+
    geom_sf(data = states, fill = NA, lwd = 0.2, color = "black")+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank())+
    ggtitle(label = "Prop Native Species Richness")


ggsave(
    filename = "C:/Users/jenrogers/Documents/git/FreshwaterBio/FreshwaterBio/tmpfigures/predicted_native_spp_richness.png",
    plot = last_plot(),
    width = 18,
    height = 12,
    units = "cm",
    dpi = 300
  )



#plot change of proportaional richness of native spp
huc12b <- huc12 %>% 
  select(3, 11:15) %>% 
  pivot_longer(2:6, names_to = "scenario", values_to = "change") %>% 
  filter(!is.na(change))
huc12b$scenario[huc12b$scenario == "prop_native_baseline"] <- "baseline"
huc12b$scenario[huc12b$scenario == "prop_native_cc"] <- "cc"
huc12b$scenario[huc12b$scenario == "prop_native_ccdvlp_cnnctv"] <- "cc + dvlp + cnn"
huc12b$scenario[huc12b$scenario == "prop_native_ccdvlp_cvr"] <- "cc + dvlp + cvr"
huc12b$scenario[huc12b$scenario == "prop_native_ccmgmt_cnnctv"] <- "cc + mgmt + cnn"
huc12b$scenario[huc12b$scenario == "prop_native_ccmgmt_cvr"] <- "cc + mgmt + cvr"


ggplot(data = huc12b)+
  geom_sf(aes(fill = change), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "white",
                        high = "red",
                        midpoint = 0)+
  facet_wrap(~scenario, nrow = 2)+
    geom_sf(data = states, fill = NA, lwd = 0.2, color = "black")+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank())+
    ggtitle(label = "Change Prop Native Species Richness")


ggsave(
    filename = "C:/Users/jenrogers/Documents/git/FreshwaterBio/FreshwaterBio/tmpfigures/predicted_native_spp_richness_change.png",
    plot = last_plot(),
    width = 18,
    height = 12,
    units = "cm",
    dpi = 300
  )





#### species richness by temperature


tmp_cc <- NHDplusV2_NewEngCrop_cc %>% 
  data.frame() %>% 
  select(huc12_tnmid, huc12_name, 40:96) %>% 
  pivot_longer(3:59, names_to = "common_name") 
tmp_cc$common_name <- gsub(".rds", "", tmp_cc$common_name)
tmp_cc$common_name <- gsub("pres_", "", tmp_cc$common_name)
tmp_cc$common_name <- gsub("\\.", " ", tmp_cc$common_name)

tmp_cc <- tmp_cc %>% 
  left_join(final_traits, by = "common_name") %>% 
  left_join(origin, by = "common_name") %>% 
  left_join(temperature, by = "common_name") %>%  
  group_by(huc12_tnmid, huc12_name, tmp, common_name) %>% 
  summarise(mean_prob = mean(value, na.rm = T)) %>% 
  filter(mean_prob >0.05) %>%
  ungroup() %>% 
  group_by(huc12_tnmid, huc12_name, tmp) %>% 
  summarise(rich_cc = n()) %>% 
  pivot_wider(names_from = tmp, values_from = rich_cc) %>% 
  mutate(sum = sum(warm, cold, cool, eury, na.rm = T),
         prop_cold_cc = cold/sum) %>% 
  select(-warm, -cold, -cool, -eury, -sum)



tmp_ccdvlp_cnnctv <- NHDplusV2_NewEngCrop_cc_dvlp_cnnctv %>% 
  data.frame() %>% 
  select(huc12_tnmid, huc12_name, 40:96) %>% 
  pivot_longer(3:59, names_to = "common_name") 
tmp_ccdvlp_cnnctv$common_name <- gsub(".rds", "", tmp_ccdvlp_cnnctv$common_name)
tmp_ccdvlp_cnnctv$common_name <- gsub("pres_", "", tmp_ccdvlp_cnnctv$common_name)
tmp_ccdvlp_cnnctv$common_name <- gsub("\\.", " ", tmp_ccdvlp_cnnctv$common_name)

tmp_ccdvlp_cnnctv <-  tmp_ccdvlp_cnnctv %>% 
  left_join(final_traits, by = "common_name") %>% 
  left_join(origin, by = "common_name")  %>% 
  left_join(temperature, by = "common_name") %>%  
  group_by(huc12_tnmid, huc12_name, tmp, common_name) %>% 
  summarise(mean_prob = mean(value, na.rm = T)) %>% 
  filter(mean_prob >0.05) %>%
  ungroup() %>% 
  group_by(huc12_tnmid, huc12_name, tmp) %>% 
  summarise(rich_ccdvlp_cnnctv = n())%>% 
  pivot_wider(names_from = tmp, values_from = rich_ccdvlp_cnnctv) %>% 
  mutate(sum = sum(warm, cold, cool, na.rm = T),
         prop_cold_ccdvlp_cnnctv = cold/sum) %>% 
  select(-warm, -cold, -cool, -sum, -eury)


tmp_ccdvlp_cvr <- NHDplusV2_NewEngCrop_cc_dvlp_cvr %>% 
  data.frame() %>% 
  select(huc12_tnmid, huc12_name, 40:96) %>% 
  pivot_longer(3:59, names_to = "common_name") 
tmp_ccdvlp_cvr$common_name <- gsub(".rds", "", tmp_ccdvlp_cvr$common_name)
tmp_ccdvlp_cvr$common_name <- gsub("pres_", "", tmp_ccdvlp_cvr$common_name)
tmp_ccdvlp_cvr$common_name <- gsub("\\.", " ", tmp_ccdvlp_cvr$common_name)

tmp_ccdvlp_cvr <-  tmp_ccdvlp_cvr %>% 
  left_join(final_traits, by = "common_name") %>% 
  left_join(origin, by = "common_name")  %>% 
  left_join(temperature, by = "common_name") %>%  
  group_by(huc12_tnmid, huc12_name, tmp, common_name) %>% 
  summarise(mean_prob = mean(value, na.rm = T)) %>% 
  filter(mean_prob >0.05) %>%
  ungroup() %>% 
  group_by(huc12_tnmid, huc12_name, tmp) %>% 
  summarise(rich_ccdvlp_cvr = n())%>% 
  pivot_wider(names_from = tmp, values_from = rich_ccdvlp_cvr) %>% 
  mutate(sum = sum(warm, cold, cool, na.rm = T),
         prop_cold_ccdvlp_cvr = cold/sum) %>% 
  select(-warm, -cold, -cool, -sum, -eury)



tmp_ccmgmt_cnnctv <- NHDplusV2_NewEngCrop_cc_mgmt_cnnctv %>% 
  data.frame() %>% 
  select(huc12_tnmid, huc12_name, 40:96) %>% 
  pivot_longer(3:59, names_to = "common_name") 
tmp_ccmgmt_cnnctv$common_name <- gsub(".rds", "", tmp_ccmgmt_cnnctv$common_name)
tmp_ccmgmt_cnnctv$common_name <- gsub("pres_", "", tmp_ccmgmt_cnnctv$common_name)
tmp_ccmgmt_cnnctv$common_name <- gsub("\\.", " ", tmp_ccmgmt_cnnctv$common_name)

tmp_ccmgmt_cnnctv <- tmp_ccmgmt_cnnctv %>% 
  left_join(final_traits, by = "common_name") %>% 
  left_join(origin, by = "common_name")  %>% 
  left_join(temperature, by = "common_name") %>%  
  group_by(huc12_tnmid, huc12_name, tmp, common_name) %>% 
  summarise(mean_prob = mean(value, na.rm = T)) %>% 
  filter(mean_prob >0.05) %>%
  ungroup() %>% 
  group_by(huc12_tnmid, huc12_name, tmp) %>% 
  summarise(rich_ccmgmt_cnnctv = n()) %>% 
  pivot_wider(names_from = tmp, values_from = rich_ccmgmt_cnnctv) %>% 
  mutate(sum = sum(warm, cold, cool, eury, na.rm = T),
         prop_cold_mgmt_cnnctv = cold/sum) %>% 
  select(-warm, -cold, -cool, -eury, -sum)


tmp_ccmgmt_cvr <- NHDplusV2_NewEngCrop_cc_mgmt_cvr %>% 
  data.frame() %>% 
  select(huc12_tnmid, huc12_name, 40:96) %>% 
  pivot_longer(3:59, names_to = "common_name") 
tmp_ccmgmt_cvr$common_name <- gsub(".rds", "", tmp_ccmgmt_cvr$common_name)
tmp_ccmgmt_cvr$common_name <- gsub("pres_", "", tmp_ccmgmt_cvr$common_name)
tmp_ccmgmt_cvr$common_name <- gsub("\\.", " ", tmp_ccmgmt_cvr$common_name)

tmp_ccmgmt_cvr <- tmp_ccmgmt_cvr %>% 
  left_join(final_traits, by = "common_name") %>% 
  left_join(origin, by = "common_name")  %>% 
  left_join(temperature, by = "common_name") %>%  
  group_by(huc12_tnmid, huc12_name, tmp, common_name) %>% 
  summarise(mean_prob = mean(value, na.rm = T)) %>% 
  filter(mean_prob >0.05) %>%
  ungroup() %>% 
  group_by(huc12_tnmid, huc12_name, tmp) %>% 
  summarise(rich_ccmgmt_cvr = n()) %>% 
  pivot_wider(names_from = tmp, values_from = rich_ccmgmt_cvr) %>% 
  mutate(sum = sum(warm, cold, cool, eury, na.rm = T),
         prop_cold_mgmt_cvr = cold/sum) %>% 
  select(-warm, -cold, -cool, -eury, -sum)




tmp_baseline <- NHDplusV2_NewEngCrop_baseline %>% 
  data.frame() %>% 
  select(huc12_tnmid, huc12_name, 40:96) %>% 
  pivot_longer(3:59, names_to = "common_name") 
tmp_baseline$common_name <- gsub(".rds", "", tmp_baseline$common_name)
tmp_baseline$common_name <- gsub("pres_", "", tmp_baseline$common_name)
tmp_baseline$common_name <- gsub("\\.", " ", tmp_baseline$common_name)

tmp_baseline <- tmp_baseline %>% 
  left_join(final_traits, by = "common_name") %>% 
  left_join(origin, by = "common_name")  %>% 
  left_join(temperature, by = "common_name") %>%  
  group_by(huc12_tnmid, huc12_name, tmp, common_name) %>% 
  summarise(mean_prob = mean(value, na.rm = T)) %>% 
  filter(mean_prob >0.05) %>%
  ungroup() %>% 
  group_by(huc12_tnmid, huc12_name, tmp) %>% 
  summarise(rich_baseline = n())%>% 
  pivot_wider(names_from = tmp, values_from = rich_baseline) %>% 
  mutate(sum = sum(warm, cold, cool, eury, na.rm = T),
         prop_cold_baseline = cold/sum) %>% 
  select(-warm, -cold, -cool, -eury, -sum)



huc8 <- st_read("C:/Users/jenrogers/Documents/necascFreshwaterBio/SpatialData/NHDplus/WBDHU8/WBDHU8_NE.shp")
huc12 <- st_read("C:/Users/jenrogers/Documents/necascFreshwaterBio/SpatialData/NHDplus/WBDHU12/WBDHU12_NE.shp")

states <- st_read("C:/Users/jenrogers/Documents/necascFreshwaterBio/SpatialData/newenglandshape/NEWENGLAND_POLY.shp")

sf_use_s2(FALSE)

huc12 <- huc12 %>% 
  select(tnmid, areasqkm , name) %>% 
  rename(huc12_areasqkm = areasqkm, huc12_name= name, huc12_tnmid = tnmid)
huc12 <- huc12[!duplicated(huc12$huc12_tnmid),]#Remove the duplicated TNMID fields
#this df needs aditional editting
#Outlet Missisquoi River - HUc12_name this is the same shape, but it actually has two separate tnmid
#Outlet Sutton River and Riviere Sutton are the same shape, but have different HUC 12 names and have different tnmid
#Ruiss Coslett-Riviere Aux Brochets vs Groat Creek are the same shape with different names and tmnid

huc12 <- huc12 %>% 
  filter(huc12_tnmid != "{7964F492-75EA-4AA7-8E77-A96D99348771}",
         huc12_name != "Riviere Sutton",
         huc12_name != "Ruiss Coslett-Riviere Aux Brochets")


# huc8 <- huc8 %>% 
#   select(tnmid, areasqkm, name) %>% 
#   rename(huc8_areasqkm = areasqkm, huc8_name= name, huc8_tnmid = tnmid)
# huc8 <- huc8[!duplicated(huc8$huc8_tnmid),]#Remove the duplicated TNMID fields


# huc8 <- left_join(huc8, tmp_baseline, by = "huc8_name")
# huc8 <- left_join(huc8, tmp_cc, by = "huc8_name")
# huc8 <- left_join(huc8, tmp_ccdvlp, by = "huc8_name")
# huc8 <- left_join(huc8, tmp_ccmgmt, by = "huc8_name")

huc12 <- left_join(huc12, tmp_baseline, by = c("huc12_tnmid", "huc12_name"))
huc12 <- left_join(huc12, tmp_cc, by = c("huc12_tnmid", "huc12_name"))
huc12 <- left_join(huc12, tmp_ccdvlp_cnnctv, by = c("huc12_tnmid", "huc12_name"))
huc12 <- left_join(huc12, tmp_ccdvlp_cvr, by = c("huc12_tnmid", "huc12_name"))
huc12 <- left_join(huc12, tmp_ccmgmt_cnnctv, by = c("huc12_tnmid", "huc12_name"))
huc12 <- left_join(huc12, tmp_ccmgmt_cvr, by = c("huc12_tnmid", "huc12_name"))

huc12 <- huc12 %>% 
  mutate(change_cc = prop_cold_cc - prop_cold_baseline,
         change_ccdvlp_cnnctv = prop_cold_ccdvlp_cnnctv - prop_cold_baseline,
         change_ccdvlp_cvr = prop_cold_ccdvlp_cvr - prop_cold_baseline,
         change_ccmgmt_cnnctv = prop_cold_mgmt_cnnctv - prop_cold_baseline,
         change_ccmgmt_cvr = prop_cold_mgmt_cvr - prop_cold_baseline,
         )

#plot absolute values of proportion of cold spp richness
huc12a <- huc12 %>% 
  select(3:9) %>% 
  pivot_longer(2:7, names_to = "scenario", values_to = "prop_richness") %>% 
  filter(!is.na(prop_richness))
huc12a$scenario[huc12a$scenario == "prop_cold_baseline"] <- "baseline"
huc12a$scenario[huc12a$scenario == "prop_cold_cc"] <- "cc"
huc12a$scenario[huc12a$scenario == "prop_cold_ccdvlp_cnnctv"] <- "cc + dvlp + cnn"
huc12a$scenario[huc12a$scenario == "prop_cold_ccdvlp_cvr"] <- "cc + dvlp + cvr"
huc12a$scenario[huc12a$scenario == "prop_cold_mgmt_cnnctv"] <- "cc + mgmt + cnn"
huc12a$scenario[huc12a$scenario == "prop_cold_mgmt_cvr"] <- "cc + mgmt + cvr"


ggplot(data = huc12a)+
  geom_sf(aes(fill = prop_richness), color = NA)+
  scale_fill_viridis_c()+
  facet_wrap(~scenario, nrow = 2)+
    geom_sf(data = states, fill = NA, lwd = 0.2, color = "black")+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank())+
    ggtitle(label = "Prop Cold Species Richness")


ggsave(
    filename = "C:/Users/jenrogers/Documents/git/FreshwaterBio/FreshwaterBio/tmpfigures/predicted_cold_spp_richness.png",
    plot = last_plot(),
    width = 18,
    height = 12,
    units = "cm",
    dpi = 300
  )

#plot change of proportion of cold spp richness
huc12a <- huc12 %>% 
  select(3, 11:15) %>% 
  pivot_longer(2:6, names_to = "scenario", values_to = "change") %>% 
  filter(!is.na(change))
huc12a$scenario[huc12a$scenario == "prop_cold_cc"] <- "cc"
huc12a$scenario[huc12a$scenario == "prop_cold_ccdvlp_cnnctv"] <- "cc + dvlp + cnn"
huc12a$scenario[huc12a$scenario == "prop_cold_ccdvlp_cvr"] <- "cc + dvlp + cvr"
huc12a$scenario[huc12a$scenario == "prop_cold_mgmt_cnnctv"] <- "cc + mgmt + cnn"
huc12a$scenario[huc12a$scenario == "prop_cold_mgmt_cvr"] <- "cc + mgmt + cvr"


ggplot(data = huc12a)+
  geom_sf(aes(fill = change), color = NA)+
  scale_fill_gradient2(low = "blue",
                        mid = "white",
                        high = "red",
                        midpoint = 0)+
  facet_wrap(~scenario, nrow = 2)+
    geom_sf(data = states, fill = NA, lwd = 0.2, color = "black")+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank())+
    ggtitle(label = "Prop Cold Species Richness Change")


ggsave(
    filename = "C:/Users/jenrogers/Documents/git/FreshwaterBio/FreshwaterBio/tmpfigures/predicted_cold_spp_richness_change.png",
    plot = last_plot(),
    width = 9,
    height = 12,
    units = "cm",
    dpi = 300
  )

```




multinomial logistic regression predictions

```{r}
library(foreign)
library(nnet)

#load prediction dataset
load(file = "C:/Users/jenrogers/Documents/necascFreshwaterBio/model_datafiles/NHDplusV2_NewEngCrop_covariates.RData")


#load and prep huc12

huc12 <- st_read("C:/Users/jenrogers/Documents/necascFreshwaterBio/SpatialData/NHDplus/WBDHU12/WBDHU12_NE.shp")


sf_use_s2(FALSE)

huc12 <- huc12 %>% 
  select(tnmid, areasqkm , name) %>% 
  rename(huc12_areasqkm = areasqkm, huc12_name= name, huc12_tnmid = tnmid)
huc12 <- huc12[!duplicated(huc12$huc12_tnmid),]#Remove the duplicated TNMID fields
#this df needs aditional editting
#Outlet Missisquoi River - HUc12_name this is the same shape, but it actually has two separate tnmid
#Outlet Sutton River and Riviere Sutton are the same shape, but have different HUC 12 names and have different tnmid
#Ruiss Coslett-Riviere Aux Brochets vs Groat Creek are the same shape with different names and tmnid

huc12 <- huc12 %>% 
  filter(huc12_tnmid != "{7964F492-75EA-4AA7-8E77-A96D99348771}",
         huc12_name != "Riviere Sutton",
         huc12_name != "Ruiss Coslett-Riviere Aux Brochets")

#load and prep huc8
# huc8 <- st_read("C:/Users/jenrogers/Documents/necascFreshwaterBio/SpatialData/NHDplus/WBDHU8/WBDHU8_NE.shp")
# sf_use_s2(FALSE)
# huc8 <- huc8 %>% 
#   select(tnmid, areasqkm, name) %>% 
#   rename(huc8_areasqkm = areasqkm, huc8_name= name, huc8_tnmid = tnmid)
# huc8 <- huc8[!duplicated(huc8$huc8_tnmid),]#Remove the duplicated TNMID fields


#load states
states <- st_read("C:/Users/jenrogers/Documents/necascFreshwaterBio/SpatialData/newenglandshape/NEWENGLAND_POLY.shp")

#need to scale the variables in NHDplusV2_NewEngCrop

test <- NHDplusV2_NewEngCrop %>% 
  data.frame() %>% 
  select(-geometry)
test <- test[,c(7:8, 10:39)]
test <- data.frame(scale(test))
NHDplusV2_NewEngCrop <- cbind((NHDplusV2_NewEngCrop)[,c(1, 5, 6)], test)

#load model
mdl <- readRDS(file = "C:/Users/jenrogers/Documents/necascFreshwaterBio/model_objects/trait_temp.rds")







#prediction using baseline values:

tmp <- predict(mdl, newdata = NHDplusV2_NewEngCrop, "probs")

#join the predictions_ccmgmt to the list of comids
tmp <- cbind(NHDplusV2_NewEngCrop, tmp)

tmp <- tmp %>%
  data.frame() %>% 
  select(huc12_name, huc12_tnmid, warm, cold, cool) %>% 
  pivot_longer(3:5, names_to = "temperature", values_to = "prop") %>% 
  group_by(huc12_name, huc12_tnmid, temperature) %>% 
  summarise(mean = round(mean(prop, na.rm = T), 2),
            min = round(quantile(prop, probs = 0.05, na.rm = T), 2),
            max = round(quantile(prop, probs = 0.95, na.rm = T), 2))
  



temptraits_baseline <- left_join(huc12, tmp, by = c("huc12_name", "huc12_tnmid"))


temptraits_baseline <- temptraits_baseline %>%  
  filter(!is.na(temperature))

ggplot(data = temptraits_baseline)+
  geom_sf(aes(fill = mean), color = NA)+
  scale_fill_viridis_c(limits = c(0,1))+
  facet_wrap(~temperature, nrow = 1)+
    geom_sf(data = states, fill = NA, lwd = 0.2, color = "black")+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank())+
    labs(fill = "Avg Prop.")
ggsave(
    filename = "C:/Users/jenrogers/Documents/git/FreshwaterBio/FreshwaterBio/tmpfigures/temp_prep_prediction_baseline.png",
    plot = last_plot(),
    width = 14,
    height = 7,
    units = "cm",
    dpi = 200
  )



ggplot(data = temptraits_baseline, aes(x = huc12_name, y = mean))+
  geom_point(size = 3)+
  geom_errorbar(aes(ymin = min, ymax = max), width = .2)+
  coord_flip()+
  facet_wrap(~temperature, nrow = 1)+
  theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        axis.text = element_text(size = 10),
        axis.title = element_text(size = 15),
        axis.title.y = element_blank(),
        title = element_text(size = 15))+
    ggtitle(label = "Temperature Trait Proportion")

ggsave(
    filename = "C:/Users/jenrogers/Documents/git/FreshwaterBio/FreshwaterBio/tmpfigures/temp_prep_prediction_baseline_dot.png",
    plot = last_plot(),
    width = 14,
    height = 9,
    units = "cm",
    dpi = 200
  )









#prediction using climate change values values:


#load the 2080 file that has the projected stream temperature and streamflow covariate values
load("C:/Users/jenrogers/Documents/necascFreshwaterBio/model_datafiles/NHDplusV2_NewEngCrop_covariates_2080.RData")


#need to get the variables named the same as the baseline dataframe and need to order the variables in the same way so that we can scale them
test <- NHDplusV2_NewEngCrop_2080 %>% 
  data.frame() %>% 
  select(7:8, 10:39) %>% 
  rename(annual_mean_summer_temp = annual_mean_summer_temp_pls_4,
         BFI_HIST = BFI_2080,
         LO7Q1DT_HIST = LO7Q1DT_2080,
         CFM_HIST = CFM_2080,
         W95_HIST = W95_2080,
         logMJJA_HIST = logMJJA_2080) %>% 
  select(1:2, 27:31, 3:24, 32, 25:26)


#scale the variables using the means and sd used to scale the variables in the baseline condition
test <- sweep(test, 2, means, FUN = '-') 
test <- sweep(test, 2, sd, FUN = '/')  

#join the scaled variables back to 
NHDplusV2_NewEngCrop_cc <- cbind((NHDplusV2_NewEngCrop_2080)[,c(1:6, 9)], test)


#this is what we used for the NAB conferencce
# NHDplusV2_NewEngCrop_cc <- NHDplusV2_NewEngCrop %>% 
#   mutate(annual_mean_summer_temp = annual_mean_summer_temp + 2
#          )


tmp <- predict(mdl, newdata = NHDplusV2_NewEngCrop_cc, "probs")

#join the predictions_ccmgmt to the list of comids
tmp <- cbind(NHDplusV2_NewEngCrop_cc, tmp)

tmp <- tmp %>%
  data.frame() %>% 
  select(huc12_name, huc12_tnmid, warm, cold, cool) %>% 
  pivot_longer(3:5, names_to = "temperature", values_to = "prop") %>% 
  group_by(huc12_name, huc12_tnmid, temperature) %>% 
  summarise(mean = round(mean(prop, na.rm = T), 2),
            min = round(quantile(prop, probs = 0.05, na.rm = T), 2),
            max = round(quantile(prop, probs = 0.95, na.rm = T), 2))
  



temptraits_cc <- left_join(huc12, tmp, by = c("huc12_name", "huc12_tnmid"))


temptraits_cc <- temptraits_cc %>%  
  filter(!is.na(temperature))

ggplot(data = temptraits_cc)+
  geom_sf(aes(fill = mean), color = NA)+
  scale_fill_viridis_c(limits = c(0,1))+
  facet_wrap(~temperature, nrow = 1)+
    geom_sf(data = states, fill = NA, lwd = 0.2, color = "black")+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank())+
    labs(fill = "Avg Prop.")
ggsave(
    filename = "C:/Users/jenrogers/Documents/git/FreshwaterBio/FreshwaterBio/tmpfigures/temp_prep_prediction_cc.png",
    plot = last_plot(),
    width = 14,
    height = 7,
    units = "cm",
    dpi = 200
  )

ggplot(data = temptraits_cc, aes(x = huc12_name, y = mean))+
  geom_point(size = 3)+
  geom_errorbar(aes(ymin = min, ymax = max), width = .2)+
  coord_flip()+
  facet_wrap(~temperature, nrow = 1)+
  theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        axis.text = element_text(size = 10),
        axis.title = element_text(size = 15),
        axis.title.y = element_blank(),
        title = element_text(size = 15))+
    ggtitle(label = "Temperature Trait Proportion")

ggsave(
    filename = "C:/Users/jenrogers/Documents/git/FreshwaterBio/FreshwaterBio/tmpfigures/temp_prep_prediction_cc_dot.png",
    plot = last_plot(),
    width = 14,
    height = 9,
    units = "cm",
    dpi = 200
  )










#prediction using climate change and development  - connectivity reduction:

#need to get the variables named the same as the baseline dataframe and need to order the variables in the same way so that we can scale them
test <- NHDplusV2_NewEngCrop_2080 %>% 
  data.frame() %>% 
  select(7:8, 10:39) %>% 
  rename(annual_mean_summer_temp = annual_mean_summer_temp_pls_4,
         BFI_HIST = BFI_2080,
         LO7Q1DT_HIST = LO7Q1DT_2080,
         CFM_HIST = CFM_2080,
         W95_HIST = W95_2080,
         logMJJA_HIST = logMJJA_2080) %>% 
  mutate(huc8_damcount = huc8_damcount * 5,
         huc12_damden_sqkm = huc12_damden_sqkm * 5,
         logRdCrsCat = logRdCrsCat * 5) %>% 
  select(1:2, 27:31, 3:24, 32, 25:26)


#scale the variables using the means and sd used to scale the variables in the baseline condition
test <- sweep(test, 2, means, FUN = '-') 
test <- sweep(test, 2, sd, FUN = '/')  

#join the scaled variables back to 
NHDplusV2_NewEngCrop_cc_dvlp_cnnctv <- cbind((NHDplusV2_NewEngCrop_2080)[,c(1:6, 9)], test)


#this is what we used for the NAB conference
# NHDplusV2_NewEngCrop_ccdvlp <- NHDplusV2_NewEngCrop %>% 
#   mutate(annual_mean_summer_temp = annual_mean_summer_temp + 2,
#          PctImp_Ws = PctImp_Ws + 2,
#          pctAg_Ws = pctAg_Ws + 2,
#          logRdCrsCat = logRdCrsCat + 2,
#          huc12_damden_sqkm = huc12_damden_sqkm + 2,
#          huc8_damcount = huc8_damcount + 2
#          )


tmp <- predict(mdl, newdata = NHDplusV2_NewEngCrop_cc_dvlp_cnnctv, "probs")

#join the predictions_ccmgmt to the list of comids
tmp <- cbind(NHDplusV2_NewEngCrop_cc_dvlp_cnnctv, tmp)

tmp <- tmp %>%
  data.frame() %>% 
  select(huc12_name, huc12_tnmid, warm, cold, cool) %>% 
  pivot_longer(3:5, names_to = "temperature", values_to = "prop") %>% 
  group_by(huc12_name, huc12_tnmid, temperature) %>%
  summarise(mean = round(mean(prop, na.rm = T), 2),
            min = round(quantile(prop, probs = 0.05, na.rm = T), 2),
            max = round(quantile(prop, probs = 0.95, na.rm = T), 2))
  



temptraits_ccdvlp_cnn <- left_join(huc12, tmp, by = c("huc12_name", "huc12_tnmid"))


temptraits_ccdvlp_cnn <- temptraits_ccdvlp_cnn %>%  
  filter(!is.na(temperature))

ggplot(data = temptraits_ccdvlp_cnn)+
  geom_sf(aes(fill = mean), color = NA)+
  scale_fill_viridis_c(limits = c(0,1))+
  facet_wrap(~temperature, nrow = 1)+
    geom_sf(data = states, fill = NA, lwd = 0.2, color = "black")+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank())+
    labs(fill = "Avg Prop.")
ggsave(
    filename = "C:/Users/jenrogers/Documents/git/FreshwaterBio/FreshwaterBio/tmpfigures/temp_prep_prediction_ccdvlp_cnn.png",
    plot = last_plot(),
    width = 14,
    height = 7,
    units = "cm",
    dpi = 200
  )

ggplot(data = temptraits_ccdvlp_cnn, aes(x = huc8_name, y = mean))+
  geom_point(size = 3)+
  geom_errorbar(aes(ymin = min, ymax = max), width = .2)+
  coord_flip()+
  facet_wrap(~temperature, nrow = 1)+
  theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        axis.text = element_text(size = 10),
        axis.title = element_text(size = 15),
        axis.title.y = element_blank(),
        title = element_text(size = 15))+
    ggtitle(label = "Temperature Trait Proportion")
ggsave(
    filename = "C:/Users/jenrogers/Documents/git/FreshwaterBio/FreshwaterBio/tmpfigures/temp_prep_prediction_ccdvlp_cnn_dot.png",
    plot = last_plot(),
    width = 14,
    height = 9,
    units = "cm",
    dpi = 200
  )







#prediction using climate change and management values: increase in connectivity

test <- NHDplusV2_NewEngCrop_2080 %>% 
  data.frame() %>% 
  select(7:8, 10:39) %>% 
  rename(annual_mean_summer_temp = annual_mean_summer_temp_pls_4,
         BFI_HIST = BFI_2080,
         LO7Q1DT_HIST = LO7Q1DT_2080,
         CFM_HIST = CFM_2080,
         W95_HIST = W95_2080,
         logMJJA_HIST = logMJJA_2080) %>% 
  mutate(huc8_damcount = huc8_damcount * .1,
         huc12_damden_sqkm = huc12_damden_sqkm * .1,
         logRdCrsCat = logRdCrsCat * .1) %>% 
  select(1:2, 27:31, 3:24, 32, 25:26)


#scale the variables using the means and sd used to scale the variables in the baseline condition
test <- sweep(test, 2, means, FUN = '-') 
test <- sweep(test, 2, sd, FUN = '/')  

#join the scaled variables back to 
NHDplusV2_NewEngCrop_cc_mgmt_cnnctv <- cbind((NHDplusV2_NewEngCrop_2080)[,c(1:6, 9)], test)


#used for NAB
# NHDplusV2_NewEngCrop_ccmgmt <- NHDplusV2_NewEngCrop %>% 
#   mutate(annual_mean_summer_temp = annual_mean_summer_temp + 2,
#          PctImp_Ws = PctImp_Ws - 2,
#          pctAg_Ws = pctAg_Ws - 2,
#          logRdCrsCat = logRdCrsCat - 2,
#          huc12_damden_sqkm = huc12_damden_sqkm - 2,
#          huc8_damcount = huc8_damcount - 2,
#          
#          )

tmp <- predict(mdl, newdata = NHDplusV2_NewEngCrop_cc_mgmt_cnnctv, "probs")

#join the predictions_ccmgmt to the list of comids
tmp <- cbind(NHDplusV2_NewEngCrop_cc_mgmt_cnnctv, tmp)

tmp <- tmp %>%
  data.frame() %>% 
  select(huc12_name, huc12_tnmid, warm, cold, cool) %>% 
  pivot_longer(3:5, names_to = "temperature", values_to = "prop") %>% 
  group_by(huc12_name, huc12_tnmid, temperature) %>%
  summarise(mean = round(mean(prop, na.rm = T), 2),
            min = round(quantile(prop, probs = 0.05, na.rm = T), 2),
            max = round(quantile(prop, probs = 0.95, na.rm = T), 2))
  



temptraits_ccmgmt_cnn <- left_join(huc12, tmp, by = c("huc12_name", "huc12_tnmid"))


temptraits_ccmgmt_cnn <- temptraits_ccmgmt_cnn %>%  
  filter(!is.na(temperature))

ggplot(data = temptraits_ccmgmt_cnn)+
  geom_sf(aes(fill = mean), color = NA)+
  scale_fill_viridis_c(limits = c(0,1))+
  facet_wrap(~temperature, nrow = 1)+
    geom_sf(data = states, fill = NA, lwd = 0.2, color = "black")+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank())+
    labs(fill = "Avg Prop.")
ggsave(
    filename = "C:/Users/jenrogers/Documents/git/FreshwaterBio/FreshwaterBio/tmpfigures/temp_prep_prediction_ccmgmt_cnn.png",
    plot = last_plot(),
    width = 14,
    height = 7,
    units = "cm",
    dpi = 200
  )

ggplot(data = temptraits_ccmgmt_cnn, aes(x = huc8_name, y = mean))+
  geom_point(size = 3)+
  geom_errorbar(aes(ymin = min, ymax = max), width = .2)+
  coord_flip()+
  facet_wrap(~temperature, nrow = 1)+
  theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        axis.text = element_text(size = 10),
        axis.title = element_text(size = 15),
        axis.title.y = element_blank(),
        title = element_text(size = 15))+
    ggtitle(label = "Temperature Trait Proportion")
ggsave(
    filename = "C:/Users/jenrogers/Documents/git/FreshwaterBio/FreshwaterBio/tmpfigures/temp_prep_prediction_ccmgmt_cnn_dot.png",
    plot = last_plot(),
    width = 14,
    height = 9,
    units = "cm",
    dpi = 200
  )






#prediction using climate change and development  - cover reduction:

#need to get the variables named the same as the baseline dataframe and need to order the variables in the same way so that we can scale them
test <- NHDplusV2_NewEngCrop_2080 %>% 
  data.frame() %>% 
  select(7:8, 10:39) %>% 
  rename(annual_mean_summer_temp = annual_mean_summer_temp_pls_4,
         BFI_HIST = BFI_2080,
         LO7Q1DT_HIST = LO7Q1DT_2080,
         CFM_HIST = CFM_2080,
         W95_HIST = W95_2080,
         logMJJA_HIST = logMJJA_2080) %>% 
  mutate(PctImp_Ws = PctImp_Ws * 5,
         pctAg_Ws = pctAg_Ws * 5) %>% 
  select(1:2, 27:31, 3:24, 32, 25:26)


#scale the variables using the means and sd used to scale the variables in the baseline condition
test <- sweep(test, 2, means, FUN = '-') 
test <- sweep(test, 2, sd, FUN = '/')  

#join the scaled variables back to 
NHDplusV2_NewEngCrop_cc_dvlp_cvr <- cbind((NHDplusV2_NewEngCrop_2080)[,c(1:6, 9)], test)


#this is what we used for the NAB conference
# NHDplusV2_NewEngCrop_ccdvlp <- NHDplusV2_NewEngCrop %>% 
#   mutate(annual_mean_summer_temp = annual_mean_summer_temp + 2,
#          PctImp_Ws = PctImp_Ws + 2,
#          pctAg_Ws = pctAg_Ws + 2,
#          logRdCrsCat = logRdCrsCat + 2,
#          huc12_damden_sqkm = huc12_damden_sqkm + 2,
#          huc8_damcount = huc8_damcount + 2
#          )


tmp <- predict(mdl, newdata = NHDplusV2_NewEngCrop_cc_dvlp_cvr, "probs")

#join the predictions_ccmgmt to the list of comids
tmp <- cbind(NHDplusV2_NewEngCrop_cc_dvlp_cvr, tmp)

tmp <- tmp %>%
  data.frame() %>% 
  select(huc12_name, huc12_tnmid, warm, cold, cool) %>% 
  pivot_longer(3:5, names_to = "temperature", values_to = "prop") %>% 
  group_by(huc12_name, huc12_tnmid, temperature) %>%
  summarise(mean = round(mean(prop, na.rm = T), 2),
            min = round(quantile(prop, probs = 0.05, na.rm = T), 2),
            max = round(quantile(prop, probs = 0.95, na.rm = T), 2))
  



temptraits_ccdvlp_cvr <- left_join(huc12, tmp, by = c("huc12_name", "huc12_tnmid"))


temptraits_ccdvlp_cvr <- temptraits_ccdvlp_cvr %>%  
  filter(!is.na(temperature))

ggplot(data = temptraits_ccdvlp_cvr)+
  geom_sf(aes(fill = mean), color = NA)+
  scale_fill_viridis_c(limits = c(0,1))+
  facet_wrap(~temperature, nrow = 1)+
    geom_sf(data = states, fill = NA, lwd = 0.2, color = "black")+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank())+
    labs(fill = "Avg Prop.")
ggsave(
    filename = "C:/Users/jenrogers/Documents/git/FreshwaterBio/FreshwaterBio/tmpfigures/temp_prep_prediction_ccdvlp_cvr.png",
    plot = last_plot(),
    width = 14,
    height = 7,
    units = "cm",
    dpi = 200
  )

ggplot(data = temptraits_ccdvlp_cvr, aes(x = huc8_name, y = mean))+
  geom_point(size = 3)+
  geom_errorbar(aes(ymin = min, ymax = max), width = .2)+
  coord_flip()+
  facet_wrap(~temperature, nrow = 1)+
  theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        axis.text = element_text(size = 10),
        axis.title = element_text(size = 15),
        axis.title.y = element_blank(),
        title = element_text(size = 15))+
    ggtitle(label = "Temperature Trait Proportion")
ggsave(
    filename = "C:/Users/jenrogers/Documents/git/FreshwaterBio/FreshwaterBio/tmpfigures/temp_prep_prediction_ccdvlp_cvr_dot.png",
    plot = last_plot(),
    width = 14,
    height = 9,
    units = "cm",
    dpi = 200
  )







#prediction using climate change and management values: increase in connectivity

test <- NHDplusV2_NewEngCrop_2080 %>% 
  data.frame() %>% 
  select(7:8, 10:39) %>% 
  rename(annual_mean_summer_temp = annual_mean_summer_temp_pls_4,
         BFI_HIST = BFI_2080,
         LO7Q1DT_HIST = LO7Q1DT_2080,
         CFM_HIST = CFM_2080,
         W95_HIST = W95_2080,
         logMJJA_HIST = logMJJA_2080) %>% 
  mutate(PctImp_Ws = PctImp_Ws * .1,
         pctAg_Ws = pctAg_Ws * .1) %>% 
  select(1:2, 27:31, 3:24, 32, 25:26)


#scale the variables using the means and sd used to scale the variables in the baseline condition
test <- sweep(test, 2, means, FUN = '-') 
test <- sweep(test, 2, sd, FUN = '/')  

#join the scaled variables back to 
NHDplusV2_NewEngCrop_cc_mgmt_cvr <- cbind((NHDplusV2_NewEngCrop_2080)[,c(1:6, 9)], test)


#used for NAB
# NHDplusV2_NewEngCrop_ccmgmt <- NHDplusV2_NewEngCrop %>% 
#   mutate(annual_mean_summer_temp = annual_mean_summer_temp + 2,
#          PctImp_Ws = PctImp_Ws - 2,
#          pctAg_Ws = pctAg_Ws - 2,
#          logRdCrsCat = logRdCrsCat - 2,
#          huc12_damden_sqkm = huc12_damden_sqkm - 2,
#          huc8_damcount = huc8_damcount - 2,
#          
#          )

tmp <- predict(mdl, newdata = NHDplusV2_NewEngCrop_cc_mgmt_cvr, "probs")

#join the predictions_ccmgmt to the list of comids
tmp <- cbind(NHDplusV2_NewEngCrop_cc_mgmt_cvr, tmp)

tmp <- tmp %>%
  data.frame() %>% 
  select(huc12_name, huc12_tnmid, warm, cold, cool) %>% 
  pivot_longer(3:5, names_to = "temperature", values_to = "prop") %>% 
  group_by(huc12_name, huc12_tnmid, temperature) %>%
  summarise(mean = round(mean(prop, na.rm = T), 2),
            min = round(quantile(prop, probs = 0.05, na.rm = T), 2),
            max = round(quantile(prop, probs = 0.95, na.rm = T), 2))
  



temptraits_ccmgmt_cvr <- left_join(huc12, tmp, by = c("huc12_name", "huc12_tnmid"))


temptraits_ccmgmt_cvr <- temptraits_ccmgmt_cvr %>%  
  filter(!is.na(temperature))

ggplot(data = temptraits_ccmgmt_cvr)+
  geom_sf(aes(fill = mean), color = NA)+
  scale_fill_viridis_c(limits = c(0,1))+
  facet_wrap(~temperature, nrow = 1)+
    geom_sf(data = states, fill = NA, lwd = 0.2, color = "black")+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank())+
    labs(fill = "Avg Prop.")
ggsave(
    filename = "C:/Users/jenrogers/Documents/git/FreshwaterBio/FreshwaterBio/tmpfigures/temp_prep_prediction_ccmgmt_cvr.png",
    plot = last_plot(),
    width = 14,
    height = 7,
    units = "cm",
    dpi = 200
  )

ggplot(data = temptraits_ccmgmt_cvr, aes(x = huc8_name, y = mean))+
  geom_point(size = 3)+
  geom_errorbar(aes(ymin = min, ymax = max), width = .2)+
  coord_flip()+
  facet_wrap(~temperature, nrow = 1)+
  theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        axis.text = element_text(size = 10),
        axis.title = element_text(size = 15),
        axis.title.y = element_blank(),
        title = element_text(size = 15))+
    ggtitle(label = "Temperature Trait Proportion")
ggsave(
    filename = "C:/Users/jenrogers/Documents/git/FreshwaterBio/FreshwaterBio/tmpfigures/temp_prep_prediction_ccmgmt_cvr_dot.png",
    plot = last_plot(),
    width = 14,
    height = 9,
    units = "cm",
    dpi = 200
  )





temptraits_baseline$scenario <- "baseline"
temptraits_cc$scenario <- "CC"
temptraits_ccdvlp_cnn$scenario <- "CC + dvlp + cnn"
temptraits_ccdvlp_cvr$scenario <- "CC + dvlp + cvr"
temptraits_ccmgmt_cnn$scenario <- "CC + Mgmt + cnn"
temptraits_ccmgmt_cvr$scenario <- "CC + Mgmt + cvr"

tmp <- bind_rows(temptraits_baseline, temptraits_cc, 
                 temptraits_ccdvlp_cnn, temptraits_ccdvlp_cvr, 
                 temptraits_ccmgmt_cnn, temptraits_ccmgmt_cvr)
tmp <- tmp %>% 
  filter(huc12_name %in% c("Sudbury Reservoir-Sudbury River", "East Branch Saco River", "Buffalo Stream"))
tmp$huc12_name[tmp$huc12_name == "Sudbury Reservoir-Sudbury River"] <- "Sudbury Reservoir"
tmp$huc12_name <- factor(tmp$huc12_name, levels = c("Sudbury Reservoir", "East Branch Saco River", "Buffalo Stream"))
tmp$scenario <- factor(tmp$scenario, levels = c("baseline", 
                                                "CC", 
                                                "CC + dvlp + cnn", 
                                                "CC + dvlp + cvr", 
                                                "CC + Mgmt + cnn",
                                                "CC + Mgmt + cvr"))

ggplot(data = tmp, aes(x = huc12_name, y = mean, color = scenario))+
  scale_color_manual(values = c("mediumpurple1", "darkgoldenrod1", "red3", "green4", "blue", "purple"))+
  geom_point(size = 2, position=position_dodge(width=0.5))+
  geom_errorbar(aes(ymin = min, ymax = max), width = .5, position=position_dodge(width=0.5))+
  geom_hline(yintercept = 0.5, color = "grey80", linetype = "dashed")+
  coord_flip()+
  facet_wrap(~temperature, nrow = 1)+
  theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        axis.text = element_text(size = 10),
        axis.title = element_text(size = 15),
        axis.title.y = element_blank(),
        title = element_text(size = 15),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"))+
  labs(y = "Avg Proportional Abundance")+
  scale_y_continuous(limits = c(0, 1), breaks = 0.5)
ggsave(
    filename = "C:/Users/jenrogers/Documents/git/FreshwaterBio/FreshwaterBio/tmpfigures/temp_prep_prediction_compare_dot.png",
    plot = last_plot(),
    width = 19,
    height = 10,
    units = "cm",
    dpi = 200
  )









diff <- temptraits_baseline %>% 
  rename(baseline_mean = mean) %>% 
  mutate(cc_mean = temptraits_cc$mean,
         ccdvlp_mean = temptraits_ccdvlp$mean,
         ccmgmt_mean = temptraits_ccmgmt$mean,
         change_dvlp = ccdvlp_mean - cc_mean,
         change_mgmt = ccmgmt_mean - cc_mean)


ggplot(data = diff)+
  geom_sf(aes(fill = change_dvlp), color = NA)+
  scale_fill_viridis_c(option = "magma", limits = c(-.25, 0.25))+
  facet_wrap(~temperature, nrow = 1)+
    geom_sf(data = states, fill = NA, lwd = 0.2, color = "black")+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank())+
    labs(fill = "Change")
ggsave(
    filename = "C:/Users/jenrogers/Documents/git/FreshwaterBio/FreshwaterBio/tmpfigures/temp_prep_prediction_cc_dvlp_change.png",
    plot = last_plot(),
    width = 14,
    height = 7,
    units = "cm",
    dpi = 200
  )

ggplot(data = diff)+
  geom_sf(aes(fill = change_mgmt), color = NA)+
  scale_fill_viridis_c(option = "magma", limits = c(-.25, 0.25))+
  facet_wrap(~temperature, nrow = 1)+
    geom_sf(data = states, fill = NA, lwd = 0.2, color = "black")+
    theme(panel.border = element_rect(colour = "black", fill = NA),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          panel.background = element_blank(),
        strip.background = element_rect(fill = "grey50",
                                        colour = "black"),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank())+
    labs(fill = "Change")
ggsave(
    filename = "C:/Users/jenrogers/Documents/git/FreshwaterBio/FreshwaterBio/tmpfigures/temp_prep_prediction_cc_mmgt_change.png",
    plot = last_plot(),
    width = 14,
    height = 7,
    units = "cm",
    dpi = 200
  )


```