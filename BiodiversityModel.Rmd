---
title: "Biodiversity Model"
author: "Jenny Rogers"
date: '2022-09-22'
output: html_document
---


In the 

```{r}
library(tidyverse)
library(sf)
library(lubridate)
library(corrplot)
library(caret)


```


In this first chunk, read in files: 

```{r}
#fish data
load("C:/Users/jenrogers/Documents/necascFreshwaterBio/model_datafiles/fish_occurrence.RData")
load("C:/Users/jenrogers/Documents/necascFreshwaterBio/model_datafiles/fish_count_with_zeros.RData")
fish_shp <- st_read("C:/Users/jenrogers/Documents/necascFreshwaterBio/SpatialData/sppdata/all_fish_event.shp")

#fish event and hydrography join
load("C:/Users/jenrogers/Documents/necascFreshwaterBio/model_datafiles/fish_event_huc_join.RData")
load("C:/Users/jenrogers/Documents/necascFreshwaterBio/model_datafiles/fish_event_flowline_join.RData")
load("C:/Users/jenrogers/Documents/necascFreshwaterBio/model_datafiles/fish_event_flowlineV2_join.RData")


#watershed shape files
huc8 <- st_read("C:/Users/jenrogers/Documents/necascFreshwaterBio/SpatialData/NHDplus/WBDHU8/WBDHU8_NE.shp")


#tidied covariates (this is called dat3)
load("C:/Users/jenrogers/Documents/necascFreshwaterBio/model_datafiles/model_covariates.RData")

#fish traits
load("C:/Users/jenrogers/Documents/necascFreshwaterBio/model_datafiles/fish_traits.RData")


```






first make a proportional abundance column and then join the count data to the event data and to all the covariates
 
```{r}

counts <- fish_count_with_zeros %>%
  filter(gear == "efish_backpack") %>% 
  group_by(UID) %>% 
  mutate(totalcount = sum(count)) %>% 
  ungroup() %>% 
  mutate(propabun = (count / totalcount)) %>% 
  select(UID, count, totalcount, propabun, common_name, gear, reach_length_m, avg_reach_width_m, efish_duration_s) %>% 
  mutate(abund_km = count / (reach_length_m) *1000) %>% 
  filter(common_name == "redfin pickerel")

#plot the observed proportional abundance
shp <- left_join(fish_shp, counts, by = "UID") %>%
  filter(!is.na(propabun)) %>%
  mutate(occurrence = ifelse(count>0, 1, 0))
ggplot(data = shp)+
  geom_sf(aes(fill = as.factor(occurrence), size = propabun), pch = 21, col = "black")




#join the counts to the tidying covariates, dat3
dat <- left_join(counts, dat3, by = "UID")


dat <- dat %>% 
  mutate(occurrence = ifelse(count>0, 1, 0)) %>% 
  select(UID, occurrence, count, abund_km, propabun, year, month, state, source, huc8_name, lat, long, 18:43)


```





model relative abundance with a zero-inflated binomial model from the glmmTMB package

```{r}
#first plot relative abundance values and map the distribution of those values
#histogram of relative abundance
ggplot(data = dat[dat$occurrence ==1,], mapping = aes(x = propabun))+
  geom_histogram()

#plot a map of observed relative abundance - need to join to the shapefile with UID
rel_abundance <- left_join(fish_shp, dat, by ="UID") 
ggplot(data = rel_abundance)+
  geom_sf(aes(fill = as.factor(occurrence), size = propabun), pch = 21, color = "black")


library(glmmTMB)

dat3$state <- as.factor(dat3$state)
dat3$source <- as.factor(dat3$source)

mdl <- glmmTMB(occurrence ~ 
                 lat + long + logWsAreaSqKm + 
                 annual_mean_max_temp_30d + 
                 logMJJA_HIST + BFI_HIST + LO7Q1DT_HIST + CFM_HIST + W95_HIST + 
                 BFIWs + ElevWs + WtDepWs + PctOw_Ws + PctUrbOp_Ws +
                 PctBl_Ws + pctforest_Ws + PctShrb_Ws + PctGrs_Ws + PctHay_Ws + 
                 PctWdWet_Ws + PctHbWet_Ws + PctImp_Ws + PctImp_WsRp100 ,
               data = dat,
               ziformula = ~lat + long + logWsAreaSqKm + ElevWs,
               family = "binomial")

summary(mdl)

#predict the model on the historical data
pred_data <- dat[,11:38]
predict <- predict(mdl, newdata = pred_data, type = "response")
compare <- data.frame("propabun" = dat$propabun, "prediction" = predict)


#plot
dat$prediction <- compare$prediction
tmp <- left_join(fish_shp, dat, by ="UID") %>% 
  mutate(pres = as.factor(ifelse(prediction > 0.1, 1, 0)))
ggplot(data = tmp[!is.na(tmp$prediction),])+
  geom_sf(aes(fill=pres, size = prediction), pch = 21, col = "black")

ggplot(data = tmp[!is.na(tmp$prediction),])+
  geom_sf(aes(fill= prediction, size = prediction), pch = 21, col = "black")

#predict the model on all of the flows lines, not just the training data 



```


Model proportional abundances of each traits using a multinomial logistic regression 
1. temperature preferences - four categories
2. spawning strategy - two categories
3. spawning season - nine categories


Model species richness using a mutivariate linear mode at the HUC12 scale



```{r}

library(foreign)
library(nnet)

counts <- fish_count_with_zeros %>%
  filter(gear == "efish_backpack") %>%
  left_join(final_traits, by = "common_name") 


temp_counts <- counts %>% 
  group_by(UID) %>% 
  mutate(totalcount = sum(count)) %>% 
  ungroup() %>% 
  filter(!is.na(tmp)) %>% 
  group_by(UID, tmp) %>% 
  mutate(temp_count = sum(count)) %>%
  ungroup() %>% 
  select(UID, tmp, totalcount, temp_count) %>% 
  unique() %>% 
  mutate(propabun_tmp = temp_count/totalcount) %>% 
  filter(temp_count> 0)

#revalue counts of greater than 500 to be 500 -- eventually we want to edit the fish count file to exclude juveniles.. hopefully this will get rid of some of the really large counts..
temp_counts$temp_count[temp_counts$temp_count>500] <- 500

#plot the observed proportional abundance
shp <- left_join(fish_shp, temp_counts, by = "UID") %>%
  filter(!is.na(propabun_tmp)) 
ggplot(data = shp)+
  geom_sf(aes(fill = propabun_tmp, col = propabun_tmp, alpha = 0.5), pch = 21)+
  facet_wrap(~tmp, nrow = 2)

#for the multinomial analysis, we want the dependent variable to be catagores, rather than a proportion of different categories
#one way to do this, is to repeat each observation 'n' times
#for example, is a site had 5 cold spp and 5 cool spp, we would make five rows for cold and five rows for cool.
n <-  temp_counts$temp_count
temp_counts <- temp_counts[rep(seq_len(nrow(temp_counts)), n),]
temp_counts <- temp_counts %>% 
  select(tmp, UID) %>% 
  left_join(dat3, by = "UID")


temp_counts$tmp2 <- relevel(as.factor(temp_counts$tmp), ref = "cool")
test <- multinom(tmp2 ~ lat + long + ElevWs, data = temp_counts)
summary(test)


sp_timing_counts <- counts%>% 
  group_by(UID) %>% 
  mutate(totalcount = sum(count)) %>% 
  ungroup() %>% 
  filter(!is.na(timing)) %>% 
  group_by(UID, timing) %>% 
  mutate(timing_count = sum(count)) %>%
  ungroup() %>% 
  select(UID, timing, totalcount, timing_count) %>% 
  unique() %>% 
  mutate(propabun_timing = timing_count/totalcount) %>% 
  select(-totalcount)

#plot the observed proportional abundance
shp <- left_join(fish_shp, sp_timing_counts, by = "UID") %>%
  filter(!is.na(propabun_timing)) 
ggplot(data = shp)+
  geom_sf(aes(fill = propabun_timing, col = propabun_timing, alpha = 0.5), pch = 21)+
  facet_wrap(~timing, nrow = 2)



sp_strat_counts <- counts%>% 
  group_by(UID) %>% 
  mutate(totalcount = sum(count)) %>% 
  ungroup() %>% 
  filter(!is.na(strategy)) %>% 
  group_by(UID, strategy) %>% 
  mutate(strategy_count = sum(count)) %>%
  ungroup() %>% 
  select(UID, strategy, totalcount, strategy_count) %>% 
  unique() %>% 
  mutate(propabun_strat = strategy_count/totalcount) %>% 
  select(-totalcount)

#plot the observed proportional abundance
shp <- left_join(fish_shp, sp_strat_counts, by = "UID") %>%
  filter(!is.na(propabun_strat)) 
ggplot(data = shp)+
  geom_sf(aes(fill = propabun_strat, col = propabun_strat, alpha = 0.5), pch = 21)+
  facet_wrap(~strategy, nrow = 1)





vel_counts <- counts%>% 
  group_by(UID) %>% 
  mutate(totalcount = sum(count)) %>% 
  ungroup() %>% 
  filter(!is.na(velocity)) %>% 
  group_by(UID, velocity) %>% 
  mutate(velocity_count = sum(count)) %>%
  ungroup() %>% 
  select(UID, velocity, totalcount, velocity_count) %>% 
  unique() %>% 
  mutate(propabun_vel = velocity_count/totalcount) %>% 
  select(-totalcount)

#plot the observed proportional abundance
shp <- left_join(fish_shp, vel_counts, by = "UID") %>%
  filter(!is.na(propabun_vel)) 
ggplot(data = shp)+
  geom_sf(aes(fill = propabun_vel, col = propabun_vel, alpha = 0.5), pch = 21)+
  facet_wrap(~velocity, nrow = 2)







```



model abundance (count/length) using all the variables
logist regression followed by a linear regression
If prob is <0.1 its absent. If its >0.1, we use the count
```{r}

library(pscl) #to run a zero inflated model
library(lme4) #to run a linear mixed effect model


ggplot(data = dat3, mapping = aes(x = log(abund_km)))+
  geom_histogram()


# lat + long + logWsAreaSqKm + annual_mean_max_temp_30d + logMJJA_HIST + BFI_HIST + LO7Q1DT_HIST +
#                            CFM_HIST + W95_HIST + BFIWs + ElevWs + WtDepWs + HUDen_Ws + PopDen_Ws + PctOw_Ws + PctUrbOp_Ws +
#                            PctBl_Ws  + pctforest_Ws + PctShrb_Ws + PctGrs_Ws + PctHay_Ws + PctWdWet_Ws +
#                            PctHbWet_Ws + PctImp_Ws + PctImp_WsRp100


#presence absence model for pumpkinseed
logreg_pumpk <- glm(occurrence ~ lat + long + logWsAreaSqKm + annual_mean_max_temp_30d + logMJJA_HIST + BFI_HIST + LO7Q1DT_HIST +
                           CFM_HIST + W95_HIST + BFIWs + ElevWs + WtDepWs + HUDen_Ws + PopDen_Ws + PctOw_Ws + PctUrbOp_Ws +
                           PctBl_Ws + pctforest_Ws + PctShrb_Ws + PctGrs_Ws + PctHay_Ws + PctWdWet_Ws +
                           PctHbWet_Ws + PctImp_Ws + PctImp_WsRp100 ,
                         family = "binomial",
                         data = dat3)

summary(logreg_pumpk)

#test prediction on the data
pred <- dat3[,c(9:40)]
predict_logreg <- predict(logreg_pumpk, newdata = pred, type = "response")
compare_logreg <- data.frame("occurrence" = dat3$occurrence, "prob" = predict_logreg)


#plot
dat2$prediction <- compare_logreg$prob
log_reg_results <- left_join(fish_shp, dat2, by ="UID")
ggplot(data = log_reg_results[!is.na(log_reg_results$prediction),])+
  geom_sf(aes(col=prediction))


#model the log abundance

dat3$logabund <- log(dat3$abund_km + 1)
lm_pumpk <- glm(logabund ~ lat + long + logWsAreaSqKm + annual_mean_max_temp_30d + logMJJA_HIST + BFI_HIST + LO7Q1DT_HIST +
                           CFM_HIST + W95_HIST + BFIWs + ElevWs + WtDepWs + HUDen_Ws + PopDen_Ws + PctOw_Ws + PctUrbOp_Ws +
                           PctBl_Ws  + pctforest_Ws + PctShrb_Ws + PctGrs_Ws + PctHay_Ws + PctWdWet_Ws +
                           PctHbWet_Ws + PctImp_Ws + PctImp_WsRp100 ,
                         family = "gaussian",
                         data = dat3)
summary(lm_pumpk)

#test prediction on the data
pred <- dat3[,c(9:40)]
predict_lm <- predict(lm_pumpk, newdata = pred, type = "response")
compare_lm <- data.frame("abund" = dat3$logabund, "mdl_abund" = predict_lm)

#plot
dat2$prediction <- compare_lm$mdl_abund
lm_pumpk_results <- left_join(fish_shp, dat2, by ="UID")
ggplot(data = lm_pumpk_results[!is.na(lm_pumpk_results$prediction),])+
  geom_sf(aes(col=prediction))


#plot 

dat2$logpred <- compare_logreg$prob
dat2$abunPred <- compare_lm$mdl_abund
dat2$finalpred <- ifelse(dat2$logpred<0.1, 0, dat2$abunPred)
final_pumpk_results <- left_join(fish_shp, dat2, by ="UID")
final_pumpk_results$occurrence <- ifelse(final_pumpk_results$finalpred>0, 1,0)
ggplot(data = final_pumpk_results[!is.na(final_pumpk_results$finalpred),])+
  geom_sf(aes(fill = as.factor(occurrence), size = finalpred), pch = 21, col="black")




```
