---
title: "Biodiversity Model"
author: "Jenny Rogers"
date: '2022-09-22'
output: html_document
---




```{r}
library(tidyverse)
library(sf)
library(lubridate)
library(corrplot)
library(caret)


```


In this first chunk, read in files: 

```{r}
#fish data
load("C:/Users/jenrogers/Documents/necascFreshwaterBio/model_datafiles/fish_occurrence.RData")
load("C:/Users/jenrogers/Documents/necascFreshwaterBio/model_datafiles/fish_count_with_zeros.RData")
fish_shp <- st_read("C:/Users/jenrogers/Documents/necascFreshwaterBio/SpatialData/sppdata/all_fish_event.shp")

#fish event and hydrography join
load("C:/Users/jenrogers/Documents/necascFreshwaterBio/model_datafiles/fish_event_huc_join.RData")
load("C:/Users/jenrogers/Documents/necascFreshwaterBio/model_datafiles/fish_event_flowline_join.RData")
load("C:/Users/jenrogers/Documents/necascFreshwaterBio/model_datafiles/fish_event_flowlineV2_join.RData")


#watershed shape files
huc8 <- st_read("C:/Users/jenrogers/Documents/necascFreshwaterBio/SpatialData/NHDplus/WBDHU8/WBDHU8_NE.shp")


#tidied covariates 
load("C:/Users/jenrogers/Documents/necascFreshwaterBio/model_datafiles/model_covariates.RData")

#fish traits
load("C:/Users/jenrogers/Documents/necascFreshwaterBio/model_datafiles/fish_traits.RData")


```






first make a proportional abundance column and then join the count data to the event data and to all the covariates
Then model relative abundance with a zero-inflated binomial model from the glmmTMB package
```{r}

library(glmmTMB)

counts <- fish_count_with_zeros %>%
  filter(gear == "efish_backpack") %>% 
  group_by(UID) %>% 
  mutate(totalcount = sum(count)) %>% 
  ungroup() %>% 
  mutate(propabun = (count / totalcount)) %>% 
  select(UID, count, totalcount, propabun, common_name, gear, reach_length_m, avg_reach_width_m, efish_duration_s) %>% 
  mutate(abund_km = count / (reach_length_m) *1000) %>% 
  filter(common_name == "chain pickerel")

hist(counts$propabun)

#plot the observed proportional abundance
# shp <- left_join(fish_shp, counts, by = "UID") %>%
#   filter(!is.na(propabun)) %>%
#   mutate(occurrence = ifelse(count>0, 1, 0))
# ggplot(data = shp)+
#   geom_sf(aes(fill = as.factor(occurrence), size = propabun), pch = 21, col = "black")

fishcovariates <- fishcovariates[complete.cases(fishcovariates),]
test <- fishcovariates[,c(2:3, 9:38)]
test <- data.frame(scale(test))

fishcovariates <- cbind((fishcovariates)[,c(1, 4:8)], test)


#join the counts to the tidying covariates, fishcovariates
dat <- left_join(counts, fishcovariates, by = "UID")


dat <- dat %>% 
  mutate(occurrence = ifelse(count>0, 1, 0)) %>% 
  select(UID, common_name, occurrence, propabun, state, huc8_name, lat, long, 18:47)


#plot of variables vs proportional abundance
# dat$occurrence <- as.factor(dat$occurrence)
# ggplot(data = dat, mapping = aes(x = occurrence, y = pctForest_ws))+
#   geom_violin()+
#   geom_boxplot(width = 0.1)+
#   geom_smooth(method = "lm")+
#     theme(panel.border = element_rect(colour = "black", fill = NA),
#           panel.grid.major = element_blank(),
#           panel.grid.minor = element_blank(),
#           panel.background = element_blank())+
#   labs(title = "brook trout")


#histogram of relative abundance
# ggplot(data = dat, mapping = aes(x = propabun))+
#   geom_histogram()
# #histogram of relative abundance without the zeros so we can see the other data
# ggplot(data = dat[dat$occurrence ==1,], mapping = aes(x = propabun))+
#   geom_histogram()
# 
# #map of observed relative abundance - need to join to the shapefile with UID
# rel_abundance <- left_join(fish_shp, dat, by ="UID") 
# ggplot(data = rel_abundance)+
#   geom_sf(aes(fill = as.factor(occurrence), size = propabun), pch = 21, color = "black")


#two options to further reduce the variable list:

# PCA to combine all the variables used in the conditional model (or both models?) need to do this

#simple binomial models to identify which variables are not related to the outcome
# mdl <- glmmTMB(propabun ~ huc8_damcount,
#                data = dat,
#                family = "binomial")
# summary(mdl)


#global model
mdl <- glmmTMB(propabun ~ 
                 annual_mean_summer_temp +
                 W95_HIST +
                 BFI_HIST +
                 logMJJA_HIST +
                 RdCrsWs +  
                 pctAg_Ws +
                 PctOw_Ws +
                 PctImp_Ws +
                 pctWetland_Ws +  
                 huc12_damden_sqkm,
               data = dat,
               ziformula = ~lat + long +ElevCat,
               family = "binomial")

saveRDS(mdl, paste("C:/Users/jenrogers/Documents/necascFreshwaterBio/model_objects/propabun_", unique(dat$common_name), ".rds", sep = ""))

#make a table of the model resuls

results <- fixef(mdl)
results2 <- as.data.frame(results$cond)
results2$variable <- row.names(results2)
names(results2)[1] <- "estimate"
rownames(results2) <- NULL
results2$mdl <- "conditional"
results3 <- as.data.frame(results$zi)
results3$variable <- row.names(results3)
names(results3)[1] <- "estimate"
rownames(results3) <- NULL
results3$mdl <- "zeroinfla"

results <- rbind(results2, results3)
results$common_name <- unique(dat$common_name)




#Start the for loop here

for (i in 2:length(unique(fish_count_with_zeros$common_name))) { #start with 2 bc we used white sucker as the started spp above
  


counts <- fish_count_with_zeros %>%
  filter(gear == "efish_backpack") %>% 
  group_by(UID) %>% 
  mutate(totalcount = sum(count)) %>% 
  ungroup() %>% 
  mutate(propabun = (count / totalcount)) %>% 
  select(UID, count, totalcount, propabun, common_name, gear, reach_length_m, avg_reach_width_m, efish_duration_s) %>% 
  mutate(abund_km = count / (reach_length_m) *1000) %>% 
  filter(common_name == unique(fish_count_with_zeros$common_name)[i])


#join the counts to the tidying covariates, fishcovariates
dat <- left_join(counts, fishcovariates, by = "UID")
dat <- dat[complete.cases(dat),]


#global model
mdl <- glmmTMB(propabun ~ 
                 annual_mean_summer_temp +
                 W95_HIST +
                 BFI_HIST +
                 logMJJA_HIST +
                 RdCrsWs +  
                 pctAg_Ws +
                 PctOw_Ws +
                 PctImp_Ws +
                 pctWetland_Ws +  
                 huc12_damden_sqkm,
               data = dat,
               ziformula = ~lat + long +ElevCat,
               family = "binomial")

saveRDS(mdl, paste("C:/Users/jenrogers/Documents/necascFreshwaterBio/model_objects/propabun_", unique(fish_count_with_zeros$common_name)[i], ".rds", sep = ""))

#make a table of the model resuls

tmp <- fixef(mdl)
results2 <- as.data.frame(tmp$cond)
results2$variable <- row.names(results2)
names(results2)[1] <- "estimate"
rownames(results2) <- NULL
results2$mdl <- "conditional"
results3 <- as.data.frame(tmp$zi)
results3$variable <- row.names(results3)
names(results3)[1] <- "estimate"
rownames(results3) <- NULL
results3$mdl <- "zeroinfla"

tmp <- rbind(results2, results3)
tmp$common_name <- unique(fish_count_with_zeros$common_name)[i]


results <- rbind(results, tmp)

print(unique(fish_count_with_zeros$common_name)[i])

}

#predict the model on the historical data
pred_data <- dat[,11:42]
predict <- predict(mdl, newdata = pred_data, type = "response")
compare <- data.frame("propabun" = dat$propabun, "prediction" = predict)


#plot
dat$prediction <- compare$prediction
tmp <- left_join(fish_shp, dat, by ="UID") %>% 
  mutate(pres = as.factor(ifelse(prediction > 0.1, 1, 0)))
ggplot(data = tmp[!is.na(tmp$prediction),])+
  geom_sf(aes(fill=pres, size = prediction), pch = 21, col = "black")

ggplot(data = tmp[!is.na(tmp$prediction),])+
  geom_sf(aes(fill= prediction, size = prediction), pch = 21, col = "black")

#predict the model on all of the flows lines, not just the training data 



```


Model proportional abundances of each traits using a multinomial logistic regression 
1. temperature preferences - four categories
2. spawning strategy - two categories
3. spawning season - nine categories

```{r}

library(foreign)
library(nnet)

counts <- fish_count_with_zeros %>%
  filter(gear == "efish_backpack") %>%
  left_join(final_traits, by = "common_name") 


#set up the temperature dataframe.  Want to count the number of cold, cool, warm, and eurythermal 
temp_counts <- counts %>% 
  filter(!is.na(tmp),
         tmp != "eurythermal") %>% 
  group_by(UID) %>% 
  mutate(totalcount = sum(count)) %>% 
  ungroup()  %>% 
  group_by(UID, tmp) %>% 
  mutate(temp_count = sum(count)) %>%
  ungroup() %>% 
  select(UID, tmp, totalcount, temp_count) %>% 
  unique() %>% 
  mutate(propabun_tmp = temp_count/totalcount) %>% 
  filter(temp_count> 0)

#revalue counts of greater than 500 to be 500 -- eventually we want to edit the fish count file to exclude juveniles.. hopefully this will get rid of some of the really large counts..
temp_counts$temp_count[temp_counts$temp_count>500] <- 500

#plot the observed proportional abundance
shp <- left_join(fish_shp, temp_counts, by = "UID") %>%
  filter(!is.na(propabun_tmp)) 
ggplot(data = shp)+
  geom_sf(aes(fill = propabun_tmp, col = propabun_tmp), pch = 21, alpha = 0.5)+
  facet_wrap(~tmp, nrow = 2)

#for the multinomial analysis, we want the dependent variable to be catagores, rather than a proportion of different categories
#one way to do this, is to repeat each observation 'n' times
#for example, is a site had 5 cold spp and 5 cool spp, we would make five rows for cold and five rows for cool.
n <-  temp_counts$temp_count
temp_counts <- temp_counts[rep(seq_len(nrow(temp_counts)), n),]
temp_counts <- temp_counts %>% 
  select(tmp, UID) %>% 
  left_join(fishcovariates, by = "UID")

#convert the temperature designations to 'factor' variables. Reference level = 'cool' (all results interpreted in relation to "cool")
temp_counts$tmp2 <- relevel(as.factor(temp_counts$tmp), ref = "warm")

#run the multinomial model
mdl <- multinom(tmp2 ~ lat + 
                 long + 
                 annual_mean_summer_temp + 
                 BFI_HIST + 
                 LO7Q1DT_HIST + 
                 W95_HIST + 
                 BFIWs + 
                 ElevCat + 
                 WtDepWs +  
                 PctOw_Ws +  
                 PctImp_Ws +  
                 pctAg_Ws +  
                 pctWetland_Ws + 
                 huc12_damden_sqkm + 
                 huc8_damcount + + 
                 logMJJA_HIST + 
                 logRdCrsCat ,
                 data = temp_counts)
results <- summary(mdl)

#plot the OR and the 95% confidence interval for Cold fish (vs warm fish)
coef <- data.frame(results$coefficients) #make a coef table
coef <- coef %>%  # keep only the cold coefficients 
  mutate(temperature = rownames(coef)) %>% 
  filter(temperature == "cold") %>% 
  select(-temperature, -X.Intercept.) %>% 
  pivot_longer(1:27, names_to = "variable", values_to = "coef")
se <- data.frame(results$standard.errors) #make a standard error table
se <- se %>%  #keep only the cold water standard errors
  mutate(temperature = rownames(se)) %>% 
  filter(temperature == "cold") %>% 
  select(-temperature, -X.Intercept.) %>% 
  pivot_longer(1:27, names_to = "variable", values_to = "se")

#create a dataframe with the variables, coef and se in one dataframe
results2 <- data.frame( 
  "variable" = coef$variable,
  "coef" = coef$coef,
  "se" = se$se)

#calucate the z score, pvalue, and the upr and lwr CI, and then exponentiate the coef and upr/lower bounds to get odds ratio units
results2 <- results2 %>% 
  mutate(z = coef/se,
         p = (1 - pnorm(abs(z), 0, 1)) * 2,
         CIlow = coef - (1.96*se),
         CIhigh = coef + (1.96*se),
         OR = exp(coef),
         ORCIlow = exp(CIlow),
         ORCIhigh = exp(CIhigh)) %>% 
  arrange(OR)
#the plot is ordering by the alphbatized letters of the variables, so we will make them factors ordered by the value of of the OR
results2$variable <- factor(results2$variable, levels = results2$variable)
#dot plot of the OR and the CI. The CI are so tiny bc the sample size is super big
ggplot(data = arrange(results2, OR), aes(x = variable, y = OR))+
  geom_point()+
  geom_errorbar(aes(ymin = ORCIlow, ymax = ORCIhigh), width = 0)+
  coord_flip()+
  geom_hline(yintercept = 1, color  = "red", linetype = "dashed")

ggsave(
    filename = "C:/Users/jenrogers/Documents/git/FreshwaterBio/FreshwaterBio/tmpfigures/coldtraitDotPlot.png",
    plot = last_plot(),
    width = 14,
    height = 9,
    units = "cm",
    dpi = 200
  )


#calcuate predicted probablies of each outcome.

predict <- temp_counts %>% 
  select(-c(1,5, 6,7,8,9, 36)) %>% 
  unique()

pp <- predict(mdl, newdata = predict, "probs")

predict2 <- data.frame("UID" = predict$UID,
                       "cool" = pp[,1],
                       "cold" = pp[,2],
                       "eury" = pp[,3],
                       "warm" = pp[,4])

predict3 <- left_join(fish_shp, predict2, by = "UID") %>%
  select(cool, cold, eury, warm) %>% 
  pivot_longer(1:4, names_to = "temperature", values_to = "proportion")
  
ggplot(data = predict3[predict3$proportion>0 & !is.na(predict3$proportion),])+
  geom_sf(aes(col = proportion))+
  facet_wrap(~temperature, nrow = 2)



#odds = exp(logodds)
#probability = odds/(1+odds)





#set up the timing dataframe (ie the season that spp spawn)
sp_timing_counts <- counts%>% 
  group_by(UID) %>% 
  mutate(totalcount = sum(count)) %>% 
  ungroup() %>% 
  filter(!is.na(timing)) %>% 
  group_by(UID, timing) %>% 
  mutate(timing_count = sum(count)) %>%
  ungroup() %>% 
  select(UID, timing, totalcount, timing_count) %>% 
  unique() %>% 
  mutate(propabun_timing = timing_count/totalcount) %>% 
  select(-totalcount) %>% 
  filter(timing_count>0)

#revalue counts of greater than 500 to be 500 -- eventually we want to edit the fish count file to exclude juveniles.. hopefully this will get rid of some of the really large counts..
sp_timing_counts$timing_count[sp_timing_counts$timing_count>500] <- 500


#plot the observed proportional abundance
shp <- left_join(fish_shp, sp_timing_counts, by = "UID") %>%
  filter(!is.na(propabun_timing)) 
ggplot(data = shp)+
  geom_sf(aes(fill = propabun_timing, col = propabun_timing), alpha = 0.5, pch = 21)+
  facet_wrap(~timing, nrow = 2)


#for the multinomial analysis, we want the dependent variable to be catagores, rather than a proportion of different categories
#one way to do this, is to repeat each observation 'n' times
#for example, is a site had 5 cold spp and 5 cool spp, we would make five rows for cold and five rows for cool.
n <-  sp_timing_counts$timing_count
sp_timing_counts <- sp_timing_counts[rep(seq_len(nrow(sp_timing_counts)), n),]
sp_timing_counts <- sp_timing_counts %>% 
  select(timing, UID) %>% 
  left_join(fishcovariates, by = "UID")

#convert the temperature designations to 'factor' variables. Reference level = 'cool' (all results interpreted in relation to "cool")
sp_timing_counts$timing <- relevel(as.factor(sp_timing_counts$timing), ref = "sp")

#run the multinomial model
mdl <- multinom(timing ~ lat + 
                 long + 
                 annual_mean_summer_temp + 
                 BFI_HIST + 
                 LO7Q1DT_HIST + 
                 CFM_HIST + 
                 W95_HIST + 
                 BFIWs + 
                 ElevCat + 
                 RdDensCatRp100 + 
                 RdDensWsRp100 + 
                 RdCrsWs + 
                 WtDepWs + 
                 PopDen_Ws + 
                 PctOw_Ws + 
                 PctImp_Cat + 
                 PctImp_Ws + 
                 PctImp_CatRp100 + 
                 PctImp_WsRp100 + 
                 pctForest_Cat + 
                 pctForest_ws + 
                 pctUrban_Cat + 
                 pctUrban_ws + 
                 pctAg_Ws + 
                 pctWetland_Cat + 
                 pctWetland_Ws + 
                 huc12_damden_sqkm + 
                 huc8_damcount + 
                 logWsAreaSqKm + 
                 logMJJA_HIST + 
                 logRdCrsCat + 
                 logPctOw_Cat,
                 data = sp_timing_counts)
results <- summary(mdl)








sp_strat_counts <- counts%>% 
  group_by(UID) %>% 
  mutate(totalcount = sum(count)) %>% 
  ungroup() %>% 
  filter(!is.na(strategy)) %>% 
  group_by(UID, strategy) %>% 
  mutate(strategy_count = sum(count)) %>%
  ungroup() %>% 
  select(UID, strategy, totalcount, strategy_count) %>% 
  unique() %>% 
  mutate(propabun_strat = strategy_count/totalcount) %>% 
  select(-totalcount)%>% 
  filter(strategy_count>0)

hist(sp_strat_counts$strategy_count)

#revalue counts of greater than 500 to be 500 -- eventually we want to edit the fish count file to exclude juveniles.. hopefully this will get rid of some of the really large counts..
sp_strat_counts$strategy_count[sp_strat_counts$strategy_count>1000] <- 1000

#plot the observed proportional abundance
shp <- left_join(fish_shp, sp_strat_counts, by = "UID") %>%
  filter(!is.na(propabun_strat)) 
ggplot(data = shp)+
  geom_sf(aes(fill = propabun_strat, col = propabun_strat), alpha = 0.5, pch = 21)+
  facet_wrap(~strategy, nrow = 1)





vel_counts <- counts%>% 
  group_by(UID) %>% 
  mutate(totalcount = sum(count)) %>% 
  ungroup() %>% 
  filter(!is.na(velocity)) %>% 
  group_by(UID, velocity) %>% 
  mutate(velocity_count = sum(count)) %>%
  ungroup() %>% 
  select(UID, velocity, totalcount, velocity_count) %>% 
  unique() %>% 
  mutate(propabun_vel = velocity_count/totalcount) %>% 
  select(-totalcount)

#plot the observed proportional abundance
shp <- left_join(fish_shp, vel_counts, by = "UID") %>%
  filter(!is.na(propabun_vel)) 
ggplot(data = shp)+
  geom_sf(aes(fill = propabun_vel, col = propabun_vel, alpha = 0.5), pch = 21)+
  facet_wrap(~velocity, nrow = 2)







```



model abundance (count/length) using all the variables
logist regression followed by a linear regression
If prob is <0.1 its absent. If its >0.1, we use the count
```{r}

library(pscl) #to run a zero inflated model
library(lme4) #to run a linear mixed effect model


ggplot(data = fishcovariates, mapping = aes(x = log(abund_km)))+
  geom_histogram()


# lat + long + logWsAreaSqKm + annual_mean_max_temp_30d + logMJJA_HIST + BFI_HIST + LO7Q1DT_HIST +
#                            CFM_HIST + W95_HIST + BFIWs + ElevWs + WtDepWs + HUDen_Ws + PopDen_Ws + PctOw_Ws + PctUrbOp_Ws +
#                            PctBl_Ws  + pctforest_Ws + PctShrb_Ws + PctGrs_Ws + PctHay_Ws + PctWdWet_Ws +
#                            PctHbWet_Ws + PctImp_Ws + PctImp_WsRp100


#presence absence model for pumpkinseed
logreg_pumpk <- glm(occurrence ~ lat + long + logWsAreaSqKm + annual_mean_max_temp_30d + logMJJA_HIST + BFI_HIST + LO7Q1DT_HIST +
                           CFM_HIST + W95_HIST + BFIWs + ElevWs + WtDepWs + HUDen_Ws + PopDen_Ws + PctOw_Ws + PctUrbOp_Ws +
                           PctBl_Ws + pctforest_Ws + PctShrb_Ws + PctGrs_Ws + PctHay_Ws + PctWdWet_Ws +
                           PctHbWet_Ws + PctImp_Ws + PctImp_WsRp100 ,
                         family = "binomial",
                         data = fishcovariates)

summary(logreg_pumpk)

#test prediction on the data
pred <- fishcovariates[,c(9:40)]
predict_logreg <- predict(logreg_pumpk, newdata = pred, type = "response")
compare_logreg <- data.frame("occurrence" = fishcovariates$occurrence, "prob" = predict_logreg)


#plot
dat2$prediction <- compare_logreg$prob
log_reg_results <- left_join(fish_shp, dat2, by ="UID")
ggplot(data = log_reg_results[!is.na(log_reg_results$prediction),])+
  geom_sf(aes(col=prediction))


#model the log abundance

fishcovariates$logabund <- log(fishcovariates$abund_km + 1)
lm_pumpk <- glm(logabund ~ lat + long + logWsAreaSqKm + annual_mean_max_temp_30d + logMJJA_HIST + BFI_HIST + LO7Q1DT_HIST +
                           CFM_HIST + W95_HIST + BFIWs + ElevWs + WtDepWs + HUDen_Ws + PopDen_Ws + PctOw_Ws + PctUrbOp_Ws +
                           PctBl_Ws  + pctforest_Ws + PctShrb_Ws + PctGrs_Ws + PctHay_Ws + PctWdWet_Ws +
                           PctHbWet_Ws + PctImp_Ws + PctImp_WsRp100 ,
                         family = "gaussian",
                         data = fishcovariates)
summary(lm_pumpk)

#test prediction on the data
pred <- fishcovariates[,c(9:40)]
predict_lm <- predict(lm_pumpk, newdata = pred, type = "response")
compare_lm <- data.frame("abund" = fishcovariates$logabund, "mdl_abund" = predict_lm)

#plot
dat2$prediction <- compare_lm$mdl_abund
lm_pumpk_results <- left_join(fish_shp, dat2, by ="UID")
ggplot(data = lm_pumpk_results[!is.na(lm_pumpk_results$prediction),])+
  geom_sf(aes(col=prediction))


#plot 

dat2$logpred <- compare_logreg$prob
dat2$abunPred <- compare_lm$mdl_abund
dat2$finalpred <- ifelse(dat2$logpred<0.1, 0, dat2$abunPred)
final_pumpk_results <- left_join(fish_shp, dat2, by ="UID")
final_pumpk_results$occurrence <- ifelse(final_pumpk_results$finalpred>0, 1,0)
ggplot(data = final_pumpk_results[!is.na(final_pumpk_results$finalpred),])+
  geom_sf(aes(fill = as.factor(occurrence), size = finalpred), pch = 21, col="black")




```
